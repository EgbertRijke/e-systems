\section{Internalizing the theory of contexts families and terms}
One of the guiding ideas behind the design of the theory of contexts, families
and terms was that it would have to be possible to consider internal versions
of the theory. In this section we aim for this internalization.

It would be interesting to write out a weak version of pre-universes, internal
to Martin-L\"of type theory with the function extensionality principle. 
To do this, the empty context needs to
be replaced by a contractible type, extension by dependent pair types,
judgmental equalities of terms by identifications and judgmental equalities
of families by equivalences of types. We conjecture that it is possible to
carry this out (in particular to make sure that all the constructions 
type-check). This could serve as a starting point for investigating internal
models without truncatedness assumptions and for investigating internal higher
categories. 
Moreover, one could then extend the notion of `weak' pre-universes
with the requirement that every internal morphism is weakly anodyne. This
could give an internal theory of weak higher groupoids.

\subsection{Extension algebras}
In this subsection our goal is to define the notion of extension algebras,
which are internal versions of the extension operation of the theory of
contexts, families and terms. In this article, their use will be mainly in
universes. The theory of extension algebras requires the full power (i.e.~all
of the ingredients) of the theory of contexts, families and terms in its
formulation and it is (perhaps surprisingly) quite involved to formulate it.

Let $P$ be a family over an extended context $\ctxext{\Gamma}{A}$. We could
mimic extension by requiring to have terms
\begin{align*}
\jhom*{\Gamma}{{A}{P}}{A}{\epsilon_0}\\
\jhom*{{\Gamma}{A}}{{P}{\jcomp{}{\epsilon_0}{P}}}{P}{\epsilon_1}.
\end{align*}

\begin{rmk}
Instead of looking at $\epsilon_1$ as a context morphism from $\ctxext{P}{\jcomp{}{\epsilon_0}{P}}$
to $P$, one could also look at $\epsilon_1$ as a morphism \emph{over $\cprojfstf{A}{P}$},
as indicated in the following diagram:
\begin{equation*}
\begin{tikzcd}
P
  \ar[fib]{d}
& \jcomp{}{\epsilon_0}{P}
  \ar[fib]{d}
  \ar{l}[swap]{\epsilon_1}
  \ar{r}
& P
  \ar[fib]{d}
  \\
A
& \ctxext{A}{P}
  \ar{l}{\cprojfstf{A}{P}}
  \ar{r}[swap]{\epsilon_0}
& A
\end{tikzcd}
\end{equation*}
This makes it clear that $\epsilon_1$ takes a family over an extended context as an
argument. The extended context consists of a `base part' and a `family part'. 
The output of $\epsilon_1$ is a new (extended) family over that base part. Forgetting 
the family part is what the projection takes care of.
\end{rmk}

Extension also satisfies the properties explained in \autoref{comp-ee}, so we
must find the two judgmental equalities for $\epsilon_0$ and $\epsilon_1$ mimicing those. 
The first of these judgmental equalities is easy to give: it says that the
following diagram commutes:
\begin{equation}\label{eq:extalg-eq1}
\begin{tikzcd}[column sep=huge]
\ctxext{A}{{P}{\jcomp{}{\epsilon_0}{P}}} 
  \ar{d}[swap]{\jvcomp{}{\epsilon_0}{\idtm{\jcomp{}{\epsilon_0}{P}}}
    } 
  \ar{r}{\jvcomp{}{\idtm{A}}{\epsilon_1}
    } 
  & \ctxext{A}{P} \ar{d}{\epsilon_0}\\
\ctxext{A}{P} \ar{r}[swap]{\epsilon_0} & A
\end{tikzcd}
\end{equation}
To get a feel for this judgmental equality we include the following lemma.

\begin{lem}
Let $A$, $P$, $\epsilon_0$ and $\epsilon_1$ be as above, satisfying \autoref{eq:extalg-eq1} and
let $x_0:A$,
$x_1:\subst{x_0}{P}$ and $x_2:\subst{x_1}{{x_0}{\jcomp{}{\epsilon_0}{P}}}$.
Then we have the judgmental equality
\begin{equation*}
\subst{{x_2}{{x_1}{\epsilon_1}}}{{x_0}{\epsilon_0}}
\jdeq
\subst{x_2}{{{x_1}{{x_0}{\epsilon_0}}}{\epsilon_0}}.
\end{equation*}
\end{lem}

\begin{proof}
The proof is a simple computation:
\begin{align*}
\subst{{x_2}{{x_1}{\epsilon_1}}}{{x_0}{\epsilon_0}}
& \jdeq
  \subst{\tmext{x_0}{\subst{x_2}{{x_1}{\epsilon_1}}}}{\epsilon_0}
  \\
& \jdeq 
  \subst{{x_2}{{x_1}{{x_0}{\jvcomp{}{\idtm{A}}{\epsilon_1}}}}}{\epsilon_0}
  \\
& \jdeq
  \subst{x_2}{{x_1}{{x_0}{\jcomp{}{\jvcomp{}{\idtm{A}}{\epsilon_1}}{\epsilon_0}}}}
  \\
& \jdeq
  \subst{x_2}{{x_1}{{x_0}{\jcomp{}{\jvcomp{}{\epsilon_0}{\idtm{\jcomp{}{\epsilon_0}{P}}}}{\epsilon_0}}}}
  \\
& \jdeq 
  \subst{{x_2}{{x_1}{{x_0}{\jvcomp{}{\epsilon_0}{\idtm{\jcomp{}{\epsilon_0}{P}}}}}}}{\epsilon_0}
  \\
& \jdeq
  \subst{\tmext{\subst{x_1}{{x_0}{\epsilon_0}}}{x_2}}{\epsilon_0}
  \\
& \jdeq
  \subst{x_2}{{{x_1}{{x_0}{\epsilon_0}}}{\epsilon_0}}.\qedhere
\end{align*}
\end{proof}

The second of the judgmental equalities is harder to describe, however. We need
to consider `higher' families, i.e.~families over families over families, and
thus we need to look at the family $\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}$ and find the
two dotted morphisms in the diagram
\begin{equation*}
\begin{tikzcd}
\ctxext{P}{{\jcomp{}{\epsilon_0}{P}}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}}
  \ar[densely dotted]{d}
  \ar[densely dotted]{r}
& \ctxext{P}{\jcomp{}{\epsilon_0}{P}} \ar{d}{\epsilon_1}\\
\ctxext{P}{\jcomp{}{\epsilon_0}{P}} \ar{r}{\epsilon_1} & P
\end{tikzcd}
\end{equation*}
The first is easy to find. Note that we have the judgmental equality
\begin{equation*}
\ctxext{\jcomp{}{\epsilon_0}{P}}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}
  \jdeq
  \jcomp{}{\epsilon_0}{\ctxext{P}{\jcomp{}{\epsilon_0}{P}}}
\end{equation*}
and therefore we may just take the morphism
\begin{equation*}
\jhom
  {{\Gamma}{A}}
  {{P}{{\jcomp{}{\epsilon_0}{P}}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}}}
  {{P}{\jcomp{}{\epsilon_0}{P}}}
  {\jvcomp{}{\idtm{P}}{\jcomp{}{\epsilon_0}{\epsilon_1}}}.
\end{equation*}
For the other morphism we need to look at the family
$\ctxext{P}{{\jcomp{}{\epsilon_0}{P}}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}}$ differently. We do
that in the following lemma.

\begin{lem}\label{lem:extalg-twins}
Suppose we have $A$, $P$, $\epsilon_0$ and $\epsilon_1$ satisfying \autoref{eq:extalg-eq1}. Then
the inference rules
\begin{align*}
& \inference
  { \jfam{{\Gamma}{A}}{Q}
    }
  { \jfameq
      {{{{\Gamma}{A}}{P}}{\jcomp{}{\epsilon_0}{P}}}
      {\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{Q}}}
      {\jcomp{}{\epsilon_1}{\jcomp{}{\epsilon_0}{Q}}}
    }
  \\
& \inference
  { \jfam{{{\Gamma}{A}}{Q}}{R}
    }
  { \jfameq
      {{{{{\Gamma}{A}}{P}}{\jcomp{}{\epsilon_0}{P}}}
        {\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{Q}}}}
      {\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{R}}}
      {\jcomp{}{\epsilon_1}{\jcomp{}{\epsilon_0}{R}}}
    }
  \\
& \inference
  { \jterm{{{\Gamma}{A}}{Q}}{R}{h}
    }
  { \jtermeq
      {{{{{\Gamma}{A}}{P}}{\jcomp{}{\epsilon_0}{P}}}
        {\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{Q}}}}
      {\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{R}}}
      {\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{h}}}
      {\jcomp{}{\epsilon_1}{\jcomp{}{\epsilon_0}{h}}}
    }
\end{align*}
are valid.
\end{lem}

\begin{proof}
We only prove the first inference rule. Let $\jfam{{\Gamma}{A}}{Q}$ be a family.
Then we have the judgmental equalities
\begin{align*}
\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{Q}}
& \jdeq
  \jcomp{}{\idtm{\jcomp{}{\epsilon_0}{P}}}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{Q}}}
  \tag{by \autoref{idfunc-precomp}}
  \\
& \jdeq
  \jcomp{}{\jvcomp{}{\epsilon_0}{\idtm{\jcomp{}{\epsilon_0}{P}}}}{\jcomp{}{\epsilon_0}{Q}}
  \tag{by \autoref{lem:composition-threesome}}
  \\
& \jdeq
  \jcomp{}{\jcomp{}{\jvcomp{}{\epsilon_0}{\idtm{\jcomp{}{\epsilon_0}{P}}}}{\epsilon_0}}{Q}
  \tag{by \autoref{lem:jcomp-jcomp}}
  \\
& \jdeq
  \jcomp{}{\jcomp{}{\jvcomp{}{\idtm{A}}{\epsilon_1}}{\epsilon_0}}{Q}
  \tag{by \autoref{eq:extalg-eq1}}
  \\
& \jdeq
  \jcomp{}{\jvcomp{}{\idtm{A}}{\epsilon_1}}{\jcomp{}{\epsilon_0}{Q}}
  \tag{by \autoref{lem:jcomp-jcomp}}
  \\
& \jdeq
  \jcomp{}{\epsilon_1}{\jcomp{}{\idtm{A}}{\jcomp{}{\epsilon_0}{Q}}}
  \tag{by \autoref{lem:composition-threesome}}
  \\
& \jdeq
  \jcomp{}{\epsilon_1}{\jcomp{}{\epsilon_0}{Q}}.
  \tag{by \autoref{idfunc-precomp}}
\end{align*}
\end{proof}

Now we see that we can use the morphism
\begin{equation*}
\jhom
  {{\Gamma}{A}}
  {{P}{{\jcomp{}{\epsilon_0}{P}}{\jcomp{}{\epsilon_1}{{}{\epsilon_0}{P}}}}}
  {{P}{\jcomp{}{\epsilon_0}{P}}}
  {\jvcomp{}{\epsilon_1}{\idtm{\jcomp{}{\epsilon_1}{{}{\epsilon_0}{P}}}}}.
\end{equation*}
Thus, the second judgmental equality we will need is that the diagram
\begin{equation}\label{eq:extalg-eq2}
\begin{tikzcd}[column sep=huge]
\ctxext{P}{{\jcomp{}{\epsilon_0}{P}}{\jcomp{}{\epsilon_0}{{}{\epsilon_0}{P}}}} 
  \ar{r}{\jvcomp{}{\idtm{P}}{\jcomp{}{\epsilon_0}{\epsilon_1}}}
  \ar{d}[swap]{
    \jvcomp{}{\epsilon_1}{\idtm{\jcomp{}{\epsilon_1}{{}{\epsilon_0}{P}}}}
    }
& \ctxext{P}{\jcomp{}{\epsilon_0}{P}} \ar{d}{\epsilon_1}\\
\ctxext{P}{\jcomp{}{\epsilon_0}{P}} \ar{r}[swap]{\epsilon_1} & P
\end{tikzcd}
\end{equation}
commutes judgmentally. Now we can confidently formulate the definition of
extension algebras.

\begin{defn}
An \emph{extension algebra in context $\Gamma$} is a quadruple $(A,P,\epsilon_0,\epsilon_1)$
consisting of a family $A$ over context $\Gamma$, a family $P$ over the context
$\ctxext{\Gamma}{A}$, a morphism $\epsilon_0$ from $\ctxext{A}{P}$ to $A$ in context
$\Gamma$ and a morphism $\epsilon_1$ from $\ctxext{P}{\jcomp{}{\epsilon_0}{P}}$ to $P$ in context
$\ctxext{\Gamma}{A}$, satisfying the judgmental equalities of
\autoref{eq:extalg-eq1,eq:extalg-eq2}.
\end{defn}

We also give a bit of intuition to the requirement of \autoref{eq:extalg-eq2} by
means of the following lemma.

\begin{lem}
Let $(A,P,\epsilon_0,\epsilon_1)$ be an extension algebra in context $\Gamma$ and let
$y_0:P$, $y_1:\subst{y_0}{\jcomp{}{\epsilon_0}{P}}$ and 
$y_2:\subst{y_1}{{y_0}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}}$. Then we have the
judgmental equality
\begin{equation*}
\subst{{y_2}{{y_1}{\jcomp{}{\epsilon_0}{\epsilon_1}}}}{{y_0}{\epsilon_1}}
  \jdeq
  \subst{y_2}{{{y_1}{{y_0}{\epsilon_1}}}{\epsilon_1}}
\end{equation*}
\end{lem}

\begin{proof}
The proof is a straightforward calculation:
\begin{align*}
\subst{{y_2}{{y_1}{\jcomp{}{\epsilon_0}{\epsilon_1}}}}{{y_0}{\epsilon_1}}
& \jdeq
  \subst{\tmext{y_0}{\subst{y_2}{{y_1}{\jcomp{}{\epsilon_0}{\epsilon_1}}}}}{\epsilon_1}
  \\
& \jdeq
  \subst{{y_2}{{y_1}{{y_0}{\jvcomp{}{\idtm{P}}{\jcomp{}{\epsilon_0}{\epsilon_1}}}}}}{\epsilon_1}
  \\
& \jdeq
  \subst
    {y_2}
    { {y_1}
      { {y_0}
        {\jcomp{}{\jvcomp{}{\idtm{P}}{\jcomp{}{\epsilon_0}{\epsilon_1}}}{\epsilon_1}}
        }
      }
  \\
& \jdeq
  \subst
    {y_2}
    { {y_1}
      { {y_0}
        {\jcomp{}{\jvcomp{}{\epsilon_1}{\idtm{\jcomp{}{\epsilon_1}{{}{\epsilon_0}{P}}}}}{\epsilon_1}}
        }
      }
  \\
& \jdeq
  \subst{{y_2}{{y_1}{{y_0}{\jvcomp{}{\epsilon_1}{\idtm{\jcomp{}{\epsilon_1}{{}{\epsilon_0}{P}}}}}}}}{\epsilon_1}
  \\
& \jdeq
  \subst{\tmext{\subst{y_1}{{y_0}{\epsilon_1}}}{y_2}}{\epsilon_1}
  \\
& \jdeq
  \subst{y_2}{{{y_1}{{y_0}{\epsilon_1}}}{\epsilon_1}}.\qedhere
\end{align*}
\end{proof}

There is a trivial class of examples of extension algebras we can give right
away. More examples will be introduced by universes, later on.

\begin{eg}
Let $A$ be a family in context $\Gamma$. Then the quadruple
\begin{equation*}
(A,\emptyf,\idtm{A},\emptytm)
\end{equation*}
is an extension algebra in context $\Gamma$, as is the quadruple
\begin{equation*}
(\emptyf,A,\emptytm,\idtm{A}).
\end{equation*}
Also, the quadruple
\begin{equation*}
(A,\ctxwk{A}{A},\cprojfstf{A}{\ctxwk{A}{A}},\cprojfstf{\ctxwk{A}}{\ctxwk{A}{{A}{A}}})
\end{equation*}
is an extension algebra in context $\Gamma$.
\end{eg}

The following lemma explains how each extension algebra gives rise to infinitely
many extension algebras.

\begin{thm}
Suppose that $(A,P,\epsilon_0,\epsilon_1)$ is an extension algebra in context
$\Gamma$. Then 
$(P,\jcomp{}{\epsilon_0}{P},\epsilon_1,\jcomp{}{\epsilon_0}{\epsilon_1})$
is an extension algebra in context $\ctxext{\Gamma}{A}$.
\end{thm}

\begin{proof}
We first need to verify that $\jcomp{}{\epsilon_0}{\epsilon_1}$ is a morphism
from $\ctxext{\jcomp{}{\epsilon_0}{P}}{\jcomp{}{\epsilon_1}{{}{\epsilon_0}{P}}}$
to $\jcomp{}{\epsilon_0}{P}$. This follows from the judgmental equality
$\jcomp{}{\epsilon_1}{{}{\epsilon_0}{P}}\jdeq
\jcomp{}{\epsilon_0}{{}{\epsilon_0}{P}}$, which we have proved in
\autoref{lem:extalg-twins}. Notice how the diagram in \autoref{eq:extalg-eq2} is
of exactly the right sort, so the quadruple
$(P,\jcomp{}{\epsilon_0}{P},\epsilon_1,\jcomp{}{\epsilon_0}{\epsilon_1})$
satisfies its version of \autoref{eq:extalg-eq1}. It is left to verify that the diagram
\begin{small}
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\ctxext
  { \jcomp{}{\epsilon_0}{P}
    }
  { { \jcomp{}{\epsilon_1}{%
        \jcomp{}{\epsilon_0}{P}
        }
      }
    { \jcomp{}{\epsilon_1}{%
        \jcomp{}{\epsilon_1}{%
          \jcomp{}{\epsilon_0}{P}
          }
        }
      }
    } 
  \ar{r}
    { \jvcomp{}{\idtm{\jcomp{}{\epsilon_0}{P}}}{%
        \jcomp{}{\epsilon_1}{%
          \jcomp{}{\epsilon_0}{\epsilon_1}}}}
  \ar{d}[swap]{
    \jvcomp{}{\jcomp{}{\epsilon_0}{\epsilon_1}}{%
      \idtm{
        \jcomp{}{\jcomp{}{\epsilon_0}{\epsilon_1}}{%
          \jcomp{}{\epsilon_1}{%
            \jcomp{}{\epsilon_0}{P}
            }
          }
        }
      }
    }
& \ctxext
    {\jcomp{}{\epsilon_0}{P}}
    {\jcomp{}{\epsilon_1}{\jcomp{}{\epsilon_0}{P}}} 
  \ar{d}{\jcomp{}{\epsilon_0}{\epsilon_1}}
  \\
\ctxext
  {\jcomp{}{\epsilon_0}{P}}
  {\jcomp{}{\epsilon_1}{\jcomp{}{\epsilon_0}{P}}} 
  \ar{r}[swap]{\jcomp{}{\epsilon_0}{\epsilon_1}} 
& \jcomp{}{\epsilon_0}{P}
\end{tikzcd}
\end{equation*}
\end{small}
commutes judgmentally; this diagram is the version of \autoref{eq:extalg-eq2}
for the quadruple
$(P,\jcomp{}{\epsilon_0}{P},\epsilon_1,\jcomp{}{\epsilon_0}{\epsilon_1})$. Note
that this follows from \autoref{eq:extalg-eq2} provided that we can show that
\begin{align}
\jvcomp{}{\idtm{\jcomp{}{\epsilon_0}{P}}}{%
  \jcomp{}{\epsilon_1}{%
    \jcomp{}{\epsilon_0}{\epsilon_1}}}
& \jdeq
  \jcomp{}{\epsilon_0}{%
    \jvcomp{}{\idtm{P}}{\jcomp{}{\epsilon_0}{\epsilon_1}}
    }
  \label{eq:extalg-infty1}
  \\
\jvcomp{}{\jcomp{}{\epsilon_0}{\epsilon_1}}{%
  \idtm{
    \jcomp{}{\jcomp{}{\epsilon_0}{\epsilon_1}}{%
      \jcomp{}{\epsilon_1}{%
        \jcomp{}{\epsilon_0}{P}
        }
      }
    }
  }
& \jdeq
\jcomp{}{\epsilon_0}{%
  \jvcomp{}{\epsilon_1}{%
    \idtm{
      \jcomp{}{\epsilon_1}{%
        \jcomp{}{\epsilon_0}{P}
        }
      }
    }
  }
  \label{eq:extalg-infty2}
\end{align}
Note that \autoref{eq:extalg-infty1} follows if we can show that
\begin{equation*}
\jcomp{}{\epsilon_1}{\jcomp{}{\epsilon_0}{\epsilon_1}}
  \jdeq
  \jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{\epsilon_1}}.
\end{equation*}
This is a special case of \autoref{lem:extalg-twins}. The second judgmental
equality, \autoref{eq:extalg-infty2}, is trivial.
\end{proof}

\begin{thm}
Let $(Q,R,\eta_0,\eta_1)$ be an extension algebra in context $\ctxext{\Gamma}{B}$ and let
$\jfam{\Gamma}{A}$. Then the quadruple
\begin{equation*}
(\ctxwk{A}{Q},\ctxwk{A}{R},\ctxwk{A}{\eta_0},\ctxwk{A}{\eta_1})
\end{equation*}
is an extension algebra in context $\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}$.
\end{thm}

\begin{proof}
The proof follows from the fact that weakening by $A$ is compatible with all
the involved operations.
\end{proof}

\begin{thm}
Let $(Q,R,\eta_0,\eta_1)$ be an extension algebra in context $\ctxext{{\Gamma}{A}}{P}$
and let $\jterm{\Gamma}{A}{x}$. Then the quadruple
\begin{equation*}
(\subst{x}{Q},\subst{x}{R},\subst{x}{\eta_0},\subst{x}{\eta_1})
\end{equation*}
is an extension algebra in context $\ctxext{\Gamma}{\subst{x}{P}}$.
\end{thm}

\begin{proof}
The proof follows from the fact that substitution with $x$ is compatible with
all the involved operations.
\end{proof}

\begin{cor}
Let $(Q,R,\eta_0,\eta_1)$ be an extension algebra in context $\ctxext{\Gamma}{B}$
and let $\jhom{\Gamma}{A}{B}{f}$. Then the quadruple
\begin{equation*}
(\jcomp{A}{f}{Q},\jcomp{A}{f}{R},\jcomp{A}{f}{\eta_0},\jcomp{A}{f}{\eta_1})
\end{equation*}
is an extension algebra in context $\ctxext{\Gamma}{A}$.
\end{cor}

\begin{defn}
An \emph{extension homomorphism} from $(A,P,\epsilon_0,\epsilon_1)$ to
$(B,Q,\eta_0,\eta_1)$ in context $\Gamma$ is a pair $(f_0,f_1)$ consisting of
\begin{align*}
\jhom*{\Gamma}{A}{B}{f_0}
  \\
\jfhom*{\Gamma}{A}{B}{f_0}{P}{Q}{f_1}
\end{align*}
for which the diagrams
\begin{equation}\label{eq:extalg-hom1}
\begin{tikzcd}
\ctxext{A}{P}
  \ar{r}{\jvcomp{}{f_0}{f_1}}
  \ar{d}[swap]{\epsilon_0}
& \ctxext{B}{Q}
  \ar{d}{\eta_0}
  \\
A
  \ar{r}[swap]{f_0}
& B
\end{tikzcd}
\end{equation}
and
\begin{equation}\label{eq:extalg-hom2}
\begin{tikzcd}[column sep=large]
\ctxext{P}{\jcomp{}{\epsilon_0}{P}}
  \ar{r}{\jvcomp{}{f_1}{\jcomp{}{\epsilon_0}{f_1}}}
  \ar{d}[swap]{\epsilon_1}
& \jcomp{}{f_0}{\ctxext{Q}{\jcomp{}{\eta_0}{Q}}}
  \ar{d}{\jcomp{}{f_0}{\eta_1}}
  \\
P
  \ar{r}[swap]{f_1}
& \jcomp{}{f_0}{Q}
\end{tikzcd}
\end{equation}
commute judgmentally.
\end{defn}

\begin{rmk}
To see that the upper morphism in the diagram of \autoref{eq:extalg-hom2} has
indeed the indicated codomain provided that the diagram of \autoref{eq:extalg-hom1}
commutes judgmentally, note that we have the judgmental equalities
\begin{align*}
\jcomp{}{f_1}{\jcomp{}{f_0}{\jcomp{}{\eta_0}{Q}}}
& \jdeq 
  \jcomp{}{\jvcomp{}{f_0}{f_1}}{\jcomp{}{\eta_0}{Q}}
  \tag{by \autoref{lem:composition-threesome}}
  \\
& \jdeq
  \jcomp{}{\jcomp{}{\jvcomp{}{f_0}{f_1}}{\eta_0}}{Q}
  \tag{by \autoref{lem:jcomp-jcomp}}
  \\
& \jdeq
  \jcomp{}{\jcomp{}{\epsilon_0}{f_0}}{Q}
  \tag{by \autoref{eq:extalg-hom1}}
  \\
& \jdeq
  \jcomp{}{\epsilon_0}{\jcomp{}{f_0}{Q}}.
  \tag{by \autoref{lem:jcomp-jcomp}}
\end{align*}
and we indeed have the morphism $\jcomp{}{\epsilon_0}{f_1}$ from 
$\jcomp{}{\epsilon_0}{P}$ to $\jcomp{}{\epsilon_0}{\jcomp{}{f_0}{Q}}$.
\end{rmk}

\begin{rmk}
I suspect that if we copy this theory of extension algebras to Martin-L\"of
type theory, with the judgmental equalities replaced by identifications, with
dependent pair types rather than those strict extensions, etcetera, then
the type of $f_1$ for which these two diagrams commute is a mere proposition.

With this notion of morphism, a term of an extension
algebra $(A,P,\epsilon_0,\epsilon_1)$ is a pair $(x_0,x_1)$ such that
$\subst{x_1}{{x_0}{\epsilon_0}}\jdeq x_0$.
\end{rmk}

\begin{comment}
Extension algebras don't come in isolation. There are also extension algebra
families and extension algebra terms. We now aim to define these and to
establish various constructions of new extension algebras out of old ones:
the empty extension algebra, and extensions, weakenings and substitutions
of extension algebras and of course the identity term as an extension algebra
term. We start with extension algebra families.

\begin{defn}
Consider an extension algebra $\mathcal{A}\defeq(A,P,e,f)$. 
An extension algebra family over $\mathcal{A}$ is likewise a quadruple
$\mathcal{B}\defeq(B,Q,g,h)$. Here we have a family $\jfam{{\Gamma}{A}}{B}$, a
family $\jfam{{{{\Gamma}{A}}{P}}{\ctxwk{P}{B}}}{Q}$ and
\begin{align*}
\jhom*{{{\Gamma}{A}}{P}}{\ctxext{\ctxwk{P}{B}}{Q}}{\jcomp{}{\epsilon_0}{B}}{g}\\
\jhom*{{{{\Gamma}{A}}{P}}{\ctxwk{P}{B}}}{\ctxext{Q}{\jcomp{}{g}{Q}}}{Q}{h}.
\end{align*}
The quadruple $(\jcomp{}{\epsilon_0}{B},Q,g,h)$ is required to be an extension algebra
in context $\ctxext{{\Gamma}{A}}{P}$.
\end{defn}

\begin{defn}
Suppose $\mathcal{A}$ is an extension algebra and $\mathcal{B}$ is an extension
algebra family over $\mathcal{A}$. A term of $\mathcal{B}$ is a pair $(x,y)$
consisting of
\begin{align*}
\jterm*{{\Gamma}{A}}{B}{x}\\
\jterm*{{{\Gamma}{A}}{P}}{\subst{\jcomp{}{\epsilon_0}{x}}{Q}}{y}
\end{align*}
such that the diagrams
\begin{equation*}
\begin{tikzcd}
\ctxext{\jcomp{}{\epsilon_0}{B}}{Q} 
  \ar{r}{g} 
  \ar[shift right=.7ex,fib]{d}
& B 
  \ar[shift right=.7ex,fib]{d} 
  \\
\ctxext{A}{P} 
  \ar[shift right=.7ex,dotted]{u}[swap]{\tmext{\jcomp{}{\epsilon_0}{x}}{y}}
  \ar{r}{e}
& A
  \ar[shift right=.7ex,dotted]{u}[swap]{x}
\end{tikzcd}
\end{equation*}
and
\begin{equation*}
\begin{tikzcd}
\jcomp{}{f}{\ctxext{Q}{\jcomp{}{g}{Q}}}
  \ar{r}{\jcomp{}{f}{h}}
  \ar[shift right=.7ex,fib]{d}
& Q
  \ar[shift right=.7ex,fib]{d}
  \\
\jcomp{}{f}{\jcomp{}{\epsilon_0}{B}}
  \ar{r}{\idtm{\jcomp{}{f}{\jcomp{}{\epsilon_0}{B}}}}
  \ar[shift right=.7ex,fib]{d}
  \ar[shift right=.7ex,dotted,mapsto]{u}[swap]{\jcomp{}{f}{y}}
& \jcomp{}{\epsilon_0}{B}
  \ar[shift right=.7ex,fib]{d}
  \ar[shift right=.7ex,dotted,mapsto]{u}[swap]{y}
  \\
\ctxext{P}{\jcomp{}{\epsilon_0}{P}}
  \ar{r}[swap]{f}
  \ar[shift right=.7ex,dotted]{u}[swap]{\jcomp{}{f}{\jcomp{}{\epsilon_0}{x}}}
& P
  \ar[shift right=.7ex,dotted]{u}[swap]{\jcomp{}{\epsilon_0}{x}}
\end{tikzcd}
\end{equation*}
commute.
\end{defn}

\begin{defn}
Suppose $\mathcal{A}$ and $\mathcal{B}$ are extension algebras in context
$\Gamma$. We define the extension algebra $\ctxwk{\mathcal{A}}{\mathcal{B}}$
to be the quadruple
\begin{equation*}
(\ctxwk{A}{B},\ctxwk{\ctxext{A}{P}}{Q},\ctxwk{\ctxext{A}{P}}{g},\ctxwk{\ctxext{A}{P}}{h}).
\end{equation*}
Note that $\ctxwk{\ctxext{A}{P}}{Q}$ is a family over $\ctxwk{\ctxext{A}{P}}{B}$,
whereas it should be a family over $\jcomp{}{\epsilon_0}{\ctxwk{A}{B}}$. These are the
same by \autoref{lem:prehom}.
\end{defn}

\begin{rmk}
Before we continue, let us explore what it means to be an extension algebra
term of the extension algebra $\ctxwk{\mathcal{A}}{\mathcal{B}}$. Such an
extension algebra term $(x,y)$ would consist of
\begin{align*}
\jterm*{{\Gamma}{A}}{\ctxwk{A}{B}}{x}\\
\jterm*{{{\Gamma}{A}}{P}}{\subst{\jcomp{}{\epsilon_0}{x}}{\ctxwk{\ctxext{A}{P}}{Q}}}{y}.
\end{align*}
Thus, $x$ is a context morphism from $A$ to $B$ and $y$ is nothing but a term
of $\jcomp{}{\jcomp{}{\epsilon_0}{x}}{Q}$. For $x$, we see that the diagram
\begin{equation*}
\begin{tikzcd}
\ctxext{B}{Q} 
  \ar{r}{g} 
& B 
  \\
\ctxext{A}{P} 
  \ar{u}{\jvcomp{}{x}{y}}
  \ar{r}{e}
& A
  \ar{u}[swap]{x}
\end{tikzcd}
\end{equation*}
commutes.
\end{rmk}
\end{comment}

\subsection{Extension-empty algebras}
\begin{defn}
Let $P$ be a family over the extended context $\ctxext{\Gamma}{A}$, let
$\jterm{\Gamma}{A}{\phi_0}$ and $\jterm{{\Gamma}{A}}{P}{\phi_1}$ be terms. Then the
quadruple $(A,P,\phi_0,\phi_1)$ is said to be an \emph{empty algebra in context $\Gamma$}
if the following judgmental equalities hold:
\begin{align}
\jfameq*{\Gamma}{\subst{\phi_0}{P}}{A}
  \label{empalg-eq1}
  \\
\jtermeq*{\Gamma}{A}{\subst{\phi_0}{\phi_1}}{\phi_0}.
  \label{empalg-eq2}
\end{align}
\end{defn}

\begin{defn}
Let $(A,P,\phi_0,\phi_1)$ and $(B,Q,\psi_0,\psi_1)$ be empty algebras in context
$\Gamma$. An empty homomorphism from $(A,P,\phi_0,\phi_1)$ to $(B,Q,\psi_0,\psi_1)$
is a pair $(f_0,f_1)$ consisting of
\begin{align*}
\jhom*{\Gamma}{A}{B}{f_0}\\
\jfhom*{\Gamma}{A}{B}{f}{P}{Q}{f_1}
\end{align*}
satisfying the judgmental equalities
\begin{align*}
\jtermeq*{\Gamma}{B}{\subst{\phi_0}{f_0}}{\psi_0}\\
\jhomeq*{\Gamma}{A}{B}{\subst{\phi_0}{f_1}}{f_0}\\
\jtermeq*{{\Gamma}{A}}{\jcomp{}{f_0}{Q}}{\subst{\phi_1}{f_1}}{\jcomp{}{f_0}{\psi_1}}.
\end{align*}
\end{defn}

Thus, the empty algebras are the kind of algebras that require that families
are compatible with contexts, just as our motivation in \autoref{empty}. We
now combine the notion of extension algebras and empty algebras.

An extension-empty algebra in context $\Gamma$ is going to be a sextuple
$(A,P,\epsilon_0,\epsilon_1,\phi_0,\phi_1)$ for which 
the quadruple $(A,P,\epsilon_0,\epsilon_1)$ is an extension algebra in context 
$\Gamma$, the quadruple $(A,P,\phi_0,\phi_1)$ is an empty algebra in context
$\Gamma$, satisfying additional judgmental equalities expressing the 
compatibility of $\epsilon_0$ and $\epsilon_1$ with $\phi_0$ and $\phi_1$.
There will be four such judgmental equalities.

We can immediately state the first two:
\begin{align}
\jtermeq*{{\Gamma}{A}}{\ctxwk{A}{A}}{\subst{\phi_0}{\epsilon_0}}{\idtm{A}}
  \label{extempalg-eq1}
  \\
\jtermeq*{{\Gamma}{A}}{\ctxwk{A}{A}}{\subst{\phi_1}{\epsilon_0}}{\idtm{A}}
  \label{extempalg-eq2}
\end{align}
To see what $\subst{\phi_0}{\epsilon_1}$ can be, we must know its type first.
It is a morphism from $\subst{\phi_0}{\ctxext{P}{\jcomp{}{\epsilon_0}{P}}}$ to
$\subst{\phi_0}{P}$. We already know that $\subst{\phi_0}{P}\jdeq A$ by
\autoref{empalg-eq1} and to compute $\subst{\phi_0}{\jcomp{}{\epsilon_0}{P}}$
we use the following lemma.

\begin{lem}\label{lem:empalg-mor}
Consider an empty algebra $(A,P,\phi_0,\phi_1)$ in context $\Gamma$
and a morphism $\jhom{\Gamma}{{A}{P}}{B}{f}$.
Then $\subst{\phi_i}{f}$ is a morphism from $A$ to $B$ in context $\Gamma$ and
the following inference rules are valid for $i$ being $0$ or $1$:
\begin{align*}
& \inference
  { \jfam{{\Gamma}{A}}{Q}
    }
  { \jfameq
      {{\Gamma}{A}}
      {\subst{\phi_i}{\jcomp{}{f}{Q}}}
      {\jcomp{}{\subst{\phi_i}{f}}{Q}}
    }
  \\
& \inference
  { \jfam{{{\Gamma}{A}}{Q}}{R}
    }
  { \jfameq
      {{{\Gamma}{A}}{\jcomp{}{\subst{\phi_i}{f}}{Q}}}
      {\subst{\phi_i}{\jcomp{}{f}{R}}}
      {\jcomp{}{\subst{\phi_i}{f}}{R}}
    }
  \\
& \inference
  { \jterm{{{\Gamma}{A}}{Q}}{R}{h}
    }
  { \jtermeq
      {{{\Gamma}{A}}{\jcomp{}{\subst{\phi_i}{f}}{Q}}}
      {\jcomp{}{\subst{\phi_i}{f}}{R}}
      {\subst{\phi_i}{\jcomp{}{f}{h}}}
      {\jcomp{}{\subst{\phi_i}{f}}{h}}
    }
\end{align*}
\end{lem}

\begin{proof}
We only prove the first inference rule in both cases.
Let $Q$ be a family over $\ctxext{\Gamma}{A}$. In the case $i=0$
 we have the judgmental equalities
\begin{align*}
\subst{\phi_0}{\jcomp{}{f}{Q}}
& \jdeq
  \subst{\phi_0}{{f}{\ctxwk{\ctxext{A}{P}}{Q}}}
  \tag{by definition}
  \\
& \jdeq
  \subst{{\phi_0}{f}}{{\phi_0}{\ctxwk{\ctxext{A}{P}}{Q}}}
  \tag{by \autoref{comp-ss-f}}
  \\
& \jdeq
  \subst{{\phi_0}{f}}{{\phi_0}{\ctxwk{P}{{A}{Q}}}}
  \tag{by \autoref{comp-ew-f}}
  \\
& \jdeq
  \subst{{\phi_0}{f}}{\ctxwk{\subst{\phi_0}{P}}{\subst{\phi_0}{\ctxwk{A}{Q}}}}
  \tag{by \autoref{comp-sw-f}}
  \\
& \jdeq
  \subst{{\phi_0}{f}}{\ctxwk{\subst{\phi_0}{P}}{Q}}
  \tag{by \autoref{cancellation-ws-f}}
  \\
& \jdeq
  \subst{{\phi_0}{f}}{\ctxwk{A}{Q}}
  \tag{by \autoref{empalg-eq1}}
  \\
& \jdeq
  \jcomp{}{\subst{\phi_0}{f}}{Q}.
  \tag{by definition}
\end{align*}
In the case $i=1$ we have the judgmental equalities
\begin{align*}
\subst{\phi_1}{\jcomp{}{f}{Q}}
& \jdeq
  \subst{\phi_1}{{f}{\ctxwk{\ctxext{A}{P}}{Q}}}
  \tag{by definition}
  \\
& \jdeq
  \subst{{\phi_1}{f}}{{\phi_1}{\ctxwk{\ctxext{A}{P}}{Q}}}
  \tag{by \autoref{comp-ss-f}}
  \\
& \jdeq
  \subst{{\phi_1}{f}}{{\phi_1}{\ctxwk{P}{{A}{Q}}}}
  \tag{by \autoref{comp-ew-f}}
  \\
& \jdeq
  \subst{{\phi_1}{f}}{\ctxwk{A}{Q}}
  \tag{by \autoref{cancellation-ws-f}}
  \\
& \jdeq
  \jcomp{}{\subst{\phi_1}{f}}{Q}.
  \tag{by definition}
\end{align*}
\end{proof}

As an immediate corollary, if we assume the judgmental equalities
\autoref{extempalg-eq1,extempalg-eq2} we get that 
\begin{equation}\label{cor:empalg-mor}
\jfameq{{\Gamma}{A}}{\subst{\phi_i}{\jcomp{}{\epsilon_0}{P}}}{P}
\end{equation}
and hence that $\subst{\phi_0}{\epsilon_1}$ is a 
morphism from $\ctxext{A}{P}$ to $A$. Thus, we can require
\begin{equation}\label{extempalg-eq3}
\jhomeq{\Gamma}{{A}{P}}{A}{\subst{\phi_0}{\epsilon_1}}{\epsilon_0}.
\end{equation}
For the final judgmental equality we need to explain the term
\begin{equation*}
\jterm
  {{{\Gamma}{A}}{\subst{\phi_1}{\jcomp{}{\epsilon_0}{P}}}}
  {\subst{\phi_1}{\ctxwk{\ctxext{P}{\jcomp{}{\epsilon_0}{P}}}{P}}}
  {\subst{\phi_1}{\epsilon_1}}.
\end{equation*}
We have already established that $\subst{\phi_1}{\jcomp{}{\epsilon_0}{P}}\jdeq
P$. We also see that 
\begin{align*}
\subst{\phi_1}{\ctxwk{\ctxext{P}{\jcomp{}{\epsilon_0}{P}}}{P}}
& \jdeq
  \subst{\phi_1}{\ctxwk{\jcomp{}{\epsilon_0}{P}}{{P}{P}}}
  \tag{by \autoref{comp-ew-f}}
  \\
& \jdeq
  \ctxwk{\subst{\phi_1}{\jcomp{}{\epsilon_0}{P}}}{\subst{\phi_1}{\ctxwk{P}{P}}}
  \tag{by \autoref{comp-sw-f}}
  \\
& \jdeq
  \ctxwk{P}{\subst{\phi_1}{\ctxwk{P}{P}}}
  \tag{by \autoref{cor:empalg-mor}}
  \\
& \jdeq
  \ctxwk{P}{P}
  \tag{by \autoref{cancellation-ws-f}}
\end{align*}
and we will therefore require that
\begin{equation}\label{extempalg-eq4}
\jtermeq{{{\Gamma}{A}}{P}}{\ctxwk{P}{P}}{\subst{\phi_1}{\epsilon_1}}{\idtm{P}}.
\end{equation}
We bring all this together in the definition of extension-empty algebras:

\begin{defn}
An \emph{extension-empty algebra in context $\Gamma$} 
is a sextuple $(A,P,\epsilon_0,\epsilon_1,\phi_0,\phi_1)$ for which 
the quadruple $(A,P,\epsilon_0,\epsilon_1)$ is an extension algebra in context 
$\Gamma$, the quadruple $(A,P,\phi_0,\phi_1)$ is an empty algebra in context
$\Gamma$, satisfying the judgmental equalities 
\autoref{extempalg-eq1,extempalg-eq2,extempalg-eq3,extempalg-eq4}.
\end{defn}

\begin{thm}
Let $(A,P,\epsilon_0,\epsilon_1,\phi_0,\phi_1)$ be an extension-empty algebra
in context $\Gamma$. Then the sextuple
\begin{equation*}
(P,\jcomp{}{\epsilon_0}{P},\epsilon_1,\jcomp{}{\epsilon_0}{\epsilon_1},\phi_1,
\jcomp{}{\epsilon_0}{\phi_1})
\end{equation*}
is an extension-empty algebra in context $\ctxext{\Gamma}{A}$. 
\end{thm}

\begin{proof}
We first check whether the quadruple $(P,\jcomp{}{\epsilon_0}{P},\phi_1,\jcomp{}{\epsilon_0}{\phi_1})$
is an empty algebra in context $\ctxext{\Gamma}{A}$. Thus we need to verify
that $\subst{\phi_1}{\jcomp{}{\epsilon_0}{P}}\jdeq P$ and that
$\subst{\phi_1}{\jcomp{}{\epsilon_0}{\phi_1}}\jdeq\phi_1$. Both these judgmental
equalities follow from \autoref{lem:empalg-mor}.

To complete the proof, we need to verify that
\autoref{extempalg-eq1,extempalg-eq2,extempalg-eq3,extempalg-eq4} hold in our
current setting.
\end{proof}

\subsection{Term-algebras and term-operations}
Until now we had no need to consider term-algebras. Extension is an operation
letting contexts and families interact and the empty object is a term which
requires that contexts and families are compatible. However, to model the
theory of contexts, families and terms we do need to take terms into account.

\begin{defn}
A term-algebra in context $\Gamma$ is a septuple 
$(A,P,T,\epsilon_0,\epsilon_1,\phi_0,\phi_1)$ such that the quadruple
$(A,P,\epsilon_0,\epsilon_1)$ is an extension algebra in context $\Gamma$, 
the quadruple $(A,P,\phi_0,\phi_1)$ is an empty algebra in context $\Gamma$,
for which we additionally have the following judgmental equality:
\begin{align*}
\jfameq*{{\Gamma}{A}}{\subst{\phi_1}{T}}{\emptyf}.
\end{align*}
\end{defn}

\begin{thm}
Let $\mathcal{A}\defeq(A,P,T,\epsilon_0,\epsilon_1,\phi_0,\phi_1)$ be a term-algebra in context
$\Gamma$. Then the septuple
\begin{equation*}
(P,\jcomp{}{\epsilon_0}{P},\jcomp{}{\epsilon_0}{T},\epsilon_1,\jcomp{}{\epsilon_0}{\epsilon_1},\phi_1,\jcomp{}{\epsilon_0}{\phi_1})
\end{equation*}
is a term-algebra in context $\ctxext{\Gamma}{A}$, called the family term-algebra
of $\mathcal{A}$.
\end{thm}

\begin{thm}
Let $\mathcal{A}\defeq(A,P,T,\epsilon_0,\epsilon_1,\phi_0,\phi_1)$ be a term-algebra in context
$\Gamma$ and let $X$ be a family in context $\Gamma$. Then
\begin{equation*}
\ctxwk{X}{\mathcal{A}}\defeq(\ctxwk{X}{A},\ctxwk{X}{P},\ctxwk{X}{T},\ctxwk{X}{\epsilon_0},\ctxwk{X}{\epsilon_1},\ctxwk{X}{\phi_0},\ctxwk{X}{\phi_1})
\end{equation*}
is a term-algebra in context $\ctxext{\Gamma}{X}$.
\end{thm}

\begin{thm}
Let $\mathcal{A}\defeq(A,P,T,\epsilon_0,\epsilon_1,\phi_0,\phi_1)$ be a term-algebra in context
$\ctxext{\Gamma}{X}$ and let $\jterm{\Gamma}{X}{x}$. Then
\begin{equation*}
\subst{x}{\mathcal{A}}\defeq
(\subst{x}{A},\subst{x}{P},\subst{x}{T},\subst{x}{\epsilon_0},\subst{x}{\epsilon_1},
\subst{x}{\phi_0},\subst{x}{\phi_1})
\end{equation*}
is a term-algebra in context $\Gamma$.
\end{thm}

\begin{defn}
Let $\mathcal{A}$ and $\mathcal{B}$ be term-algebras in context $\Gamma$. 
A term-operation from $\mathcal{A}$ to $\mathcal{B}$ is a triple $(f_0,f_1,f_2)$
consisting of
\begin{align*}
\jhom*{\Gamma}{A}{B}{f_0}
  \\
\jfhom*{\Gamma}{A}{B}{f_0}{P}{Q}{f_1}
  \\
\jfhom*{\Gamma}{{A}{P}}{{B}{Q}}{\jvcomp{P}{f_0}{f_1}}{T}{U}{f_2}
\end{align*}
such that the pair $(f_0,f_1)$ is both an extension homomorphism from
$(A,P,\epsilon_0,\epsilon_1)$ to $(B,Q,\eta_0,\eta_1)$ in context $\Gamma$
and an empty homomorphism from $(A,P,\phi_0,\phi_1)$ to $(B,Q,\psi_0,\psi_1)$
in context $\Gamma$.
\end{defn}

\subsection{Weakening term-algebras}
Weakening term-algebras will be term-algebras with certain added structure.
Although strictly speaking one could formulate a notion of weakening algebra
which only depends on extension algebras and which omits both empty objects
and terms, we shall not do so here. 

Let $(A,P,T,\epsilon_0,\epsilon_1,\phi_0,\phi_1)$ be a term-algebra in context
$\Gamma$. 

An extension-weakening algebra in context $\Gamma$ will be an octuple
\begin{equation*}
(A,P,\epsilon_0,\epsilon_1,\phi_0,\phi_1,\omega_0,\omega_1)
\end{equation*}
where $(A,P,\epsilon_0,\epsilon_1,\phi_0,\phi_1)$ is an extension-empty algebra
in context $\Gamma$ and where
\begin{align*}
\jhom*
  {{{\Gamma}{A}}{P}}
  {\ctxwk{P}{P}}
  {\jcomp{}{\epsilon_0}{P}}
  {\omega_0}
  \\
\jfhom*
  {{{\Gamma}{A}}{P}}
  {\ctxwk{P}{P}}
  {\jcomp{}{\epsilon_0}{P}}
  {\omega_0}
  {\ctxwk{P}{\jcomp{}{\epsilon_0}{P}}}
  {\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}
  {\omega_1}
\end{align*}
such that $(\omega_0,\omega_1)$ is both an extension homomorphism
\begin{equation*}
\begin{tikzcd}[column sep=large]
\ctxwk{P}{(P,
  \jcomp{}{\epsilon_0}{P},
  \epsilon_1,
  \jcomp{}{\epsilon_0}{\epsilon_1})}
\ar{r}{(\omega_0,\omega_1)}
& \jcomp{}{\epsilon_0}{(P,
  \jcomp{}{\epsilon_0}{P},
  \epsilon_1,
  \jcomp{}{\epsilon_0}{\epsilon_1})}
\end{tikzcd}
\end{equation*}
and an empty homomorphism

satisfying five(?) additional judgmental equalities expressing that $\omega_0$
and $\omega_1$ are compatible with $\epsilon_1$, $\phi_1$
and with each other. Our current goal is to figure out what these are. 

Before we go into that, we develop a bit of intuition by explaining how
$\omega_0$ and $\omega_1$ act when applied to a family $x_1:\subst{x_0}{P}$
over $x_0:A$. Note that
\begin{equation*}
\jterm{{\Gamma}{\subst{x_0}{P}}}{\subst{{x_1}{{x_0}{\epsilon_0}}}{P}}{\subst{x_1}{{x_0}{\omega_0}}},
\end{equation*}
so $\subst{x_1}{{x_0}{\omega_0}}$ takes families over $x_0$ to families over
the extended $\subst{x_1}{{x_0}{\epsilon_0}}$.

To compute the type of $\subst{x_2}{{x_1}{{x_0}{\omega_1}}}$ for families
$x_1,x_2:\subst{x_0}{P}$ over $x_0:A$ we have to do a
bit more work. Note that
\begin{align*}
& \subst{x_2}{{x_1}{{x_0}{\jcomp{}{\omega_0}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}}}}
  \\
& \jdeq
  \subst{x_2}{{x_1}{{x_0}{\unfold{\jcomp{\ctxwk{P}{P}}{\omega_0}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}}}}}
  \tag{by definition}
  \\
& \jdeq
  \subst
    { {x_2}
      { {x_1}
        { {x_0}
          {\omega_0}
          }
        }
      }
    { {x_2}
      { {x_1}
        { {x_0}
          {\ctxwk{{P}{P}}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}}
          }
        }
      }
  \tag{by \autoref{comp-ss-f}}
  \\
& \jdeq
  \subst
    { {x_2}
      { {x_1}
        { {x_0}
          {\omega_0}
          }
        }
      }
    { {x_2}
      { \ctxwk
          {\subst{x_1}{\ctxwk{\subst{x_0}{P}}{\subst{x_0}{P}}}}
          {\subst{x_1}{{x_0}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}}}
        }
      }
  \tag{by \autoref{comp-sw-f}}
  \\
& \jdeq
  \subst
    { {x_2}
      { {x_1}
        { {x_0}
          {\omega_0}
          }
        }
      }
    { {x_1}
      { {x_0}
        {\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}
        }
      }
  \tag{by \autoref{cancellation-ws-f}}
  \\
& \jdeq
  \subst
    { {{x_2}{{x_1}{{x_0}{\omega_0}}}}
      {{{x_1}{{x_0}{\epsilon_0}}}{\epsilon_0}}
      }
    { P
      }.
  \tag{by \autoref{comp-ss-f}}
\end{align*}
Therefore, we see that
\begin{equation*}
\jterm
  {{\Gamma}{\subst{{x_2}{{x_0}{\epsilon_0}}}{P}}}
  { \subst
      { {{x_2}{{x_1}{{x_0}{\omega_0}}}}
        {{{x_1}{{x_0}{\epsilon_0}}}{\epsilon_0}}
        }
      { P
        }
    }
  { \subst{x_2}{{x_1}{{x_0}{\omega_1}}}
    }
\end{equation*}
Thus, the term $\subst{x_2}{{x_1}{{x_0}{\omega_1}}}$ takes a family over the
extended context $\subst{x_2}{{x_0}{\epsilon_0}}$ to a family over the
weakening $\subst{x_2}{{x_1}{{x_0}{\omega_0}}}$, which is itself a family
over $\subst{x_1}{{x_0}{\epsilon_0}}$. In other words, $\omega_1$
is precisely the internalization of the action on families of weakening, as
intended.

\subsubsection{The compatibility of weakening with extension}
The first rule, expressing that $\omega_0$ is compatible with $\epsilon_1$ is that
the diagram
\begin{equation}\label{wkalg-exteq1}
\begin{tikzcd}[column sep=large]
\ctxwk{P}{\ctxext{P}{\jcomp{}{\epsilon_0}{P}}}
  \ar{r}{\jvcomp{}{\omega_0}{\omega_1}}
  \ar{d}[swap]{\ctxwk{P}{\epsilon_1}}
& \ctxext
    {\jcomp{}{\epsilon_0}{P}}
    {\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}
  \ar{d}{\jcomp{}{\epsilon_0}{\epsilon_1}}
  \\
\ctxwk{P}{P}
  \ar{r}[swap]{\omega_0}
& \jcomp{}{\epsilon_0}{P}
\end{tikzcd}
\end{equation}
commutes judgmentally. For the second rule, expressing that $\omega_1$ is 
compatible with $\epsilon_1$, we wish to fill in a commutative diagram
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\ctxwk
  {P}
  { \ctxext
      {\jcomp{}{\epsilon_0}{P}}
      {\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}
    }
  \ar[densely dotted]{r}{\jvcomp{}{\omega_1}{?}}
  \ar{d}[swap]{\ctxwk{P}{\jcomp{}{\epsilon_0}{\epsilon_1}}}
& \jcomp{}{\omega_0}{%
    \jcomp{}{\epsilon_0}{%
      \jcomp{}{\epsilon_0}{%
        \ctxext{P}{\jcomp{}{\epsilon_0}{P}}
        }
      }
    }
  \ar{d}{ \jcomp{}{\omega_0}{%
            \jcomp{}{\epsilon_0}{%
              \jcomp{}{\epsilon_0}{\epsilon_1}
              }
            }
          }
  \\
\ctxwk{P}{\jcomp{}{\epsilon_0}{P}}
  \ar{r}[swap]{\omega_1}
& \jcomp{}{\omega_0}{%
    \jcomp{}{\epsilon_0}{%
      \jcomp{}{\epsilon_0}{P}
      }
    }
\end{tikzcd}
\end{equation*}
The morphism indicated by the question mark is a morphism from
$\ctxwk{P}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}$ to
$%
\jcomp{}{\omega_1}{%
  \jcomp{}{\omega_0}{%
    \jcomp{}{\epsilon_0}{%
      \jcomp{}{\epsilon_0}{%
        \ctxext{P}{\jcomp{}{\epsilon_0}{P}}
        }
      }
    }
  }
$ in context $\ctxext{{\Gamma}{A}}{P}$. One would expect this morphism to be
\begin{equation*}
\begin{tikzcd}[column sep=large]
\jcomp{}{\ctxwk{P}{\epsilon_0}}{\ctxwk{P}{\jcomp{}{\epsilon_0}{P}}}
  \ar{r}{\jcomp{}{\ctxwk{P}{\epsilon_0}}{\omega_1}}
& \jcomp{}{\ctxwk{P}{\epsilon_0}}{%
    \jcomp{}{\omega_0}{%
      \jcomp{}{\epsilon_0}{%
        \jcomp{}{\epsilon_0}{%
          P
          }
        }
      }
    }
\end{tikzcd}
\end{equation*}
in the context $\ctxext{{\Gamma}{A}}{P}$, 
so we must verify the judgmental equalities
\begin{align*}
\jcomp{}{\ctxwk{P}{\epsilon_0}}{\ctxwk{P}{\jcomp{}{\epsilon_0}{P}}}
& \jdeq 
  \ctxwk{P}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}
  \\
\jcomp{}{\ctxwk{P}{\epsilon_0}}{%
    \jcomp{}{\omega_0}{%
      \jcomp{}{\epsilon_0}{%
        \jcomp{}{\epsilon_0}{%
          P
          }
        }
      }
    }
& \jdeq
  \jcomp{}{\omega_1}{%
    \jcomp{}{\omega_0}{%
      \jcomp{}{\epsilon_0}{%
        \jcomp{}{\epsilon_0}{%
          \ctxext{P}{\jcomp{}{\epsilon_0}{P}}
          }
        }
      }
    } 
\end{align*}
of families over the context $\ctxext{{\Gamma}{A}}{P}$. The first of these
judgmental equalities is nothing special: it follows at straight from
\autoref{comp-ws-f}. We prove the second equality in the following lemma.

\begin{lem}
Let $(A,P,\epsilon_0,\epsilon_1)$ be an extension algebra and let
\begin{align*}
\jhom*
  {{{\Gamma}{A}}{P}}
  {\ctxwk{P}{P}}
  {\jcomp{}{\epsilon_0}{P}}
  {\omega_0}
  \\
\jfhom*
  {{{\Gamma}{A}}{P}}
  {\ctxwk{P}{P}}
  {\jcomp{}{\epsilon_0}{P}}
  {\omega_0}
  {\ctxwk{P}{\jcomp{}{\epsilon_0}{P}}}
  {\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}
  {\omega_1}
\end{align*}
be morphisms satisfying \autoref{wkalg-exteq1}. Then the inference rules
\begin{align*}
& \inference
  { \jfam{{\Gamma}{A}}{Q}
    }
  { \jfameq
      {\blank}
      { \jcomp{}{\omega_1}{%
          \jcomp{}{\omega_0}{%
            \jcomp{}{\epsilon_0}{%
              \jcomp{}{\epsilon_0}{%
                \jcomp{}{\epsilon_0}{Q}
                }
              }
            }
          } 
        }
      { \jcomp{}{\ctxwk{P}{\epsilon_0}}{%
          \jcomp{}{\omega_0}{%
            \jcomp{}{\epsilon_0}{%
              \jcomp{}{\epsilon_0}{%
                Q
                }
              }
            }
          }
        }
      }
\end{align*}
are valid.
\end{lem}

\begin{proof}
We have the judgmental equalities
\begin{align*}
& \jcomp{}{\omega_1}{%
          \jcomp{}{\omega_0}{%
            \jcomp{}{\epsilon_0}{%
              \jcomp{}{\epsilon_0}{%
                \jcomp{}{\epsilon_0}{Q}
                }
              }
            }
          } 
  \\
& \jdeq
  \jcomp{}{\jvcomp{}{\omega_0}{\omega_1}}{%
            \jcomp{}{\epsilon_0}{%
              \jcomp{}{\epsilon_0}{%
                \jcomp{}{\epsilon_0}{Q}
                }
              }
            }
  \tag{by \autoref{lem:composition-threesome}}
  \\
& \jdeq
  \jcomp{}{\jvcomp{}{\omega_0}{\omega_1}}{%
            \jcomp{}{\epsilon_0}{%
              \jcomp{}{\epsilon_1}{%
                \jcomp{}{\epsilon_0}{Q}
                }
              }
            }
  \tag{by \autoref{lem:extalg-twins}}
  \\
& \jdeq
  \jcomp{}{\jvcomp{}{\omega_0}{\omega_1}}{%
            \jcomp{}{\jcomp{}{\epsilon_0}{\epsilon_1}}{%
              \jcomp{}{\epsilon_0}{%
                \jcomp{}{\epsilon_0}{Q}
                }
              }
            }
   \tag{by \autoref{lem:jcomp-higherjcomp}}
   \\
& \jdeq
  \jcomp{}{\jcomp{}{%
             \jvcomp{}{\omega_0}{\omega_1}}{%
               \jcomp{}{\epsilon_0}{\epsilon_1}}}{%
              \jcomp{}{\epsilon_0}{%
                \jcomp{}{\epsilon_0}{Q}
                }
              }
  \tag{by \autoref{lem:jcomp-jcomp}}
  \\
& \jdeq
  \jcomp{}{\jcomp{}{\ctxwk{P}{\epsilon_0}}{\omega_0}}{%
              \jcomp{}{\epsilon_0}{%
                \jcomp{}{\epsilon_0}{Q}
                }
              }
  \tag{by \autoref{wkalg-exteq1}}
  \\
& \jdeq
  \jcomp{}{\ctxwk{P}{\epsilon_0}}{%
    \jcomp{}{\omega_0}{%
      \jcomp{}{\epsilon_0}{%
        \jcomp{}{\epsilon_0}{%
          Q
          }
        }
      }
    }
  \tag{by \autoref{lem:jcomp-jcomp}}
\end{align*}
\end{proof}

This enables us to require that the diagram
\begin{equation}\label{wkalg-exteq2}
\begin{tikzcd}[column sep=huge]
\ctxwk
  {P}
  { \ctxext
      {\jcomp{}{\epsilon_0}{P}}
      {\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}
    }
  \ar{r}{\jvcomp{}{\omega_1}{\jcomp{}{\ctxwk{P}{\epsilon_0}}{\omega_1}}}
  \ar{d}[swap]{\ctxwk{P}{\jcomp{}{\epsilon_0}{\epsilon_1}}}
& \jcomp{}{\omega_0}{%
    \jcomp{}{\epsilon_0}{%
      \jcomp{}{\epsilon_0}{%
        \ctxext{P}{\jcomp{}{\epsilon_0}{P}}
        }
      }
    }
  \ar{d}{ \jcomp{}{\omega_0}{%
            \jcomp{}{\epsilon_0}{%
              \jcomp{}{\epsilon_0}{\epsilon_1}
              }
            }
          }
  \\
\ctxwk{P}{\jcomp{}{\epsilon_0}{P}}
  \ar{r}[swap]{\omega_1}
& \jcomp{}{\omega_0}{%
    \jcomp{}{\epsilon_0}{%
      \jcomp{}{\epsilon_0}{P}
      }
    }
\end{tikzcd}
\end{equation}
commutes judgmentally.

\subsubsection{The compatibility of weakening with the empty context and family}
The first two judgmental equalities expressing that $\omega_0$ and $\omega_1$
are compatible with $\phi_1$ are easy to state:
\begin{align}
\jhomeq*{{\Gamma}{A}}{P}{P}{\subst{\phi_1}{\omega_0}}{\idtm{P}}\\
\jhomeq*{{\Gamma}{A}}{P}{P}{\subst{\phi_1}{\omega_1}}{\idtm{P}}
\end{align}

\subsubsection{The compatibility of weakening with itself}
To express the compatibility of weakening with itself, we must fill in the
following diagram:
\begin{equation*}
\begin{tikzcd}
\ctxwk{P}{{P}{P}}
  \ar{r}{\ctxwk{P}{\omega_0}}
  \ar{d}[swap]{\ctxwk{{P}{P}}{\omega_0}}
& \ctxwk{P}{\jcomp{}{\epsilon_0}{P}}
  \ar{d}{\omega_1}
  \\
\ctxwk{{P}{P}}{\jcomp{}{\epsilon_0}{P}}
  \ar[densely dotted]{r}
& \jcomp{}{\omega_0}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}
\end{tikzcd}
\end{equation*}

\subsubsection{The definition of weakening algebras}

\subsection{Extension-substitution algebras}

Let $(A,P,T,\epsilon_0,\epsilon_1,\phi_0,\phi_1)$ be a term-algebra. To define
substitution algebras, we will consider
\begin{align*}
\jhom*
  {{{{\Gamma}{A}}{P}}{T}}
  {\ctxwk{T}{\jcomp{}{\epsilon_0}{P}}}
  {P}
  {\sigma_0}
  \\
\jfhom*
  {{{{\Gamma}{A}}{P}}{T}}
  {\ctxwk{T}{\jcomp{}{\epsilon_0}{P}}}
  {P}
  {\sigma_0}
  {\ctxwk{T}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}}
  {\jcomp{}{\epsilon_0}{P}}
  {\sigma_1}
  \\
\jfhom*
  {{{{\Gamma}{A}}{P}}{T}}
  { \ctxext
      {\ctxwk{T}{\jcomp{}{\epsilon_0}{P}}}
      {\ctxwk{T}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{P}}}}
    }
  {\ctxext{P}{\jcomp{}{\epsilon_0}{P}}}
  {\jvcomp{}{\sigma_0}{\sigma_1}}
  {\ctxwk{T}{\jcomp{}{\epsilon_0}{\jcomp{}{\epsilon_0}{T}}}}
  {\jcomp{}{\epsilon_0}{T}}
  {\sigma_2}
\end{align*}
for which the pair $(\sigma_0,\sigma_1)$ is required to be an extension
homomorphism and the triple $(\sigma_0,\sigma_1,\sigma_2)$ is required to
be an empty term-homomorphism.

\subsection{Pre-universes}
Pre-universes are internal versions of the theory of contexts, families and
terms. They interpret extension, the empty context, weakening, substitution
and identity terms all at once in a compatible way. Besides the compatibility
properties there will be judgmental equalities analoguous to the cancellation
properties of \autoref{cancellation-ws,cancellation-i}. Pre-universes are to
the theory of contexts, families and terms what internal categories to a
category.
