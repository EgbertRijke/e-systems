%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% PACKAGES

\usepackage[utf8]{inputenc}
\usepackage[english]{babel}

%%%% Spicing up the document
\usepackage{mathpazo}
\usepackage[scaled=0.95]{helvet}
\usepackage{courier}
\linespread{1.05} % Palatino looks better with this
\usepackage{microtype}

\usepackage{fancyhdr} % To set headers and footers
\usepackage{enumitem,mathtools,xspace,xcolor}
\usepackage{comment}
\usepackage{ifthen}
\usepackage{pifont}
\newcommand{\cmark}{\ding{51}\xspace}
\newcommand{\xmark}{\ding{55}\xspace}

\usepackage{graphicx}
\usepackage{tikz-cd}
\usepackage{tikz}
\usetikzlibrary{decorations.pathmorphing}
\usepackage[inference]{semantic}
\usepackage{booktabs}

\usepackage[hyphens]{url} % This package has to be loaded *before* hyperref
\usepackage[pagebackref,colorlinks,citecolor=darkgreen,linkcolor=darkgreen,unicode]{hyperref}
\definecolor{darkgreen}{rgb}{0,0.45,0}

% For some reason the following can't be above hyperref...
\usepackage{amssymb,amsmath,amsthm,stmaryrd,mathrsfs,wasysym}
\usepackage{aliascnt}
\usepackage[capitalize]{cleveref}

% The braket macro shouldn't be necessary
\usepackage{braket} % used for \setof{ ... } macro

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% To include references in TOC we should use this package rather than a hack.
\usepackage{tocbibind}
%\usepackage{etoolbox}           % get \apptocmd
%\apptocmd{\thebibliography}{\addcontentsline{toc}{section}{References}}{}{} % tell bibliography to get itself into the table of contents


\begin{comment}
%%%% Header and footers
\pagestyle{fancyplain}
\setlength{\headheight}{15pt}
\renewcommand{\chaptermark}[1]{\markboth{\textsc{Chapter \thechapter. #1}}{}}
\renewcommand{\sectionmark}[1]{\markright{\textsc{\thesection\ #1}}}
\end{comment}

% TOC depth
\setcounter{tocdepth}{3}

\lhead[\fancyplain{}{{\thepage}}]%
      {\fancyplain{}{\nouppercase{\rightmark}}}
\rhead[\fancyplain{}{\nouppercase{\leftmark}}]%
      {\fancyplain{}{\thepage}}
\cfoot{\textsc{\footnotesize [Draft of \today]}}
\lfoot[]{}
\rfoot[]{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% We mostly use the macros of the book, to keep notations
%%%% and conventions the same. Recall that when the macros file
%%%% is updated, we need to comment the lines containing the
%%%% string `[chapter]` since our article is not a book.
%%%%
%%%% Instructions for updating the macros.tex file:
%%%% - fetch the latest macros.tex file from the HoTT/book git repository.
%%%% - comment all lines containing "[chapter]" because this is not a book.
%%%% - comment the definition of pbcorner because the xypic package is not used.
%%%%
\input{macros}

\newcommand{\idsymbin}{=}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Our commands which are not part of the macros.tex file.
%%%% We should keep these commands separate, because we will
%%%% update the macros.tex following the updates of the book.

%%%% First we redefine the \id, \eqv and \ct commands so that they accept an
%%%% arbitrary number of arguments. This is useful when writing longer strings
%%%% of equalities or equivalences.

\makeatletter

\renewcommand{\id}[3][]{
  \@ifnextchar\bgroup
    {#2 \mathbin{\idsym_{#1}} \id[#1]{#3}}
    {#2 \mathbin{\idsym_{#1}} #3}
  }

\renewcommand{\eqv}[2]{
  \@ifnextchar\bgroup
    {#1 \eqvsym \eqv{#2}}
    {#1 \eqvsym #2}
  }

\newcommand{\ctsym}{%
  \mathchoice{\mathbin{\raisebox{0.5ex}{$\displaystyle\centerdot$}}}%
             {\mathbin{\raisebox{0.5ex}{$\centerdot$}}}%
             {\mathbin{\raisebox{0.25ex}{$\scriptstyle\,\centerdot\,$}}}%
             {\mathbin{\raisebox{0.1ex}{$\scriptscriptstyle\,\centerdot\,$}}}
  }

\renewcommand{\ct}[3][]{
  \@ifnextchar\bgroup
    {#2 \mathbin{\ctsym_{#1}} \ct[#1]{#3}}
    {#2 \mathbin{\ctsym_{#1}} #3}
  }

\makeatother

%%%% We always use textstyle products and sums...
%\renewcommand{\prd}{\tprd}
%\renewcommand{\sm}{\tsm}
\makeatletter
\renewcommand{\@dprd}{\@tprd}
\renewcommand{\@dsm}{\@tsm}
\renewcommand{\@dprd@noparens}{\@tprd}
\renewcommand{\@dsm@noparens}{\@tsm}

%%%% ...with a bit more spacing
\renewcommand{\@tprd}[1]{\mathchoice{{\textstyle\prod_{(#1)}\,}}{\prod_{(#1)}\,}{\prod_{(#1)}\,}{\prod_{(#1)}\,}}
\renewcommand{\@tsm}[1]{\mathchoice{{\textstyle\sum_{(#1)}\,}}{\sum_{(#1)}\,}{\sum_{(#1)}\,}{\sum_{(#1)}\,}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% We adjust the \prd command so that implicit arguments become possible.
%%%%
%%%% First, we have the following switch. Set it to true if implicit arguments
%%%% are desired, or to false if not. Note turning off implicit arguments
%%%% might render some parts of the text harder to comprehend, since in the
%%%% text might appear $f(x)$ where we would have $f(i,x)$ without implicit
%%%% arguments.

\newcommand{\implicitargumentson}{\boolean{true}}

%%%% If one wants to use implicit arguments in the notation for product types,
%%%% a * has to be put before the argument that has to be implicit.
%%%% For example: in $\prd{x:A}*{y:B}{u:P(y)}Q(x,y,u)$, the argument y is
%%%% implicit. Any of the arguments can be made implicit this way.

%%%% First of all, we should make the command \prd search not only for a
%%%% brace, but also for a star. We introduce an auxiliary command that
%%%% determines whether the next character is a star or brace.
\newcommand{\@ifnextchar@starorbrace}[2]
%  {\@ifnextcharamong{#1}{#2}{*}{\bgroup};}
  {\@ifnextchar*{#1}{\@ifnextchar\bgroup{#1}{#2}}}
  
%%%% When encountering the \prd command, latex should determine whether it
%%%% should print implicit argument brackets or not. So the first branching
%%%% happens right here.
\renewcommand{\prd}{\@ifnextchar*{\@iprd}{\@prd}}

\newcommand{\@prd}[1]
  {\@ifnextchar@starorbrace
    {\prd@parens{#1}}
    {\@ifnextchar\sm{\prd@parens{#1}\@eatsm}{\prd@noparens{#1}}}}
\newcommand{\@prd@parens}{\@ifnextchar*{\@iprd}{\prd@parens}}
\renewcommand{\prd@parens}[1]
  {\@ifnextchar@starorbrace
    {\@theprd{#1}\@prd@parens}
    {\@ifnextchar\sm{\@theprd{#1}\@eatsm}{\@theprd{#1}}}}
\newcommand{\@theprd}[1]
  {\mathchoice{\@dprd{#1}}{\@tprd{#1}}{\@tprd{#1}}{\@tprd{#1}}}
\renewcommand{\dprd}[1]{\@dprd{#1}\@ifnextchar@starorbrace{\dprd}{}}
\renewcommand{\tprd}[1]{\@tprd{#1}\@ifnextchar@starorbrace{\tprd}{}}

%%%% Here we tell the actual symbols to be printed.
\newcommand{\@theiprd}[1]{\mathchoice{\@diprd{#1}}{\@tiprd{#1}}{\@tiprd{#1}}{\@tiprd{#1}}}
\newcommand{\@iprd}[2]{\@ifnextchar@starorbrace%
  {\@theiprd{#2}\@prd@parens}%
  {\@ifnextchar\sm%
    {\@theiprd{#2}\@eatsm}%
    {\@theiprd{#2}}}}
\def\@tiprd#1{
  \ifthenelse{\implicitargumentson}
    {\@@tiprd{#1}\@ifnextchar\bgroup{\@tiprd}{}}
    {\@tprd{#1}}}
\def\@@tiprd#1{\mathchoice{{\textstyle\prod_{\{#1\}}\,}}{\prod_{\{#1\}}\,}{\prod_{\{#1\}}\,}{\prod_{\{#1\}}\,}}
\def\@diprd{
  \ifthenelse{\implicitargumentson}
    {\@tiprd}
    {\@tprd}}
    

%%%% And finally we need to redefine \@eatprd so that implicit arguments also
%%%% works in the scope of a dependent sum.    
\def\@eatprd\prd{\@prd@parens}

\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Redefining the quantifiers, so that some of the longer 
%%%% formulas appear one a single line without problems

%%% Dependent products written with \forall, in the same style
\makeatletter
\def\tfall#1{\forall_{(#1)}\@ifnextchar\bgroup{\,\tfall}{\,}}
\renewcommand{\fall}{\tfall}

%%% Existential quantifier %%%
\def\texis#1{\exists_{(#1)}\@ifnextchar\bgroup{\,\texis}{\,}}
\renewcommand{\exis}{\texis}

%%% Unique existence %%%
\def\uexis#1{\exists!_{(#1)}\@ifnextchar\bgroup{\,\uexis}{\,}}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% UNFOLD
%%%%
%%%% For each definition in the type theory we make two versions of the macro:
%%%% the macro introducing the new notation and an @unfold version of the macro
%%%% which outputs the meaning of that new notation. Thus, we can use the
%%%% following construction to write our text. When we introduce \macro, we can
%%%% write \unfold{\macro} and the output will be the result of \macro@unfold.

\makeatletter
\newcommand{\unfold}{%
  \unfoldnext}
\newcommand{\unfoldall}[1]{%
  \begingroup%
  \renewcommand{\jhom}{\jhom@unfold}%
  \renewcommand{\jhomeq}{\jhomeq@unfold}%
  \renewcommand{\jhomdefn}{\jhomdefn@unfold}%
  \renewcommand{\jfhom}{\jfhom@unfold}%
  \renewcommand{\jcomp}{\jcomp@unfold}%
  \renewcommand{\@jcomp@nested}{\@jcomp@unfold@nested}%
  \renewcommand{\@jcomp@parens}{\@jcomp@unfold@parens}%
  \renewcommand{\tmext}{\tmext@unfold}%
  \renewcommand{\@tmext@nested}{\@tmext@unfold@nested}%
  \renewcommand{\@tmext@parens}{\@tmext@unfold@parens}%
  \renewcommand{\cprojfstf}{\cprojfstf@unfold}%
  \renewcommand{\cprojfst}{\cprojfst@unfold}%
  \renewcommand{\cprojsndf}{\cprojsndf@unfold}%
  \renewcommand{\cprojsnd}{\cprojsnd@unfold}%
  \renewcommand{\jfcomp}{\jfcomp@unfold}%
%  \renewcommand{\@jfcomp@nested}{\@jfcomp@unfold@nested}%
%  \renewcommand{\@jfcomp@parens}{\@jfcomp@unfold@parens}%
  \renewcommand{\sandwich}{\sandwich@unfold}%
  \renewcommand{\finc}{\finc@unfold}%
  \renewcommand{\jvcomp}{\jvcomp@unfold}%
  \renewcommand{\subst@type@unfold}[1]{
    \@ifnextchar\cprojfstf{\@eatdo{\cprojfstf@parens}}{%
      ##1}
    }
  #1%
  \endgroup%
  }

%%%% The following command is useful when you have checked with '\@ifnextchar'
%%%% that the next character is a macro '\firstmacro' and you want to replace
%%%% it by '\secondmacro'. To establish this, simply call for
%%%% '\@ifnextchar\firstmacro{\@eatdo{\secondmacro}}{}' with the second 
%%%% argument of \@eatdo left unspecified.
\newcommand{\@eatdo}[2]{#1}

%%%% The intention of '\unfoldnext' is to unfold only the definition of the
%%%% next character, provided that it is in the list of unfoldable macros.
\newcommand{\unfoldnext}[1]{
  \@ifnextchar\jhom{\@eatdo{\jhom@unfold}}{%
  \@ifnextchar\jhomeq{\@eatdo{\jhomeq@unfold}}{%
  \@ifnextchar\jhomdefn{\@eatdo{\jhomdefn@unfold}}{%
  \@ifnextchar\jfhom{\@eatdo{\jfhom@unfold}}{%
  \@ifnextchar\jcomp{\@eatdo{\jcomp@unfold}}{%
  \@ifnextchar\@jcomp@nested{\@eatdo{\@jcomp@unfold@nested}}{%
  \@ifnextchar\@jcomp@parens{\@eatdo{\@jcomp@unfold@parens}}{%
  \@ifnextchar\tmext{\@eatdo{\tmext@unfold}}{%
  \@ifnextchar\@tmext@nested{\@eatdo{\@tmext@unfold@nested}}{%
  \@ifnextchar\@tmext@parens{\@eatdo{\@tmext@unfold@parens}}{%
  \@ifnextchar\cprojfstf{\@eatdo{\cprojfstf@unfold}}{%
  \@ifnextchar\cprojfst{\@eatdo{\cprojfst@unfold}}{%
  \@ifnextchar\cprojsndf{\@eatdo{\cprojsndf@unfold}}{%
  \@ifnextchar\cprojsnd{\@eatdo{\cprojsnd@unfold}}{%
  \@ifnextchar\jfcomp{\@eatdo{\jfcomp@unfold}}{%
%  \@ifnextchar\@jfcomp@nested{\@eatdo{\@jfcomp@unfold@nested}}{%
%  \@ifnextchar\@jfcomp@parens{\@eatdo{\@jfcomp@unfold@parens}}{%
  \@ifnextchar\sandwich{\@eatdo{\sandwich@unfold}}{%
  \@ifnextchar\finc{\@eatdo{\finc@unfold}}{%
  \@ifnextchar\jvcomp{\@eatdo{\jvcomp@unfold}}{%
  }}}}}}}}}}}}}}}}}}%}}
  #1}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% A PRETTY PRINTER
%%%%
%%%% We write a \pretty command that pretty prints judgments or types by
%%%% diplaying variables and omitting explicit notation for weakening.
%%%%
%%%% This command should work similar to the \unfold command
%%%%
%%%% -- UNDER CONSTRUCTION

\makeatletter
\newcommand{\vardis}[2]{\@vardis@type #2{}(\@vardis@term #1)}
\newcommand{\@vardis}{\@ifnextchar\bgroup{\@@vardis}{}}
\newcommand{\@@vardis}[1]{\@ifnextchar\bgroup{\vardis{#1}}{#1}}
\newcommand{\@vardis@term}{\@vardis}
\newcommand{\@vardis@type}{\@ifnextchar\ctxext{\@ctxext@nested}{\@ifnextchar\ctxwk{\@ctxwk@nested}{\@vardis}}}
\newcommand{\@vardis@nested}[3]{\@vardis@parens{#2}{#3}}
\newcommand{\@vardis@parens}[2]{(\vardis{#1}{#2})}
\makeatother

\makeatletter
\newcommand{\jvctx}{\jctx}
\newcommand{\jvctxeq}{\jctxeq}

\newcommand{\cctxextcombi}[2]{\@ifnextchar\bgroup{\@cctxextcombi #1}{#1:}#2}
\newcommand{\@cctxextcombi}[4]{\cctxext{{\cctxextcombi{#1}{#3}}{\@@cctxextcombi{#1}{#2}{#4}}}}
\newcommand{\@@cctxextcombi}[3]{\@ifnextchar\bgroup{\@@@ctxextcombi #2}{#2(#1):}#3(\cctxext{#1})}
\newcommand{\@@@ctxextcombi}[8] % the 5th argument is (, the 6th is \cctxext and the 8th is ).
  {\@@ctxextcombi{#7}{#1}{#3},\@@ctxextcombi{{#7}{#3}}{#2}{#4}}
\newcommand{\cctxext}[1]{\@ifnextchar\bgroup{\@cctxext}{}#1}
\newcommand{\@cctxext}[2]{\cctxext{#1},\cctxext{#2}}

\newcommand{\jvfamcombi}[3]{
  \cctxextcombi{#1}{#2} \vdash \vardis{\cctxext{#1}}{#3}
}

\newcommand{\jvfam}{\@ifnextchar*{\@jvfamAlignTrue}{\@jvfamAlignFalse}}
\newcommand{\@jvfamAlignTrue}[4]{\jfam*{#2:#3}{\vardis{#2}{#4}}}
\newcommand{\@jvfamAlignFalse}[3]{\jfam{#1:#2}{\vardis{#1}{#3}}\quad@test}

\newcommand{\jvfameq}{\@ifnextchar*{\@jvfameqAlignTrue}{\@jvfameqAlignFalse}}
\newcommand{\@jvfameqAlignTrue}[5]{\jfameq*{#2:#3}{\vardis{#2}{#4}}{\vardis{#2}{#5}}}
\newcommand{\@jvfameqAlignFalse}[4]{\jfameq{#1:#2}{\vardis{#1}{#3}}{\vardis{#1}{#4}}\quad@test}

\newcommand{\jvtype}{\@ifnextchar*{\@jvtypeAlignTrue}{\@jvtypeAlignFalse}}
\newcommand{\@jvtypeAlignTrue}[4]{\jtype*{#2:#3}{\vardis{#2}{#4}}}
\newcommand{\@jvtypeAlignFalse}[3]{\jtype{#1:#2}{\vardis{#1}{#3}}\quad@test}

\newcommand{\jvtypeeq}{\@ifnextchar*{\@jvtypeeqAlignTrue}{\@jvtypeeqAlignFalse}}
\newcommand{\@jvtypeeqAlignTrue}[5]{\jtypeeq*{#2:#3}{\vardis{#2}{#4}}{\vardis{#2}{#5}}}
\newcommand{\@jvtypeeqAlignFalse}[4]{\jtypeeq{#1:#2}{\vardis{#1}{#3}}{\vardis{#1}{#4}}\quad@test}

\newcommand{\jvterm}{\@ifnextchar*{\@jvtermAlignTrue}{\@jvtermAlignFalse}}
\newcommand{\@jvtermAlignTrue}[5]{\jterm*{#2:#3}{\vardis{#2}{#4}}{\vardis{#2}{#5}}}
\newcommand{\@jvtermAlignFalse}[4]{\jterm{#1:#2}{\vardis{#1}{#3}}{\vardis{#1}{#4}}\quad@test}

\newcommand{\jvtermeq}{\@ifnextchar*{\@jvtermeqAlignTrue}{\@jvtermeqAlignFalse}}
\newcommand{\@jvtermeqAlignTrue}[6]{\jtermeq*{#2:#3}{\vardis{#2}{#4}}{\vardis{#2}{#5}}{\vardis{#2}{#6}}}
\newcommand{\@jvtermeqAlignFalse}[5]{\jtermeq{#1:#2}{\vardis{#1}{#3}}{\vardis{#1}{#4}}{\vardis{#1}{#5}}\quad@test}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%

\newcommand{\famsym}{\mathcal{F}}
\newcommand{\tmsym}{\mathcal{T}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% JUDGMENTS
%%%%
%%%% Below we define several commands for the judgments of type theory. There
%%%% are commands
%%%% * \jctx for the judgment that something is a context.
%%%% * \jctxeq for the judgment that two contexts are the same
%%%% * \jtype for the judgment that something is a type in a context
%%%% * \jtypeeq for the judgment that two types in the same context are the same
%%%% * \jterm for the judgment that something is a term of a type in a context
%%%% * \jtermeq for the judgment that two terms of the same type are the same

\makeatletter
% We first make a generic judgment command
\newcommand{\judgment}{\@ifnextchar*{\@judgmentAT}{\@judgmentAF}}
\newcommand{\@judgmentAT}[8]{\@judgment@ctx{#2} & \vdash \@judgment@rel{#3}{#4}{#5}{#6}{#7} #8}
\newcommand{\@judgmentAF}[7]{\@judgment@ctx{#1} \vdash \@judgment@rel{#2}{#3}{#4}{#5}{#6} #7\quad@test}
\newcommand{\@judgment@ctx}{\@judgment@ext}
\newcommand{\@judgment@rel}[5]{
  { \default@ctxext #1
    }
  #2 
  { \default@ctxext #3
    }
  #4
  { \default@ctxext #5
    }}
\newcommand{\@judgment@kind}[1]{~~\textit{#1}}
\newcommand{\@judgment@ext}[1]{\default@ctxext #1}

\newcommand{\quad@test}{%
  \@ifnextchar\jctx{\quad}{%
  \@ifnextchar\jctxeq{\quad}{%
  \@ifnextchar\jvctx{\quad}{%
  \@ifnextchar\jvctxeq{\quad}{%
  \@ifnextchar\jfam{\quad}{%
  \@ifnextchar\jfameq{\quad}{%
  \@ifnextchar\jvfam{\quad}{%
  \@ifnextchar\jvfameq{\quad}{%
  \@ifnextchar\jtype{\quad}{%
  \@ifnextchar\jtypeeq{\quad}{%
  \@ifnextchar\jvtype{\quad}{%
  \@ifnextchar\jvtypeeq{\quad}{%
  \@ifnextchar\jterm{\quad}{%
  \@ifnextchar\jtermeq{\quad}{%
  \@ifnextchar\jvterm{\quad}{%
  \@ifnextchar\jvtermeq{\quad}{%
  \@ifnextchar\jhom{\quad}{%
  \@ifnextchar\jhomeq{\quad}{%
  \@ifnextchar\jfhom{\quad}{%
  \@ifnextchar\jfhomeq{\quad}{%
  }}}}}}}}}}}}}}}}}}}}}

%%%% Judgments about contexts
\newcommand{\jctx@sym}{\@judgment@kind{ctx}}

\newcommand{\jctx}{\@ifnextchar*{\@jctxAlignTrue}{\@jctxAlignFalse}}
\newcommand{\@jctxAlignTrue}[2]{\judgment*{}{}{}{}{}{#2}{\jctx@sym}}
\newcommand{\@jctxAlignFalse}[1]{\judgment{}{}{}{}{}{#1}{\jctx@sym}}

\newcommand{\jctxeq}{\@ifnextchar*{\@jctxeqAlignTrue}{\@jctxeqAlignFalse}}
\newcommand{\@jctxeqAlignTrue}[3]{\judgment*{}{#2}{\jdeq}{#3}{}{}{\jctx@sym}}
\newcommand{\@jctxeqAlignFalse}[2]{\judgment{}{#1}{\jdeq}{#2}{}{}{\jctx@sym}}

\newcommand{\jctxdefn}{\@ifnextchar*{\@jctxdefnAlignTrue}{\@jctxdefnAlignFalse}}
\newcommand{\@jctxdefnAlignTrue}[3]{\judgment*{}{#2}{\defeq}{#3}{}{}{\jctx@sym}}
\newcommand{\@jctxdefnAlignFalse}[2]{\judgment{}{#1}{\defeq}{#2}{}{}{\jctx@sym}}

%%%% Judgments about families
\newcommand{\jfam@sym}{\@judgment@kind{fam}}

\newcommand{\jfam}{\@ifnextchar*{\@jfamAlignTrue}{\@jfamAlignFalse}}
\newcommand{\@jfamAlignTrue}[3]{\judgment*{#2}{}{}{}{}{#3}{\jfam@sym}}
\newcommand{\@jfamAlignFalse}[2]{\judgment{#1}{}{}{}{}{#2}{\jfam@sym}}

\newcommand{\jfameq}{\@ifnextchar*{\@jfameqAlignTrue}{\@jfameqAlignFalse}}
\newcommand{\@jfameqAlignTrue}[4]{\judgment*{#2}{#3}{\jdeq}{#4}{}{}{\jfam@sym}}
\newcommand{\@jfameqAlignFalse}[3]{\judgment{#1}{#2}{\jdeq}{#3}{}{}{\jfam@sym}}

\newcommand{\jfamdefn}{\@ifnextchar*{\@jfamdefnAlignTrue}{\@jfamdefnAlignFalse}}
\newcommand{\@jfamdefnAlignTrue}[4]{\judgment*{#2}{#3}{\defeq}{#4}{}{}{\jfam@sym}}
\newcommand{\@jfamdefnAlignFalse}[3]{\judgment{#1}{#2}{\defeq}{#3}{}{}{\jfam@sym}}
  
%%%% Judgments about types
\newcommand{\jtype@sym}{\@judgment@kind{type}}
\newcommand{\jtype}{\@ifnextchar*{\@jtypeAlignTrue}{\@jtypeAlignFalse}}
\newcommand{\@jtypeAlignTrue}[3]{\judgment*{#2}{}{}{}{}{#3}{\jtype@sym}}
\newcommand{\@jtypeAlignFalse}[2]{\judgment{#1}{}{}{}{}{#2}{\jtype@sym}}
  
\newcommand{\jtypeeq}{\@ifnextchar*{\@jtypeeqAlignTrue}{\@jtypeeqAlignFalse}}
\newcommand{\@jtypeeqAlignTrue}[4]{\judgment*{#2}{#3}{\jdeq}{#4}{}{}{\jtype@sym}}
\newcommand{\@jtypeeqAlignFalse}[3]{\judgment{#1}{#2}{\jdeq}{#3}{}{}{\jtype@sym}}

\newcommand{\jtypedefn}{\@ifnextchar*{\@jtypedefnAlignTrue}{\@jtypedefnAlignFalse}}
\newcommand{\@jtypedefnAlignTrue}[4]{\judgment*{#2}{#3}{\defeq}{#4}{}{}{\jtype@sym}}
\newcommand{\@jtypedefnAlignFalse}[3]{\judgment{#1}{#2}{\defeq}{#3}{}{}{\jtype@sym}}
  
%%%% Judgments about terms
\newcommand{\jterm}{\@ifnextchar*{\@jtermAlignTrue}{\@jtermAlignFalse}}
\newcommand{\@jtermAlignTrue}[4]{\judgment*{#2}{}{}{#4}{:}{#3}{}}
\newcommand{\@jtermAlignFalse}[3]{\judgment{#1}{}{}{#3}{:}{#2}{}}

\newcommand{\jtermeq}{\@ifnextchar*{\@jtermeqAlignTrue}{\@jtermeqAlignFalse}}
\newcommand{\@jtermeqAlignTrue}[5]{\judgment*{#2}{#4}{\jdeq}{#5}{:}{#3}{}}
\newcommand{\@jtermeqAlignFalse}[4]{\judgment{#1}{#3}{\jdeq}{#4}{:}{#2}{}}

\newcommand{\jtermdefn}{\@ifnextchar*{\@jtermdefnAlignTrue}{\@jtermdefnAlignFalse}}
\newcommand{\@jtermdefnAlignTrue}[5]{\judgment*{#2}{#4}{\defeq}{#5}{:}{#3}{}}
\newcommand{\@jtermdefnAlignFalse}[4]{\judgment{#1}{#3}{\defeq}{#4}{:}{#2}{}}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% THE EMPTY CONTEXT

\newcommand{\emptysym}{[\;]}
\newcommand{\emptyc}{{\emptysym}}
\newcommand{\emptyf}[1][]{{\emptysym}_{#1}}
\newcommand{\emptytm}[1][]{\typefont{\#}_{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% CONTEXT EXTENSION 
%%%%
%%%% The context extension command.
%%%%
%%%% To get a feeling of how the command works, here are a few examples.
%%%% \ctxext{A}{B} will print A.B
%%%% \ctxext{{A}{B}}{C} will print (A.B).C
%%%% \ctxext{{{A}{B}}{C}}{{D}{E}} will print ((A.B).C).(D.E)

\makeatletter
\newcommand{\ctxext}[2]{\@ctxext@ctx #1.\@ctxext@type #2}
\newcommand{\@ctxext}{\@ifnextchar\bgroup{\@@ctxext}{}}
\newcommand{\@ctxext@ctx}{%
  \@ifnextchar\ctxext{\@ctxext@nested}{%
  \@ifnextchar\ctxwk{\@ctxwk@nested}{%
  \@ifnextchar\jcomp{\@jcomp@nested}{%
  \@ifnextchar\jvcomp{\@jvcomp@nested}{%
  \@ifnextchar\jfcomp{\@jfcomp@nested}{%
  \@ctxext}}}}}}
\newcommand{\@ctxext@type}{%
  \@ifnextchar\ctxext{\@ctxext@nested}{%
  \@ifnextchar\subst{\@subst@nested}{%
  \@ifnextchar\jcomp{\@jcomp@nested}{%
  \@ifnextchar\jvcomp{\@jvcomp@nested}{%
  \@ifnextchar\jfcomp{\@jfcomp@nested}{%
  \@ctxext}}}}}}
\newcommand{\@@ctxext}[1]{\@ifnextchar\bgroup{\@ctxext@parens{#1}}{#1}}
\newcommand{\@ctxext@parens}[2]{(\ctxext{#1}{#2})}
\newcommand{\@ctxext@nested}[3]{\@ctxext@parens{#2}{#3}}

%%%% We want that some commands accept binary trees as arguments that default
%%%% into extensions. We make the following command to realize this
\newcommand{\default@ctxext}{\@ifnextchar\bgroup{\ctxext}{}}
\newcommand{\default@ctxext@parens}{\@ifnextchar\bgroup{\@ctxext@parens}{}}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% SUBSTITUTION

%%%% The substitution command will act the following way
%%%%
%%%% \subst{x}{P} will print P[x]
%%%% \subst{x}{{f}{Q}} will print Q[f][x]
%%%% \subst{{x}{f}}{{x}{Q}} will print Q[x][f[x]]

\makeatletter
\newcommand{\subst}[3][]{%
  \@subst@type #3{}[\@subst@term #2]^{#1}}
\newcommand{\@subst}{%
  \@ifnextchar\bgroup{\@@subst}{}}
\newcommand{\@@subst}[1]{%
  \@ifnextchar\bgroup{\subst{#1}}{#1}}
\newcommand{\@subst@term}{%
  \@subst}
\newcommand{\@subst@type}{%
  \@ifnextchar\ctxext{\@ctxext@nested}{%
  \@ifnextchar\ctxwk{\@ctxwk@nested}{%
  \@ifnextchar\jcomp{\@jcomp@nested}{%
  \@ifnextchar\tmext{\@tmext@nested}{%
  \@ifnextchar\jvcomp{\@jvcomp@nested}{%
  \@ifnextchar\jfcomp{\@jfcomp@nested}{%
%  \@ifnextchar\mfam{\@mfam@nested}{%
%  \@ifnextchar\mtm{\@mtm@nested}{%
  \subst@type@unfold{\@subst}
  }}}}}}}%}}
\newcommand{\subst@type@unfold}[1]{#1}
\newcommand{\@subst@nested}[3]{%
  \@subst@parens{#2}{#3}}
\newcommand{\@subst@parens}[2]{%
  (\subst{#1}{#2})}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% WEAKENING

%%%% The weakening command is very much like the substitution command.

\makeatletter
\newcommand{\ctxwk}[3][]{%
  \langle\@ctxwk@act #2\rangle^{#1} \@ctxwk@pass #3}
\newcommand{\@ctxwk}{%
  \@ifnextchar\bgroup{\@@ctxwk}{}}
\newcommand{\@@ctxwk}[1]{%
  \@ifnextchar\bgroup{\ctxwk{#1}}{#1}}
\newcommand{\@ctxwk@act}{%
  \@ctxwk}
\newcommand{\@ctxwk@pass}{%
  \@ifnextchar\ctxext{\@ctxext@nested}{%
  \@ifnextchar\subst{\@subst@nested}{%
  \@ifnextchar\jcomp{\@jcomp@nested}{%
  \@ifnextchar\tmext{\@tmext@nested}{%
  \@ifnextchar\jvcomp{\@jvcomp@nested}{%
  \@ifnextchar\jfcomp{\@jfcomp@nested}{%
%  \@ifnextchar\mfam{\@mfam@nested}{%
%  \@ifnextchar\mtm{\@mtm@nested}{%
  \@ctxwk
  }}}}}}}%}}
\newcommand{\@ctxwk@parens}[2]{%
  (\ctxwk{#1}{#2})}
\newcommand{\@ctxwk@nested}[3]{%
  \@ctxwk@parens{#2}{#3}}
\makeatother

%%%% Not sure if we're gonna need the following.
\newcommand{\ctxwkop}[2]{%
  \ctxwk{#2}{#1}}
  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% IDENTITY TERMS

\makeatletter
\newcommand{\idtm}[1]{\typefont{id}_{\default@ctxext #1}}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% TERM EXTENSION
%%%%
%%%% The term extension command \tmext is slightly complicated because 
%%%% \tmext@unfold should do different things depending on whether it has two
%%%% or four arguments. Thus \tmext has a full form and a short form, where
%%%% the short form has two arguments and the full form has four. 

\makeatletter

%%%% The basic term extension commands
\newcommand{\default@tmext}{\@ifnextchar\bgroup{\tmext}{}}
\newcommand{\tmext}[2]{%
  \@ifnextchar\bgroup{\tmext@full{#1}{#2}}{\tmext@short{#1}{#2}}}
\newcommand{\tmext@full}[4]{%
  \ctxext{\tmext@testleft #3}{\tmext@testright #4}}
\newcommand{\tmext@short}[2]{%
  \ctxext{\tmext@testleft #1}{\tmext@testright #2}}
\newcommand{\tmext@testleft}{%
  \@ifnextchar\bgroup{\@tmext@parens}{%
  \@ifnextchar\tmext{\@tmext@nested}{%
  \@ifnextchar\ctxwk{\@ctxwk@nested}{%
  \@ifnextchar\jcomp{\@jcomp@nested}{%
  \@ifnextchar\jvcomp{\@jvcomp@nested}{%
  \@ifnextchar\jfcomp{\@jfcomp@nested}{%
%  \default@tmext
  }}}}}}}
\newcommand{\tmext@testright}{%
  \@ifnextchar\bgroup{\@tmext@parens}{%
  \@ifnextchar\tmext{\@tmext@nested}{%
  \@ifnextchar\subst{\@subst@nested}{%
  \@ifnextchar\jcomp{\@jcomp@nested}{%
  \@ifnextchar\jvcomp{\@jvcomp@nested}{%
  \@ifnextchar\jfcomp{\@jfcomp@nested}{%
  \@ifnextchar\cprojfst{\cprojfst@nested}{%
  \@ifnextchar\cprojsnd{\cprojsnd@nested}{%
%  \default@tmext
  }}}}}}}}}
\newcommand{\@tmext@nested}[1]{%
  \@tmext@parens}
\newcommand{\@tmext@parens}[2]{%
  \@ifnextchar\bgroup
    {\tmext@full@parens{#1}{#2}}
    {(\tmext@short{#1}{#2})}}
\newcommand{\tmext@full@parens}[4]{%
  (\tmext@full{#1}{#2}{#3}{#4})}

%%%% The unfolded term extension commands
\newcommand{\tmext@unfold}[2]{%
  \@ifnextchar\bgroup{\tmext@unfold@full{#1}{#2}}{\tmext@short{#1}{#2}}}
\newcommand{\tmext@unfold@full}[4]{%  
  \subst{#4}{{#3}{\idtm{\ctxext{#1}{#2}}}}}
\newcommand{\@tmext@unfold@nested}[1]{%
  \@tmext@unfold@parens}
\newcommand{\@tmext@unfold@parens}[4]{%
  (\tmext@unfold{#1}{#2}{#3}{#4})}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% JUDGMENTAL MORPHISMS

\makeatletter

%%%% The judgment that f is a morphism from A to B in context \Gamma.
\newcommand{\jhomsym}[3][]{%
  ~~\textit{hom}_{#1}(\default@ctxext #2,\default@ctxext #3)}
\newcommand{\jhom}{%
  \@ifnextchar*{\@jhomAlignTrue}{\@jhomAlignFalse}}
\newcommand{\@jhomAlignTrue}[5]{%
  \judgment*{#2}{}{}{#5}{}{}{\jhomsym{#3}{#4}}}
\newcommand{\@jhomAlignFalse}[4]{%
  \judgment{#1}{}{}{#4}{}{}{\jhomsym{#2}{#3}}}
\newcommand{\jhomeq}{%
  \@ifnextchar*{\@jhomeqAlignTrue}{\@jhomeqAlignFalse}}
\newcommand{\@jhomeqAlignTrue}[6]{%
  \judgment*{#2}{#5}{\jdeq}{#6}{}{}{\jhomsym{#3}{#4}}}
\newcommand{\@jhomeqAlignFalse}[5]{%
  \judgment{#1}{#4}{\jdeq}{#5}{}{}{\jhomsym{#2}{#3}}}
\newcommand{\jhomdefn}{%
  \@ifnextchar*{\@jhomdefnAlignTrue}{\@jhomdefnAlignFalse}}
\newcommand{\@jhomdefnAlignTrue}[6]{%
  \judgment*{#2}{#5}{\defeq}{#6}{}{}{\jhomsym{#3}{#4}}}
\newcommand{\@jhomdefnAlignFalse}[5]{%
  \judgment{#1}{#4}{\defeq}{#5}{}{}{\jhomsym{#2}{#3}}}

\newcommand{\jhom@unfold}[4]{%
  \jterm
    {{#1}{#2}}
    {\ctxwk{\default@ctxext #2}{\default@ctxext@parens #3}}
    {#4}}
\newcommand{\jhomeq@unfold}[5]{%
  \jtermeq
    {{#1}{#2}}
    {\ctxwk{\default@ctxext #2}{\default@ctxext@parens #3}}
    {#4}
    {#5}}
\newcommand{\jhomdefn@unfold}[5]{%
  \jtermdefn
    {{#1}{#2}}
    {\ctxwk{\default@ctxext #2}{\default@ctxext@parens #3}}
    {#4}
    {#5}}

%%%% Composition of morphisms
\newcommand{\jcomp}[3]{%
  \jcomp@testleft #3 \circ \jcomp@testright #2}
\newcommand{\jcomp@testleft}{%
  \@ifnextchar\jcomp{\@jcomp@nested}{%
  \@ifnextchar\ctxwk{\@ctxwk@nested}{%
  \@ifnextchar\ctxext{\@ctxext@nested}{%
  \@ifnextchar\bgroup{\@jcomp@parens}{%
  \@ifnextchar\tmext{\@tmext@nested}{%
  \@ifnextchar\jvcomp{\@jvcomp@nested}{%
  \@ifnextchar\jfcomp{\@jfcomp@nested}{%
  }}}}}}}}
\newcommand{\jcomp@testright}{%
  \@ifnextchar\jcomp{\@jcomp@nested}{%
  \@ifnextchar\subst{\@subst@nested}{%
  \@ifnextchar\ctxext{\@ctxext@nested}{%
  \@ifnextchar\bgroup{\@jcomp@parens}{%
  \@ifnextchar\tmext{\@tmext@nested}{%
  \@ifnextchar\jvcomp{\@jvcomp@nested}{%
  \@ifnextchar\jfcomp{\@jfcomp@nested}{%
  }}}}}}}}
\newcommand{\@jcomp@nested}[4]{%
  \@jcomp@parens{#2}{#3}{#4}}
\newcommand{\@jcomp@parens}[3]{%
  (\jcomp{#1}{#2}{#3})}

\newcommand{\jcomp@unfold}[3]{%
  \subst
    {\jcomp@unfold@test@preside #2}
    {\ctxwk{\default@ctxext #1}{\jcomp@unfold@test@postside #3}}}
\newcommand{\jcomp@unfold@test@preside}{%
  \@ifnextchar\bgroup{\@jcomp@unfold@parens}{}}
\newcommand{\jcomp@unfold@test@postside}{%
  \@ifnextchar\bgroup{\@jcomp@unfold@parens}{}}
\newcommand{\@jcomp@unfold@nested}[4]{%
  \@jcomp@unfold@parens{#2}{#3}{#4}}
\newcommand{\@jcomp@unfold@parens}[3]{%
  (\jcomp@unfold{#1}{#2}{#3})}

%%%% Vertical composition of morphisms.
\newcommand{\jvcomp}[3]{%
  \jcomp@testleft #2 * \jcomp@testright #3}
\newcommand{\jvcomp@testleft}{%
  \@ifnextchar\jvcomp{\@jvcomp@nested}{%
  \@ifnextchar\ctxwk{\@ctxwk@nested}{%
  \@ifnextchar\ctxext{\@ctxext@nested}{%
  \@ifnextchar\bgroup{\@jvcomp@parens}{%
  \@ifnextchar\tmext{\@tmext@nested}{%
  \@ifnextchar\jcomp{\@jcomp@nested}{%
  \@ifnextchar\jfcomp{\@jfcomp@nested}{%
  }}}}}}}}
\newcommand{\jvcomp@testright}{%
  \@ifnextchar\jvcomp{\@jvcomp@nested}{%
  \@ifnextchar\subst{\@subst@nested}{%
  \@ifnextchar\ctxext{\@ctxext@nested}{%
  \@ifnextchar\bgroup{\@jvcomp@parens}{%
  \@ifnextchar\tmext{\@tmext@nested}{%
  \@ifnextchar\jcomp{\@jcomp@nested}{%
  \@ifnextchar\jfcomp{\@jfcomp@nested}{%
  }}}}}}}}
\newcommand{\@jvcomp@nested}[4]{%
  \@jvcomp@parens{#2}{#3}{#4}}
\newcommand{\@jvcomp@parens}[3]{%
  (\jvcomp{#1}{#2}{#3})}

\newcommand{\jvcomp@unfold}[3]{%
  \tmext{}{}{\ctxwk{#1}{#2}}{#3}
  }
\newcommand{\jvcomp@unfold@test@preside}{%
  \@ifnextchar\bgroup{\@jvcomp@unfold@parens}{}}
\newcommand{\jvcomp@unfold@test@postside}{%
  \@ifnextchar\bgroup{\@jvcomp@unfold@parens}{}}
\newcommand{\@jvcomp@unfold@nested}[4]{%
  \@jvcomp@unfold@parens{#2}{#3}{#4}}
\newcommand{\@jvcomp@unfold@parens}[3]{%
  (\jvcomp@unfold{#1}{#2}{#3})}

%%%% The judgment that F is a morphism from P to Q over f in context \Gamma.
\newcommand{\jfhomsym}[3]{\jhomsym[{#1}]{#2}{#3}}
\newcommand{\jfhom}{%
  \@ifnextchar*{\jfhomAlignTrue}{\jfhomAlignFalse}}
\newcommand{\jfhomAlignTrue}[8]{
  \judgment*{#2}{}{}{#8}{}{}{\jfhomsym{#5}{#6}{#7}}}
\newcommand{\jfhomAlignFalse}[7]{
  \judgment{#1}{}{}{#7}{}{}{\jfhomsym{#4}{#5}{#6}}}
\newcommand{\jfhomeq}[8]{%
  \judgment{#1}{#7}{\jdeq}{#8}{}{}{\jhomsym[{#4}]{#5}{#6}}}
\newcommand{\jfhomdefn}[8]{%
  \judgment{#1}{#7}{\defeq}{#8}{}{}{\jhomsym[{#4}]{#5}{#6}}}
\newcommand{\jfhom@unfold}[7]{%
  \jterm
    {{{#1}{#2}}{#5}}
    {\ctxwk{\default@ctxext #5}{\jcomp{#2}{#4}{#6}}}
    {#7}}
    
\newcommand{\jfcomp}[5]{%
  \jfcomp@testleft #5 \bullet \jfcomp@testright #4}
\newcommand{\jfcomp@testleft}{%
  \@ifnextchar\bgroup{\@jfcomp@parens}{%
  \@ifnextchar\jfcomp{\@jfcomp@nested}{%
  \@ifnextchar\jcomp{\@jcomp@nested}{%
  \@ifnextchar\ctxwk{\@ctxwk@nested}{%
  \@ifnextchar\tmext{\@tmext@nested}{%
  \@ifnextchar\jvcomp{\@jvcomp@nested}{%
  }}}}}}}
\newcommand{\jfcomp@testright}{%
  \@ifnextchar\bgroup{\@jfcomp@parens}{%
  \@ifnextchar\jfcomp{\@jfcomp@nested}{%
  \@ifnextchar\jcomp{\@jcomp@nested}{%
  \@ifnextchar\subst{\@subst@nested}{%
  \@ifnextchar\tmext{\@tmext@nested}{%
  \@ifnextchar\jvcomp{\@jvcomp@nested}{%
  }}}}}}}
\newcommand{\@jfcomp@nested}[1]{%
  \@jfcomp@parens}
\newcommand{\@jfcomp@parens}[5]{%
  (\jfcomp{#1}{#2}{#3}{#4}{#5})}
  
\newcommand{\jfcomp@unfold}[5]{%
  \jcomp{#3}{#4}{{#1}{#2}{#5}}}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% JUDGMENTAL TRIVIAL COFIBRATIONS

\newcommand{\jtcext}{\tilde}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% CONTEXT PROJECTIONS

\makeatletter
\newcommand{\cprojgenf}[3]{%
  \typefont{pr}^{%
    \@ifnextchar\bgroup{\@ctxext@parens}{%
    \@ifnextchar\ctxext{\@ctxext@nested}{%
    }}
    #2,
    \@ifnextchar\bgroup{\@ctxext@parens}{%
    \@ifnextchar\ctxext{\@ctxext@nested}{%
    }}
    #3
    }_{#1}}
\newcommand{\cprojgen}[4]{%
  \subst{#4}{\cprojgenf{#1}{#2}{#3}}}
\newcommand{\cprojgenf@nested}[1]{%
  \cprojgenf@parens}
\newcommand{\cprojgenf@parens}[3]{%
  (\cprojgenf{#1}{#2}{#3})}
\newcommand{\cprojgen@nested}[1]{%
  \cprojgen@parens}
\newcommand{\cprojgen@parens}[4]{%
  (\cprojgen{#1}{#2}{#3}{#4})}

\newcommand{\cprojfstf}[2]{%
  \cprojgenf{0}{#1}{#2}}
\newcommand{\cprojfstf@nested}[1]{%
  \cprojfstf@parens}
\newcommand{\cprojfstf@parens}[2]{%
  (\cprojfstf{#1}{#2})}
\newcommand{\cprojfstf@unfold}[2]{%
  \ctxwk{\default@ctxext #2}\idtm{\default@ctxext #1}}

\newcommand{\cprojfst}[3]{%
  \cprojgen{0}{#1}{#2}{#3}}
\newcommand{\cprojfst@nested}[1]{%
  \cprojfst@parens}
\newcommand{\cprojfst@parens}[3]{%
  (\cprojfst{#1}{#2}{#3})}
\newcommand{\cprojfst@unfold}[3]{%
  \subst{#3}{(\cprojfstf@unfold{#1}{#2})}}

\newcommand{\cprojsndf}[2]{%
  \cprojgenf{1}{#1}{#2}}
\newcommand{\cprojsndf@nested}[1]{%
  \cprojsndf@parens}
\newcommand{\cprojsndf@parens}[2]{%
  (\cprojsndf{#1}{#2})}
\newcommand{\cprojsndf@unfold}[2]{%
  \idtm{\default@ctxext #2}}

\newcommand{\cprojsnd}[3]{%
  \cprojgen{1}{#1}{#2}{#3}}
\newcommand{\cprojsnd@nested}[1]{%
  \cprojsnd@parens}
\newcommand{\cprojsnd@parens}[3]{%
  (\cprojsnd{#1}{#2}{#3})}
\newcommand{\cprojsnd@unfold}[3]{%
  \subst{#3}{\cprojsnd@unfold{#1}{#2}}}
  
%%%% The sandwich function
\newcommand{\sandwich}[3]{\typefont{sw}^{#1,#2,#3}}
\newcommand{\sandwich@unfold}[3]{\typefont{sw}^{#1,#2,#3}}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% FIBER INCLUSIONS

\makeatletter
\newcommand{\finc}[2]{\typefont{in}^{#2}_{#1}}
\newcommand{\finc@unfold}[2]{\tmext{}{}{\ctxwk{\subst{x}{P}}{x}}{\idtm{\subst{x}{P}}}}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% THE UNIT TYPE

\makeatletter
\newcommand{\unitc}[1]{%
  \unit^0_{\default@ctxext #1}}
\newcommand{\unitct}[1]{%
  \ttt^0_{\default@ctxext #1}}
\newcommand{\unitf}[2]{%
  \unit^1_{\default@ctxext #1,\default@ctxext #2}}
\newcommand{\unitft}[2]{%
  \ttt^1_{\default@ctxext #1,\default@ctxext #2}}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% DEPENDENT FUNCTION TYPES

\makeatletter
\newcommand{\sprd}[2]{\Pi(\default@ctxext #1,\default@ctxext #2)}
\begin{comment}
\newcommand{\@sprd@test@cod}[2]{%
  \@ifnextchar\bgroup{\@sprd@do@cod{#1}}{%
  \Pi(\@sprd@test@dom{#1}{#2} #1,
  }}
\newcommand{\@sprd@do@cod}[4]{%
  \ctxext{\@sprd{#1}{#2}}{\@sprd{#1}{#3}}
  }
\newcommand{\@sprd}[2]{
  \@ifnextchar\bgroup{\@@sprd}{%
    \Pi(}
    #1,{#2})
  }
\newcommand{\@@sprd}[5]{%
  \sprd{#1}{\sprd{#2}{#4}}
  }
\end{comment}

\newcommand{\slam}[3]{%
  \lambda^{{\default@ctxext@parens #1},{\default@ctxext@parens #2}}
  (\default@ctxext #3)
  }
\newcommand{\sev}[1]{\tfev(#1)}

\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% NON-DEPENDENT FUNCTION TYPES

\newcommand{\jfun}[2]{#1\to#2}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% THE CONSTRUCTORS OF THE TYPE THEORY OF MODELS

\makeatletter
%%%% The initial model
\newcommand{\mctx}{%
  \mathcal{C}}

%%%% The family constructor
\newcommand{\mfam}[2][]{%
  \mathcal{F}_{\default@ctxext #2}^{#1}}
\newcommand{\@mfam@nested}[1]{\@mfam@parens}
\newcommand{\@mfam@parens}[2][]{(\mfam[#1]{#2})}

%%%% The terms constructor
\newcommand{\mtm}[2][]{%
  \mathcal{T}_{\default@ctxext #2}^{#1}}
\newcommand{\@mtm@nested}[1]{\@mtm@parens}
\newcommand{\@mtm@parens}[2][]{(\mtm[#1]{#2})}

%%%% The empty type constructor
\newcommand{\tfemp}[1]{%
  \typefont{emp}_{\default@ctxext #1}}
\newcommand{\tft}[1]{%
  \typefont{t}_{\default@ctxext #1}}

%%%% The extension constructor
\newcommand{\tfext}[1]{%
  \typefont{ext}_{\default@ctxext #1}}

%%%% The substitution constructor
\newcommand{\tfsubst}[1]{%
  \typefont{subst}_{\default@ctxext #1}}
  
%%%% The weakening constructor
\newcommand{\tfwk}[1]{%
  \typefont{wk}_{\default@ctxext #1}}

%%%% The identity function constructor
\newcommand{\tfid}[1]{%
  \typefont{idtm}_{\default@ctxext #1}}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%% Introducing logical usage of fonts.
\newcommand{\modelfont}{\mathit} % use 'mf' in command to indicate model font
\newcommand{\typefont}{\mathsf} % use 'tf' in command to indicate type font
\newcommand{\catfont}{\mathrm} % use 'cf' in command to indicate cat font

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Some macros of the book are redefined.

\renewcommand{\UU}{\typefont{U}}
\renewcommand{\isequiv}{\typefont{isEquiv}}
\renewcommand{\happly}{\typefont{hApply}}
\renewcommand{\pairr}[1]{{\mathopen{}\langle #1\rangle\mathclose{}}}
\renewcommand{\type}{\typefont{Type}}
\renewcommand{\op}[1]{{{#1}^\typefont{op}}}
\renewcommand{\susp}{\typefont{\Sigma}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% The following is a big unorganized list of new macros that we use in the
%%%% notes. 

\newcommand{\tfW}{\typefont{W}}
\newcommand{\tfM}{\typefont{M}}
\newcommand{\mfM}{\modelfont{M}}
\newcommand{\mfN}{\modelfont{N}}
\newcommand{\tfctx}{\typefont{ctx}}
\newcommand{\mftypfunc}[1]{{\modelfont{typ}^{#1}}}
\newcommand{\mftyp}[2]{{\mftypfunc{#1}(#2)}}
\newcommand{\tftypfunc}[1]{{\typefont{typ}^{#1}}}
\newcommand{\tftyp}[2]{{\tftypfunc{#1}(#2)}}
\newcommand{\hfibfunc}[1]{\typefont{fib}_{#1}}
\newcommand{\mappingcone}[1]{\mathcal{C}_{#1}}
\newcommand{\equifib}{\typefont{equiFib}}
\newcommand{\tfcolim}{\typefont{colim}}
\newcommand{\tflim}{\typefont{lim}}
\newcommand{\tfdiag}{\typefont{diag}}
\newcommand{\tfGraph}{\typefont{Graph}}
\newcommand{\mfGraph}{\modelfont{Graph}}
\newcommand{\unitGraph}{\unit^\mfGraph}
\newcommand{\UUGraph}{\UU^\mfGraph}
\newcommand{\tfrGraph}{\typefont{rGraph}}
\newcommand{\mfrGraph}{\modelfont{rGraph}}
\newcommand{\isfunction}{\typefont{isFunction}}
\newcommand{\tfconst}{\typefont{const}}
\newcommand{\conemap}{\typefont{coneMap}}
\newcommand{\coconemap}{\typefont{coconeMap}}
\newcommand{\tflimits}{\typefont{limits}}
\newcommand{\tfcolimits}{\typefont{colimits}}
\newcommand{\islimiting}{\typefont{isLimiting}}
\newcommand{\iscolimiting}{\typefont{isColimiting}}
\newcommand{\islimit}{\typefont{isLimit}}
\newcommand{\iscolimit}{\typefont{iscolimit}}
\newcommand{\pbcone}{\typefont{cone_{pb}}}
\newcommand{\tfinj}{\typefont{inj}}
\newcommand{\tfsurj}{\typefont{surj}}
\newcommand{\tfepi}{\typefont{epi}}
\newcommand{\tftop}{\typefont{top}}
\newcommand{\sbrck}[1]{\Vert #1\Vert}
\newcommand{\strunc}[2]{\Vert #2\Vert_{#1}}
\newcommand{\gobjclass}{{\typefont{U}^\mfGraph}}
\newcommand{\gcharmap}{\typefont{fib}}
\newcommand{\diagclass}{\typefont{T}}
\newcommand{\opdiagclass}{\op{\diagclass}}
\newcommand{\equifibclass}{\diagclass^{\eqv{}{}}}
\newcommand{\universe}{\typefont{U}}
\newcommand{\catid}[1]{{\catfont{id}_{#1}}}
\newcommand{\isleftfib}{\typefont{isLeftFib}}
\newcommand{\isrightfib}{\typefont{isRightFib}}
\newcommand{\leftLiftings}{\typefont{leftLiftings}}
\newcommand{\rightLiftings}{\typefont{rightLiftings}}
\newcommand{\psh}{\typefont{Psh}}
\newcommand{\rgclass}{\typefont{\Omega^{RG}}}
\newcommand{\terms}[2][]{\lfloor #2 \rfloor^{#1}}
\newcommand{\grconstr}[2]
             {\mathchoice % max size is textstyle size.
             {{\textstyle \int_{#1}}#2}% 
             {\int_{#1}#2}%
             {\int_{#1}#2}%
             {\int_{#1}#2}}
\newcommand{\ctxhom}[3][]{\typefont{hom}_{#1}(#2,#3)}
\newcommand{\graphcharmapfunc}[1]{\gcharmap_{#1}}
\newcommand{\graphcharmap}[2][]{\graphcharmapfunc{#1}(#2)}
\newcommand{\tfexp}[1]{\typefont{exp}_{#1}}
\newcommand{\tffamfunc}{\typefont{fam}}
\newcommand{\tffam}[1]{\tffamfunc(#1)}
\newcommand{\tfev}{\typefont{ev}}
\newcommand{\tfcomp}{\typefont{comp}}
\newcommand{\isDec}[1]{\typefont{isDecidable}(#1)}
\newcommand{\smal}{\mathcal{S}}
\renewcommand{\modal}{{\ensuremath{\ocircle}}}
\newcommand{\eqrel}{\typefont{EqRel}}
\newcommand{\piw}{\ensuremath{\Pi\typefont{W}}} %% to be used in conjunction with -pretopos.
\renewcommand{\sslash}{/\!\!/}
\newcommand{\mprd}[2]{\Pi(#1,#2)}
\newcommand{\msm}[2]{\Sigma(#1,#2)}
\newcommand{\midt}[1]{\idvartype_#1}
\newcommand{\reflf}[1]{\typefont{refl}^{#1}}
\newcommand{\tfJ}{\typefont{J}}
\newcommand{\tftrans}{\typefont{trans}}

\newcommand{\tfT}{\typefont{T}}
\newcommand{\reflsym}{{\mathsf{refl}}}
\newcommand{\strans}[2]{\ensuremath{{#1}_{*}({#2})}}
\newcommand{\eqtype}[1]{\typefont{Eq}_{#1}}
\newcommand{\eqtoid}[1]{\typefont{eqtoid}(#1)}
\newcommand{\greek}{\mathrm}
\newcommand{\product}[2]{{#1}\times{#2}}
\newcommand{\pairp}[1]{(#1)}
\newcommand{\jequalizer}[3]{\{#1|#2\jdeq #3\}}
\newcommand{\jequalizerin}[2]{\iota_{#1,#2}}
\newcommand{\tounit}[1]{{!_{#1}}}
\newcommand{\trwk}{\typefont{trwk}}
\newcommand{\trext}{\typefont{trext}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% When investigation pointed structures we use the \pt macro.

\makeatletter
\newcommand{\pt}[1][]{*_{
  \@ifnextchar\undergraph{\@undergraph@nested}
    {\@ifnextchar\underovergraph{\@underovergraph@nested}{}}#1}}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% OPERATIONS ON GRAPHS
%%%%
%%%% First of all, each graph has a type of vertices and a type of edges. The
%%%% type of vertices of a graph $\Gamma$ is denoted by $\pts{\Gamma}$;
%%%% and likewise for the type of edges.

\makeatletter
\newcommand{\pts}[1]{{\@graphop@nested{#1}}_{0}}
\newcommand{\edg}[1]{{\@graphop@nested{#1}}_{1}}
\newcommand{\@graphop@nested}[1]
  {\@ifnextchar\ctxext{\@ctxext@nested}
      {\@ifnextchar\undergraph{\@undergraph@nested}
         {\@ifnextchar\underovergraph{\@underovergraph@nested}{}}}
    #1}
\makeatother

%%%% The following operations of \undergraph and \underovergraph are used to
%%%% define the free category and the free groupoid of a graph, respectively

\makeatletter
\newcommand{\@undergraphtest}[2]{\@ifnextchar({#1}{#2}}
\newcommand{\undergraph}[2]{\@undergraphtest{\@undergraph@parens{#1}{#2}}{\@undergraph{#1}{#2}}}
\newcommand{\@undergraph}[2]{{#2/#1}}
\newcommand{\@undergraph@nested}[3]{\@undergraph@parens{#2}{#3}}
\newcommand{\@undergraph@parens}[2]{(\@undergraph{#1}{#2})}
\makeatother

\makeatletter
\newcommand{\underovergraph}[2]{\@underovergraphtest{\@underovergraph@parens{#1}{#2}}{\@underovergraph{#1}{#2}}}
\newcommand{\@underovergraph}[2]{{#2}\,{\parallel}\,{#1}}
\newcommand{\@underovergraphtest}{\@undergraphtest}
\newcommand{\@underovergraph@parens}[2]{(\@underovergraph{#1}{#2})}
\newcommand{\@underovergraph@nested}[3]{\@underovergraph@parens{#2}{#3}}
\makeatother

\newcommand{\graphid}[1]{\mathrm{id}_{#1}}
\newcommand{\freecat}[1]{\mathcal{C}(#1)}
\newcommand{\freegrpd}[1]{\mathcal{G}(#1)}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Some tikz macros to typeset diagrams uniformly.

\tikzset{patharrow/.style={double,double equal sign distance,-,font=\scriptsize}}
\tikzset{description/.style={fill=white,inner sep=2pt}}
\tikzset{fib/.style={->>,font=\scriptsize}}

%% Used for extra wide diagrams, e.g. when the label is too large otherwise.
\tikzset{commutative diagrams/column sep/Huge/.initial=18ex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% New theorem environment for conjectures.

\defthm{conj}{Conjecture}{Conjectures}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% The following environment for desiderata should not be there. It is better
%%%% to use the issue tracker for desiderata.

\newenvironment{desiderata}{\begingroup\color{blue}\textbf{Desiderata.}}
{\endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% The following piece of code from tex.stackexchange:
%%%%
%%%% http://tex.stackexchange.com/a/55180/14653
%%%%
%%%% We include it so that inference rules in align environments have enough
%%%% vertical space.

\newlength\minalignvsep

\makeatletter
\def\align@preamble{%
   &\hfil
    \setboxz@h{\@lign$\m@th\displaystyle{##}$}%
    \ifnum\row@>\@ne
    \ifdim\ht\z@>\ht\strutbox@
    \dimen@\ht\z@
    \advance\dimen@\minalignvsep
    \ht\strutbox\dimen@
    \fi\fi
    \strut@
    \ifmeasuring@\savefieldlength@\fi
    \set@field
    \tabskip\z@skip
   &\setboxz@h{\@lign$\m@th\displaystyle{{}##}$}%
    \ifnum\row@>\@ne
    \ifdim\ht\z@>\ht\strutbox@
    \dimen@\ht\z@
    \advance\dimen@\minalignvsep
    \ht\strutbox@\dimen@
    \fi\fi
    \strut@
    \ifmeasuring@\savefieldlength@\fi
    \set@field
    \hfil
    \tabskip\alignsep@
}
\makeatother

\minalignvsep.2em

\allowdisplaybreaks

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\setdescription[1]{itemsep=-0.2em}
