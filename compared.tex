\section{E-systems compared to other systems of type dependency}\label{sec:esys_compared}
In an effort to formalize the simplicial set model of Martin-L\"of type theory
with the univalence axiom, Voevodsky has studied various notions of models of
type theory, taking Cartmell's \emph{contextual categories} as a starting
point. Voevodsky's definition of a \emph{C-system} is equivalent to that of Cartmell
\cite{VV_C-systems_quotients}. There are several techniques of defining 
C-systems: in \cite{VV_Csys_univ}, C-systems are constructed out of a universe
in a category; in \cite{VV_C-systems_quotients}, sub-C-systems and regular
quotients of C-systems are defined; in \cite{VV_C-systems_monad}, a C-system
is constructed out of a monad $R$ on the category of sets and a left $R$-module
with values in $\mathbf{Set}$. 

In \cite{VV_B-systems}, Voevodsky introduced his notion of \emph{B-systems}, which is
an essentially algebraic theory of type dependency with infinitely many sorts 
and operations, and subsequently he showed that there is a full and faithful
functor from the category of C-systems to the category of B0-systems, of which
the image is contained in the subcategory of B-systems. This fact is important at least
for a theoretical reason: it tells us that the conditions of being a B-system
are necessary to axiomatize type dependency. In other words,
this is a theorem that tells us that we need no further axioms. It is
unknown whether the categories of C-systems and B-systems are actually equivalent.
This question would settle the sufficiency of the conditions of being a B-system.

The category of B-systems will be shown to be equivalent to the category of
stratified E-systems. However, we do not arrive at the fact that the functor
$\mathcal{E}:\mathbf{Bsys}\to\mathbf{Esys}$ is full without imposing an additional
condition on the E-homomorphisms. 
To ensure that the category of stratified E-systems with stratified 
E-homomorphisms between them is a full subcategory of the category 
$\mathbf{Esys}$, we will require that the underlying functor of each E-homomorphism
lifts factorizations. It is
important to note that this condition is also algebraic, so that the category
of E-systems remains algebraic.

\subsection{Lifting factorizations}
Recall
that for any morphism $f:X\to Y$ in a category $\cat{C}$ there is a category
$\mathbf{fact}(f)$ of factorizations of $f$. Also, any functor $F:\cat{C}\to\cat{D}$
determines a functor $F_{\mathbf{fact}(f)}:\mathbf{fact}(f)\to\mathbf{fact}(H(f))$
for any morphism $f$ of $\cat{C}$.

\begin{defn}
A functor $F:\cat{C}\to\cat{D}$ is said to
\emph{lift factorizations} if for any $f\in\cat{C}/X$, the functor
$F_{\mathbf{fact}(f)}:\mathbf{fact}(f)\to\mathbf{fact}(F(f))$ is an isomorphism
of categories. 
\end{defn}

\begin{comment}
\begin{rmk}
We may choose the property of lifting factorizations
to involve either an equivalence or an isomorphism of categories. The
isomorphism-version, would say that for every factorization $h'\circ g'$
of $F(f)$ there is a unique factorization $f\jdeq h\circ g$ in $\cat{C}$ such
that $F(g)\jdeq g'$ and $F(h)\jdeq h'$. In the version with equivalences,
the uniqueness is replaced by uniqueness up to isomorphism, and the equalites
are replaced by an isomorphism in $\mathbf{fact}(F(f))$. 

It is easier to state the isomorphism version of lifting factorizations with
inference rules and it might be easier to explain this condition on type theoretical
grounds, although the equivalence version has the advantage of being
categorical (i.e.~invariant under equivalence of categories).

In the present
context, it doesn't matter very much which one we pick: the categories in which
we're interested are all posets.
\end{rmk}
\end{comment}

\begin{eg}
For any slice category $\cat{C}/X$, the forgetful functor $\cat{C}/X\to\cat{C}$
lifts factorizations.
\end{eg}

\begin{defn}
We write $\mathbf{Esys}$ for the category of E-systems where the underlying
functor of each E-homomorphism lifts factorizations.
\end{defn}

\subsection{Stratified E-systems}

In this subsection we define the notion of stratified E-system. Then we show
that the category $\mathbf{Esys_s}$ of stratified E-systems with homomorphisms preserving the
stratification, is a full subcategory of $\mathbf{Esys}$. 

\begin{defn}
A category $\cat{C}$ with terminal object is said to be \emph{stratified} if there exists a 
\emph{stratification functor}
\begin{equation*}
L : \cat{C}\to (\mathbb{N},\geq)
\end{equation*}
such that
\begin{enumerate}
\item $L(X)\jdeq 0$ if and only if $X$ is terminal, and for any $f:X\to Y$ we have
$L(X)\jdeq L(Y)$ if and only if $X\jdeq Y$ and $f\jdeq\catid{X}$. 
\item every morphism $f:X\to Y$ in $\cat{C}_\mathbb{E}$, where $L(X)\jdeq
n+m+1$ and $L(Y)\jdeq n$, has a unique factorization 
\begin{equation*}
\begin{tikzcd}
X \arrow[r,"f_m"] & X_m \arrow[r,"f_{m-1}"] & \cdots \arrow[r,"f_1"] & X_1 \arrow[r,"f_0"] & Y
\end{tikzcd}
\end{equation*}
where $L(X_i)\jdeq n+i$.
\end{enumerate}
A functor $F:\cat{C}\to\cat{D}$ between stratified categories is said to be stratified 
if $L_{\cat{C}}\jdeq L_{\cat{D}}\circ F$. 
\end{defn}

%\begin{rmk}
%The categorical version of being stratified, is that there exists a factofibration
%$L:\cat{C}\to (N,\geq)$ which preserves the terminal object.
%\end{rmk}

\begin{lem}
Any stratified category is a rooted tree.
\end{lem}

\begin{proof}
Let $\cat{C}$ be a stratified category. The root of the tree is going to be the terminal
object of $\cat{C}$. Note that objects of $\cat{C}$ have no automorphisms other
than the identity morphisms. Therefore, to show that $\cat{C}$ is a tree,
it suffices to show that for every object $X$ with $L(X)>0$ there is
a unique object $\eft(X)$ with $L(\eft(X))\jdeq L(X)-1$, with a morphism $X\to \eft(X)$.
The existence follows from the existence of the factorization of $X\to 1$. The 
uniqueness follows from the observation that for any arrow
$X\to Y$ with $L(Y)\jdeq L(X)-1$, we can factorize $X\to 1$ through $Y$. Since
factorizations are unique, we will have $Y\jdeq \eft(X)$. 
\end{proof}

\begin{lem}
The category of small stratified categories is a full subcategory of the category
of small categories with terminal objects and between them functors which lift 
factorizations and preserve the terminal object.
\end{lem}

\begin{proof}
Let $F:\cat{C}\to\cat{D}$ be a functor between stratified categories which lifts
factorizations and 
which preserves terminal objects. We show by induction that $F$ is stratified.
Since $F$ preserves the terminal object, $L(Y)\jdeq 0$ implies $L(F(Y))\jdeq 0$.
Now suppose that for $n\in\mathbb{N}$, we have that $L(\Gamma)\jdeq n$ implies
$L(F(Y))\jdeq n$, and let $X$ be such that $L(X)\jdeq n+1$ with
$p_X:X\to\eft(X)$. Then the poset $\mathbf{fact}(p_X)$ is isomorphic to the
poset $\mathbf{2}$ with two objects, one of which is smaller than the other. By the
assumption that $F$ lifts factorizations, the poset $\mathbf{fact}(F(p_X))$
is also isomorphic to $\mathbf{2}$. Thus, the only factorization
of $F(X)\to\unit$ starts with $F(p_X):H(X)\to F(\eft(X))$, which implies that
$L(F(X))\jdeq n+1$. 
\end{proof}

\begin{rmk}
It is easy to show that a category can only be stratified in at most one way,
and that if a category is stratified, then so are any of its slices. Therefore,
it makes sense to ask for the property that the weakening and substitution
functors in a pre-weakening or pre-substitution system are stratified.
\end{rmk}

\begin{defn}
A pre-E-system is said to be \emph{stratified} if its underlying category is
stratified and if each $W_A$ and $S_x$ is a stratified functor. The category of
stratified pre-E-systems with stratified E-homomorphisms between them is denoted by
$\mathbf{Esys_s}$.
\end{defn}

\begin{cor}\label{lem:strat_full}
The category of stratified pre-E-systems is a full subcategory of the category of
pre-E-systems.
\end{cor}

\subsection{The embedding of B0-systems into pre-E-systems}

Voevodsky distinguishes between pre-B-systems, which is an essentially algebraic theory with
only operations and no equalities; B0-systems, which is an extension of the
essentially algebraic theory of pre-B-systems which ensures that all the operations behave
well with two sets of the operations ($\eft$ and $\ebd$); and B-systems, which extends the 
theory of B0-systems with equalities ensuring that the rest of the operations 
are compatible with each other. Voevodsky, furthermore distinguishes
non-unital and unital versions of these, and noted that not all B-homomorphisms
between unital B-systems are unital. The same distinguishment could be made for 
E-systems by forgetting the projection structure, but we have not been able to construct a
functor from unital B0-systems to unital pre-E-systems. Therefore, we shall only
consider non-unital B0-systems and unital B-systems. In this section we will
recall the definition of non-unital B0-systems and construct a full and faithful
functor from them to the category of pre-E-systems. 

One reason for introducing B-systems by first introducing pre-B-systems is that
it is clear in the definition of pre-B-systems that there are only countably
many operations. Since we are interested in embedding the B-systems into E-systems,
we shall organize the definition of B-systems a bit differently, but of course
the resulting definition of B0-systems and B-systems will be (trivially) 
equivalent.

\begin{defn}
A \emph{B-framework} is a collection of data of the following form:
\begin{enumerate}
\item for all $n\in\mathbb{N}$ two sets $B_n$ and $\tilde{B}_n$. 
\item for all $n\in\mathbb{N}$ maps of the form
\begin{align*}
\eft[n] & : B_{n+1}\to B_n \\
\ebd[n] & : \tilde{B}_n\to B_n.
\end{align*}
For $m,n\in\mathbb{N}$, we denote the composition $\eft[n]\circ\cdots\circ\eft[n+m]:B_{n+m+1}\to B_n$ by $\eft[n]^m$. 
\item $B_0$ is a singleton $\{\pt\}$.
\end{enumerate} 
\end{defn}

\begin{rmk}
Since the indices $n,m\in\mathbb{N}$ can be infered, we will usually omit them
in the infix form of the operators.
\end{rmk}

\begin{defn}
A homomorphism $H:\mathbb{B}\to\mathbb{A}$ of B-frameworks consists of maps
$H_n:B_n\to A_n$ and $\tilde{H}_n:\tilde{B}_n\to\tilde{A}_n$ such that
\begin{align*}
\eft(H(X)) & \jdeq H(\eft(X)) \\
\ebd(\tilde{H}(x)) & \jdeq H(\ebd(x))
\end{align*}
for any $X\in B_n$ and $x\in\tilde{B}_n$. The category of B-frameworks is
denoted by $\mathbf{Bfr}$. 
\end{defn}

\begin{defn}
For every B-framework $\mathbb{B}$ and any $X\in B_n$, there is a B-framework
$\mathbb{B}/X$ given by
\begin{align*}
(B/X)_{m} & \jdeq \{Y\in B_{n+m}\mid\eft^{m}(Y)\jdeq X\}\\
(\tilde{B}/X)_m & \jdeq \{y\in \tilde{B}_{n+m}\mid\eft^m(\ebd(y))\jdeq X\}.
\end{align*}
Also, for any homomorphism $H:\mathbb{B}\to\mathbb{A}$ of B-frameworks and any
$X\in B_n$, there is a homomorphism $H/X:\mathbb{B}/X\to\mathbb{A}/H(X)$
defined in the obvious way.
\end{defn}

\begin{rmk}
Note that for $X\in B_n$ and $Y\in B_{n+m}$ such that $\eft^m(Y)\jdeq X$, 
we have $(\mathbb{B}/X)/Y\cong B/Y$.
\end{rmk}

\begin{defn}
A B0-system $\mathbb{B}$ consists of a B-framework $\mathbb{B}$ and homomorphisms
\begin{align*}
W_{X} & : \mathbb{B}/\eft(X)\to\mathbb{B}/X\\
S_{x} & : \mathbb{B}/\ebd(x)\to\mathbb{B}/\eft(\ebd(x))
\end{align*}
of B-frameworks, for any $X\in B_{n+1}$ and any $x\in\tilde{B}_{n+1}$. 
\end{defn}

\begin{lem}
When $\mathbb{B}$ is a B0-system, then so is each $\mathbb{B}/X$.
\end{lem}

\begin{proof}
Straightforward.
\end{proof}

\begin{defn}
A B0-homomorphism $H:\mathbb{B}\to\mathbb{A}$ is a homomorphism of B-frameworks
for which the diagrams
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\mathbb{B}/X \arrow[r,"H/X"] & \mathbb{A}/H(X) \\
\mathbb{B}/\eft(X) \arrow[u,"W_X"] \arrow[r,swap,"H/\eft(X)"] & \mathbb{A}/\eft(H(X)) \arrow[u,swap,"W_{H(X)}"]
\end{tikzcd}
\end{equation*}
and
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\mathbb{B}/\ebd(x) \arrow[r,"H/\ebd(x)"] \arrow[d,swap,"S_x"] & \mathbb{A}/\ebd(H(X)) \arrow[d,"S_{\tilde{H}(x)}"] \\
\mathbb{B}/\eft(\ebd(x)) \arrow[r,swap,"H/\eft(\ebd(x))"] & \mathbb{A}/\eft(\ebd(H(X)))
\end{tikzcd}
\end{equation*}
of homomorphisms of B-frameworks commute for every 
$X\in B_n$ and $x\in\tilde{B}_n$. The category of B0-systems is denoted
by $\mathbf{B0sys}$.
\end{defn}

Now that we have defined the category of B0systems, we can start defining the
embedding into pre-E-systems.

\begin{defn}
Let $\mathbb{B}$ be a B-framework. Then $\mathbb{B}$ determines
a stratified category $U(\mathbb{B})$. Also, any homomorphism of B-frameworks
determines a stratified functor.
\end{defn}

\begin{constr}
The set of objects of $U(\mathbb{B})$ is taken to be the set
$\bigsqcup_{(n\in\mathbb{N})}B_n$. Now we define
$(k,X)\leq (n,Y)$ if and only if $n\leq k$ and $\eft[n]^{k-n}(X)\jdeq Y$.
In other words, we only have $(n+m,X)\leq (n,\eft^m(X))$. It is immediate from
this definition that for any $X\in B_{n+1}$ there is a unique $\Gamma\in
B_n$ such that $(n+1,X)\leq (n,\Gamma)$, so $U(\mathbb{B})$ is stratified.

To show that the functor $U(H):U(\mathbb{B})\to U(\mathbb{A})$ is stratified for
any homomorphism $H:\mathbb{B}\to\mathbb{A}$ of B-frameworks, note that
by \autoref{lem:strat_full} it suffices to show that each $U(H)$ 
lifts factorizations.
Let $H:\mathbb{B}\to\mathbb{A}$ be a homomorphism of B-frameworks, and let
$(m,X):(n+m,X)\leq (n,\Gamma)$. Then the category $\mathbf{fact}_{(m,X)}$ of
factorizations of $(m,X)$ is a finite linear order with
$m+1$ elements, and so is the category $\mathbf{fact}_{(m,H(X))}$. 
\end{constr}

\begin{rmk} 
It is in fact the case that $U(\mathbb{B})$ is the free category generated by the
graph with $\bigsqcup_{(n\in\mathbb{N})}B_n$ as the set of vertices, and
for each object of the form $(n+1,X)$ an edge to $(n,\eft[n](X))$. 
Essentially all $U$ does, is forgetting about the term structure 
$\tilde{B}$ of $\mathbb{B}$.

Furthermore, it is useful to note that for any $X\in B_n$, we get an 
isomorphism $U(\mathbb{B}/X)\cong  U(\mathbb{B})/(n,X)$ of rooted trees,
natural in $X$. Therefore we will usually not distinguish between $U(\mathbb{B})/X$
and $U(\mathbb{B})/(n,X)$. 
\end{rmk}

\begin{defn}
Let $\mathbb{B}$ be a B0-system. Then $U(\mathbb{B})$ can be given the structure
of a pre-E-system. We write $\mathcal{E}(\mathbb{B})$ for the resulting
pre-E-system. Thus we get a functor $\mathcal{E}:\mathbf{B0sys}\to\mathbf{Esys_s}$.
\end{defn}

\begin{constr}
We begin by simultaneously defining the term structure and the pre-substitution
structure on $U(\mathbb{B})$ by induction on the natural numbers. More precisely,
for any $m\in\mathbb{N}$ we will define, for any $(n+m,X)\leq (n,\Gamma)$ a set
$T(m,X)$ and for any $x\in T(m,X)$ a homomorphism 
$S_x:\mathbb{B}/X\to\mathbb{B}/\Gamma$ of B-frameworks. Then it follows
immediately that we get stratified functors $U(S_x):U(\mathbb{B})/X\to U(\mathbb{B})/\Gamma$
defining the pre-substitution structure of $\mathcal{E}(\mathbb{B})$.

For $(n,X)\in U(\mathbb{B})$, we define $T(0,X)\defeq
\{\pt[X]\}$ and $S_{\pt[X]}\defeq \catid{\mathbb{B}/X}$. We also define for
$(n+1,X)\leq (n,\Gamma)$ the set $T(1,X)\jdeq\{x\in B_{n+1}\mid \ebd(x)\jdeq X\}$.
Note that for $x\in T(1,X)$, the homomorphism $S_x:\mathbb{B}/X \to\mathbb{B}/\Gamma$
is already assumed to exist, because $\mathbb{B}$ is a B0-system.

For the inductive step, suppose that for $m\in\mathbb{N}$ we have sets $T(m,X)$
for any $(n+m,X)\leq (n,\Gamma)$ and homomorphisms $S_x:\mathbb{B}/X \to \mathbb{B}/\Gamma$
of B-frameworks, for any $x\in T(m,X)$. Then we define
\begin{equation*}
T(m+1,X)\defeq\bigsqcup_{x\in T(m,\eft(X))} T(1,S_x(X)).
\end{equation*}
For $(x,u)\in T(m+1,X)$ we define the homomorphism $S_{(x,u)}:\mathbb{B}/X\to
\mathbb{B}/\Gamma$ as
\begin{equation*}
S_{(x,u)}\defeq S_u\circ S_x/X.
\end{equation*}
It remains to define a pre-weakening structure on $U(\mathbb{B})$. To do this,
it suffices to define homomorphisms $W_{(m,X)}:\mathbb{B}/\Gamma \to\mathbb{B}/X$
of B-frameworks, for any $(n+m,X)\leq (n,\Gamma)$. We define
\begin{equation*}
W_{(m,X)}\defeq W_X\circ\cdots\circ W_{\eft^{m-1}(X)}.\qedhere
\end{equation*}
\end{constr}

\begin{thm}
The functor $\mathcal{E}$ is full and faithful.
\end{thm}

\begin{proof}
We have to show that the map $\mathrm{hom}(\mathbb{B},\mathbb{A})\to
\mathrm{hom}(\mathcal{E}(\mathbb{B}),\mathcal{E}(\mathbb{A}))$ is a bijection
for any two B0-systems $\mathbb{B}$ and $\mathbb{A}$.

To show that this map is injective, suppose $F,G:\mathbb{B}\to\mathbb{A}$ are 
B0-homomorphisms such that $\mathcal{E}(F)\jdeq\mathcal{E}(G)$. Then we have
$F_n(X)\jdeq\mathcal{E}(F)(n,X)\jdeq \mathcal{E}(G)(n,X)\jdeq G_n(X)$ for each
object $x\in B_n$. Also, we have $\tilde{F}_n(x)\jdeq T_{\mathcal{E}(F)}(n,x)
\jdeq T_{\mathcal{E}(G)}(n,x)\jdeq \tilde{G}_n(x)$ for each
$x\in\tilde{B}_n$. This shows that $F\jdeq G$, so we conclude that $\mathcal{E}$
is faithful.  

To show that the map $\mathrm{hom}(\mathbb{B},\mathbb{A})\to
\mathrm{hom}(\mathcal{E}(\mathbb{B}),\mathcal{E}(\mathbb{A}))$ 
is surjective, let $H:\mathcal{E}(\mathbb{B})\to
\mathcal{E}(\mathbb{A})$. Since both $\mathcal{E}(\mathbb{B})$ and
$\mathcal{E}(\mathbb{A})$ are stratified, we get from
\autoref{lem:strat_full} that $H$ is a stratified pre-E-homomorphism. 
Because $H$ is stratified, we get maps $H_n:B_n\to A_n$ for any $n\in\mathbb{N}$.
The term structure of $H$ gives maps $\tilde{H}_n:
\tilde{B}_n\to\tilde{A}_n$. This defines a B0-homomorphism since $H$ 
preserves the pre-weakening and pre-substitution structures of $\mathcal{E}(\mathbb{B})$.
It is immediate from the definition of $H_n$ and
$\tilde{H}_n$ that this B0-homomorphism is mapped back to $H$, so we conclude
that $\mathcal{E}$ is full.
\end{proof}

\subsection{B-systems are stratified E-systems}
There are two properties which hold for pre-E-systems of the form $\mathcal{E}
(\mathbb{B})$ for some B0-system $\mathbb{B}$, 
which stand in the way of proving that the category of stratified
pre-E-systems is equivalent to the category of B0-systems. The first is that
for any $A\in U(\mathbb{B})/\Gamma$ and $P\in U(\mathbb{B})/\ctxext{\Gamma}{A}$,
we have an isomorphism $T(\ctxext{A}{P})\cong\bigsqcup_{x\in T(A)}T(S_x(P))$.
The second, which depends on the first, is that for any $(x,u)\in T(\ctxext{A}{P})$
we have $S(x,u)\jdeq S_u\circ S_x/P$. In other words, both the term structure
and the pre-substitution structure of $\mathcal{E}(\mathbb{B})$ are compatible
with the categorical structure of the underlying category $U(\mathbb{B})$.
However, to prove the corresponding facts for E-systems, we needed the full
set of conditions on unital E-systems: to prove that the term structure of
$U(\mathbb{B})$ is compatible with composition we needed units, and to prove 
that the operations $S_x$ are compatible with the pairing function we needed
that they are E-homomorphisms. 

Presumably, we can assume these compatibility conditions on pre-E-systems in order
to prove the desired equivalence of B0-systems and stratified pre-E-systems. However,
that seems somewhat unnatural, especially given that they automatically hold
for E-systems. Thus, for the remainder of this section we set out to show that
the category of unital B-systems is equivalent to the category of stratified 
unital E-systems.

\begin{defn}
A unital B0-system is a B0-system with maps
\begin{equation*}
\delta_n : B_{n+1}\to \tilde{B}_{n+2}.
\end{equation*}
such that $\ebd(\delta_n(X))\jdeq W_{X}(X)$ for any $X\in B_n$. 
A B0-homomorphism $H$ is said to be unital if one has
\begin{equation*}
H(\delta(X))\jdeq\delta(H(X))
\end{equation*}
for any $X\in B_n$.  
\end{defn}

\begin{rmk}
Voevodsky showed in \cite{VV_B-systems} that the category of unital B0-systems
with unital B0-homomorphisms between them is not a full
subcategory of $\mathbf{B0sys}$. 
\end{rmk}

\begin{defn}
A \emph{(unital) B-system} is a B0-system for which the following conditions
hold:
\begin{enumerate}
\item Every $W_X$ and $S_x$ is a unital B0-homomorphism.
\item For every $x\in \tilde{B}_{n+1}$ one has $S_x\circ W_{\ebd(x)}\jdeq
\catid{\mathbb{B}/\eft(\ebd(x))}$. 
\item For every $x\in\tilde{B}_{n+1}$ one has $S_x(\delta(\ebd(x)))\jdeq x$.
\item For every $X\in B_{n+1}$ one has $S_{\delta(X)}\circ W_X/X\jdeq
\catid{\mathbb{B}/X}$. 
\end{enumerate}
\emph{B-homomorphisms} are unital B0-homomorphisms between B-systems.
We denote the category of B-systems by $\mathbf{Bsys}$. 
\end{defn}

\begin{lem}
For any non-unital B-system $\mathbb{B}$, $\mathcal{E}(\mathbb{B})$ is a 
stratified non-unital E-system. 
\end{lem}

\begin{proof}
Straightforward.
\end{proof}

\begin{defn}
For any unital B-system $\mathbb{B}$, $\mathcal{E}(\mathbb{B})$ has a
projection structure. We thus obtain a functor 
$\mathcal{E}:\mathbf{Bsys}\to\mathbf{Esys}$ from unital B-systems to E-systems.
\end{defn}

\begin{constr}
We first need to extend the functor $\mathcal{E}:\mathbf{B0sys}\to\mathbf{Esys_p}$
from non-unital B0-systems to non-unital pre-E-systems, to a functor from
unital B-systems to E-systems.

We need to give $\mathcal{E}(\mathbb{B})$ the structure of a unital
pre-E-system. We construct by induction on $m\in \mathbb{N}$, a term of type 
$T(m,W_{(m,X)}(X))$ with the property that that 
\begin{equation*}
S_{\tfid{(m,X)}}\circ W_{(m,X)}/X\jdeq\catid{U(\mathbb{B})/X},
\end{equation*} 
for every $(n+m,X)\leq (n,\Gamma)$ by induction on $m$. The extra
condition is part of the inductive construction, because we need it on the way.

For $m\jdeq 0$ we have but one
choice, and for $m\jdeq 1$ we can directly use the unital structure of
$\mathbb{B}$. For the inductive step, recall that
\begin{equation*}
T(m+1,W_{(m+1,X)}(X))\jdeq\bigsqcup_{x\in T(m,W_{(m+1,X)}(\eft(X)))}T(1,S_x(W_{(m+1,X)}(X))).
\end{equation*}
We have the term $x\defeq \tilde{W}_X(\tfid{(m,\eft(X))})\in T(m,W_{(m+1,X)}(\eft(X)))$.
Now we may observe that 
\begin{align*}
S_x(W_{(m+1,X)}(X))
  & \jdeq 
S_{\tilde{W}_X(\tfid{(m,\eft(X))})}(W_{(m+1,X)}(X))\\
  & \jdeq 
S_{\tilde{W}_X(\tfid{(m,\eft(X))})}(W_X(W_{(m,\eft(X))}(X))) \\
  & \jdeq
W_{X}(S_{\tfid{(m,\eft(X))}}(W_{(m,\eft(X))}(X))) \\
  & \jdeq 
W_{X}(X).
\end{align*}
Therefore, we see that $T(1,S_x(W_{(m+1,X)}(X)))\jdeq T(1,W_X(X))$, where we can
choose the term $\delta(X)$. Thus, we define
\begin{equation*}
\tfid{(m+1,X)}\defeq (\tilde{W}_X(\tfid{(m,\eft(X))}),\delta(X))
\end{equation*} 
for $m\geq 1$. Now we need to check that $S_{\tfid{(m+1,X)}}\circ 
W_{(m+1,X)}/X\jdeq \catid{U(\mathbb{B})/X}$. This is indeed the case:
\begin{align*}
S_{\tfid{(m+1,X)}}\circ W_{(m+1,X)}/X
  & \jdeq
S_{\delta(X)}\circ S_{\tilde{W}_X(\tfid{(m,\eft(X))})}\circ W_{(m+1,X)}/X \\
  & \jdeq
S_{\delta(X)}\circ W_X/X \\
  & \jdeq
\catid{U(\mathbb{B})/X}.
\end{align*}
This finishes the definition of the pre-projection structure on $\mathcal{E}(\mathbb{B})$.
Straightforward proves by induction give that each $W_{(m,X)}$ and $S_x$ is a 
pre-projection homomorphism and that $S_x(\tfid{(m,X)})\jdeq x$, for any 
$x\in T(m,X)$.
\end{constr}

\begin{thm}
The functor $\mathcal{E}:\mathbf{Bsys}\to\mathbf{Esys}$ lifts to an equivalence
to the subcategory $\mathbf{Esys_s}$ of stratified E-systems: i.e.~we have a
commuting diagram
\begin{equation*}
\begin{tikzcd}
& \mathbf{Esys_s} \arrow[dr,"\subseteq"]\\
\mathbf{Bsys} \arrow[ur,"\simeq"] \arrow[rr,swap,"\mathcal{E}"] & & \mathbf{Esys}
\end{tikzcd}
\end{equation*}
\end{thm}

\begin{proof}
We already have shown that $\mathcal{E}$ factors through the stratified
E-systems and that it is full and faithful, so it remains
to show that every stratified E-system is in the image of $\mathcal{E}$. In
other words, for every stratified E-system $\mathbb{E}$ we need to construct
a B0-system $\mathbb{B}$ such that $\mathcal{E}(\mathbb{B})\cong\mathbb{E}$. 

Let $\mathbb{E}$ be a stratified E-system. From the stratification functor
$L:\mathbb{C}_{\mathbb{E}}\to (\mathbb{N},\geq)$ we obtain the pre-image
presheaf $B(\mathbb{E}):\op{(\mathbb{N},\leq)}\to\mathbf{Set}$ given by
\begin{align*}
B(\mathbb{E})_n & \defeq \{X\in\mathrm{Ob}(\mathbb{C}_{\mathbb{E}})\mid L(X)\jdeq n\}
\end{align*}
and $\eft(X)\defeq\mathrm{cod}(p_X)$. We define the term structure of $B(\mathbb{E})_n$
to be given by
\begin{equation*}
\tilde{B}(\mathbb{E})_n \defeq \bigsqcup_{X\in B(\mathbb{E})_n} T(p_X)
\end{equation*}
with the projection map $\ebd[n]\defeq\pi_1:\tilde{B}(\mathbb{E})_n\to B(\mathbb{E})_n$.
This defines the B-framework $B(\mathbb{E})$, and we obtain a functor
$B:\mathbf{Esys_s}\to\mathbf{B0sys}$. It is immediate that we get isomorphisms
$U(B(\mathbb{E}))\cong\cat{F}_{\mathbb{E}}$, natural in $\mathbb{E}$. Also, we
get natural isomorphisms $B(\mathbb{E}/\Gamma)\cong B(\mathbb{E})/\Gamma$. 

The weakening and substitution structures on
$B(\mathbb{E})$ are given by $W_X\defeq B(W_{p_X})$ and $S_{(X,x)}\defeq B(S_x)$,
respectively. Since these functors are assumed to be stratified, they define
homomorphisms of B-frameworks. Because a weakening system of an E-system is
required to be functorial, i.e.~$W_{\ctxext{A}{P}}\jdeq W_P\circ W_A$ and
$W_{\catid{\Gamma}}\jdeq\catid{\cat{F}_{\mathbb{E}}/\Gamma}$, it follows
immediately that the weakening structure on $U(B(\mathbb{E}))$ is isomorphic to
that of $\mathbb{E}$. 
\end{proof}

\begin{comment}
In the following definition $\Delta(X)$ denotes the discrete category on the set
$X$ and $\mathbf{2}$ is the category $s\to t$.
\begin{defn}
Define $\mathbb{S}$ to be the pushout
\begin{equation*}
\begin{tikzcd}[column sep=large]
\Delta(\mathbb{N}) \arrow[r,"{n\mapsto(n,s)}"] \arrow[d,swap,"i"] & \Delta(\mathbb{N})\times\mathbf{2} \arrow[d] \\
(\mathbb{N},\leq) \arrow[r] & \mathbb{S}
\end{tikzcd}
\end{equation*}
in $\mathbf{Cat}$.
\end{defn}

Note that for any $n\in\mathbb{N}$, we have the map $S^n := (m\mapsto m+n)$ which
is monotone. By the universal property of pushouts, we obtain a functor $\sigma^n:\mathbb{S}\to\mathbb{S}$
given by
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\Delta(\mathbb{N}) 
  \arrow[r,"{n\mapsto(n,s)}"] 
  \arrow[d,swap,"i"] 
  & 
\Delta(\mathbb{N})\times\mathbf{2} 
  \arrow[d]
  \arrow[r,"{\Delta(S^n)\times\catid{\mathbf{2}}}"]
  &
\Delta(\mathbb{N})\times\mathbf{2}
  \arrow[dd]
  \\
(\mathbb{N},\leq) 
  \arrow[r] 
  \arrow[d,swap,"{(S^n,\leq)}"]
  & 
\mathbb{S}
  \arrow[dr,densely dotted,yshift=.5ex,"\sigma^n"]
  \\
(\mathbb{N},\leq)
  \arrow[rr] & &
\mathbb{S}
\end{tikzcd}
\end{equation*}

\begin{defn}
A non-unital pre-B0-system is a presheaf $B$ on $\mathbb{S}$ such that $B(0)$ is
a singleton, and the following additional structure:
\begin{enumerate}
\item For any $n\in\mathbb{N}$ and $X\in B(n)$, write $B/X$ for the sub-presheaf
of $B\circ\sigma^n$ given by $B/X(0)=\{X\}$ and $B/X(n+1)=B_{n\leq n+1}^{-1}(B/X(n))$. 
We require that for any $n\in\mathbb{N}$ and any $A\in B(n+1)$, there is a 
natural transformation $W_A:B/(B_{n\leq n+1}(A))\Rightarrow B/A$.
\end{enumerate}
\end{defn}
\end{comment}

\subsection{Comprehension categories and categories with families}
In this section we recall Dybjer's notion of categories with families and we
introduce the equivalent notion of D-systems. After having proved that categories with families
are the same things as D-systems, we will focus on constructing a canonical functor from
D-systems to E'-systems, in which the category $\cat{F}$ of families has contexts
as objects and compositions of projections as morphisms. There is no reason why
this category should possess a terminal object, so we naturally have to retreat
to E'-systems without empty contex. However, the construction of a
canonical functor in which families are represented by compositions of projections
is still not possible without a further coherence condition. To make sure that
the pullback operations of a D-system extend to the category
$\cat{F}$, we introduce \emph{coherent} D-systems. So we only have a functor $U$
from the category $\mathbf{Dsys}$ of coherent D-systems to the category
$\mathbf{E'sys_{\circ}}$ of E'-systems without empty context.
We see that it is not evident at all to turn categories with families into
E-systems, even if we ignore the issue that categories with families map
naturally into E'-systems without empty context.
Thus it seems that the type theories of categories with families and of E-systems
are not directly comparable.

We end this section by showing that the functor 
$U:\mathbf{Dsys}\to\mathbf{E'sys_{\circ}}$ restricts to a full and faithful 
functor on the coherent D-systems which satisfy the condition that every 
composition of projections is a composition of projections in precisely one way.
We call coherent D-systems with this property
locally well-founded. Among the locally well-founded D-systems are the B-systems.
As a by-product, we get that the full and faithful functor from B-systems to
E-systems factors through D-systems. 

\begin{defn}
Let $p:\cat{E}\to\cat{B}$ be a functor and let $f:\Delta\to \Gamma$ be a morphism in $\cat{B}$.
A morphism $g:A\to B$ in $\cat{E}$ is said to be \emph{cartesian over $f$}, if
\begin{enumerate}
\item $p(g)\jdeq f$, and 
\item For all $g':A'\to B$ with $p(g')\jdeq f$, there is a unique $u:A'\to A$
such that $g'=g\circ u$ and $p(u)\jdeq\catid{\Delta}$. 
\end{enumerate}
Dually, a morphism $g:A\to B$ in $\cat{E}$ is said to be \emph{cocartesian over
$f$}, if
\begin{enumerate}
\item $p(g)\jdeq f$, and
\item For all $g':A\to B'$ with $p(g')\jdeq f$, there is a unique $v:B\to B'$
such that $g'=v\circ g$ and $p(v)\jdeq\catid{\Gamma}$. 
\end{enumerate}
A (co)cartesian morphism over $f$ is also called a \emph{(co)cartesian lift of $f$}.
\end{defn}

\begin{defn}
A functor $p:\cat{E}\to\cat{B}$ is called a \emph{Grothendieck fibration} if
every morphism into an object of the form $p(A)$ for some object $A$ of $\cat{E}$ 
has a cartesian lift, and cartesian morphisms are closed under composition.
\end{defn}

\begin{defn}
A Grothendieck fibration $p:\cat{E}\to\cat{B}$ is said to be \emph{split}, if
there is a functorial choice of cartesian lifts, i.e.~for every $f:\Delta\to \Gamma$ in 
$\cat{B}$ and any $B\in \cat{E}$ such that $p(B)\jdeq \Delta$,
there is a cartesian lift $j(B,g):A \to B$ for some object $A$ of $\cat{E}$, such that 
$j(B,p(B))\jdeq\catid{B}$ and $j(B, g\circ h)\jdeq j(B,g)\circ j(\mathrm{dom}(j(B,g)),h)$.
\end{defn}

\begin{eg}
For any presheaf $P:\cat{C}\to\mathbb{Set}$, the projection functor
$\int_\cat{C} P\to\cat{C}$ is a Grothendieck fibration.
\end{eg}

\begin{defn}
A comprehension category $\mathcal{P}$ consists of categories $\cat{E}$, $\cat{C}$ and a
commuting triangle
\begin{equation*}
\begin{tikzcd}
\cat{E} \arrow[rr,"\mathcal{P}"] \arrow[dr,swap,"p"] & & \cat{C}^{\to} \arrow[dl,"\mathrm{cod}"] \\
& \cat{C}
\end{tikzcd}
\end{equation*}
of functors, such that $p$ is a Grothendieck fibration, and $\mathcal{P}$ maps
cartesian morphisms in $\cat{E}$ to pullback squares in $\cat{C}$. We say that
$\mathcal{P}$ is a full comprehension category if the functor $\mathcal{P}:
\cat{E}\to\cat{C}^{\to}$ is full and faithful; and we say that
$\mathcal{P}$ is split if $p$ is split.
\end{defn}

We now recall the notion of categories with families, which forms a class of
examples of comprehension categories. 

\begin{defn}
A \emph{category with families} consists of
\begin{enumerate}
\item A category $\cat{C}$ with a terminal object $1$.
\item A presheaf $\mathrm{Ty}:\op{\cat{C}}\to\mathbf{Set}$. We will write
$f_\ast(A)$ for $\mathrm{Ty}(f,A)$.
\item For any $A\in\mathrm{Ty}(\Gamma)$, a morphism
\begin{equation*}
p_A : \ctxext{\Gamma}{A}\twoheadrightarrow \Gamma
\end{equation*}
in $\cat{C}$.
\item a preasheaf $\mathrm{Tm}:\op{(\int_\cat{C}\mathrm{Ty})}\to\mathbf{Set}$.
The action of a morphism $f:(\Delta,f_\ast(A))\to(\Gamma,A)$ of $\int_\cat{C}\mathrm{Ty}$
on a term $x\in \mathrm{Tm}(A)$ is also written by $f_\ast(x)$.
\item a term $\delta_A\in\mathrm{Tm}(\ctxext{\Gamma}{A},(p_A)_\ast(A))$ for every
$A\in\mathrm{Ty}(\Gamma)$, 
\end{enumerate}
with the universal property that for every $f:\Delta\to\Gamma$ in $\cat{C}$, 
the function
\begin{equation*}
\theta\mapsto\theta_\ast(\delta_A)
  : \{\theta:\Delta\to\ctxext{\Gamma}{A}\mid p_A\circ\theta\jdeq f\}\to
    \mathrm{Tm}(f_\ast(A))
\end{equation*}
is a bijection. We denote the inverse of this map by $\mu_{A,f}$. 
\end{defn}

There are of course many more sensible examples of categories with families,
but the following class of examples causes us to doubt whether it is possible
at all to have a faithful functor from the category of categories
with families to the category of E-systems. 

\begin{eg}
Every category $\cat{C}$ with a terminal object and the empty presheaf 
$\mathrm{Ty}$, is a category with families.
\end{eg}

\begin{rmk}
Although a terminal object is usually assumed to exist, not every object 
of a D-system is assumed to be `fibrant', i.e.~it is
not the case that every $X\to 1$ is a composition of projections $p_A$.
We could only hope that there is a functor from D-sytems to E-systems without
terminal objects.
\end{rmk}

There is essentially only one choice for the presheaf $\mathrm{Tm}$ and the
term $\delta_A$, so the extra structure on a setup for categories with families
is determined essentially uniquely once it exists. In other words, being a
category with families is a property on setups for categories with families.

\begin{defn}\label{lem:cwf_to_dsys}
Let $\mathbb{D}$ be a category with families. Then there is a natural isomorphism
\begin{equation*}
\varphi_A:\mathrm{Tm}(A)\cong\{\theta:\Gamma\to\ctxext{\Gamma}{A}\mid p_A\circ\theta\jdeq\catid{\Gamma}\}
\end{equation*}
in the presheaf category $\mathrm{Psh}(\int_{\cat{C}}\mathrm{Ty})$. 
\begin{comment}
The
natural isomorphism $\varphi$ is such that the term $\delta_A\in\mathrm{Tm}((p_A)_\ast(A))$
corresponds to the unique arrow $\tilde{q}_A$ which fits in the diagram
\begin{equation*}
\begin{tikzcd}
\ctxext{\Gamma}{A} \arrow[ddr,bend right=15,equals] \arrow[drr,bend left=15,equals] \arrow[dr,"{\tilde \delta_A}"] \\
& \ctxext{{\Gamma}{A}}{(p_A)_\ast(A)} \arrow[d,fib] & \ctxext{\Gamma}{A} \arrow[d,fib] \\
& \ctxext{\Gamma}{A} \arrow[r,"{p_A}"] & \Gamma
\end{tikzcd}
\end{equation*}
\end{comment}
\end{defn}

\begin{constr}
We define the inverse of $\varphi_A$ by $\theta\mapsto\theta_\ast(\delta_A)$. Verifying
that these form a natural isomorphism is straightforward.
\end{constr}

The definition of D-system we give below, is practically the same as the definition
of category with attributes in \cite[Definition 3.10]{Hofmann_syntax_semantics}.
Following Voevodsky, we wish to reserve the word `category' for usage in mathematical terms
for notions which are `categorical' in the sense of being invariant under 
equivalence of categories. The definition of categories with attributes involves
an equality of functors (which would have to be replaced by a natural 
isomorphism), so it is at least not obviously categorical.

\begin{defn}
A \emph{D-system} (a category with attributes, see \cite{Hofmann_syntax_semantics}) consists of
\begin{enumerate}
\item A category $\cat{C}$ with a terminal object $1$.
\item A presheaf $\mathrm{Ty}:\op{\cat{C}}\to\mathbf{Set}$. 
\item A commuting triangle
\begin{equation*}
\begin{tikzcd}
\int_{\cat{C}}\mathrm{Ty} \arrow[rr,"p"] \arrow[dr,"\pi"] & & \cat{C}^\square \arrow[dl,"\mathrm{cod}"] \\
& \cat{C}
\end{tikzcd}
\end{equation*}
of functors, where $\cat{C}^\square$ is the sub-pre-category of $\cat{C}^{\to}$ of
which the morphisms are pullback squares. For any $A\in\mathrm{Ty}(\Gamma)$,
the morphism $p(\Gamma,A)$ will be denoted by $p_A$; for any
$(f,A):(\Delta,f_\ast(A))\to(\Gamma,A)$ in $\int_{\cat{C}}\mathrm{Ty}$, the top
morphism of the pullback square $p(f,A)$ will be denoted by $\pi_2(f,A)$.
\end{enumerate}
\end{defn}

\begin{rmk}
For any $f:\Delta\to\Gamma$, $g:X\to\Delta$ and $A\in\mathrm{Ty}(\Gamma)$ in a
D-system $\mathbb{D}$, one has 
$\pi_2(\catid{\Gamma},A)\jdeq\catid{\ctxext{\Gamma}{A}}$ and
$\pi_2(f\circ g,A)\jdeq \pi_2(f,A)\circ\pi_2(g,f_\ast(A))$.
\end{rmk}

\begin{defn}
A \emph{D-homomorphism from $\mathbb{D}\to\mathbb{D}'$} consists of a functor 
$\mathcal{F}:\cat{C}\to\cat{C}'$ which maps the terminal object of
$\cat{C}$ to the terminal object of $\cat{C}'$, and a natural transformation
$\tau:\mathrm{Ty}\Rightarrow\mathrm{Ty}'\circ\mathcal{F}$, such that 
$\mathcal{F}(p_A)\jdeq p_{\mathcal{F}(A)}$ for any
$A\in\mathrm{Ty}(\Gamma)$, and $\mathcal{F}(\pi_2(f,A))\jdeq
\pi_2(\mathcal{F}(f),\tau_\Gamma(A))$ for any $f:\Delta\to\Gamma$ in $\cat{C}$ and
any $A\in\mathrm{Ty}(\Gamma)$. 
\end{defn}

The following lemma restates the last condition under the assumption that
$\mathcal{F}$ preserves \emph{all} finite limits. Note that
in the definition of D-homomorphism, the underlying functor is only
required to preserve the pullbacks of the projections, of which there may be
none.

\begin{lem}
Suppose $\mathbb{D}$ and $\mathbb{D}'$ are D-systems with underlying categories
$\cat{C}$ and $\cat{C}'$, respectively. Then a pair consisting of a finite
limit preserving functor
$\mathcal{F}:\cat{C}\to\cat{C}'$ and a natural transformation
$\tau:\mathrm{Ty}\to \mathrm{Ty'}\circ\mathcal{F}$ is a D-homomorphism if and
only if $\mathcal{F}$ preserves the terminal object on the nose and the induced
square
\begin{equation*}
\begin{tikzcd}
\int_{\cat{C}}\mathrm{Ty} \arrow[r,"p"] \arrow[d,swap,"{\int_{\mathcal{F}}\tau}"] & \cat{C}^{\square} \arrow[d,"\mathcal{F}^\square"] \\
\int_{\cat{C}'}\mathrm{Ty}' \arrow[r,"{p'}"] & {\cat{C}'}^\square
\end{tikzcd}
\end{equation*}
commutes.
\end{lem}

\begin{proof}
Straightforward.
\end{proof}

%\begin{lem}
%In the definition of D-system, the assumed structure beyond a choice of
%projections $p_A:\ctxext{\Gamma}{A}\twoheadrightarrow\Gamma$ is property-like.
%\end{lem}

The following theorem is due to Hofmann, \cite[section 3.2]{Hofmann_syntax_semantics}. 
%In the proof that every category with families is a D-system, we
%outline the successive steps. The omitted details are marked as omitted, and
%they are straightforward to fill in.

\begin{thm}\label{thm:DD}
The category of categories with families is equivalent to the category of 
D-systems.\hfill$\square$
\end{thm}

\begin{comment}
Since this theorem basically asserts that a category with families is a
comprehension category

\begin{proof}[Outline of the proof]
Let $\mathbf{CWF}$ be a category with families. The fact that $\mathbf{CWF}$ is
a D-system can be shown by proving each of the assertions in the following six 
steps.
\begin{enumerate}
\item For every $f:\Delta\to\Gamma$ and $A\in\mathrm{Ty}(\Gamma)$, there is an
isomorphism
\begin{equation*}
\zeta_{A,f}:\{\theta:\Delta\to\ctxext{\Gamma}{A}\mid p_A\circ\theta\jdeq f\}
  \cong
\{\eta:\Delta\to\ctxext{\Delta}{f_\ast(A)}\mid p_{f_\ast(A)}\circ\eta\jdeq\catid{\Delta}\}
\end{equation*}
natural in $f$ in the sense that the equalities
\begin{align*}
\zeta_{A,\catid{\Gamma}}(\theta) & \jdeq \theta \\
\zeta_{A,f\circ g}(\theta\circ g) & \jdeq \zeta_{f_\ast(A),g}(\zeta_{A,f}(\theta)\circ g)
\end{align*}
hold for any $f:\Delta\to\Gamma$ and $g:X\to\Delta$, and any $\theta:\Delta\to\ctxext{\Gamma}{A}$
such that $p_A\circ\theta\jdeq f$.
Furthermore, we get $\zeta_{A,p_A}(\catid{\ctxext{\Gamma}{A}})\jdeq\varphi_{(p_A)_\ast(A)}(\delta_A)$.

\medskip
(Proof omitted).
\begin{comment}
By \autoref{lem:cwf_to_dsys} we may define
\begin{equation*}
\zeta_{A,f}(\theta)\defeq \varphi_{f_\ast(A)}(\theta_\ast(\delta_A))
\end{equation*}
for any $\theta\in\{\theta:\Delta\to\ctxext{\Gamma}{A}\mid p_A\circ\theta\jdeq f\}$. 
Since $\zeta_{A,f}$ is a composition of isomorphism, it is itself an isomorphism.
Also, we get immediately that $\zeta_{A,\catid{\Gamma}}(\theta)\jdeq\theta$. To
show the remaining identity:
\begin{align*}
\zeta_{A,f\circ g}(\theta\circ g)
& \jdeq \varphi_{g_\ast(f_\ast(A))}((\theta\circ g)_\ast(\delta_A)) \\
& \jdeq \varphi_{g_\ast(f_\ast(A))}(g_\ast(\theta_\ast(\delta_A))) \\
& \jdeq \varphi_{g_\ast(f_\ast(A))}(g_\ast(\varphi_{f_\ast(A)}(\theta_\ast(\delta_A))_\ast(\delta_A))) \\
& \jdeq \varphi_{g_\ast(f_\ast(A))}(g_\ast(\zeta_{A,f}(\theta)_\ast(\delta_A))) \\
& \jdeq \varphi_{g_\ast(f_\ast(A))}((\zeta_{A,f}(\theta)\circ g)_\ast(\delta_A)) \\
& \jdeq \zeta_{f_\ast(A),g}(\zeta_{A,f}(\theta)\circ g).
\end{align*}
This completes the proof that the isomorphisms $\zeta_{A,f}$ satisfy the required
equalities.
\end{comment}

\begin{comment}
\item
For any $A\in\mathrm{Ty}(\Gamma)$, we define
$W_A\defeq (p_A)_\ast:\cat{F}/\Gamma\to\cat{F}/\ctxext{\Gamma}{A}$. Then we get
for any $A,B\in\cat{F}/\Gamma$ an isomorphism
\begin{equation*}
\mathrm{hom}_{\cat{C}/\Gamma}(A,B)
  \cong
T(W_A(B)).
\end{equation*}
In particular, we get a term $\idtm{A}\in T((p_A)_\ast(A))$. 
\medskip

Let $A,B\in\cat{F}/\Gamma$. Then we have the isomorphism
\begin{align*}
T(W_A(B)) & \jdeq \{\eta:\ctxext{\Gamma}{A}\to\ctxext{{\Gamma}{A}}{W_A(B)}\mid W_A(B)\circ\eta\jdeq\catid{\ctxext{\Gamma}{A}}\} \\
  & \cong
\{\theta:\ctxext{\Gamma}{A}\to\ctxext{\Gamma}{B}\mid B\circ\theta\jdeq A\},
\end{align*}
so we find $\idtm{A}\defeq\zeta_{A,A}(\catid{\ctxext{\Gamma}{A}})\in T(W_A(A))$.

\item For any $A\in\mathrm{Ty}(\Gamma)$ and $f:\Delta\to\Gamma$ 
there is a morphism $\pi_2(f,A):\ctxext{\Delta}{f_\ast(A)}\to\ctxext{\Gamma}{A}$
such that $p_A\circ \pi_2(f,A)\jdeq f\circ p_{f_\ast(A)}$.

\medskip
(Proof omitted).
\begin{comment}
Note that we have the isomorphism
\begin{align*}
& \{ \theta : \ctxext{\Delta}{f_\ast(A)}\to\ctxext{\Gamma}{A}\mid p_A\circ\theta\jdeq f\circ p_{f_\ast(A)} \} \\
  & \cong
\{ \eta : \ctxext{\Delta}{f_\ast(A)}\to\ctxext{{\Delta}{f_\ast(A)}}{(f\circ p_{f_\ast(A)})_\ast(A)}
  \mid (f\circ p_{f_\ast(A)})_\ast(A)\circ\eta\jdeq\catid{\ctxext{\Delta}{f_\ast(A)}}\} \\
  & \jdeq
\{ \eta : \ctxext{\Delta}{f_\ast(A)}\to\ctxext{{\Delta}{f_\ast(A)}}{(p_{f_\ast(A)})_\ast(f_\ast(A))}
  \mid (f\circ p_{f_\ast(A)})_\ast(A)\circ\eta\jdeq\catid{\ctxext{\Delta}{f_\ast(A)}}\} \\
  & \jdeq
T((p_{f_\ast(A)})_\ast(f_\ast(A))).
\end{align*}
Since we have $\delta_{f_\ast(A)}\in T((p_{f_\ast(A)})_\ast(f_\ast(A)))$, we obtain 
\begin{equation*}
\pi_2(f,A)\defeq \zeta_{A,f\circ p_{f_\ast(A)}}^{-1}(\delta_{f_\ast(A)}):\ctxext{\Delta}{f_\ast(A)}\to\ctxext{\Gamma}{A}
\end{equation*}
satisfying $p_A\circ\pi_2(f,A)\jdeq f\circ p_{f_\ast(A)}$.
\end{comment}
\begin{comment}
\item For any $f:\Delta\to\Gamma$, $g:X\to\Delta$ and $A\in\mathrm{Ty}(\Gamma)$, one has
\begin{equation*}
\pi_2(f,A)\circ\pi_2(g,f_\ast(A))\jdeq\pi_2(f\circ g,A).
\end{equation*}

\medskip
(Proof omitted).
\begin{comment}
It suffices to show that
\begin{equation*}
\zeta_{A,f\circ g\circ p_{g_\ast(f_\ast(A))}}(\pi_2(f,A)\circ\pi_2(g,f_\ast(A)))\jdeq\delta_{g_\ast(f_\ast(A))}.
\end{equation*}
Because $g\circ p_{g_\ast(f_\ast(A))}\jdeq p_{f_\ast(A)}\circ\pi_2(g,f_\ast(A))$, we get
to use the naturality of $\zeta$:
\begin{align*}
& \zeta_{A,f\circ g\circ p_{g_\ast(f_\ast(A))}}(\pi_2(f,A)\circ\pi_2(g,f_\ast(A))) \\
& \jdeq
\zeta_{A,f\circ p_{f_\ast(A)}\circ\pi_2(g,f_\ast(A))}(\pi_2(f,A)\circ\pi_2(g,f_\ast(A))) \\
& \jdeq
\zeta_{(p_{f_\ast(A)})_\ast(f_\ast(A)),\pi_2(g,f_\ast(A))}(\zeta_{A,f\circ p_{f_\ast(A)}}(\pi_2(f,a))\circ\pi_2(g,f_\ast(A))) \\
& \jdeq
\zeta_{(p_{f_\ast(A)})_\ast(f_\ast(A)),\pi_2(g,f_\ast(A))}(\delta_{f_\ast(A)}\circ\pi_2(g,f_\ast(A))) \\
& \jdeq
\zeta_{(p_{f_\ast(A)})_\ast(f_\ast(A)),\pi_2(g,f_\ast(A))}(\zeta_{f_\ast(A),p_{f_\ast(A)}}(\catid{\ctxext{\Delta}{f_\ast(A)}})\circ\pi_2(g,f_\ast(A))) \\
& \jdeq
\zeta_{f_\ast(A),p_{f_\ast(A)}\circ\pi_2(g,f_\ast(A))}(\catid{\ctxext{\Delta}{f_\ast(A)}}\circ\pi_2(g,f_\ast(A))) \\
& \jdeq
\zeta_{f_\ast(A),p_{f_\ast(A)}\circ\pi_2(g,f_\ast(A))}(\pi_2(g,f_\ast(A))) \\
& \jdeq
\zeta_{f_\ast(A),g\circ p_{g_\ast(f_\ast(A))}}(\pi_2(g,f_\ast(A)))\\
& \jdeq
\delta_{g_\ast(f_\ast(A))}.
\end{align*}
\end{comment}\begin{comment}
\item
Let $f:\Delta\to\Gamma$ and $A\in\mathrm{Ty}(\Gamma)$. Then one has 
\begin{equation*}
\pi_2(f,A)\circ\zeta_{A,f}(\theta)\jdeq\theta
\end{equation*}
for any $\theta:\Delta\to\ctxext{\Gamma}{A}$ satisfying $A\circ\theta\jdeq f$.

\medskip
(Proof omitted).
\begin{comment}
We will write $\tilde\theta\defeq\zeta_{A,f}(\theta)$. Note that
\begin{equation*}
p_A\circ\pi_2(f,A)\circ\tilde\theta\jdeq f\circ p_{f_\ast(A)}\circ\tilde\theta\jdeq f.
\end{equation*} 
Therefore, we can prove that $\pi_2(f,A)\circ\tilde\theta\jdeq\theta$ by showing
that $\zeta_{A,f}(\pi_2(f,A)\circ\tilde\theta)\jdeq\tilde\theta$. This is
shown using the naturality of $\zeta$:
\begin{align*}
\zeta_{A,f}(\pi_2(f,A)\circ\tilde\theta)
  & \jdeq
\zeta_{A,f\circ p_{f_\ast(A)}\circ\tilde\theta}(\pi_2(f,A)\circ\tilde\theta)
  \\
  & \jdeq
\zeta_{(p_{f_\ast(A)})_\ast(f_\ast(A)),\tilde{\theta}}(\zeta_{A,f\circ p_{f_\ast(A)}}(\pi_2(f,A))\circ\tilde\theta)
  \\
  & \jdeq
\zeta_{(p_{f_\ast(A)})_\ast(f_\ast(A)),\tilde{\theta}}(\idtm{f_\ast(A)}\circ\tilde\theta)
  \\
  & \jdeq
\zeta_{(p_{f_\ast(A)})_\ast(f_\ast(A)),\tilde{\theta}}(\zeta_{f_\ast(A),p_{f_\ast(A)}}(\catid{\ctxext{\Delta}{f_\ast(A)}})\circ\tilde\theta)
  \\
  & \jdeq
\zeta_{f_\ast(A),p_{f_\ast(A)}\circ\tilde\theta}(\catid{\ctxext{\Delta}{f_\ast(A)}}\circ\tilde\theta) \\
  & \jdeq
\zeta_{f_\ast(A),\catid{\Delta}}(\tilde\theta) \\
  & \jdeq 
\theta.
\end{align*}
\end{comment}\begin{comment}
\item 
The diagram
\begin{equation*}
\begin{tikzcd}[column sep=large]
\ctxext{\Delta}{f_\ast(A)} \arrow[d,fib] \arrow[r,"{\pi_2(f,A)}"] & \ctxext{\Gamma}{A} \arrow[d,fib] \\
\Delta \arrow[r,"f"] & \Gamma
\end{tikzcd}
\end{equation*}
is a pullback square.

Proof of (vi): To verify the universal mapping property of the pullback square, consider a
commuting diagram
\begin{equation*}
\begin{tikzcd}
X \arrow[d,swap,"g"] \arrow[r,"h"] & \ctxext{\Gamma}{A} \arrow[d,fib] \\
\Delta \arrow[r,"f"] & \Gamma
\end{tikzcd}
\end{equation*}
Then $h$ corresponds uniquely to a section $k$ of $(f\circ g)_\ast(A)$. Since
$(f\circ g)_\ast(A)\jdeq g_\ast(f_\ast(A))$, the section $k$ fits in the
commuting diagram
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\ctxext{X}{g_\ast(f_\ast(A))} \arrow[d,xshift=.7ex,fib] \arrow[r,"{\pi_2(g,f_\ast(A))}"]
& \ctxext{\Delta}{f_\ast(A)} \arrow[d,fib] \arrow[r,"{\pi_2(f,A)}"]
& \ctxext{\Gamma}{A} \arrow[d,fib] \\
X \arrow[r,swap,"g"] \arrow[u,xshift=-.7ex,"k"] & \Delta \arrow[r,swap,"f"] & \Gamma
\end{tikzcd}
\end{equation*}
so we obtain $u\defeq\pi_2(g,f_\ast(A))\circ k:X\to\ctxext{\Delta}{f_\ast(A)}$. 
Then we have $p_{f_\ast(A)}\circ u\jdeq g\circ p_{g_\ast(f_\ast(A))}\circ k\jdeq g$ and
$\pi_2(f,A)\circ u\jdeq \pi_2(f\circ g,A)\circ k\jdeq h$. Note that
$u$ corresponds uniquely to $k$, which corresponds uniquely to $h$, so the
uniqueness of $u$ is automatic.
\end{enumerate}
This completes the proof outline that $\mathbf{CWF}$ is a D-system. 

Now let $\mathbb{D}$ be a D-system. We define the presheaf $\mathrm{Tm}:
\op{(\int_{\cat{C}}\mathrm{Ty})}\to\mathbf{Set}$ by
\begin{equation*}
\mathrm{Tm}(A) \defeq \{x:\Gamma\to\ctxext{\Gamma}{A}\mid p_A\circ x\jdeq \catid{\Gamma}\}.
\end{equation*}
For $f:\Delta\to\Gamma$ and $A\in\mathrm{Ty}(\Gamma)$, we get a function
$x\mapsto f_\ast(x):\mathrm{Tm}(A)\to\mathrm{Tm}(f_\ast(A))$ by defining $f_\ast(x)$
to be the unique morphism such that the diagram
\begin{equation*}
\begin{tikzcd}[column sep=huge] 
\Delta \arrow[ddr,bend right=15,equals] \arrow[drr,bend left=15,"x\circ f"] \arrow[dr,densely dotted,near end,"{f_\ast(x)}"] \\
& \ctxext{\Delta}{f_\ast(A)} \arrow[d,fib] \arrow[r,swap,"{\pi_2(f,A)}"] & \ctxext{\Gamma}{A} \arrow[d,fib] \\
& \Delta \arrow[r,swap,"f"] & \Gamma
\end{tikzcd}
\end{equation*}
commutes. A combination of the assumed uniqueness and the assumed equalities on
$\pi_2(\blank,\blank)$ gives the functoriality of $\mathrm{Tm}$. 

The term $\delta_A\in\mathrm{Tm}((p_A)_\ast(A))$ is defined to be the unique morphism
such that the diagram
\begin{equation*}
\begin{tikzcd}[column sep=large]
\ctxext{\Gamma}{A} \arrow[drr,bend left=15,equals] \arrow[ddr,bend right=15,equals] \arrow[dr,densely dotted,near end,"{\delta_{A}}"] \\
& \ctxext{{\Gamma}{A}}{(p_A)_\ast(A)} \arrow[r,swap,"{\pi_2(A,A)}"] \arrow[d,fib] & \ctxext{\Gamma}{A} \arrow[d,fib] \\
& \ctxext{\Gamma}{A} \arrow[r,swap,"A"] & \Gamma
\end{tikzcd}
\end{equation*}
commutes.

The universality assumption of categories with families is a consequence of
the universal property of pullbacks: the map $x\mapsto\pi_2(f,X)\circ x$
from $\{x:\Delta\to\ctxext{\Delta}{f_\ast(A)}\mid p_{f_\ast(A)}\circ x\jdeq\catid{\Delta}\}$
to $\{\theta:\Delta\to\ctxext{\Gamma}{A}\mid p_A\circ\theta\jdeq f\}$ is a bijection.
\end{proof}
\end{comment}

\begin{eg}
Since any morphism of $\int_{\cat{C}}$ is cartesian, it follows that D-systems
are comprehension categories. As D-systems are built up from a presheaf of types
on the underlying category, they are in fact discrete comprehension categories.
\end{eg}

The following two definitions define subclasses of closed D-systems and 
coherent closed D-systems, and the latter structure is the same as an E'-system
(without empty context). In the next section we will show how to close a comprehension
category, so that it becomes a closed D-system which satisfies an additional coherence condition.

\begin{defn}
Let $\cat{C}$ be a D-system. In this definition, we will write
$\mathrm{Fam}$ for the presheaf of types. The D-system $\cat{C}$
is said to be \emph{closed}, if we have elements $\emptyf[\Gamma]\in
\mathrm{Fam}(\Gamma)$ for each $\Gamma\in\cat{C}$, and maps 
$P\mapsto\ctxext{A}{P}:\mathrm{Fam}(\ctxext{\Gamma}{A})\to \mathrm{Fam}(\Gamma)$
such that
\begin{enumerate}
\item 
\begin{enumerate}
\item for any $A\in\mathrm{Fam}(\Gamma)$, $P\in\mathrm{Fam}(\ctxext{\Gamma}{A})$
and $Q\in\mathrm{Fam}(\ctxext{{\Gamma}{A}}{P})$, one has
\begin{equation*}
\ctxext{{A}{P}}{Q}\jdeq\ctxext{A}{{P}{Q}},
\end{equation*}
\item and for any $A\in\mathrm{Fam}(\Gamma)$, one has
\begin{equation*}
\ctxext{\emptyf[\Gamma]}{A}\jdeq\ctxext{A}{\emptyf[\ctxext{\Gamma}{A}]}\jdeq A,
\end{equation*}
\end{enumerate}
\item 
\begin{enumerate}
\item for any $A\in\mathrm{Fam}(\Gamma)$ and $P\in\mathrm{Fam}(\ctxext{\Gamma}{A})$,
one has
\begin{equation*}
p_{\ctxext{A}{P}}\jdeq p_A\circ p_P,
\end{equation*}
\item and for any $\Gamma\in\cat{C}$ one has
\begin{equation*}
p_{\emptyf[\Gamma]}\jdeq\catid{\Gamma}
\end{equation*}
\end{enumerate}
\item 
\begin{enumerate}
\item for any $A\in\mathrm{Fam}(\Gamma)$, $P\in\mathrm{Fam}(\ctxext{\Gamma}{A})$
and any $f:\Delta\to\Gamma$ in $\cat{C}$, one has
\begin{equation*}
f_\ast(\ctxext{A}{P})\jdeq f_\ast(A)\circ \pi_2(f,A)_\ast(P),
\end{equation*}
\item and for any $f:\Delta\to\Gamma$ in $\cat{C}$, one has
\begin{equation*}
f_\ast(\emptyf[\Gamma])\jdeq\emptyf[\Delta].
\end{equation*}
\end{enumerate}
\end{enumerate} 
\end{defn}

\begin{lem}
A D-system is closed if and only if  the following two conditions hold:
\begin{enumerate}
\item There is a section $\phi:\cat{C}\to \int_{\cat{C}}\mathrm{Ty}$ of $\pi$.
\item For every $P\in\mathrm{Ty}(\ctxext{\Gamma}{A})$,
the morphism $p_A:\ctxext{\Gamma}{A}\to\Gamma$ has a unique cocartesian lift
at $P$.
\end{enumerate}
\end{lem}

\begin{proof}
Let $\mathbb{D}$ be a closed D-system. To show that $\mathbb{D}$ has the two
stated properties:
\begin{enumerate}
\item
\item We have to show that each for $P\in\mathrm{Ty}(\ctxext{\Gamma}{A})$,
the projection $p_A:\ctxext{\Gamma}{A}\to\Gamma$ has a unique cocartesian lift
at $P$. Note that the morphism $(\ctxext{\Gamma}{A},P)\to (\Gamma,\ctxext{A}{P})$
in $\int_{\cat{C}}\mathrm{Ty}$ 
\end{enumerate}

Let $\mathbb{D}$ be a D-system for which the stated two conditions hold. To show
that $\mathbb{D}$ is a closed D-system, we systematically go through each of the
properties:
\begin{enumerate}
\item 
\end{enumerate} 
\end{proof}

\begin{defn}
A closed D-system is said to be \emph{coherent}, if for any $A,A'\in\mathrm{Fam}(\Gamma)$
such that $p_A\jdeq p_{A'}$, and any $f:\Delta\to\Gamma$, we have
$p_{f_\ast(A)}\jdeq p_{f_\ast(A')}$ and $\pi_2(f,A)\jdeq \pi_2(f,A')$.
\end{defn}

\begin{thm}
An E'-system without empty context is the same thing as a coherent closed D-system.
\end{thm}

\begin{proof}
Let $\mathbb{E}$ be an E'-system without empty context. Then we define the
presheaf $\mathrm{Fam}$ on $\cat{C}$ on objects by
\begin{equation*}
\mathrm{Fam}(\Gamma)\defeq \mathrm{Obj}(\cat{F}/\Gamma)
\end{equation*}
and on morphisms by the action on objects of $f_\ast$, for each $f:\Delta\to
\Gamma$ in $\cat{C}$. By condition (b) and (c) in the definition of E'-systems, it
follows that this defines a contravariant functor. 

We define a functor $\mathcal{P}:\int_{\cat{C}}\to\cat{C}^\square$ by sending
the pair $(\Gamma,A)$ to the morphism $A:\ctxext{\Gamma}{A}\to\Gamma$ in
$\cat{C}$, and by sending $f:(\Delta,f_\ast(A))\to (\Gamma,A)$ to the pullback
square
\begin{equation*}
\begin{tikzcd}[column sep=large]
\ctxext{\Delta}{f_\ast(A)} \arrow[d,swap,"{f_\ast(A)}"] \arrow[r,"{\pi_2(f,A)}"] &
\ctxext{\Gamma}{A} \arrow[d,"A"] \\ \Delta \arrow[r,"f"] & \Gamma
\end{tikzcd}
\end{equation*}
This is also functorial because of conditions (b) and (c) in the definition of
E'-systems. Thus, we have defined a D-system
\begin{equation*}
\begin{tikzcd}
\int_{\cat{C}}\mathrm{Fam} \arrow[rr,"{\mathcal{P}}"] \arrow[dr,"{\pi}"] & & \cat{C}^\square \arrow[dl,"{\mathrm{cod}}"] \\ & \cat{C}
\end{tikzcd}
\end{equation*}
and it is straightforward to verify that this D-system is closed and coherent.

Conversely, suppose $\mathbb{D}$ is a closed D-system with underlying category
$\cat{C}$. Define $\cat{F}$ to be the category with the same objects as
$\cat{C}$, and morphisms of the form $p_A$. To check that this forms a category,
note that $p_{\emptyf[\Gamma]}\jdeq\catid{\Gamma}$ and $p_A\circ p_P\jdeq
p_{\ctxext{A}{P}}$.

Now let $f:\Delta\to\Gamma$ be a morphism in $\cat{C}$. For any $A\in\cat{F}/\Gamma$,
we have an element $\tilde{A}\in\mathrm{Fam}(\Gamma)$ such that $p_{\tilde{A}}
\jdeq A$, and we can form a pullback square
\begin{equation*}
\begin{tikzcd}
\ctxext{\Delta}{f_\ast(\tilde{A})} \arrow[r,"\tilde{A}"] \arrow[d,fib,swap,"p_{f_\ast(\tilde{A})}"]
& \ctxext{\Gamma}{\tilde{A}} \arrow[d,fib,"{p_{\tilde{A}}}"] \\
\Delta \arrow[r,"f"] & \Gamma
\end{tikzcd}
\end{equation*}
By the coherence condition, this choice of pullback square does not depend on the
choice of $\tilde{A}$ such that $p_{\tilde{A}}\jdeq A$ (having this fact 
available is precisely what the coherence condition is for). The verification of conditions
(a) to (d) of \autoref{defn:E'sys} is straightforward.
\end{proof}

\subsection{From comprehension categories to E-systems}
To get from comprehension categories to E'-systems without empty contexts, we
need to turn comprehension categories into closed D-systems. 

\begin{defn}
Let $\mathcal{P}$ be a comprehension category. Then we define the pre-category
$\cat{F}$ to be the category with the same objects as $\cat{C}$, of which the
morphisms are generated by the morphisms of the form $P(A)$, for objects
$A\in\cat{E}$. 
\end{defn}

\begin{defn}
Let $\mathcal{P}$ be a comprehension category. Then we define for any 
$\Gamma\in\cat{C}$, the poset $\Lambda(\Gamma)$ to be the category of finite 
sequences  $A_1,\ldots,A_n$ of objects of $\cat{E}$, such that 
$p(A_1)\jdeq\Gamma$ and $p(A_{i+1})\jdeq\mathrm{dom}(\mathcal{P}(A_i))$ 
for any $1\leq i < n$. The partial order on 
$\Lambda(\Gamma)$ is defined by $(A_1,\ldots,A_n)\leq (B_1,\ldots,B_m)$ if and 
only if $n\leq m$ and $A_i\jdeq B_i$ for all $1\leq i\leq n$.

The functor $\mathcal{P}$ induces a functor $\mathcal{P}:\Lambda(\Gamma)\to
\cat{F}/\Gamma$ by $\mathcal{P}(A_1,\ldots,A_n)\jdeq\mathcal{P}(A_1)\circ
\cdots\circ\mathcal{P}(A_n)$.
\end{defn}

\begin{defn}
Let $\mathcal{P}$ be a split comprehension category with choice $j$ of cartesian
lifts. We define a closed D-system
\begin{equation*}
\begin{tikzcd}
\int_{\cat{C}}\Lambda \arrow[rr,"\bar{\mathcal{P}}"] \arrow[dr,swap,"\pi"] & &
\cat{C}^\square \arrow[dl,"\mathrm{cod}"] \\ & \cat{C}
\end{tikzcd}
\end{equation*}
\end{defn}

\begin{constr}
We first define, for any morphism $f_0\defeq f:\Delta\to\Gamma$ of $\cat{C}$,
and for any $A\jdeq (A_1,\ldots,A_n)\in\Lambda(\Gamma)$,
an element $\Lambda(f,A)\in\Lambda(\Delta)$ together with
a morphism $q(f,A):\mathrm{dom}(\mathcal{P}(\Lambda(f,A)))\to 
\mathrm{dom}(\mathcal{P}(A))$. We do this by induction on the length of $A$.

For $n\jdeq 0$, i.e.~if $A$ is the empty sequence, we let $\Lambda(f,A)$ be the 
empty sequence, and $q(f,A) \jdeq f$. For the inductive step, consider a 
sequence $A_1,\ldots,A_{n+1}\in \Lambda(\Gamma)$. Then we define
\begin{align*}
\Lambda(f,A) & \jdeq \mathrm{dom}(j(A_{n+1},q(f,(A_1,\ldots,A_n))))
\intertext{and}
q(f,A) & \jdeq \mathrm{dom}(\mathcal{P}(j(A_{n+1},q(f,(A_1,\ldots,A_n)))))
\end{align*}
where we consider in the definition of $q(f,A)$, $\mathrm{dom}$ to be the 
domain functor from $\cat{C}^{\to}\to\cat{C}$. 

It follows immediately from the definition of comprehension categories and the
pasting lemma of pullbacks, that the square
\begin{equation*}
\begin{tikzcd}[column sep=large]
\mathrm{dom}(\mathcal{P}(\Lambda(f,A))) \arrow[r,"{q(f,A)}"] \arrow[d,swap,"{\mathcal{P}(\Lambda(f,A))}"] & \mathrm{dom}(\mathcal{P}(A)) \arrow[d,"{\mathcal{P}(A)}"] \\
\Delta \arrow[r,"f"] & \Gamma
\end{tikzcd}
\end{equation*}
is a pullback square.

From the above construction we obtain a poset-valued presheaf $\Lambda:\op{\cat{C}}
\to\mathbf{Pos}$, to which we can apply the Grothendieck construction to obtain
the Grothendieck fibration $\pi:\int_{\cat{C}}\Lambda\to\cat{C}$. 
\end{constr}

\begin{comment}
\begin{defn}
Let $f_0\defeq f:\Delta\to\Gamma$ be a morphism of $\cat{C}$, the base category of a
split comprehension category $\mathcal{P}$ wich a choice $j$ of cartesian lifts.
By induction we define an element $\Lambda(f,A)\in\Lambda(\Delta)$ together with
a morphism $q(f,A):\mathrm{dom}(\mathcal{P}(\Lambda(f,A)))\to 
\mathrm{dom}(\mathcal{P}(A))$, for any $A\jdeq (A_1,\ldots,A_n) 
\in\Lambda(\Gamma)$.

For $n\jdeq 0$, i.e.~if $A$ is the empty sequence, we let $\Lambda(f,A)$ be the 
empty sequence, and $q(f,A) \jdeq f$. For the inductive step, consider a 
sequence $A_1,\ldots,A_{n+1}\in \Lambda(\Gamma)$. Then we define
\begin{align*}
\Lambda(f,A) & \jdeq \mathrm{dom}(j(A_{n+1},q(f,(A_1,\ldots,A_n))))
\intertext{and}
q(f,A) & \jdeq \mathrm{dom}(\mathcal{P}(j(A_{n+1},q(f,(A_1,\ldots,A_n)))))
\end{align*}
where we consider in the definition of $q(f,A)$, $\mathrm{dom}$ to be the 
domain functor from $\cat{C}^{\to}\to\cat{C}$. 
\end{defn}

\begin{rmk}
It follows immediately from the definition of comprehension categories and the
pasting lemma of pullbacks, that the square
\begin{equation*}
\begin{tikzcd}[column sep=large]
\mathrm{dom}(\mathcal{P}(\Lambda(f,A))) \arrow[r,"{q(f,A)}"] \arrow[d,swap,"{\mathcal{P}(\Lambda(f,A))}"] & \mathrm{dom}(\mathcal{P}(A)) \arrow[d,"{\mathcal{P}(A)}"] \\
\Delta \arrow[r,"f"] & \Gamma
\end{tikzcd}
\end{equation*}
is a pullback square.
\end{rmk}
\end{comment}

\begin{thm}
Let $\mathcal{P}$ be a comprehension category. Then the following are equivalent:
\begin{enumerate}
\item The choice functors $\Lambda(f)$ and lifts $q(f)$ can be extended to the 
structure of an E'-system without empty context.
\item For any
$A,A'\in\Lambda(\Gamma)$ such that $\mathcal{P}(A)\jdeq\mathcal{P}(A')$
and for any $f:\Delta\to\Gamma$ in $\cat{C}$, the equalities
$\mathcal{P}(\Lambda(f,A))\jdeq\mathcal{P}(\Lambda(f,A'))$ and
$\pi_2(f,A)\jdeq\pi_2(f,A')$ hold. 
\end{enumerate}
\end{thm}

\begin{proof}
Suppose we can extend $\Lambda(f)$ for all $f:\Delta\to\Gamma$, to form commuting
diagrams
\begin{equation*}
\begin{tikzcd}
\Lambda(\Gamma) \arrow[d,swap,"\mathcal{P}"] \arrow[r,"\Lambda(f)"] & \Lambda(\Delta) \arrow[d,"\mathcal{P}"] \\
\cat{F}/\Gamma \arrow[r,densely dotted,"{f_\ast}"] & \cat{F}/\Delta
\end{tikzcd}
\end{equation*}
of functors, forming an E'-system without empty context, where $\mathcal{P}(A)
\defeq \mathcal{P}(A_1)\circ\cdots\circ\mathcal{P}(A_n)$ for any
$A\jdeq (A_1,\ldots,A_n)\in\Lambda(\Gamma)$. Then it must hold that for any
$A,A'\in\Lambda(\Gamma)$ such that $\mathcal{P}(A)\jdeq\mathcal{P}(A')$, we have
$\mathcal{P}(\Lambda(f,A))\jdeq\mathcal{P}(\Lambda(f,A'))$. Also, for such
$A$ and $A'$ it follows from the way $\Lambda(f)$ is defined, 
that $\Lambda(\pi_2(f,A))\jdeq \Lambda(f)/A\jdeq
\Lambda(f)/A' \jdeq \Lambda(\pi_2(f,A'))$, and therefore we also get the equalities
\begin{equation*}
\pi_2(f,A)\jdeq \pi_2(\pi_2(f,A),())\jdeq \pi_2(\pi_2(f,A'),()) \jdeq \pi_2(f,A'),
\end{equation*}
so the desired equality holds.

For the converse, suppose that for all $f:\Delta\to\Gamma$ and $A,A'\in
\Lambda(\Gamma)$ such that $\mathcal{P}(A)\jdeq \mathcal{P}(A')$, one has 
$\mathcal{P}(\Lambda(f,A))\jdeq \mathcal{P}(\Lambda(f,A'))$ and $\pi_2(f,A)\jdeq\pi_2(f,A')$.
Let $f:\Delta\to\Gamma$. By the assumption that $\mathcal{P}(\Lambda(f,A))\jdeq \mathcal{P}(\Lambda(f,A'))$,
it follows that the objects part of $\mathcal{P}\circ\Lambda(f):\Lambda(\Gamma)\to\cat{F}/\Delta$ 
factors through $\mathcal{P}:\Lambda(\Gamma)\to\cat{F}/\Gamma$. Moreover, by the
assumption that $\pi_2(f,A)\jdeq \pi_2(f,A')$ it follows that the pullback
squares
\begin{equation*}
\begin{tikzcd}[column sep=large]
\ctxext{\Delta}{f_\ast(A)} \arrow[d,fib] \arrow[r,"{\pi_2(f,A)}"] & \ctxext{\Gamma}{A} \arrow[d,fib] \\
\Delta \arrow[r,"f"] & \Gamma
\end{tikzcd}
\qquad\text{and}\qquad
\begin{tikzcd}[column sep=large]
\ctxext{\Delta}{f_\ast(A')} \arrow[d,fib] \arrow[r,"{\pi_2(f,A')}"] & \ctxext{\Gamma}{A} \arrow[d,fib] \\
\Delta \arrow[r,"f"] & \Gamma
\end{tikzcd}
\end{equation*}
are the same. Since we have this property
for any object $\Gamma$, it also follows that the morphisms part of
$p^\Delta\circ\Lambda(f)$ factors through $p^\Gamma$. This defines the functor
$f_\ast$ in the commuting square
\begin{equation*}
\begin{tikzcd}
\Lambda(\Gamma) \arrow[d,swap,"p"] \arrow[r,"\Lambda(f)"] & \Lambda(\Delta) \arrow[d,"p"] \\
\cat{F}/\Gamma \arrow[r,densely dotted,"{f_\ast}"] & \cat{F}/\Delta
\end{tikzcd}
\end{equation*}
We need to verify that $f_\ast$ is a functorial choice of pullbacks, as in the
definition of \autoref{defn:E'sys}. Since $f_\ast$ is defined as an extension
of $\Lambda(f)$, it is enough to verify the analoguous functoriality properties
for $\Lambda(f)$. We do this by induction on the objects of $\Lambda(\Gamma)$,
in the same order as in \autoref{defn:E'sys}.
\begin{enumerate}[label=(\alph*)]
\item This property holds by definition.
\item Let $\Gamma\in\cat{C}$. We will prove by induction on $A\in\Lambda(\Gamma)$
that $(\catid{\Gamma})_\ast(A)\jdeq A$ and that $\pi_2(\catid{\Gamma},A)\jdeq \catid{\ctxext{\Gamma}{A}}$.
Note that these properties hold by definition for $A\jdeq\catid{\Gamma}$. For the
inductive step, assume that $A\in\Lambda(\Gamma)$ is such that
$(\catid{\Gamma})_\ast(A)\jdeq A$ and $\pi_2(\catid{\Gamma},A)\jdeq
\catid{\ctxext{\Gamma}{A}}$ and let $B\in\mathrm{Ty}(\ctxext{\Gamma}{A})$. Then
we have
\begin{align*}
(\catid{\Gamma})_\ast(A\circ p_B) & \jdeq (\catid{\Gamma})_\ast(A)\circ \pi_2(\catid{\Gamma},A)_\ast(p_B) \\
& \jdeq A\circ p_B
\end{align*}
Also, we have
\begin{align*}
\pi_2(\catid{\Gamma},A\circ p_B) & \jdeq \pi_2(\pi_2(\catid{\Gamma},A),p_B) \\
& \jdeq \pi_2(\catid{\ctxext{\Gamma}{A}},p_B) \\
& \jdeq \catid{\ctxext{{\Gamma}{A}}{B}}
\end{align*}
\item Let $f:\Delta\to \Gamma$ and $g:X\to \Delta$. We will prove by induction
on $A\in\Lambda(\Gamma)$ that $(f\circ g)_\ast(A)\jdeq g_\ast(f_\ast(A))$ and
that $\pi_2(f\circ g,A)\jdeq \pi_2(f,A)\circ \pi_2(g,f_\ast(A))$. Note that
these properties hold by definition for $A\jdeq\catid{\Gamma}$. For the inductive
step, assume that $A\in\Lambda(\Gamma)$ is such that $(f\circ g)_\ast(A)\jdeq g_\ast(f_\ast(A))$ and
$\pi_2(f\circ g,A)\jdeq \pi_2(f,A)\circ \pi_2(g,f_\ast(A))$, and let
$B\in\mathrm{Ty}(\ctxext{\Gamma}{A})$. Then we have
\begin{align*}
(f\circ g)_\ast(A\circ p_B) & \jdeq \pi_2(f\circ g,A)_\ast(p_B) \\
& \jdeq (\pi_2(f,A)\circ\pi_2(g,f_\ast(A)))_\ast(p_B) \\
& \jdeq \pi_2(g,f_\ast)_\ast(\pi_2(f,A)_\ast(p_B)) \\
& \jdeq g_\ast(f_\ast(A\circ p_B))
\end{align*}
\item This property holds by definition.\qedhere
\end{enumerate}
\end{proof}

\begin{defn}
There is a functor $\mathcal{V}:\mathbf{Comp}\to\mathbf{E'sys_{\circ}}$, from
the category $\mathbf{Comp}$ of split full comprehension categories to
E'-systems without empty context.
\end{defn}

\begin{constr}
Let $\mathcal{P}$ be a comprehension category with underlying category
$\cat{C}$. We define $\cat{F}$ to be the sub-pre-category of $\cat{C}$ generated
by the morphisms $\mathcal{P}(A):\ctxext{\Gamma}{A}\to\Gamma$ for $A\in\cat{E}$.  

For any $f:\Delta\to\Gamma$, we define a functor $f_\ast:\cat{F}/\Gamma\to
\cat{F}/\Delta$ by induction on the length of the morphism
Let $f:\Delta\to\Gamma$ and $p(A)\jdeq\Gamma$. Then we get a pullback square
\begin{equation*}
\begin{tikzcd}[column sep=large]
\ctxext{\Delta}{f_\ast(A)} \arrow[d,fib] \arrow[r,"{\pi_2(f,A)}"] & \ctxext{\Gamma}{A} \arrow[d,fib] \\
\Delta \arrow[r,"f"] & \Gamma
\end{tikzcd}
\end{equation*}
There seems to be no way to show that
$\pi_2(f,\ctxext{A}{P})\jdeq \pi_2(\pi_2(f,A),P)$.
\end{constr}

\begin{conj}
An E'-system is the same thing as a split full comprehension category in which
$\cat{E}$ has a terminal object.
\end{conj}

\begin{proof}
Let $\mathcal{E}$ be an E'-system. Define $\cat{E}$ to be the full subcategory
of $\cat{C}^\to$ whose objects are the morphisms of $\cat{F}$. Thus, for any
$\Gamma\in\cat{C}$, the category $p^{-1}(\Gamma)$ is the category of internal
morphisms the E-system $\mathcal{E}/\Gamma$. 

We first show that $p$ is a Grothendieck fibration. Let $f:\Delta\to\Gamma$ be
a morphism in $\cat{C}$ and let $A\in\cat{F}/\Gamma$. Then we have $\catid{\Delta},\catid{\Gamma}\in\cat{E}$,
and $(f,\pi_2(f,A)):f_\ast(A)\to A$. It is routine to verify that $(f,\pi_2(f,A))$
is a cartesian lift of $f$, and that this choice of catesian lifts is functorial. 

Now let $g:X\to\Delta$ and $f:\Delta\to \Gamma$, and let $\tilde{f}:\tilde{\Delta}\to\tilde{\Gamma}$ and
$\tilde{g}:\tilde{X}\to\tilde{\Delta}$ be cartesian lifts of $f$ and $g$, respectively. We have to show
that $\tilde{f}\circ \tilde{g}$ is a cartesian lift of $f\circ g$. Let $C\in\cat{F}/X$ and
let $h : C\to \tilde{\Gamma}$ be a morphism such that $\mathrm{cod}(h)\jdeq f\circ g$. 
\end{proof}

\subsection{From categories with families and comprehension categories to E-systems}

\begin{defn}
Let $\mathbb{D}$ be a D-system with underlying category $\cat{C}$. We define
$\cat{F}\subseteq\cat{C}$ to be the subcategory with the same objects as
$\cat{C}$, where the morphisms are generated by the projections $p_A$. Note that
there is no reason why $\cat{F}$ should possess a terminal object.
\end{defn}

\begin{defn}
Let $\mathbb{D}$ be a D-system. Then we define for any $\Gamma\in\mathbb{D}$ 
the category $\Lambda(\Gamma)$ of which the objects are finite sequences
of the form $(A_1,\ldots,A_n)$ where
\begin{equation*}
A_1\in\mathrm{Ty}(\Gamma),\ A_2\in\mathrm{Ty}(\ctxext{\Gamma}{A_1}),\ \ldots,\ 
A_n\in\mathrm{Ty}(\ctxext{{{\Gamma}{A_1}}{\cdots}}{A_{n-1}})
\end{equation*}
where the morphisms are generated by $(A_1,\ldots,A_{n+1})\leq (A_1,\ldots,A_{n})$.
\end{defn}

\begin{defn}
Let $\mathbb{D}$ be a D-system and let $f:\Delta\to\Gamma$ in $\mathbb{D}$.
Then there is a functor $\Lambda(f):\Lambda(\Gamma)\to\Lambda(\Delta)$, with
morphisms $\pi_2(f,A):\ctxext{\Delta}{p_{\Lambda(f,A)}}\to
\ctxext{\Gamma}{p_A}$ in $\mathbb{D}$, such that the square
\begin{equation*}
\begin{tikzcd}[column sep=large]
\ctxext{\Delta}{\Lambda(f,A)} \arrow[r,"{\pi_2(f,A)}"] \arrow[d,fib] & \ctxext{\Gamma}{A} \arrow[d,fib] \\
\Delta \arrow[r,swap,"f"] & \Gamma
\end{tikzcd}
\end{equation*}
is a pullback square.
\end{defn}

\begin{constr}
We construct the asserted structure by
induction on the length of the arrow $A$ into $\Gamma$. We define
$\Lambda(f)$ on the empty sequence as
$\Lambda(f,\emptyf[\Gamma])\defeq \emptyf[\Delta]$, and we define
$\pi_2(f,\emptyf[\Gamma])\defeq f:\ctxext{\Delta}{\catid{\Delta}}\to
\ctxext{\Gamma}{\catid{\Gamma}}$. The resulting square is trivially
a pullback square. Now suppose we have a pullback square as above.
and let $B\in\mathrm{Ty}(\ctxext{\Gamma}{A})$. Then we define
\begin{equation*}
\Lambda(f,[A,B])\defeq [\Lambda(f,A),\pi_2(f,A)_\ast(B)].
\end{equation*}
By \autoref{thm:DD}, the top square in the diagram
\begin{equation*}
\begin{tikzcd}[column sep=6em]
\ctxext{{\Delta}{\Lambda(f,A)}}{(\pi_2(f,A)_\ast(B))} \arrow[d,fib] \arrow[r,"{\pi_2(\pi_2(f,A),B)}"] & \ctxext{{\Gamma}{A}}{B} \arrow[d,fib] \\
\ctxext{\Delta}{\Lambda(f,A)} \arrow[d,fib] \arrow[r,"{\pi_2(f,A)}"] & \ctxext{\Gamma}{A} \arrow[d,fib] \\
\Delta \arrow[r,"f"] & \Gamma
\end{tikzcd}
\end{equation*}
is a pullback square.
Since the bottom square is assumed to be a pullback, we get that the outer rectangle
is a pullback, as desired. 
\end{constr}

\begin{rmk}
We can't directly use the functors $\Lambda(f)$ to give a D-system the structure
of an E'-system, because there is a coherence condition missing.
\end{rmk}

\begin{thm}\label{thm:Dsys_coh}
The following are equivalent:
\begin{enumerate}
\item The functors $\Lambda(f):\Lambda(\Gamma)\to\Lambda(\Delta)$ extend to 
the structure of an E'-system without empty context.
\item For any $f:\Delta\to\Gamma$ and all $A,A'\in\Lambda(\Gamma)$ satisfying 
$p_A\jdeq p_{A'}$, one has
\begin{equation*}
p_{\Lambda(f,A)}\jdeq p_{\Lambda(f,A')}\qquad\text{and}\qquad\pi_2(f,A)\jdeq \pi_2(f,A').
\end{equation*}
\end{enumerate}
\end{thm}

\begin{proof}
Suppose we can extend $\Lambda(f)$ for all $f:\Delta\to\Gamma$, to form commuting
diagrams
\begin{equation*}
\begin{tikzcd}
\Lambda(\Gamma) \arrow[d,swap,"p"] \arrow[r,"\Lambda(f)"] & \Lambda(\Delta) \arrow[d,"p"] \\
\cat{F}/\Gamma \arrow[r,densely dotted,"{f_\ast}"] & \cat{F}/\Delta
\end{tikzcd}
\end{equation*}
of functors, forming an E'-system without empty context. Let 
$f:\Delta\to\Gamma$, and let $A,A':\Lambda(\Gamma)$ be such that 
$p_A\jdeq p_{A'}$. Then it follows
that $\pi_2(f,A)_\ast\jdeq f_\ast/A\jdeq f_\ast/A'\jdeq\pi_2(f,A')_\ast$, so
we get the desired equality $\pi_2(f,A)\jdeq\pi_2(f,A')$.

For the converse, suppose that for all $f:\Delta\to\Gamma$ and $A,A'\in
\Lambda(\Gamma)$ such that $p_A\jdeq p_{A'}$, one has 
$p_{\Lambda(f,A)}\jdeq p_{\Lambda(f,A')}$ and $\pi_2(f,A)\jdeq\pi_2(f,A')$.
Let $f:\Delta\to\Gamma$. By the assumption that $p_{\Lambda(f,A)}\jdeq p_{\Lambda(f,A')}$,
it follows that the objects part of $p^\Delta\circ\Lambda(f):\Lambda(\Gamma)\to\cat{F}/\Delta$ 
factors through $p^\Gamma:\Lambda(\Gamma)\to\cat{F}/\Gamma$. Moreover, by the
assumption that $\pi_2(f,A)\jdeq \pi_2(f,A')$ it follows that the pullback
squares
\begin{equation*}
\begin{tikzcd}[column sep=large]
\ctxext{\Delta}{f_\ast(A)} \arrow[d,fib] \arrow[r,"{\pi_2(f,A)}"] & \ctxext{\Gamma}{A} \arrow[d,fib] \\
\Delta \arrow[r,"f"] & \Gamma
\end{tikzcd}
\qquad\text{and}\qquad
\begin{tikzcd}[column sep=large]
\ctxext{\Delta}{f_\ast(A')} \arrow[d,fib] \arrow[r,"{\pi_2(f,A')}"] & \ctxext{\Gamma}{A} \arrow[d,fib] \\
\Delta \arrow[r,"f"] & \Gamma
\end{tikzcd}
\end{equation*}
are the same. Since we have this property
for any object $\Gamma$, it also follows that the morphisms part of
$p^\Delta\circ\Lambda(f)$ factors through $p^\Gamma$. This defines the functor
$f_\ast$ in the commuting square
\begin{equation*}
\begin{tikzcd}
\Lambda(\Gamma) \arrow[d,swap,"p"] \arrow[r,"\Lambda(f)"] & \Lambda(\Delta) \arrow[d,"p"] \\
\cat{F}/\Gamma \arrow[r,densely dotted,"{f_\ast}"] & \cat{F}/\Delta
\end{tikzcd}
\end{equation*}
We need to verify that $f_\ast$ is a functorial choice of pullbacks, as in the
definition of \autoref{defn:E'sys}. Since $f_\ast$ is defined as an extension
of $\Lambda(f)$, it is enough to verify the analoguous functoriality properties
for $\Lambda(f)$. We do this by induction on the objects of $\Lambda(\Gamma)$,
in the same order as in \autoref{defn:E'sys}.
\begin{enumerate}[label=(\alph*)]
\item This property holds by definition.
\item Let $\Gamma\in\cat{C}$. We will prove by induction on $A\in\Lambda(\Gamma)$
that $(\catid{\Gamma})_\ast(A)\jdeq A$ and that $\pi_2(\catid{\Gamma},A)\jdeq \catid{\ctxext{\Gamma}{A}}$.
Note that these properties hold by definition for $A\jdeq\catid{\Gamma}$. For the
inductive step, assume that $A\in\Lambda(\Gamma)$ is such that
$(\catid{\Gamma})_\ast(A)\jdeq A$ and $\pi_2(\catid{\Gamma},A)\jdeq
\catid{\ctxext{\Gamma}{A}}$ and let $B\in\mathrm{Ty}(\ctxext{\Gamma}{A})$. Then
we have
\begin{align*}
(\catid{\Gamma})_\ast(A\circ p_B) & \jdeq (\catid{\Gamma})_\ast(A)\circ \pi_2(\catid{\Gamma},A)_\ast(p_B) \\
& \jdeq A\circ p_B
\end{align*}
Also, we have
\begin{align*}
\pi_2(\catid{\Gamma},A\circ p_B) & \jdeq \pi_2(\pi_2(\catid{\Gamma},A),p_B) \\
& \jdeq \pi_2(\catid{\ctxext{\Gamma}{A}},p_B) \\
& \jdeq \catid{\ctxext{{\Gamma}{A}}{B}}
\end{align*}
\item Let $f:\Delta\to \Gamma$ and $g:X\to \Delta$. We will prove by induction
on $A\in\Lambda(\Gamma)$ that $(f\circ g)_\ast(A)\jdeq g_\ast(f_\ast(A))$ and
that $\pi_2(f\circ g,A)\jdeq \pi_2(f,A)\circ \pi_2(g,f_\ast(A))$. Note that
these properties hold by definition for $A\jdeq\catid{\Gamma}$. For the inductive
step, assume that $A\in\Lambda(\Gamma)$ is such that $(f\circ g)_\ast(A)\jdeq g_\ast(f_\ast(A))$ and
$\pi_2(f\circ g,A)\jdeq \pi_2(f,A)\circ \pi_2(g,f_\ast(A))$, and let
$B\in\mathrm{Ty}(\ctxext{\Gamma}{A})$. Then we have
\begin{align*}
(f\circ g)_\ast(A\circ p_B) & \jdeq \pi_2(f\circ g,A)_\ast(p_B) \\
& \jdeq (\pi_2(f,A)\circ\pi_2(g,f_\ast(A)))_\ast(p_B) \\
& \jdeq \pi_2(g,f_\ast)_\ast(\pi_2(f,A)_\ast(p_B)) \\
& \jdeq g_\ast(f_\ast(A\circ p_B))
\end{align*}
\item This property holds by definition.\qedhere
\end{enumerate}
\end{proof}

\begin{defn}
If either of the equivalent conditions of \autoref{thm:Dsys_coh} hold, we say 
that the D-system is \emph{coherent}. Thus, we have a functor
$U:\mathbf{Dsys}\to\mathbf{E'sys_{\circ}}$ from coherent D-systems to E'-systems
\end{defn}

\begin{defn}
We say that a D-system $\cat{D}$ is \emph{locally well-founded} if the obvious functor
$p:\Lambda(\mathbb{D})\to\cat{F}/\Gamma$ is an isomorphism of pre-categories.
\end{defn}

\begin{rmk}
In other words, a D-system is locally well-founded if and only if
for any $A\in\cat{F}$ there is a unique sequence
$A_1\in\mathrm{Ty}(\Gamma)$, $A_2\in\mathrm{Ty}(\ctxext{\Gamma}{A_1})$, \ldots,
$A_n\in\mathrm{Ty}(\ctxext{{{\Gamma}{A_1}}{\cdots}}{A_{n-1}})$ such that
$A\jdeq p_{A_1}\circ\cdots\circ p_{A_n}$. Locally well-founded D-systems 
are examples of coherent D-systems.
\end{rmk}

\begin{thm}
The restriction of the functor $U:\mathbf{Dsys}\to\mathbf{E'sys_{\circ}}$ to the
locally well-founded D-systems is full and faithful.
\end{thm}

\begin{proof}
The functor $U$ is faithful on the locally well-founded D-systems, because for any morphism 
$\mathcal{F}:\mathbb{D}\to\mathbb{D}'$ of locally well-founded D-systems, 
$U(\mathcal{F})$ and $\mathcal{F}$ have the same underlying functor
from $\cat{C}$ to $\cat{C}'$. 

It remains to show that $U$ is full on the locally well-founded D-systems. Let
$\mathbb{D}$ and $\mathbb{D}$ be locally well-founded D-systems and let $\mathcal{G}:U(\mathbb{D})
\to U(\mathbb{D}')$. Then $\mathcal{G}$ restricted to $\cat{F}$ lifts factorizations.
We  first have to define a natural transformation
$\mathrm{Ty}\Rightarrow \mathrm{Ty}'\circ\mathcal{G}$. Let
$\Gamma\in\cat{C}$ and $A\in\mathrm{Ty}(\Gamma)$. Then we have
$\mathcal{G}(p_A):\mathcal{G}(\ctxext{\Gamma}{A})\to \mathcal{G}(\Gamma)$.
The category of factorizations of $p_A$ in $\cat{F}$ is a isomorphic to $\mathbf{2}$,
so the category of factorizations of $\mathcal{G}(p_A)$ is also isomorphic to
$\mathbf{2}$. This implies that $\mathcal{G}(p_A)$ is of the form $p_B$ for
some $B\in\mathrm{Ty}'(\mathcal{G}(\Gamma))$. This $B$ is called $\mathcal{G}(A)$.

To verify the naturality, let $f:\Delta\to\Gamma$. We need to show that the
square
\begin{equation*}
\begin{tikzcd}
\mathrm{Ty}(\Delta) \arrow[r,"{\mathcal{G}_\Delta}"] & \mathrm{Ty}'(\mathcal{G}(\Delta)) \\
\mathrm{Ty}(\Gamma) \arrow[u,"\mathrm{Ty}(f)"] \arrow[r,"{\mathcal{G}_\Gamma}"] &
\mathrm{Ty}'(\mathcal{G}(\Gamma)) \arrow[u,swap,"{\mathrm{Ty}'(\mathcal{G}(f))}"]
\end{tikzcd}
\end{equation*}
commutes. Let $A\in\mathrm{Ty}(\Gamma)$. Then we need to show that
$\mathcal{G}(f)_\ast(\mathcal{G}(A))\jdeq \mathcal{G}(f_\ast(A))$. By the uniqueness
assumption of well-founded D-systems, it suffices to show that
$p_{\mathcal{G}(f)_\ast(\mathcal{G}(A))}\jdeq p_{\mathcal{G}(f_\ast(A))}$. To
see this, we do a simple calculation
\begin{align*}
p_{\mathcal{G}(f)_\ast(\mathcal{G}(A))}
& \jdeq \mathcal{G}(f)_\ast(p_{\mathcal{G}(A)}) \\
& \jdeq \mathcal{G}(f)_\ast(\mathcal{G}(p_A)) \\
& \jdeq \mathcal{G}(f_\ast(p_A)) \\
& \jdeq \mathcal{G}(p_{f_\ast(A)}) \\
& \jdeq p_{\mathcal{G}(f_\ast(A))} \qedhere
\end{align*}
\end{proof}

\begin{thm}
The image of $U$ is the subcategory of locally stratified E'-systems without
empty context. 
\end{thm}

\begin{proof}
For any $\Gamma\in\mathbb{D}$, there is an obvious stratification functor
$\Lambda(\Gamma)\to (\N,\geq)$, so $U(\mathbb{D})$ is a locally stratified
E'-system. 

Now let $\mathbb{E}$ be a locally stratified E'-system without empty context.
For $\Gamma\in\cat{C}$, we define $\mathrm{Ty}(\Gamma)$ to be the set of
families of length one. Since any $f_\ast$ is stratified, it follows that
$\mathrm{Ty}$ is a presheaf on $\cat{C}$. The choice of pullback squares
\begin{equation*}
\begin{tikzcd}[column sep=large]
\ctxext{\Delta}{f_\ast(A)} \arrow[r,"{\pi_2(f,A)}"] \arrow[d,fib] & \ctxext{\Gamma}{A} \arrow[d,fib] \\
\Delta \arrow[r,swap,"f"] & \Gamma
\end{tikzcd}
\end{equation*}
is functorial by assumption, so we have defined a category with families. It
is straigtforward to verify that this category with families is locally well-founded,
and that its construction is inverse to $U$. 
\end{proof}
