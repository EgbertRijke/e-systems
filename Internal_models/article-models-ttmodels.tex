\section{The type theory of models of type theory}\label{ttmodels}
In this section we pursue the idea of what a general model of type theory is by
axiomatizing what you can do with them. We have the following ideas:
\begin{itemize}
\item There are dependent models and sections thereof. Particular instances
  of sections: extension, weakening and substitution (and something for identity
  function?). And like the original
  extension, weakening and substitution, they're going to be compatible with each
  other. Therefore we state our theory of models as an extension of type theory
  without constructors.
\item Type theory without constructors is a model of itself, the canonical model $\mctx$.
\item for any (family of) model(s) $A$, there is the family model $\mfam{A}$ which
  is a family of models over $A$.
\item The terms of $\mctx$ should be precisely contexts. Terms of $\subst{\Gamma}{\mfam{\mctx}}$
  should be families over $\Gamma$.
\item if a model and a family of models over it are given, there is an extended model.
  If we extend $A$ by $\mfam{A}$, we get the Sierpinski model of $A$.
\item Likewise, models can be weakened and substituted and there are identity
  functions.
\item So the theory of models is going to be an extension of this theory with this
  data. The theory we are about to describe can be seen as an elementary theory
  of the category (with families (and terms)) of categories (with families (and terms)).
\item We would also like to remark explicitly that the valid judgments of the original type
  theory become contexts, families or terms, depending on what kind of judgments
  it was. Then, valid inferences of the original type theory become valid
  judgments here. In some sense, the theory we present here is therefore a second
  order theory over the basic theory of types.
\item Martin Escardo and Mike Shulman have been promoting the use of 
  inductive-inductive definitions for internal models. What we're doing here looks
  different, because we're writing down a type theory for internal models, but it
  might not be that different at all. The type theory can be seen as the theory
  of (dependent) algebras over the inductive-inductively defined model and the
  terms of this type theory are the (dependent) algebra homomorphisms. The
  asserted initial object of our type theory is the inductive-inductively defined
  type. 
\end{itemize}

\subsection{The basic ingredients of the type theory of models}
\subsubsection{The family and term models and the initial model}
For every model $A$ there is a dependent model $\mfam{A}$ of families over $A$,
called the \emph{family model of $A$}.
The terms of a model $A$ are to be thought of as the contexts of $A$. Thus, when
we have a term $x:A$, the families over $x$ are the terms of the substituted
model $\subst{x}{\mfam{A}}$.
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    }
  { \jfam{{\Gamma}{A}}{\mfam{A}}
    }
  \tag{families}
\end{equation*}

Likewise, there is a \emph{term model $\mtm{A}$ of $A$}, 
which is a family of models over the family model $\mfam{A}$ of $A$. When
$x_0:A$ and $x_1:\mfam{A}$, then a term of $\subst{x_1}{{x_0}{\mtm{A}}}$ is
to be thought of as a term of $x_1$ in context $x_0$.
\begin{equation*}
\inference
  { \jctx{\Gamma}
    }
  { \jfam{{\Gamma}{\mfam{\Gamma}}}{\mtm{\Gamma}}
    }
  \tag{terms}
\end{equation*}
We shall furthermore assume that there is an initial model $\mctx$ in the theory
of models.
\begin{align*}
& \inference
  { }
  { \jctx{\mctx}
    }
  \tag{the canonical model}\\
& \inference
  { \jfam{\mctx}{P}
    }
  { \jterm{\mctx}{P}{i}
    }
  \tag{initiality of $\mctx$}
\end{align*}

\subsubsection{The action of terms on families and on terms}
We will require that every term $\jterm{{\Gamma}{A}}{P}{f}$ has an action on
families and on terms. It tells that when $x_1$ is a family over $x_0$ in $A$
with a term $y$, then we obtain a family $\subst{x_1}{{x_0}{\mfam{f}}}$ over
$\subst{x_0}{f}$ with a term $\subst{y}{{x_1}{{x_0}{\mtm{f}}}}$.
However, there is a choice in the precise formulation of this idea. One option
is to require that $\mfam{f}$ is a term of the family $\ctxwk{\mfam{A}}
{\subst{f}{\mfam{P}}}$; the other option, first investigated over a pastis
and peanuts before having breakfast, is that $\mfam{f}$ is a term of
the family $\jcomp{}{\tfext{A}}{\subst{f}{\mfam{P}}}$. We explore these two
options in more detail separately.

\paragraph{Option one: pullback along the projection}
Suppose we require the inference rules
\begin{align*}
& \inference
  { \jterm{{\Gamma}{A}}{P}{f}
    }
  { \jhom
      {{\Gamma}{A}}
      {\mfam{A}}
      {\subst{f}{\mfam{P}}}
      {\mfam{f}}
    }
  \\
& \inference
  { \jterm{{\Gamma}{A}}{P}{f}
    }
  { \jfhom
      {{\Gamma}{A}}
      {\mfam{A}}
      {\subst{f}{\mfam{P}}}
      {\mfam{f}}
      {\mtm{A}}
      {\subst{f}{\mtm{P}}}
      {\mtm{f}}
    }
\end{align*}
When the situation requires clarity --  for instance when extensions
are involved -- we will write $\mfam[\Gamma]{f}$ and $\mtm[\Gamma]{f}$ to make
what we regard as the context explicit.

With these two inference rules we see that
\begin{align*}
\subst{\tfemp{A}}{\ctxwk{\mfam{A}}{\subst{f}{\mfam{P}}}}
& \jdeq
  \ctxwk{\subst{\tfemp{A}}{\mfam{A}}}{\subst{\tfemp{A}}{{f}{\mfam{P}}}}
  \\
& \jdeq
  \ctxwk{A}{\subst{\tfemp{A}}{{f}{\mfam{P}}}}
  \\
& \jdeq
  \ctxwk{A}{\subst{{\tfemp{A}}{f}}{{\tfemp{A}}{\mfam{P}}}}
  \\
& \jdeq
  \ctxwk{A}{\subst{\tfemp{\subst{\tfemp{A}}{P}}}{{\tfemp{A}}{\mfam{P}}}}
  \\
& \jdeq
  \ctxwk{A}{\subst{\tfemp{\subst{\tfemp{A}}{P}}}}{\mfam{\subst{\tfemp{A}}{P}}}
  \\
& \jdeq
  \ctxwk{A}{\subst{\tfemp{A}}{P}}
\end{align*}

\paragraph{Option two: pullback along extension}

\subsubsection{The rest}
The empty context of a model $A$ is simply a term of $A$:
\begin{align*}
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jterm{\Gamma}{A}{\tfemp{A}}
    }
  \tag{empty context}\\
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jterm{{{\Gamma}{A}}{\mfam{A}}}{\subst{\tfemp{\mfam{A}}}{\mtm{A}}}{\tft{A}}
    }
\intertext{%
  Extension is going to be a morphism from $\ctxext{A}{\mfam{A}}$ to
  $A$ in context $\Gamma$:}
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jhom{\Gamma}{{A}{\mfam{A}}}{A}{\tfext{A}}
    }
  \tag{extension}
\intertext{%
  The action of weakening on families
  is a morphism from $\ctxwk{\mfam{A}}{\mfam{A}}$ to
  $\mfam{\mfam{A}}$ in context $\ctxext{{\Gamma}{A}}{\mfam{A}}$:}
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jhom
      {{{\Gamma}{A}}{\mfam{A}}}
      {\ctxwk{\mfam{A}}{\mfam{A}}}
      {\mfam{\mfam{A}}}
      {\tfwk{A}^0}
    }
  \tag{weakening}
\intertext{%
  The action of weakening on terms
  is a morphism from $\ctxwk{\mfam{A}}{\mtm{A}}$ to $\mtm{\mfam{\mfam{A}}}$ over
  $\tfwk{A}^0$ in context $\ctxext{{\Gamma}{A}}{\mfam{A}}$:}
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jfhom
      {{{\Gamma}{A}}{\mfam{A}}}
      {\ctxwk{\mfam{A}}{\mfam{A}}}
      {\mfam{\mfam{A}}}
      {\tfwk{A}^0}
      {\ctxwk{\mfam{A}}{\mtm{A}}}
      {\mtm{\mfam{\mfam{A}}}}
      {\tfwk{A}^1}
    }
  \tag{weakening}
\intertext{%
  The action of substitution by a term on families
  is going to be a morphism from $\ctxwk{\mtm{A}}{\mfam{\mfam{A}}}$ to 
  $\ctxwk{\mtm{A}}{{\mfam{A}}{\mfam{A}}}$
  in context $\ctxext{{{\Gamma}{A}}{\mfam{A}}}{\mtm{A}}$:}
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jhom
      {{{{\Gamma}{A}}{\mfam{A}}}{\mtm{A}}}
      {\ctxwk{\mtm{A}}{\mfam{\mfam{A}}}}
      {\ctxwk{\mtm{A}}{{\mfam{A}}{\mfam{A}}}}
      {\tfsubst{A}^0}
    }
  \tag{substitution}
\intertext{%
  Likewise, the action of substitution by a term on terms of those
  families is going to be a morphism from $\ctxwk{\mtm{A}}{\mtm{\mfam{\mfam{A}}}}$
  to $\ctxwk{\mtm{A}}{{\mfam{A}}{\mtm{A}}}$ over $\tfsubst{A}^0$ in context
  $\ctxext{{{\Gamma}{A}}{\mfam{A}}}{\mtm{A}}$:}
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jfhom
      {{{{\Gamma}{A}}{\mfam{A}}}{\mtm{A}}}
      {\ctxwk{\mtm{A}}{\mfam{\mfam{A}}}}
      {\ctxwk{\mtm{A}}{{\mfam{A}}{\mfam{A}}}}
      {\tfsubst{A}^0}
      {\ctxwk{\mtm{A}}{\mtm{\mfam{\mfam{A}}}}}
      {\ctxwk{\mtm{A}}{{\mfam{A}}{\mtm{A}}}}
      {\tfsubst{A}^1}
    }
  \tag{substitution}
\intertext{%
  The identity terms are coded by}
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jterm
      {{{\Gamma}{A}}{\mfam{A}}}
      {\subst{{\idfunc[\mfam{A}]}{\tfwk{A}^0}}{\mtm{\mfam{\mfam{A}}}}}
      {\tfid{A}}
    }
  \tag{identity terms}
\end{align*}
We will call the terms that we introduced here the model constructors.

\subsection{The compatibility rules}
We need to do several things in this section:
\begin{itemize}
\item postulate that ordinary extension, weakening, substitution and identity
functions are compatible with the model constructors.
\item postulate that each of the model constructors is compatible with ordinary
extension, weakening, substitution and identity terms. Actually, we want
that every term of this type theory is compatible with those. I.e.~every term
is a functor/morphism of models. Also the sections.
\item postulate that the model constructors are compatible with each other,
so that they come to model ordinary extension, weakening, substitution and
identity terms respectively.
\item Note that the rules for compatibility with extension are going to explain which
model $\ctxext{A}{P}$ is by telling what the families, the terms, extension,
weakening, substitution and identity terms are. Likewise the rules for
compatibility with weakening and substitution do this for their respective
cases.
\item The easiest set of compatibility rules comes with weakening. The compatibility
rules that deal with substitution are likely going to have to do with the
Yoneda lemma, which we should be able to implement at some point.
\item The model $\subst{\tfemp{A}}{\mtm{A}}$ is going to be initial in the category of
all models over $A$. That means: whenever $P$ is a family over $\subst{\tfemp{A}}
{\mtm{A}}$ there will be a term of $P$. This means in particular that
$\subst{\tfemp{\emptyf}}{\mtm{\emptyf}}$ is going to be $\mctx$.
\end{itemize}

\subsubsection{Families of weakenings}
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    \jfam{\Gamma}{B}
    }
  { \jfameq
      {{{\Gamma}{A}}{\ctxwk{A}{B}}}
      {\mfam{\ctxwk{A}{B}}}
      {\ctxwk{A}{\mfam{B}}}
    }.
\end{equation*}

\subsubsection{Terms of weakenings}
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    \jfam{\Gamma}{B}
    }
  { \jfameq
    {{{{\Gamma}{A}}{\ctxwk{A}{B}}}{\mfam{\ctxwk{A}{B}}}}
    {\mtm{\ctxwk{A}{B}}}
    {\ctxwk{A}{\mtm{B}}}
    }
\end{equation*}

\subsubsection{Families over families are families over extensions}
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    }
  { \jfameq
      {{{\Gamma}{A}}{\mfam{A}}}
      {\mfam{\mfam{A}}}
      {\jcomp{{A}{\mfam{A}}}{\tfext{A}}{\mfam{A}}}
    }
\end{equation*}
\emph{(Note: this rule might be a consequence of an explanation of what $\mfam{{A}{P}}$
is in general, but at the moment I don't see how to do this)}

\subsubsection{Terms of families over families are terms of families over extensions}
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    }
  { \jfameq
      {{{{\Gamma}{A}}{\mfam{A}}}{\mfam{\mfam{A}}}}
      {\mtm{\mfam{A}}}
      {\jcomp{}{\tfext{A}}{\mtm{A}}}
      }
\end{equation*}

\subsubsection{Extension acts as the identity on families of families}
The family of which $\tfext{A}$ is a term, is unfolded as
\begin{equation*}
\unfold{\jhom{\Gamma}{{A}{\mfam{A}}}{A}{\tfext{A}}}
\end{equation*}
Because we have the judgmental equality $\ctxext{\Gamma}{{A}{\mfam{A}}}
\jdeq \ctxext{{\Gamma}{A}}{\mfam{A}}$, there is a term
\begin{equation*}
\jhom
  {{{\Gamma}{A}}{\mfam{A}}}
  {\mfam{\mfam{A}}}
  {\subst{\tfext{A}}{\mfam{\ctxwk{\ctxext{A}{\mfam{A}}}{A}}}}
  {\mfam[\ctxext{\Gamma}{A}]{\tfext{A}}}
\end{equation*}
By the rule asserting that families of families are families of extensions, we
have $\mfam{\mfam{A}}\jdeq\jcomp{}{\tfext{A}}{\mfam{A}}$. By the rule that
families over weakenings are weakenings of families, we have the judgmental
equalities
\begin{equation*}
\subst{\tfext{A}}{\mfam{\ctxwk{\ctxext{A}{\mfam{A}}}{A}}}
\jdeq 
  \unfold{\jcomp{{A}{P}}{\tfext{A}}{\mfam{A}}}
\jdeq 
  \jcomp{{A}{P}}{\tfext{A}}{\mfam{A}}
\end{equation*}
Therefore, we can compare the term $\mfam[\ctxext{\Gamma}{A}]{\tfext{A}}$
to the identity term $\idfunc[\jcomp{}{\tfext{A}}{\mfam{A}}]$. 
The compatibility
rule for the action of extension on families of families asserts that
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    }
  { \jhomeq
      {{{\Gamma}{A}}{\mfam{A}}}
      {\jcomp{}{\tfext{A}}{\mfam{A}}}
      {\jcomp{}{\tfext{A}}{\mfam{A}}}
      {\mfam[\ctxext{\Gamma}{A}]{\tfext{A}}}
      {\idfunc[\jcomp{}{\tfext{A}}{\mfam{A}}]}
    }
\end{equation*}
\emph{(Note: this rule might be a consequence of an explanation of what $\mfam{{A}{P}}$
is in general, but at the moment I don't see how to do this)}

\subsubsection{Extension acts as the identity on terms of families of families}
We now investigate the nature of the morphism.
\begin{equation*}
\jfhom
  {{{\Gamma}{A}}{\mfam{A}}}
  {\mfam{\mfam{A}}}
  {\subst{\tfext{A}}{\mfam{\ctxwk{\ctxext{A}{\mfam{A}}}{A}}}}
  {\mfam[\ctxext{\Gamma}{A}]{\tfext{A}}}
  {\mtm{\mfam{A}}}
  {\subst{\tfext{A}}{\mtm{\ctxwk{\ctxext{A}{\mfam{A}}}{A}}}}
  {\mtm[\ctxext{\Gamma}{A}]{\tfext{A}}}
\end{equation*}
Note that we have the judgmental equality 
$\mtm{\mfam{A}}\jdeq\jcomp{}{\tfext{A}}{\mtm{A}}$. Likewise, we have the
judgmental equality $\subst{\tfext{A}}{\mtm{\ctxwk{\ctxext{A}{\mfam{A}}}{A}}}
\jdeq\jcomp{}{\tfext{A}}{\mtm{A}}$. Thirdly, we have the judgmental equality
$\mfam[\ctxext{\Gamma}{A}]{\tfext{A}}\jdeq\idfunc[\jcomp{}{\tfext{A}}{\mfam{A}}]$.
We may combine these three facts with \autoref{hom-over-id-is-hom} to see that
\begin{equation*}
\jhom
  {{{{\Gamma}{A}}{\mfam{A}}}{\jcomp{}{\tfext{A}}}{\mfam{A}}}
  {\jcomp{}{\tfext{A}}{\mtm{A}}}
  {\jcomp{}{\tfext{A}}{\mtm{A}}}
  {\mtm[\ctxext{\Gamma}{A}]{\tfext{A}}}
\end{equation*}
Now we see that we can require that $\mtm[\ctxext{\Gamma}{A}]{\tfext{A}}$ is
the identity term on $\jcomp{}{\tfext{A}}{\mtm{A}}$:
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    }
  { \jhomeq
    {{{{\Gamma}{A}}{\mfam{A}}}{\jcomp{}{\tfext{A}}}{\mfam{A}}}
    {\jcomp{}{\tfext{A}}{\mtm{A}}}
    {\jcomp{}{\tfext{A}}{\mtm{A}}}
    {\mtm[\ctxext{\Gamma}{A}]{\tfext{A}}}
    {\idfunc[\jcomp{}{\tfext{A}}{\mtm{A}}]}
    }
\end{equation*}

\subsubsection{Weakening followed by substitution is the identity}
The weakening morphism $\tfwk{A}^0$ gives a weakened morphism
\begin{equation*}
\jhom
  {{{{\Gamma}{A}}{\mfam{A}}}{\mtm{A}}}
  {\ctxwk{\mtm{A}}{{\mfam{A}}{\mfam{A}}}}
  {\ctxwk{\mtm{A}}{\mfam{\mfam{A}}}}
  {\ctxwk{\mtm{A}}{\tfwk{A}^0}}
\end{equation*}
which can be composed with the morphism $\tfsubst{A}^0$. We require that this
composition is the identity term on $\ctxwk{\mtm{A}}{{\mfam{A}}{\mfam{A}}}$:
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    }
  { \jhomeq
      {{{{\Gamma}{A}}{\mfam{A}}}{\mtm{A}}}
      {\ctxwk{\mtm{A}}{{\mfam{A}}{\mfam{A}}}}
      {\ctxwk{\mtm{A}}{{\mfam{A}}{\mfam{A}}}}
      {\jcomp{}{\ctxwk{\mtm{A}}{\tfwk{A}^0}}{\tfsubst{A}^0}}
      {\idfunc[\ctxwk{\mtm{A}}{{\mfam{A}}{\mfam{A}}}]}
    }
\end{equation*}
Likewise, the weakening morphism $\tfwk{A}^1$ gives a weakened morphism
\begin{equation*}
\jfhom
  {{{{\Gamma}{A}}{\mfam{A}}}{\mtm{A}}}
  {\ctxwk{\mtm{A}}{{\mfam{A}}{\mfam{A}}}}
  {\ctxwk{\mtm{A}}{\mfam{\mfam{A}}}}
  {\ctxwk{\mtm{A}}{\tfwk{A}^0}}
  {\ctxwk{\mtm{A}}{\ctxwk{\mfam{A}}{\mtm{A}}}}
  {\ctxwk{\mtm{A}}{\mtm{\mfam{\mfam{A}}}}}
  {\ctxwk{\mtm{A}}{\tfwk{A}^1}}
\end{equation*}
which can be composed with the the morphism $\tfsubst{A}^1$. We require that
this composition is the identity term on 
$\ctxwk{\mtm{A}}{\ctxwk{\mfam{A}}{\mtm{A}}}$. Note that this composition gives
a morphism over $\jcomp{}{\ctxwk{\mtm{A}}{\tfwk{A}^0}}{\tfsubst{A}^0}$, which
is the identity term on $\ctxwk{\mtm{A}}{{\mfam{A}}{\mfam{A}}}$; so in fact
it is an ordinary morphism in the context
$\ctxext{{{{\Gamma}{A}}{\mfam{A}}}{\mtm{A}}}{\ctxwk{\mtm{A}}{{\mfam{A}}{\mfam{A}}}}$.
Thus the inference rule we require to become valid is:
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    }
  { \jhomeq
      {{{{{\Gamma}{A}}{\mfam{A}}}{\mtm{A}}}{\ctxwk{\mtm{A}}{{\mfam{A}}{\mfam{A}}}}}
      {\ctxwk{\mtm{A}}{\ctxwk{\mfam{A}}{\mtm{A}}}}
      {\ctxwk{\mtm{A}}{\ctxwk{\mfam{A}}{\mtm{A}}}}
      {\jcomp{}{\ctxwk{\mtm{A}}{\tfwk{A}^1}}{\tfsubst{A}^1}}
      {\idfunc[\ctxwk{\mtm{A}}{\ctxwk{\mfam{A}}{\mtm{A}}}]}
    }
\end{equation*}

\subsubsection{Families of extended models}
Suppose we have a model $\ctxext{A}{P}$ in context $\Gamma$. In this section we
will figure out what the families of this model are. This is a bit tricky, so
we first treat the case where $P\jdeq\mfam{A}$. A context $\gamma$ in this
model is decomposed as a pair $\tmext{A}{\mfam{A}}{\pts{\gamma}}{\edg{\gamma}}$
which consists of a context $\pts{\gamma}$ of the model $A$ and a context
$\edg{\gamma}$ of the model $\mfam{A}$ in the fiber above $\pts{\Gamma}$. In
other words, $\edg{\gamma}$ is a family over $\pts{\gamma}$. A family $\beta$
over $\gamma$ is then a pair $\tmext{\pts{\beta}}{\edg{\beta}}$ consisting
of a family $\pts{\beta}$ over $\pts{\gamma}$ and a family $\edg{\beta}$ over
the extended term $\tmext{\pts{\beta}}{\edg{\gamma}}$. 
It is this extension which appears in the type of $\edg{\beta}$ which requires
a workaround for general $P$.

We consider the following dependency diagram helpful:
\begin{equation*}
\begin{tikzcd}
\jcomp{}{\bar{\typefont{pr}}}{{}{\tfext{A}}{\mfam{P}}}
  \ar[fib]{d}
  &
  \jcomp{}{\tfext{A}}{\mfam{P}}
    \ar[fib]{d}{}
  &
  \mfam{P}
    \ar[fib]{d}{}
  \\
\jcomp{}{\bar{\typefont{pr}}}{{}{\tfext{A}}{P}}
  \ar[fib]{d}{}
  &
  \jcomp{}{\tfext{A}}{P}
  \ar[fib]{d}{}
  &
  P
  \ar[fib]{d}{}\\
\ctxext{{A}{P}}{\ctxwk{P}{\mfam{A}}}
  \ar{r}[swap]{\bar{\typefont{pr}}}
  &
  \ctxext{A}{\mfam{A}}
  \ar{r}[swap]{\tfext{A}}
  &
  A
\end{tikzcd}
\end{equation*}
Here the morphism 
$\bar{\typefont{pr}}$ should be explained (skip ahead to 
\autoref{barproj} for the definition). 

\subsubsection{Families of substituted modes}
The following inference rule explains that the fiber at a term $f$ of $P$
of the model of families of a family of models $Q$ over $\ctxext{{\Gamma}{A}}{P}$
is judgmentally the same as the model of families of the fiber at the term $f$
of the family $Q$. In more practical terms, suppose we have a context $\gamma$
in $Q$ which happens to be in the fiber at $f$ of $Q$ over $P$, then a family
over $\gamma$ according to $Q$ is the same thing as a family over $\Gamma$
according to $\subst{f}{Q}$. The following inference rule captures this idea
precisely:

\begin{equation}
\inference
  { \jfam{{{\Gamma}{A}}{P}}{Q}
    \jterm{{\Gamma}{A}}{P}{f}
    }
  { \jfameq
      {{\Gamma}{A}}
      {\subst{f}{\mfam{Q}}}
      {\mfam{\subst{f}{Q}}}
    }
\end{equation}

\subsubsection{Families of weakened models}
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    \jfam{\Gamma}{B}
    }
  { \jfameq
      {{{\Gamma}{A}}{\ctxwk{A}{B}}}
      {\ctxwk{A}{\mfam{B}}}
      {\mfam{\ctxwk{A}{B}}}
    }
\end{equation*}

\subsubsection{The action on families of the identity term}
Let $A$ be a model in context $\Gamma$. Then we have the identity term
$\jhom{\Gamma}{A}{A}{\idtm{A}}$, which also has an action on families with the
following specification:
\begin{equation*}
\jhom{{\Gamma}{A}}{\mfam{A}}{\subst{\idtm{A}}{\mfam{\ctxwk{A}{A}}}}{\mfam{\idtm{A}}}.
\end{equation*}
Note, however that we have the judgmental equalities
\begin{equation*}
\subst{\idtm{A}}{\mfam{\ctxwk{A}{A}}}\jdeq\subst{\idtm{A}}{\ctxwk{A}{\mfam{A}}}
\jdeq\mfam{A},
\end{equation*}
so we may require that the action on families of the identity
term $\idtm{A}$ is the identity term $\idtm{\mfam{A}}$. We get the following
inference rule:
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    }
  { \jhomeq
      {{\Gamma}{A}}
      {\mfam{A}}
      {\mfam{A}}
      {\mfam{\idtm{A}}}
      {\idtm{\mfam{A}}}
    }
\end{equation*}

\subsubsection{Weakening by a family is precomposing with extension}
We seem to need the following rule:
\begin{equation*}
\inference
  { \jfam{{\Gamma}{A}}{P}
    }
  { \jfameq
      {{{\Gamma}{A}}{\mfam{A}}}
      {\ctxwk{\mfam{A}}{P}}
      {\jcomp{}{\tfext{A}}{P}}
    }
\end{equation*}
I don't know very well how to motivate requiring this rule. Maybe it's provable?

\subsubsection{Families of extensions}

\subsubsection{Terms of families of extensions}

\subsubsection{Terms of extensions}

\subsubsection{Families over the empty context}
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    }
  { \jfameq{\Gamma}{\subst{\tfemp{A}}{\mfam{A}}}{A}
    }
\end{equation*}

\subsubsection{Terms of the empty family}
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    }
  { \jfameq{{\Gamma}{A}}{\subst{\tfemp{\mfam{A}}}{\mtm{A}}}{\emptyf[A]}
    }
\end{equation*}

\subsubsection{The empty family over the empty family}
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    }
  { \jtermeq{\Gamma}{A}{\subst{\tfemp{A}}{\tfemp{\mfam{A}}}}{\tfemp{A}}
    }
\end{equation*}

\subsubsection{Extension by the empty family}
To understand the following inference rule, recall that for $\jfam{\Gamma}{A}$
we have the judgmental equalities
\begin{equation*}
\subst{\tfemp{\mfam{A}}}{\ctxwk{\ctxext{A}{\mfam{A}}}{A}}
\jdeq
  \subst{\tfemp{\mfam{A}}}{\ctxwk{\mfam{A}}{{A}{A}}}
\jdeq
  \ctxwk{A}{A}.
\end{equation*}
Therefore, we can postulate:
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    }
  { \jhomeq{\Gamma}{A}{A}{\subst{\tfemp{\mfam{A}}}{\tfext{A}}}{\idfunc[A]}
    }
\end{equation*}

\subsubsection{Extensions of the empty context}
To understand the following inference rule, recall that for $\jfam{\Gamma}{A}$
we have the judgmental equalities
\begin{align*}
\subst{\tfemp{A}}{\ctxwk{\ctxext{A}{\mfam{A}}}{A}}
& \jdeq 
  \subst{\tfemp{A}}{\ctxwk{\mfam{A}}{{A}{A}}}
  \\
& \jdeq 
  \ctxwk{\subst{\tfemp{A}}{\mfam{A}}}{\subst{\tfemp{A}}{\ctxwk{A}{A}}}
  \\
& \jdeq 
  \ctxwk{A}{\subst{\tfemp{A}}{\ctxwk{A}{A}}}
  \\
& \jdeq 
  \ctxwk{A}{A}
\end{align*}
Therefore, we can postulate
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    }
  { \jhomeq{\Gamma}{A}{A}{\subst{\tfemp{A}}{\tfext{A}}}{\idfunc[A]}
    }
\end{equation*}

\subsubsection{Weakening by the empty family}

\subsubsection{Weakenings of the empty family}

\subsubsection{Substitutions of the empty family}

\subsubsection{Substitution by the term of the empty family}

\subsection{Compatibility properties of arbitrary terms}
In this subsection we will state the inference rules that assert that every
term $\jterm{{\Gamma}{A}}{P}{f}$ acts functorially. That means, every term
preserves the empty context, extension, weakening, substitution and the
identity terms. Moreover, there will be several inference rules
involving the behavior of $\mfam{f}$ and $\mtm{f}$.

\subsubsection{The action on families of families of a term is the action on
families over extensions}
Let $\jterm{{\Gamma}{A}}{P}{f}$. Then we have the term
\begin{equation*}
\jterm{{{\Gamma}{A}}{\mfam{A}}}{\ctxwk{\mfam{A}}{\subst{f}{\mfam{P}}}}{\mfam{f}}
\end{equation*}
and we have the term
\begin{equation*}
\jterm
  { {{{\Gamma}{A}}{\mfam{A}}}{\mfam{\mfam{A}}}
    }
  { \ctxwk
      {\mfam{\mfam{A}}}
      {\subst{\mfam{f}}{\mfam{\ctxwk{\mfam{A}}{\subst{f}{\mfam{P}}}}}}
    }
  { \mfam{\mfam{f}}
    }.
\end{equation*}
We have the judgmental equality $\mfam{\mfam{A}}\jdeq
\jcomp{}{\tfext{A}}{\mfam{A}}$; in this subsubsection we wish to establish a
similar judgmental equality explaining what $\mfam{\mfam{f}}$ is. Note that
we have the judgmental equalities
\begin{align*}
\ctxwk
  {\mfam{\mfam{A}}}
  {\subst{\mfam{f}}{\mfam{\ctxwk{\mfam{A}}{\subst{f}{\mfam{P}}}}}}
& \jdeq
  \ctxwk
    {\jcomp{}{\tfext{A}}{\mfam{A}}}
    {\subst{\mfam{f}}{\mfam{\ctxwk{\mfam{A}}{\subst{f}{\mfam{P}}}}}}
  \\
& \jdeq
  \ctxwk
    {\unfold{\jcomp{\ctxext{A}{\mfam{A}}}{\tfext{A}}{\mfam{A}}}}
    {\subst{\mfam{f}}{\mfam{\ctxwk{\mfam{A}}{\subst{f}{\mfam{P}}}}}}
  \\
& \jdeq
  \ctxwk
    {\subst{\tfext{A}}{\ctxwk{\mfam{A}}{{A}{\mfam{A}}}}}
    {\subst{\mfam{f}}{\mfam{\ctxwk{\mfam{A}}{\subst{f}{\mfam{P}}}}}}
  \\
& \jdeq
  \ctxwk
    { \subst{\tfext{A}}{\ctxwk{\mfam{A}}{{A}{\mfam{A}}}}
      }
    { \subst
        { \tfext{A}
          }
        { \ctxwk
            {A}
            {\subst{\mfam{f}}{\mfam{\ctxwk{\mfam{A}}{\subst{f}{\mfam{P}}}}}}}
      }
  \\
& \jdeq
  \subst
    { \tfext{A}
      }
    { \ctxwk
        { {\mfam{A}}{{A}{\mfam{A}}}
          }
        { {A}
          {\subst{\mfam{f}}{\mfam{\ctxwk{\mfam{A}}{\subst{f}{\mfam{P}}}}}}
          }
      }
  \\
& \jdeq \unfold{\jcomp{{A}{\mfam{A}}}{\tfext{A}}{\mfam{\ctxwk{\mfam{A}}{\subst{f}{\mfam{P}}}}}}
\end{align*}


\subsubsection{Every term is compatible with the empty context}
\begin{equation*}
\inference
  { \jterm{{\Gamma}{A}}{P}{f}
    }
  { \jtermeq
      {\Gamma}
      {\subst{\tfemp{A}}{P}}
      {\subst{\tfemp{A}}{f}}
      {\tfemp{\subst{\tfemp{A}}{P}}}
    }
\end{equation*}

\subsubsection{The action on families of the action on families of a term is the action
on contexts of that term}
\emph{In this subsubsection we attempted to establish a rule asserting that
$\subst{\tfemp{A}}{\mfam{f}}\jdeq f$ for any $\jterm{{\Gamma}{A}}{P}{f}$. This
is however not true.}

Consider a term $\jterm{{\Gamma}{A}}{P}{f}$. Then we have the term
\begin{equation*}
\jterm
  {{\Gamma}{\subst{\tfemp{A}}{\mfam{A}}}}
  {\subst{\tfemp{A}}{\ctxwk{\mfam{A}}{\subst{f}{\mfam{P}}}}}
  {\subst{\tfemp{A}}{\mfam{f}}}
\end{equation*}
We have required that $\subst{\tfemp{A}}{\mfam{A}}\jdeq A$. Also, we have the
judgmental equalities
\begin{align*}
\subst{\tfemp{A}}{\ctxwk{\mfam{A}}{\subst{f}{\mfam{P}}}}
& \jdeq
  \ctxwk{\subst{\tfemp{A}}{\mfam{A}}}{\subst{\tfemp{A}}{{f}{\mfam{P}}}}
  \\
& \jdeq
  \ctxwk{A}{\subst{{\tfemp{A}}{f}}{{\tfemp{A}}{\mfam{P}}}}
  \\
& \jdeq
  \ctxwk{A}{\subst{\tfemp{\subst{\tfemp{A}}{P}}}{{\tfemp{A}}{\mfam{P}}}}
  \\
& \jdeq
  \ctxwk{A}{\subst{{\tfemp{A}}{\tfemp{P}}}{{\tfemp{A}}{\mfam{P}}}}
  \\
& \jdeq
  \ctxwk{A}{\subst{\tfemp{A}}{{\tfemp{P}}{\mfam{P}}}}
  \\
& \jdeq
  \ctxwk{A}{\subst{\tfemp{A}}{P}}
\end{align*}
If we require also the following inference rule, we would get $\mfam{A}\jdeq
\ctxwk{A}{A}$.
\begin{equation*}
\inference
  { \jfam{{\Gamma}{A}}{P}
    }
  { \jfameq{{\Gamma}{A}}{P}{\ctxwk{A}{\subst{\tfemp{A}}{P}}}
    }
\end{equation*}
This rule would say that a family $P$ of models over $A$ is determined by the
model $\subst{\tfemp{A}}{P}$ and that the only possible families of models
are the constant families.

\subsubsection{Every term is compatible with extension}
Let $\jterm{{\Gamma}{A}}{P}{f}$. The rule we're about to explain is that $f$
commutes with extension.

We have the morphism
$\jhom{{\Gamma}{A}}{\mfam{A}}{\subst{f}{\mfam{P}}}{\mfam{f}}$. Let's unfold
to remind ourselves what this means:
\begin{equation*}
\unfold{\jhom{{\Gamma}{A}}{\mfam{A}}{\subst{f}{\mfam{P}}}{\mfam{f}}}
\end{equation*}
Now note that we have the judgmental equality
\begin{equation*}
  \ctxwk{\mfam{A}}{\subst{f}{\mfam{P}}}
  \jdeq
  \subst{\ctxwk{\mfam{A}}{f}}{\ctxwk{\mfam{A}}{\mfam{P}}}
\end{equation*}
and we see that we get the term
$ \tmext
    {\ctxwk{\mfam{A}}{P}}
    {\ctxwk{\mfam{A}}{\mfam{P}}}
    {\ctxwk{\mfam{A}}{f}}
    {\mfam{f}}
  $
of the family $\ctxwk{\mfam{A}}{\ctxext{P}{\mfam{P}}}$. We can substitute this
term in the morphism
\begin{equation*}
\jhom
  {{{\Gamma}{A}}{\mfam{A}}}
  {\ctxwk{\mfam{A}}{\ctxext{P}{\mfam{P}}}}
  {\ctxwk{\mfam{A}}{P}}
  {\ctxwk{\mfam{A}}{\tfext{P}}}
\end{equation*}
to obtain the term 
$ \jterm
    {{{\Gamma}{A}}{\mfam{A}}}
    {\ctxwk{\mfam{A}}{P}}
    { \subst
        { \tmext
            {\ctxwk{\mfam{A}}{P}}
            {\ctxwk{\mfam{A}}{\mfam{P}}}
            {\ctxwk{\mfam{A}}{f}}
            {\mfam{f}}
          }
        { \ctxwk{\mfam{A}}{\tfext{P}}
          }
      }.
  $
We can also compose $\tfext{A}$ with $f$ to obtain the term
\begin{equation*}
\jterm{{{\Gamma}{A}}{\mfam{f}}}{\jcomp{}{\tfext{A}}{P}}{\jcomp{}{\tfext{A}}{f}}
\end{equation*}
Note that we have (?) the judgmental equality $\jcomp{}{\tfext{A}}{P}
\jdeq\ctxwk{\mfam{A}}{P}$ and therefore
we can require:
\begin{equation*}
\inference
  { \jterm{{\Gamma}{A}}{P}{f}
    }
  { \jtermeq
       {{{\Gamma}{A}}{\mfam{A}}}
       {\ctxwk{\mfam{A}}{P}}
       { \subst
           { \tmext
               {\ctxwk{\mfam{A}}{P}}
               {\ctxwk{\mfam{A}}{\mfam{P}}}
               {\ctxwk{\mfam{A}}{f}}
               {\mfam{f}}
             }
           { \ctxwk{\mfam{A}}{\tfext{P}}
             }
         }
       {\jcomp{}{\tfext{A}}{f}}
    }
\end{equation*}

\subsubsection{Every term is compatible with weakening}
Let $\jterm{{\Gamma}{A}}{P}{f}$ be a term. We will establish an inference rule
asserting that $f$ commutes with weakening. 

\subsubsection{Every term is compatible with substitution}

\subsubsection{Every term preserves identity}
