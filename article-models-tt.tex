\section{Type theory before type constructors}\label{tt}
In this section we give a description of type theory before basic
constructors and with explicit extension, weakening and substitution. We will
formulate the type theory in such a way that contexts aren't lists of variable
declarations. The main reason is that we don't see variable declarations in the
models either. This way we also set out to a more algebraic approach of type
theory and higher category theory. Thirdly, we will not have to be burdened with
comments about variables being bounded or not, or fresh or not occuring at all.

We will develop a theory which is in fact a theory of contexts and families of
contexts where a family of context can be a type, behind which we have the
intuition that it is an atomic or irreducible family of contexts. We get immediately
that every construction can be made in an arbitrary context. 

It should be noted that this is just a prototype description. It may be the case
that various other elements have to be added yet, such as terms
$\jterm{\ctxext{\Gamma}{\subst{x}{P}}}{\ctxwk{\subst{x}{P}}{\ctxext{A}{P}}}{i}$
including the fiber $\subst{x}{P}$ into the extended family $\ctxext{A}{P}$ over
$\Gamma$. Moreover, it hasn't been thoroughly tested whether the theory presented
here lives up to its promise.

Much of the rules we state are just compatibility rules of extension, weakening
and substitution with each other. In a way, these rules assert that our contexts
are just structureless lists of contexts and that likewise terms are structureless
lists of terms. They are structureless in the sense that the order in which
they are formed by pairing up is irrelevant. We note that this causes complications
in the traditional way that categorical sematics of type theory is implemented,
where contexts become objects of the category which is supposed to model type
theory. The reason for this is that context extension will not satisfy all the
compatibility rules we're about to state. The first step to resolving this is taking
the types in the empty context as the objects. 

To get the overview of the compatibility rules, we list the sections
where these compatibility rules are described in the following table (in this
table, the
subsection mentioned in row $X$ and column $Y$ consideres the rules of the
operation $Y\circ X$):
\begin{center}
\begin{tabular}{r|ccc}
& extension & weakening & substitution\\
\hline
extension & \autoref{comp-ee} & \autoref{comp-ew} & \\
weakening & \autoref{comp-we} & \autoref{comp-ww} & \autoref{comp-ws}\\
substitution & \autoref{comp-se} & \autoref{comp-sw} & \autoref{comp-ss}
\end{tabular}
\end{center}
Since extension by a context acts trivially on families and terms there are
no rules added for extension followed by substitution.

In \autoref{extension-on-terms} we come back to the operation of extension, but
now for terms. The rules in this section explain what it means to be a term of
an extended family, namely to be an extended term. The compatibility rules for
extended terms are then similar as the compatibility rules that have appeared
earlier: there is a compatibility rule for the extension of an extension, for
the weakening of an extended term, for the substutution of an extended term by
an arbitrary term and for substitution by an extended term. The last set of
compatibility rules is a form of currying-uncurrying -- this famous
correspondence naturally comes out of our scheme of compatibility rules.

\subsection{The basic judgments}
The type theory we describe here is a theory of contexts, families of
contexts and terms thereof. The families of contexts are by some authors called
dependent contexts, but they are handled a bit differently here because they
become the primary object of study. Dependent contexts can be types; they could
be seen as atomic or indecomposable dependent contexts.

Thus we make eight kinds of judgments in our type theory: ``$\Gamma$ is a context'',
``$A$ is a family of contexts over $\Gamma$'', ``$A$ is a type in context $\Gamma$''
and ``$x$ is a term of the family $A$ of contexts over $\Gamma$''. The other four
judgments are for judgmental equality. 

\begin{align*}
\jctx*{\Gamma} & \jctxeq*{\Gamma}{\Gamma'}\\
\jfam*{\Gamma}{A} & \jfameq*{\Gamma}{A}{B}\\
\jtype*{\Gamma}{A} & \jtypeeq*{\Gamma}{A}{B}\\
\jterm*{\Gamma}{A}{x} & \jtermeq*{\Gamma}{A}{x}{y}.
\end{align*}

If $A$ is a type
in context $\Gamma$, then $A$ is also a family of contexts over $\Gamma$. Being
a term of type $A$ means the same thing as being a term of the family $A$ of contexts.
Two types in context $\Gamma$ are judgmentally equal precisely when they are equal
as context families. Moreover, if a family $B$ of contexts over $\Gamma$ is
judgmentally equal to a type $A$ in context $\Gamma$, then $B$ is a type in
context $\Gamma$. This is expressed by the following four inference rules:

\begin{align*}
& \inference{\jtype{\Gamma}{A}}{\jfam{\Gamma}{A}} & & \inference{\jtypeeq{\Gamma}{A}{B}}{\jfameq{\Gamma}{A}{B}}\\
& \inference{\jtype{\Gamma}{A}\quad\jfameq{\Gamma}{A}{B}}{\jtype{\Gamma}{B}}
& & \inference{\jtype{\Gamma}{A}\quad\jfameq{\Gamma}{A}{B}}{\jtypeeq{\Gamma}{A}{B}}
\end{align*}


\subsection{The basic rules for judgmental equality}
The rules for judgmental equality establish that it is an equivalence relation
in all three cases (contexts, types and terms).
\bgroup\small
\begin{align*}
& \inference{\jctx{\Gamma}}{\jctxeq{\Gamma}{\Gamma}} 
& & \inference{\jctxeq{\Gamma}{\Delta}}{\jctxeq{\Delta}{\Gamma}} 
& & \inference{\jctxeq{\Gamma}{\Delta}\qquad\jctxeq{\Delta}{\greek{E}}}{\jctxeq{\Gamma}{\greek{E}}}\\
& \inference{\jfam{\Gamma}{A}}{\jfameq{\Gamma}{A}{A}} 
& & \inference{\jfameq{\Gamma}{A}{B}}{\jfameq{\Gamma}{B}{A}}
& & \inference{\jfameq{\Gamma}{A}{B}\qquad\jfameq{\Gamma}{B}{C}}{\jfameq{\Gamma}{A}{C}}\\
& \inference{\jterm{\Gamma}{A}{x}}{\jtermeq{\Gamma}{A}{x}{x}}
& & \inference{\jtermeq{\Gamma}{A}{x}{y}}{\jtermeq{\Gamma}{A}{y}{x}}
& & \inference{\jtermeq{\Gamma}{A}{x}{y}\qquad\jtermeq{\Gamma}{A}{y}{z}}{\jtermeq{\Gamma}{A}{x}{z}}
\end{align*}
\egroup

The following convertibility rules are responsible for the strictness
of judgmental equality, which sets it apart from equivalences or identifications:

\begin{align*}
& \inference{\jctxeq{\Gamma}{\Delta}\qquad\jfam{\Gamma}{A}}{\jfam{\Delta}{A}}
& & \inference{\jctxeq{\Gamma}{\Delta}\qquad\jfameq{\Gamma}{A}{B}}{\jfameq{\Delta}{A}{B}}\\
& \inference{\jctxeq{\Gamma}{\Delta}\qquad\jterm{\Gamma}{A}{x}}{\jterm{\Delta}{A}{x}}
& & \inference{\jctxeq{\Gamma}{\Delta}\qquad\jtermeq{\Gamma}{A}{x}{y}}{\jtermeq{\Delta}{A}{x}{y}}\\
& \inference{\jfameq{\Gamma}{A}{B}\qquad \jterm{\Gamma}{A}{x}}{\jterm{\Gamma}{B}{x}}
& & \inference{\jfameq{\Gamma}{A}{B}\qquad\jtermeq{\Gamma}{A}{x}{y}}{\jtermeq{\Gamma}{B}{x}{y}}
\end{align*}

\subsection{The empty context}
There is an empty context and over any context there is an empty family of
contexts. We do not assume that the empty context is a type, that would be like
assuming that the multiplicative unit of a ring is prime. The empty family
always has a unique term. 

\begin{align}
& \inference{}{\jctx{\emptyc}}\\
& \inference{\jctx{\Gamma}}{\jfam{\Gamma}{\emptyf[\Gamma]}}\\
& \inference{\jctx{\Gamma}}{\jterm{\Gamma}{\emptyf[\Gamma]}{\emptytm[\Gamma]}}\\
& \inference{\jterm{\Gamma}{\emptyf[\Gamma]}{x}}{\jtermeq{\Gamma}{\emptyf[\Gamma]}{x}{\emptytm[\Gamma]}}
\end{align}

Moreover, if $\Gamma$ is a context family over the
empty context, then $\Gamma$ is a context and every context is a context
family over the empty context. Note that this allows us to speak
of terms of contexts too.

\begin{align}
& \inference{\jctx{\Gamma}}{\jfam{\emptyc}{\Gamma}} 
& & \inference{\jfam{\emptyc}{\Gamma}}{\jctx{\Gamma}}\\
& \inference{\jctxeq{\Gamma}{\Delta}}{\jfameq{\emptyc}{\Gamma}{\Delta}}
& & \inference{\jfameq{\emptyc}{\Gamma}{\Delta}}{\jctxeq{\Gamma}{\Delta}}
\end{align}

\subsubsection{The empty context is compatible with itslef}
The empty context $\emptyc$ may be considered as a family of contexts over the empty
context. When we do this, we get $\emptyf[\emptyc]$.
\begin{equation}
\inference{}{\jfameq{\emptyc}{\emptyc}{\emptyf[\emptyc]}}
\end{equation}
In the future, we shall denote $\emptyf[\Gamma]$ by $\emptyf$. The above rule
guarantees that this will not cause confusion. Likewise, we shall denote
$\emptytm[\Gamma]$ by $\emptytm$.

\subsection{Extension}
We introduce extension which not only extends a context $\Gamma$ and a family
$A$ over it to a context $\ctxext{\Gamma}{A}$, but which also extends a family $A$
in context $\Gamma$ and a family $P$ over it to a family $\ctxext{A}{P}$ over context
$\Gamma$. We do this to ensure that all of type theory can be done in a context.
For instance, we could say (1) that a context in context $\Gamma$ is the same thing
as a family over $\Gamma$; (2) When $A$ is a context in this sense, a family over
$A$ is the same thing as a family $P$ over $\ctxext{\Gamma}{A}$ and 
(3) when $P$ is a family over $A$ in this sense, a term of $P$ keeps its original meaning.

\begin{align}
& \inference{\jfam{\Gamma}{A}}{\jctx{\ctxext{\Gamma}{A}}}
& & \inference{\jctxeq{\Gamma}{\Delta}\qquad\jfameq{\Gamma}{A}{B}}{\jctxeq{\ctxext{\Gamma}{A}}{\ctxext{\Delta}{B}}}\\
& \inference{\jfam{\ctxext{\Gamma}{A}}{P}}{\jfam{\Gamma}{\ctxext{A}{P}}}
& & \inference{\jfameq{\Gamma}{A}{B}\qquad\jfameq{\ctxext{\Gamma}{A}}{P}{Q}}{\jfameq{\Gamma}{\ctxext{A}{P}}{\ctxext{B}{Q}}}
\end{align}

\subsubsection{Extension is compatible with the empty context}
The following rule asserts that extension by $\emptyc$ leaves the contexts unchanged.
\begin{align}
& \inference{\jctx{\Gamma}}{\jctxeq{\ctxext{\emptyc}{\Gamma}}{\Gamma}}\\
& \inference{\jctx{\Gamma}}{\jctxeq{\ctxext{\Gamma}{\emptyf}}{\Gamma}}\\
& \inference{\jfam{\Gamma}{A}}{\jfameq{\Gamma}{\ctxext{\emptyf}{A}}{A}}
\end{align}

\subsubsection{Extension is compatible with itself}\label{comp-ee}
The inference rules asserting that extension is compatible with itself assert
that contexts are unstructured lists of type declarations. This rule is
unavoidable if we want that for a family $A$ in context $\Gamma$, a family over
$A$ is the same thing as a family over $\ctxext{\Gamma}{A}$. 

\begin{align}
& \inference{\jfam{\Gamma}{A}\qquad\jfam{\ctxext{\Gamma}{A}}{P}}
  {\jctxeq{\ctxext{{\Gamma}{A}}{P}}{\ctxext{\Gamma}{{A}{P}}}}\\
& \inference{\jfam{\ctxext{\Gamma}{A}}{P}\qquad\jfam{\ctxext{{\Gamma}{A}}{P}}{Q}}
  {\jfameq{\Gamma}{\ctxext{{A}{P}}{Q}}{\ctxext{A}{{P}{Q}}}}
\end{align}

\subsection{The type theoretic operation of weakening}
When $A$ is a context family over a context $\Gamma$, we wish to define a weakening
operation $\ctxwk{A}{}$. The weakening operation acts on context families $B$ 
over $\Gamma$, terms thereof, context families over $B$ and terms thereof.
It weakens those, which means that it ``adds $A$ to the context''. The context
family $\ctxwk{A}{B}$ can be seen as the constant family $B$ over $\ctxext{\Gamma}{A}$.
Likewise, when $y$ is a term of $B$, the term $\ctxwk{A}{y}$ of $\ctxwk{A}{B}$
can be seen as the constant term with value $y$.
 
 In the following inference rules we assume that $\jfam{\Gamma}{A}$ and in the
 rules asserting a judgmental equality we assume furthermore that 
 $\jfameq{\Gamma}{A}{A'}$.
\begin{align}
& \inference{\jfam{\Gamma}{B}}{\jfam{\ctxext{\Gamma}{A}}{\ctxwk{A}{B}}}
& & \inference{\jfameq{\Gamma}{B}{B'}}{\jfameq{\ctxext{\Gamma}{A}}{\ctxwk{A}{B}}{\ctxwk{A'}{B'}}}\\
& \inference{\jfam{\ctxext{\Gamma}{B}}{Q}}
{\jfam{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}}
& & \inference{\jfameq{\ctxext{\Gamma}{B}}{Q}{Q'}}
{\jfameq{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}{\ctxwk{A'}{Q'}}}\\
& \inference{\jterm{\Gamma}{B}{y}}{\jterm{\ctxext{\Gamma}{A}}{\ctxwk{A}{B}}{\ctxwk{A}{y}}}
& & \inference{\jtermeq{\Gamma}{B}{y}{y'}}{\jtermeq{\ctxext{\Gamma}{A}}{\ctxwk{A}{B}}{\ctxwk{A}{y}}{\ctxwk{A'}{y'}}}\\
& \inference{\jterm{\ctxext{\Gamma}{B}}{Q}{g}}{\jterm{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}{\ctxwk{A}{g}}}
& & \inference{\jtermeq{\ctxext{\Gamma}{B}}{Q}{g}{g'}}
{\jtermeq{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}{\ctxwk{A}{g}}{\ctxwk{A'}{g'}}}
\end{align}

We add rules asserting that a weakened type is again a type:

\begin{align}
& \inference{\jfam{\Gamma}{B}\quad\jtype{\ctxext{\Gamma}{B}}{Q}}{\jtype{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}}
\end{align}

\subsubsection{Weakening is compatible with the empty context}
The following rules express that when the empty context or context family is
weakened, the result is the empty context family.
\begin{align}
& \inference{\jctx{\Gamma}}{\jfameq{\Gamma}{\ctxwk{\Gamma}{\emptyc}}{\emptyf}}\\
& \inference{\jfam{\Gamma}{A}}{\jfameq{\ctxext{\Gamma}{A}}{\ctxwk{A}{\emptyf}}{\emptyf}}
\end{align}
Weakening by the empty family $\emptyf$ over a context $\Gamma$ leaves families, 
their terms, families over those families and
terms of those unchanged:
\begin{align}
& \inference{\jfam{\Gamma}{B}}{\jfameq{\Gamma}{\ctxwk{\emptyf}{B}}{B}}\\
& \inference{\jterm{\Gamma}{B}{y}}{\jtermeq{\Gamma}{B}{\ctxwk{\emptyf}{y}}{y}}\\
& \inference{\jfam{\ctxext{\Gamma}{B}}{Q}}{\jfameq{\ctxext{\Gamma}{B}}{\ctxwk{\emptyf}{Q}}{Q}}\\
& \inference{\jterm{\ctxext{\Gamma}{B}}{Q}{g}}{\jtermeq{\ctxext{\Gamma}{B}}{Q}{\ctxwk{\emptyf}{g}}{g}}
\end{align}

\subsubsection{Weakening is compatible with extension}\label{comp-we}

The following rules assert the compatibility of extension with weakening: for
every family $A$ over $\Gamma$ and every family $Q$ over $\ctxext{\Gamma}{B}$
there is a
judgmental equality $\ctxwk{A}{\ctxext{B}{Q}}\jdeq\ctxext{\ctxwk{A}{B}}
{\ctxwk{A}{Q}}$. 

When thinking of terms of $\ctxwk{A}{B}$ as morphisms of families from $A$ to
$B$, this looks already like form of type theoretic choice. It is weaker in that
it is not stated with function types, yet it is stronger in that it states a
judgmental equality between two families. When one makes the weakening operation
notationally invisible -- as is in fact the usual practice in type theory -- the
following compatibility rules become completely obvious.

In the following inference rules we assume that $\jfam{\Gamma}{A}$.
\begin{align}
& \inference
  {\jfam{\ctxext{{\Gamma}{B}}{Q}}{R}}
  {\jfameq
    {\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}
    {\ctxwk{A}{\ctxext{Q}{R}}}
    {\ctxext{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}}
\end{align}

\subsubsection{Weakening is compatible with itself}\label{comp-ww}
We state judgmental equality rules expressing
that weakening is compatible with itself. These rules state that the following
diagram commutes given any two families $A$ and $B$ in context $\Gamma$:
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\jfam{\Gamma}{\blank} \ar{r}{C\mapsto\ctxwk{B}{C}} \ar{d}[swap]{C\mapsto\ctxwk{A}{C}} & \jfam{\ctxext{\Gamma}{B}}{\blank} \ar{d}{Q\mapsto\ctxwk{A}{Q}}\\
\jfam{\ctxext{\Gamma}{A}}{\blank} \ar{r}[swap]{P\mapsto\ctxwk{{A}{B}}{P}} & \jfam{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\blank}
\end{tikzcd}
\end{equation*}
Thus, we get the following set of inference rules:
\begin{align}
& \inference{\jfam{\Gamma}{A}\qquad\jfam{\Gamma}{B}\qquad\jfam{\ctxext{\Gamma}{C}}{R}}
          {\jfameq{\ctxext{{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{{A}{B}}{{A}{C}}}}
            {\ctxwk{A}{{B}{R}}}
            {\ctxwk{{A}{B}}{{A}{R}}}}\label{comp-ww-f}\\
& \inference{\jfam{\Gamma}{A}\qquad\jfam{\Gamma}{B}\qquad\jterm{\ctxext{\Gamma}{C}}{R}{t}}
          {\jtermeq{\ctxext{{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{{A}{B}}{{A}{C}}}}
            {\ctxwk{{A}{B}}{{A}{R}}}{\ctxwk{A}{{B}{t}}}{\ctxwk{{A}{B}}{{A}{t}}}}
            \label{comp-ww-t}
\end{align}

\subsubsection{Extension is compatible with weakening}\label{comp-ew}
The rules expressing that extension is compatible with weakening assert that
weakening by an extension is the same thing as weakening twice in the
appropriate way.

In the following inference rules we assume that
$\jfam{\Gamma}{A}$ and $\jfam{\ctxext{\Gamma}{A}}{P}$. 
\begin{align}
& \inference{\jfam{\ctxext{\Gamma}{B}}{Q}}
    {\jfameq{\ctxext{{{\Gamma}{A}}{P}}{\ctxwk{P}{{A}{B}}}}{\ctxwk{\ctxext{A}{P}}{Q}}{\ctxwk{P}{{A}{Q}}}}\label{comp-ew-f}\\
& \inference{\jterm{\ctxext{\Gamma}{B}}{Q}{g}}
    {\jtermeq{\ctxext{{{\Gamma}{A}}{P}}{\ctxwk{P}{{A}{B}}}}{\ctxwk{P}{{A}{Q}}}{\ctxwk{\ctxext{A}{P}}{g}}{\ctxwk{P}{{A}{g}}}}\label{comp-ew-t}
\end{align}

\subsection{The type theoretic operation of substitution}
Given a family $P$ over $A$ and a term $x$ of $A$, substitution gives a way to
consider the fiber $\subst{x}{P}$ of $P$ at $x$. Also, we get a way to evaluate
terms $f$ of $P$ at $x$. This will give us ways to compose functions too. In
this section, we shall first introduce the operations `substitution of a term $x$'
for families $P$ over $\ctxext{\Gamma}{A}$, terms $f$ of those, families $Q$ over
$\ctxext{{\Gamma}{A}}{P}$ and terms $g$ of those. 
Then we shall explain how substitution interacts
with itself, extension and weakening.

In the rules introducing the various substitutions we assume $\jterm{\Gamma}{A}{x}$;
in the rules introducing the definitional equalities we assume $\jtermeq{\Gamma}{A}{x}{x'}$.

\begin{align}
& \inference{\jfam{\ctxext{\Gamma}{A}}{P}}{\jfam{\Gamma}{\subst{x}{P}}}
& & \inference{\jfameq{\ctxext{\Gamma}{A}}{P}{P'}}{\jfameq{\Gamma}{\subst{x}{P}}{\subst{x'}{P'}}}\\
& \inference{\jfam{\ctxext{{\Gamma}{A}}{P}}{Q}}{\jfam{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}}
& & \inference{\jfameq{\ctxext{{\Gamma}{A}}{P}}{Q}{Q'}}{\jfameq{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}{\subst{x'}{Q'}}}\\
& \inference{\jterm{\ctxext{\Gamma}{A}}{P}{f}}{\jterm{\Gamma}{\subst{x}{P}}{\subst{x}{f}}}
& & \inference{\jtermeq{\ctxext{\Gamma}{A}}{P}{f}{f'}}{\jtermeq{\Gamma}{\subst{x}{P}}{\subst{x}{f}}{\subst{x'}{f'}}}\\
& \inference{\jterm{\ctxext{{\Gamma}{A}}{P}}{Q}{g}}{\jterm{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}{\subst{x}{g}}}
& &\inference{\jtermeq{\ctxext{{\Gamma}{A}}{P}}{Q}{g}{g'}}{\jtermeq{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}{\subst{x}{g}}{\subst{x'}{g'}}}
\end{align}

We also add the following rule asserting that substitution preserves the
property of being a type:
\begin{align}
& \inference{\jterm{\Gamma}{A}{x}\quad\jtype{\ctxext{{\Gamma}{A}}{P}}{Q}}{\jtype{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}}
\end{align}

\subsubsection{Substitution is compatible with the empty context}
The fibers of the empty family are the empty families:
\begin{align}
& \inference{\jterm{\Gamma}{A}{x}}{\jfameq{\Gamma}{\subst{x}{\emptyf}}{\emptyf}}\\
& \inference{\jterm{\Gamma}{A}{x}\quad\jfam{\ctxext{\Gamma}{A}}{P}}{\jfameq{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{\emptyf}}{\emptyf}}
\end{align}

The following rules assert that substituting by the term $\jterm{\Gamma}{\emptyf}{\emptytm}$
leaves everything unchanged.
\begin{align}
& \inference{\jfam{\Gamma}{A}}{\jfameq{\Gamma}{\subst{\emptytm}{A}}{A}}\\
& \inference{\jterm{\Gamma}{A}{x}}{\jtermeq{\Gamma}{A}{\subst{\emptytm}{x}}{x}}\\
& \inference{\jfam{\ctxext{\Gamma}{A}}{P}}{\jfameq{\ctxext{\Gamma}{A}}{\subst{\emptytm}{P}}{P}}\\
& \inference{\jterm{\ctxext{\Gamma}{A}}{P}{f}}{\jtermeq{\ctxext{\Gamma}{A}}{P}{\subst{\emptytm}{f}}{f}}.
\end{align}

\subsubsection{Substitution is compatible with extension}\label{comp-se}
Suppose $\jterm{\Gamma}{A}{x}$ in all of the following inference rule.
\begin{align}
& \inference{\jfam{\ctxext{{{\Gamma}{A}}{P}}{Q}}{R}}
  {\jfameq{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{\ctxext{Q}{R}}}{\ctxext{\subst{x}{Q}}{\subst{x}{R}}}}
\end{align}

\subsubsection{Substitution is compatible with weakening}\label{comp-sw}
The rules asserting the compatibility of substitution with weakening assert
that the following diagram commutes for any $\jterm{\Gamma}{A}{x}$ and any
$\jfam{\ctxext{\Gamma}{A}}{P}$:
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\jfam{\ctxext{\Gamma}{A}}{\blank} \ar{d}[swap]{Q\mapsto\subst{x}{Q}} \ar{r}{Q\mapsto\ctxwk{P}{Q}} & \jfam{\ctxext{{\Gamma}{A}}{P}}{\blank} \ar{d}{R\mapsto\subst{x}{R}}\\ 
\jfam{\Gamma}{\blank} \ar{r}[swap]{B\mapsto\ctxwk{\subst{x}{P}}{B}} & \jfam{\ctxext{\Gamma}{\subst{x}{P}}}{\blank}
\end{tikzcd}
\end{equation*}
We plug in an extra layer of families to cover the most general case at once.
In the following inference rules we assume that $\jterm{\Gamma}{A}{x}$ and
$\jfam{\ctxext{\Gamma}{A}}{P}$:
\begin{align}
& \inference
  {\jfam{\ctxext{{\Gamma}{A}}{Q}}{R}}
  {\jfameq{\ctxext{{\Gamma}{\subst{x}{P}}}{\subst{x}{\ctxwk{P}{Q}}}}{\subst{x}{\ctxwk{P}{R}}}{\ctxwk{\subst{x}{P}}{\subst{x}{R}}}}\label{comp-sw-f}\\
& \inference
    {\jterm{\ctxext{{\Gamma}{A}}{Q}}{R}{h}}
    {\jtermeq
      {\ctxext{{\Gamma}{\subst{x}{P}}}{\subst{x}{\ctxwk{P}{Q}}}}
      {\subst{x}{\ctxwk{P}{R}}}
      {\subst{x}{\ctxwk{P}{h}}}
      {\ctxwk{\subst{x}{P}}{\subst{x}{h}}}}\label{comp-sw-t}
\end{align}

\subsubsection{Substitution is compatible with substitution}\label{comp-ss}

We require that substitution is compatible with itself, which is roughly the
assertion that substitution is associative. However, we cannot just state that
$\subst{x}{{f}{g}}\jdeq\subst{{x}{f}}{g}$ since the expression $\subst{{x}{f}}{g}$
is not well-formed. The term $\subst{x}{f}$ can be substituted in (terms of) families over
$\subst{x}{P}$; the term $\subst{x}{g}$ is such. Therefore, associativity of
substitution takes the form $\subst{x}{{f}{g}}\jdeq\subst{{x}{f}}{{x}{g}}$.
Note that the term $\subst{{x}{f}}{{x}{g}}$ may be written down more conveniently
as $\subst{x,\subst{x}{f}}{g}$, although we will not do that here.

In the following inference rules we assume
$\jterm{\Gamma}{A}{x}$ and $\jterm{\ctxext{\Gamma}{A}}{P}{f}$.

\begin{align}
&\inference{\jfam{\ctxext{{{\Gamma}{A}}{P}}{Q}}{R}}
{\jfameq{\ctxext{\Gamma}{\subst{x}{{f}{Q}}}}{\subst{x}{{f}{R}}}{\subst{{x}{f}}{{x}{R}}}}\label{comp-ss-f}\\
&\inference{\jterm{\ctxext{{{\Gamma}{A}}{P}}{Q}}{R}{h}}
{\jtermeq{\ctxext{\Gamma}{\subst{x}{{f}{Q}}}}{\subst{x}{{f}{R}}}{\subst{x}{{f}{h}}}{\subst{{x}{f}}{{x}{h}}}}\label{comp-ss-t}
\end{align}

\subsubsection{Weakening is compatible with substitution}\label{comp-ws}
We already have rules for the compatibility of substitution with weakening, but
we still need the rules the other way around, asserting that there is a 
judgmental equality $\ctxwk{A}{\subst{y}{Q}}\jdeq\subst{\ctxwk{A}{y}}{\ctxwk{A}{Q}}$
together with all its variants.

In the following inference rules we assume that $\jfam{\Gamma}{A}$ and that
$\jterm{\Gamma}{B}{y}$.

\begin{align}
& \inference{\jfam{\ctxext{{\Gamma}{B}}{Q}}{R}}{\jfameq{\ctxext{{\Gamma}{A}}{\ctxwk{A}{\subst{y}{Q}}}}{\ctxwk{A}{\subst{y}{R}}}{\subst{\ctxwk{A}{y}}{\ctxwk{A}{R}}}}\label{comp-ws-f}\\
& \inference{\jterm{\ctxext{{\Gamma}{B}}{Q}}{R}{h}}{\jtermeq{\ctxext{{\Gamma}{A}}{\ctxwk{A}{\subst{y}{Q}}}}{\ctxwk{A}{\subst{y}{R}}}{\ctxwk{A}{\subst{y}{h}}}{\subst{\ctxwk{A}{y}}{\ctxwk{A}{h}}}}\label{comp-ws-t}
\end{align}

\subsection{Composition and identity functions}
\subsubsection{The defining property of weakening}
The judgmental equalities we're about to describe assert that substituting a term
in the weakening a thing gives you the thing back. In the case of contexts we get that each fiber
$\subst{x}{\ctxwk{A}{B}}$ is just $B$ and in the case of terms we get 
that $\ctxwk{A}{y}$ is the constant function
mapping everything to $y:B$. Thus, these rules actually establish the weakening
as the weakening. After stating the rules we will describe what it means to
compose context morphisms (terms of weakened contexts).

\begin{align}
& \inference{\jfam{\Gamma}{A}\qquad\jfam{\ctxext{\Gamma}{B}}{Q}\qquad\jterm{\Gamma}{A}{x}}{\jfameq{\ctxext{\Gamma}{B}}{\subst{x}{\ctxwk{A}{Q}}}{Q}}\label{defn-ws-3}\\
& \inference{\jterm{\Gamma}{A}{x}\qquad\jterm{\ctxext{\Gamma}{B}}{Q}{g}}{\jtermeq{\ctxext{\Gamma}{B}}{Q}{\subst{x}{\ctxwk{A}{g}}}{g}}\label{defn-ws-4}
\end{align}

Using the rules of the compatibility of substitution with weakening and of the
compatibility of weakening with itself, we see that we can show
\begin{equation*}
\jfameq{\ctxext{\Gamma}{A}}{\subst{f}{\ctxwk{A}{{B}{C}}}}{\ctxwk{A}{C}}
\end{equation*}
for any three families $A$, $B$ and $C$ in context $\Gamma$ and any $\jterm{\ctxext{\Gamma}{A}}{\ctxwk{A}{B}}{f}$.
It follows that for $\jterm{\ctxext{\Gamma}{B}}{\ctxwk{B}{C}}{g}$ we have
\begin{equation*}
\jterm{\ctxext{\Gamma}{A}}{\ctxwk{A}{C}}{\subst{f}{\ctxwk{A}{g}}}
\end{equation*}
The term $\jcomp{A}{f}{g}$ is the composition of $g$ with $f$. We may call
a term $\jterm{\ctxext{\Gamma}{A}}{\ctxwk{A}{B}}{f}$ a morphism from $A$ to $B$.

\subsubsection{Identity functions}
Without a rule explicitly asserting the existence of an identity morphism we don't
get one, hence we do that here. The identity morphism is a term which introduced
in ordinary type theory via the variable rule. The variable rule is a bit more
general: it asserts that
\begin{equation*}
\jterm{\Gamma,\,x_1:A_1,\ldots,\,x_n:A_n}{A_i}{x_i}
\end{equation*}
for every $1\leq i\leq n$. Thus, it establishes the projections. In our setting,
we get the projections from the identity morphisms together with weakening. We
already have weakening, so here it suffices to introduce the identity morphisms.
\begin{align}
& \inference{\jfam{\Gamma}{A}}{\jterm{\ctxext{\Gamma}{A}}{\ctxwk{A}{A}}{\idfunc[A]}}
& & \inference{\jfameq{\Gamma}{A}{A'}}{\jtermeq{\ctxext{\Gamma}{A}}{\ctxwk{A}{A}}{\idfunc[A]}{\idfunc[A']}}
\end{align}
Identity functions are determined by their behavior with respect to substitution combined with
weakening. The identity functions will also be subject to compatibility rules.
\begin{align}
& \inference{\jterm{\Gamma}{A}{x}}{\jtermeq{\Gamma}{A}{\subst{x}{\idfunc[A]}}{x}}\label{idfunc-subst-defn}\\
& \inference{\jfam{\ctxext{\Gamma}{A}}{P}}{\jfameq{\ctxext{\Gamma}{A}}{\subst{\idfunc[A]}{\ctxwk{A}{P}}}{P}}\label{idfunc-wk-defn}\\
& \inference{\jfam{\ctxext{\Gamma}{A}}{P}}{\jfameq{\ctxext{\Gamma}{A}}{\subst{\idfunc[A]}{\ctxwk{{A}{A}}{P}}}{P}}\label{idfunc-wk-defn2}\\
& \inference{\jterm{\ctxext{\Gamma}{A}}{P}{f}}{\jtermeq{\ctxext{\Gamma}{A}}{P}{\subst{\idfunc[A]}{\ctxwk{A}{f}}}{f}}\label{idfunc-precomp} \\
& \inference{\jterm{\ctxext{\Gamma}{A}}{P}{f}}{\jtermeq{\ctxext{\Gamma}{A}}{P}{\subst{\idfunc[A]}{\ctxwk{{A}{A}}{f}}}{f}}\label{idfunc-precomp} \\
& \inference{\jterm{\ctxext{\Gamma}{B}}{\ctxwk{B}{A}}{g}}{\jtermeq{\ctxext{\Gamma}{B}}{\ctxwk{B}{A}}{\subst{g}{\ctxwk{B}{\idfunc[A]}}}{g}}\label{idfunc-postcomp}
\end{align}

We won't state a compatibility rule stating that the identity function is
compatible with extension because we will be able to prove that. Instead, we
will just state the compatibility rules for the identity function combined with
weakening and with substitution.

The identity function of a weakened family is the weakened identity function:
\begin{equation}\label{idfunc-wk-comp}
\inference{\jfam{\Gamma}{A}\quad\jfam{\Gamma}{B}}{\jtermeq{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{{A}{B}}{{A}{B}}}{\idfunc[\ctxwk{A}{B}]}{\ctxwk{A}{\idfunc[B]}}}
\end{equation}

The identity function of a substituted family is the substitution of the identity function
\begin{equation}\label{idfunc-subst-comp}
\inference{\jterm{\Gamma}{A}{x}\quad\jfam{\ctxext{\Gamma}{A}}{P}}{\jtermeq{\ctxext{\Gamma}{\subst{x}{P}}}{\ctxwk{\subst{x}{P}}{\subst{x}{P}}}{\idfunc[\subst{x}{P}]}{\subst{x}{\idfunc[P]}}}
\end{equation}

\subsection{Extension on terms}\label{extension-on-terms}
In this subsection we consider the notion of extension on terms, which has now
become definable inside our theory. Moreover, every compatibility rule one may
dream of is provable as well, using the compatibility rules we have introduced
earlier. \emph{This subsection contains no new assumptions.}

\begin{defn}
When $\jterm{\Gamma}{A}{x}$ and $\jterm{\Gamma}{\subst{x}{P}}{u}$ are terms,
we define 
\begin{equation*}
\jtermdefn{\Gamma}{\ctxext{A}{P}}{\ctxext{x}{u}}{\subst{u}{{x}{\idfunc[\ctxext{A}{P}]}}}.
\end{equation*} 
\end{defn}

Thus, the term $\ctxext{x}{u}$ is the pairing of $x$ and $u$. Note that because
we have the judgmental equality 
$\ctxwk{P}{{A}{\ctxext{A}{P}}}\jdeq\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}$ in the
context $\ctxext{{\Gamma}{A}}{P}$, the
pairing function could just be defined as $\idfunc[\ctxext{A}{P}]$. 

When we substitute by an extended term we get an equal result as when we
substitute two consecutive times, like the way currying works.

\begin{lem}
The following inference rules are valid:
\begin{align*}
& \inference{\jterm{\Gamma}{A}{x}\quad\jterm{\Gamma}{\subst{x}{P}}{u}\quad\jfam{\ctxext{{\Gamma}{A}}{P}}{Q}}
  {\jfameq{\Gamma}{\subst{\ctxext{x}{u}}{Q}}{\subst{u}{{x}{Q}}}}\\
& \inference{\jterm{\Gamma}{A}{x}\quad\jterm{\Gamma}{\subst{x}{P}}{u}\quad\jterm{\ctxext{{\Gamma}{A}}{P}}{Q}{g}}
  {\jtermeq{\Gamma}{\subst{u}{{x}{Q}}}{\subst{\ctxext{x}{u}}{g}}{\subst{u}{{x}{g}}}}\\
& \inference{\jterm{\Gamma}{A}{x}\quad\jterm{\Gamma}{\subst{x}{P}}{u}\quad\jfam{\ctxext{{{\Gamma}{A}}{P}}{Q}}{R}}
  {\jfameq{\ctxext{\Gamma}{\subst{u}{{x}{Q}}}}{\subst{\ctxext{x}{u}}{R}}{\subst{u}{{x}{R}}}}\\
& \inference{\jterm{\Gamma}{A}{x}\quad\jterm{\Gamma}{\subst{x}{P}}{u}\quad\jterm{\ctxext{{{\Gamma}{A}}{P}}{Q}}{R}{t}}
  {\jtermeq{\ctxext{\Gamma}{\subst{u}{{x}{Q}}}}{\subst{u}{{x}{R}}}{\subst{\ctxext{x}{u}}{t}}{\subst{u}{{x}{t}}}}
\end{align*}
\end{lem}

\begin{proof}
We prove only the first judgmental equality. All the others are similar.
Let $\jterm{\Gamma}{A}{x}$ and $\jterm{\Gamma}{\subst{x}{P}}{u}$
be terms and let $\jfam{\ctxext{{\Gamma}{A}}{P}}{Q}$ be a family. Then we have
\begin{align*}
\subst{\ctxext{x}{u}}{Q} 
& \jdeq \subst{{u}{{x}{\idfunc[\ctxext{A}{P}]}}}{Q} \tag{by definition}\\
& \jdeq \subst{{u}{{x}{\idfunc[\ctxext{A}{P}]}}}{{x}{\ctxwk{A}{Q}}}\tag{by \autoref{defn-ws-3}}\\
& \jdeq \subst{{u}{{x}{\idfunc[\ctxext{A}{P}]}}}{{u}{\ctxwk{\subst{x}{P}}{\subst{x}{\ctxwk{A}{Q}}}}}\tag{by \autoref{defn-ws-3}}\\
& \jdeq \subst{{u}{{x}{\idfunc[\ctxext{A}{P}]}}}{{u}{{x}{\ctxwk{P}{{A}{Q}}}}}\tag{by \autoref{comp-sw-f}}\\
& \jdeq \subst{u}{{{x}{\idfunc[\ctxext{A}{P}]}}{{x}{\ctxwk{{P}{{A}{Q}}}}}}\tag{by \autoref{comp-ss-f}}\\
& \jdeq \subst{u}{{x}{{\idfunc[\ctxext{A}{P}]}{\ctxwk{P}{{A}{Q}}}}}\tag{by \autoref{comp-ss-f}}\\
& \jdeq \subst{u}{{x}{{\idfunc[\ctxext{A}{P}]}{\ctxwk{\ctxext{A}{P}}{Q}}}}\tag{by \autoref{comp-ew-f}}\\
& \jdeq \subst{u}{{x}{Q}}\tag{by \autoref{idfunc-wk-defn}}
\end{align*}
\end{proof}

We have seen above that the pairing function into $\ctxext{A}{P}$ is just the identity function on
$\ctxext{A}{P}$. To analyze the pairing functin a little further, we will also
need the projection maps from $\ctxext{A}{P}$ to $A$ and from $\ctxext{A}{P}$
to $P$. We will now define these and see that the identity function of an
extended family is the extension (or pairing) of the identity
functions on the components in the apropriate way.

To find out what the
apropriate way is, note that
\begin{align*}
\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}} & \jdeq \ctxwk{P}{{A}{\ctxext{A}{P}}}\\
& \jdeq \ctxext{\ctxwk{P}{{A}{A}}}{\ctxwk{P}{{A}{P}}}
\end{align*}
We have the term $\jterm{\ctxext{\Gamma}{{A}{P}}}{\ctxwk{P}{A}}{\ctxwk{P}{\idfunc[A]}}$.
Thus we need to find out what $\subst{\ctxwk{P}{\idfunc[A]}}{\ctxwk{P}{{A}{P}}}$ is:
\begin{align*}
\subst{\ctxwk{P}{\idfunc[A]}}{\ctxwk{P}{{A}{P}}} & \jdeq \ctxwk{P}{\subst{\idfunc[A]}{\ctxwk{A}{P}}}\\
& \jdeq \ctxwk{P}{P},
\end{align*}
where we find the term $\idfunc[P]$. Therefore we define:

\begin{defn}
Let $\jfam{\Gamma}{A}$ and $\jfam{\ctxext{\Gamma}{A}}{P}$ be families. We define
\begin{align*}
\jtermdefn*{\ctxext{\Gamma}{{A}{P}}}{\ctxwk{P}{{A}{A}}}{\cprojfstf{A}{P}}{\ctxwk{P}{\idfunc[A]}}\\
\jtermdefn*{\ctxext{\Gamma}{{A}{P}}}{\ctxwk{P}{P}}{\cprojsndf{A}{P}}{\idfunc[P]}
\end{align*}
\end{defn}

We find the following inference rule, which expresses that the identity function
is compatible with extension:

\begin{lem}
For any $\jfam{\Gamma}{A}$ and $\jfam{\ctxext{\Gamma}{A}}{P}$ we have
\begin{equation}\label{idfunc-ext-comp}
\inference{\jfam{\Gamma}{A}\quad\jfam{\ctxext{\Gamma}{A}}{P}}{\jtermeq{\ctxext{\Gamma}{{A}{P}}}{\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}}{\idfunc[\ctxext{A}{P}]}{\subst{\cprojsndf{A}{P}}{{\cprojfstf{A}{P}}{\idfunc[\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}]}}}}
\end{equation}
\end{lem}

\begin{proof}
Consider the families $\jfam{\Gamma}{A}$ and $\jfam{\ctxext{\Gamma}{A}}{P}$. Then
we have the judgmental equalities
\begin{align*}
\subst{\cprojsndf{A}{P}}{{\cprojfstf{A}{P}}{\idfunc[\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}]}}
& \jdeq \subst{\idfunc[P]}{{\ctxwk{P}{\idfunc[A]}}{\idfunc[\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}]}}\\
& \jdeq \subst{\idfunc[P]}{{\ctxwk{P}{\idfunc[A]}}{\ctxwk{\ctxext{A}{P}}{\idfunc[\ctxext{A}{P}]}}}\\
& \jdeq \subst{\idfunc[P]}{{\ctxwk{P}{\idfunc[A]}}{\ctxwk{P}{{A}{\idfunc[\ctxext{A}{P}]}}}}\\
& \jdeq \subst{\idfunc[P]}{\ctxwk{P}{\subst{\idfunc[A]}{\ctxwk{A}{\idfunc[\ctxext{A}{P}]}}}}\\
& \jdeq \subst{\idfunc[A]}{\ctxwk{A}{\idfunc[\ctxext{A}{P}]}}\\
& \jdeq \idfunc[\ctxext{A}{P}].
\end{align*}
\end{proof}

\begin{lem}
The following inference is valid:
\begin{equation*}
\inference{\jfam{\ctxext{\Gamma}{A}}{P}\quad\jfam{\ctxext{\Gamma}{A}}{Q}}
{\jfameq{\ctxext{\Gamma}{{A}{P}}}{\subst{\cprojfstf{A}{P}}{\ctxwk{\ctxext{A}{P}}{Q}}}{\ctxwk{P}{Q}}}
\end{equation*}
\end{lem}

\begin{proof}
Let $\jfam{\ctxext{\Gamma}{A}}{P}$ and $\jfam{\ctxext{\Gamma}{A}}{Q}$ be
families. Then we have
\begin{align*}
\subst{\cprojfstf{A}{P}}{\ctxwk{\ctxext{A}{P}}{Q}} 
& \jdeq \subst{\ctxwk{P}{\idfunc[A]}}{\ctxwk{\ctxext{A}{P}}{Q}} \tag{by definition}\\
& \jdeq \subst{\ctxwk{P}{\idfunc[A]}}{\ctxwk{P}{{A}{Q}}} \tag{by \autoref{comp-ww-f}}\\
& \jdeq \ctxwk{P}{\subst{\idfunc[A]}{\ctxwk{A}{Q}}} \tag{by \autoref{comp-ws-f}}\\
& \jdeq \ctxwk{P}{Q} \tag{by \autoref{idfunc-wk-defn}}
\end{align*}
\end{proof}

The constructions of the terms $\ctxext{x}{u}$ and $\cprojfst{A}{P}{w}$ and
$\cprojsnd{A}{P}{w}$ are subject to various rules, with all of them being
consequences of earlier introduced inference rules.

\begin{lem} The following inference rules expressing that pairing is a strict
inverse to the combination of decompositions, are valid:
\begin{align*}
& \inference{\jterm{\Gamma}{\ctxext{A}{P}}{w}}{\jtermeq{\Gamma}{\ctxext{A}{P}}{\ctxext{\cprojfst{A}{P}{w}}{\cprojsnd{A}{P}{w}}}{w}}\\
& \inference{\jterm{\Gamma}{A}{x}\quad\jterm{\Gamma}{\subst{x}{P}}{u}}{\jtermeq{\Gamma}{A}{\cprojfst{A}{P}{\ctxext{x}{u}}}{x}}\\
& \inference{\jterm{\Gamma}{A}{x}\quad\jterm{\Gamma}{\subst{x}{P}}{u}}{\jtermeq{\Gamma}{\subst{x}{P}}{\cprojsnd{A}{P}{\ctxext{x}{u}}}{u}}
\end{align*}
\end{lem}

\begin{proof}
To prove the first judgmental equality, note that
\begin{align*}
w & \jdeq \subst{w}{\idfunc[\ctxext{A}{P}]} \tag{by \autoref{idfunc-subst-defn}}\\
& \jdeq \subst{w}{\subst{\idfunc[P]}{{\ctxwk{P}{\idfunc[A]}}{\idfunc[\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}]}}}
  \tag{by \autoref{idfunc-ext-comp}}\\
& \jdeq \subst{{w}{\idfunc[P]}}{\subst{w}{{\ctxwk{P}{\idfunc[A]}}{\idfunc[\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}]}}}\tag{by \autoref{comp-ss-t}}\\
& \jdeq \subst{{w}{\idfunc[P]}}{{\subst{w}{\ctxwk{P}{\idfunc[A]}}}{\subst{w}{\idfunc[\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}]}}}\tag{by \autoref{comp-ss-t}}\\
& \jdeq \subst{{w}{\idfunc[P]}}{{\subst{w}{\ctxwk{P}{\idfunc[A]}}}{\subst{w}{\ctxwk{\ctxext{A}{P}}{\idfunc[\ctxext{A}{P}]}}}}\tag{by \autoref{idfunc-wk-comp}}\\
& \jdeq \subst{{w}{\idfunc[P]}}{{\subst{w}{\ctxwk{P}{\idfunc[A]}}}{\idfunc[\ctxext{A}{P}]}}\tag{by \autoref{defn-ws-4}}\\
& \jdeq \ctxext{\cprojfst{A}{P}{w}}{\cprojsnd{A}{P}{w}}\tag{by definition}
\end{align*}
To prove the second judgmental equality, let $\jterm{\Gamma}{A}{x}$ and
$\jterm{\Gamma}{\subst{x}{P}}{u}$. Then we have
\begin{align*}
\cprojfst{A}{P}{\ctxext{x}{u}}
& \jdeq \subst{\ctxext{x}{u}}{\ctxwk{P}{\idfunc[A]}}\\
& \jdeq \subst{u}{{x}{\ctxwk{P}{\idfunc[A]}}} \\
& \jdeq \subst{u}{\ctxwk{\subst{x}{P}}{\subst{x}{\idfunc[A]}}}\\
& \jdeq \subst{x}{\idfunc[A]}\\
& \jdeq x.
\end{align*}
To prove the third judgmental equality, note that
\begin{align*}
\cprojsnd{A}{P}{\ctxext{x}{u}}
& \jdeq \subst{\ctxext{x}{u}}{\idfunc[P]}\\
& \jdeq \subst{u}{{x}{\idfunc[P]}}\\
& \jdeq \subst{u}{\idfunc[\subst{x}{P}]}\\
& \jdeq u.
\end{align*}
\end{proof}

\begin{lem}
The following compatibility rules for two consecutive term extensions is valid:
\begin{align*}
& \inference{\jterm{\Gamma}{A}{x}\quad\jterm{\Gamma}{\subst{x}{P}}{u}\quad\jterm{\Gamma}{\subst{\ctxext{x}{u}}{Q}}{v}}
{\jtermeq{\Gamma}{\ctxext{{A}{P}}{Q}}{\ctxext{x}{{u}{v}}}{\ctxext{{x}{u}}{v}}}\\
& \inference{\jterm{\Gamma}{\ctxext{{A}{P}}{Q}}{w}}
  {\jtermeq{\Gamma}{A}{\cprojfst{A}{P}{\cprojfst{\ctxext{A}{P}}{Q}{w}}}{\cprojfst{A}{\ctxext{P}{Q}}{w}}}\\
& \inference{\jterm{\Gamma}{\ctxext{{A}{P}}{Q}}{w}}
  {\jtermeq{\Gamma}{\subst{\cprojfst{A}{\ctxext{P}{Q}}{w}}{P}}
  {\cprojsnd{A}{P}{\cprojfst{\ctxext{A}{P}}{Q}{w}}}
  {\cprojfst{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}}\\
& \inference{\jterm{\Gamma}{\ctxext{{A}{P}}{Q}}{w}}
  {\jtermeq{\Gamma}{\subst{\cprojfst{\ctxext{A}{P}}{Q}{w}}{Q}}
  {\cprojsnd{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}
  {\cprojsnd{\ctxext{A}{P}}{Q}{w}}}
\end{align*}
\end{lem}

\begin{proof}
Consider terms $\jterm{\Gamma}{A}{x}$, $\jterm{\Gamma}{\subst{x}{P}}{u}$ and
$\jterm{\Gamma}{\subst{u}{{x}{Q}}}{v}$. Then we have
\begin{align*}
\ctxext{x}{{u}{v}} & \jdeq \subst{\ctxext{u}{v}}{{x}{\idfunc[\ctxext{A}{{P}{Q}}]}}\\
& \jdeq \subst{v}{{u}{{x}{\idfunc[\ctxext{A}{{P}{Q}}]}}}\\
& \jdeq \subst{v}{{u}{{x}{\idfunc[\ctxext{{A}{P}}{Q}]}}}\\
& \jdeq \subst{v}{{\ctxext{x}{u}}{\idfunc[\ctxext{{A}{P}}{Q}]}}\\
& \jdeq \ctxext{{x}{u}}{v}.
\end{align*}
Now consider a term $\jterm{\Gamma}{\ctxext{A}{{P}{Q}}}{w}$. Then we have
\begin{align*}
w 
& \jdeq \ctxext{\cprojfst{A}{\ctxext{P}{Q}}{w}}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}\\
& \jdeq \ctxext{\cprojfst{A}{\ctxext{P}{Q}}{w}}{{\cprojfst{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}{\cprojsnd{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}}\\
& \jdeq \ctxext{{\cprojfst{A}{\ctxext{P}{Q}}{w}}{\cprojfst{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}}{\cprojsnd{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}
\end{align*}
Thus we see that 
\begin{align*}
\cprojfst{\ctxext{A}{P}}{Q}{w} & \jdeq \ctxext{\cprojfst{A}{\ctxext{P}{Q}}{w}}{\cprojfst{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}\\ 
\cprojsnd{\ctxext{A}{P}}{Q}{w} & \jdeq \cprojsnd{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}},
\end{align*}
proving the fourth judgmental equality, and therefore also that
\begin{align*}
\cprojfst{A}{P}{\cprojfst{\ctxext{A}{P}}{Q}{w}} & \jdeq \cprojfst{A}{\ctxext{P}{Q}}{w}\\
\cprojsnd{A}{P}{\cprojfst{\ctxext{A}{P}}{Q}{w}} & \jdeq \cprojfst{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}},
\end{align*}
proving the second and the third judgmental equalities.
\end{proof}

\begin{lem}
When we weaken a term $\ctxext{y}{v}$ of $\ctxext{B}{Q}$ in context $\Gamma$ by
a family $A$, the term that we get is $\ctxext{\ctxwk{A}{y}}{\ctxwk{A}{v}}$. More
precisely, the following inference rules are valid:
\begin{align*}
& \inference{\jterm{\ctxext{\Gamma}{B}}{Q}{g}\quad\jterm{\ctxext{\Gamma}{B}}{\subst{g}{R}}{t}}{\jtermeq{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{\ctxext{Q}{R}}}{\ctxwk{A}{\ctxext{g}{t}}}{\ctxext{\ctxwk{A}{g}}{\ctxwk{A}{t}}}}
% \\
%& \inference{\jterm{\Gamma}{\ctxwk{A}{\ctxext{B}{Q}}}{\ctxwk{A}{w}}}{\jtermeq{\ctxext{\Gamma}{A}}{\ctxwk{A}{B}}{\cprojfst{\ctxwk{A}{B}}{\ctxwk{A}{Q}}{\ctxwk{A}{w}}}{\ctxwk{A}{(\cprojfst{B}{Q}{w})}}}\\
\end{align*}
\end{lem}

\begin{proof}
Consider $\jterm{\ctxext{\Gamma}{B}}{Q}{g}$ and $\jterm{\ctxext{\Gamma}{B}}{\subst{g}{R}}{t}$.
Then we have the judgmental equalities
\begin{align*}
\ctxwk{A}{\ctxext{g}{t}}
& \jdeq \ctxwk{A}{\subst{t}{{g}{\idfunc[\ctxext{Q}{R}]}}}\\
& \jdeq \subst{\ctxwk{A}{t}}{\ctxwk{A}{\subst{g}{\idfunc[\ctxext{Q}{R}]}}}\\
& \jdeq \subst{\ctxwk{A}{t}}{{\ctxwk{A}{g}}{\ctxwk{A}{\idfunc[\ctxext{Q}{R}]}}}\\
& \jdeq \subst{\ctxwk{A}{t}}{{\ctxwk{A}{g}}{\idfunc[\ctxwk{A}{\ctxext{Q}{R}}]}}\\
& \jdeq \subst{\ctxwk{A}{t}}{{\ctxwk{A}{g}}{\idfunc[\ctxext{\ctxwk{A}{Q}}{\ctxwk{A}{R}}]}}\\
& \jdeq \ctxext{\ctxwk{A}{g}}{\ctxwk{A}{t}}
\end{align*}
\end{proof}

\begin{lem}
When we substitute an extended term $\ctxext{f}{g}$ of $\ctxext{P}{Q}$ by a term
$x$ of $A$, the term that we get is $\ctxext{\subst{x}{f}}{\subst{x}{g}}$.
More precisely, the following inference rules are valid:
\begin{align*}
& \inference{\jterm{\ctxext{{\Gamma}{A}}{P}}{Q}{g}\quad\jterm{\ctxext{{\Gamma}{A}}{P}}{\subst{g}{R}}{t}}{\jtermeq{\ctxext{\Gamma}{\subst{x}{P}}}{\ctxext{\subst{x}{Q}}{\subst{x}{R}}}{\subst{x}{\ctxext{g}{t}}}{\ctxext{\subst{x}{g}}{\subst{x}{t}}}}
\end{align*}
\end{lem}

\begin{proof}
Consider $\jterm{\ctxext{\Gamma}{B}}{Q}{g}$ and $\jterm{\ctxext{\Gamma}{B}}{\subst{g}{R}}{t}$.
Then we have the judgmental equalities
\begin{align*}
\subst{x}{\ctxext{g}{t}}
& \jdeq \subst{x}{{t}{{g}{\idfunc[\ctxext{Q}{R}]}}}\\
& \jdeq \subst{{x}{t}}{{x}{{g}{\idfunc[\ctxext{Q}{R}]}}}\\
& \jdeq \subst{{x}{t}}{{{x}{g}}{{x}{\idfunc[\ctxext{Q}{R}]}}}\\
& \jdeq \subst{{x}{t}}{{{x}{g}}{\idfunc[\subst{x}{\ctxext{Q}{R}}]}}\\
& \jdeq \subst{{x}{t}}{{{x}{g}}{\idfunc[\ctxext{\subst{x}{Q}}{\subst{x}{R}}]}}\\
& \jdeq \ctxext{\subst{x}{g}}{\subst{x}{t}}.
\end{align*}
\end{proof}

\section{Pretty type theory}
In this section we will do three things. First we explain basic type theory with
variable names, which we simply call \emph{Pretty Type Theory}. 
Then we will show how every formula in basic type theory without
variable names (shall we call it \emph{Structural Type Theory}?) 
can be interpreted in pretty type theory. Finally, we will show how every formula
in pretty type theory can be interpreted in structural type theory.

Pretty type theory is pretty as the ugly little duckling that grew up. At first, it is actually uglier than
structural type theory because one has to keep track of a variable nobody is
actually interested in. The situation improves when we introduce the operators
of extension and weakening, because from that point onwards one can draw notational
advantages from having the variable around.

\subsection{The basic judgments}
The type theory we describe here is a theory of contexts, families of
contexts and terms thereof. The families of contexts are by some authors called
dependent contexts, but they are handled a bit differently here because they
become the primary object of study. Dependent contexts can be types; they could
be seen as atomic or indecomposable dependent contexts.

Thus we make eight kinds of judgments in our type theory: ``$\Gamma$ is a context'',
``$A(i)$ is a family of contexts over $\Gamma$'', ``$A$ is a type in context $\Gamma$''
and ``$x$ is a term of the family $A$ of contexts over $\Gamma$''. The other four
judgments are for judgmental equality. 

\begin{align*}
\jvctx*{\Gamma} & \jvctxeq*{\Gamma}{\Gamma'}\\
\jvfam*{i}{\Gamma}{A} & \jvfameq*{i}{\Gamma}{A}{B}\\
\jvtype*{i}{\Gamma}{A} & \jvtypeeq*{i}{\Gamma}{A}{B}\\
\jvterm*{i}{\Gamma}{A}{x} & \jvtermeq*{i}{\Gamma}{A}{x}{y}.
\end{align*}

If $A$ is a type
in context $\Gamma$, then $A$ is also a family of contexts over $\Gamma$. Being
a term of type $A$ means the same thing as being a term of the family $A$ of contexts.
Two types in context $\Gamma$ are judgmentally equal precisely when they are equal
as context families. Moreover, if a family $B$ of contexts over $\Gamma$ is
judgmentally equal to a type $A$ in context $\Gamma$, then $B$ is a type in
context $\Gamma$. This is expressed by the following four inference rules:

\begin{small}
\begin{align*}
& \inference{\jvtype{i}{\Gamma}{A}}{\jvfam{i}{\Gamma}{A}} & & \inference{\jvtypeeq{i}{\Gamma}{A}{B}}{\jvfameq{i}{\Gamma}{A}{B}}\\
& \inference{\jvtype{i}{\Gamma}{A}\quad\jvfameq{i}{\Gamma}{A}{B}}{\jvtype{i}{\Gamma}{B}}
& & \inference{\jvtype{i}{\Gamma}{A}\quad\jvfameq{i}{\Gamma}{A}{B}}{\jvtypeeq{i}{\Gamma}{A}{B}}
\end{align*}
\end{small}

\subsection{The basic rules for judgmental equality}
The rules for judgmental equality establish that it is an equivalence relation
in all three cases (contexts, types and terms).
\bgroup\small
\begin{align*}
& \inference{\jvctx{\Gamma}}{\jvctxeq{\Gamma}{\Gamma}} 
& & \inference{\jvctxeq{\Gamma}{\Delta}}{\jvctxeq{\Delta}{\Gamma}} 
& & \inference{\jvctxeq{\Gamma}{\Delta}\qquad\jvctxeq{\Delta}{\greek{E}}}{\jvctxeq{\Gamma}{\greek{E}}}\\
& \inference{\jvfam{i}{\Gamma}{A}}{\jvfameq{i}{\Gamma}{A}{A}} 
& & \inference{\jvfameq{i}{\Gamma}{A}{B}}{\jvfameq{i}{\Gamma}{B}{A}}
& & \inference{\jvfameq{i}{\Gamma}{A}{B}\qquad\jvfameq{i}{\Gamma}{B}{C}}{\jvfameq{i}{\Gamma}{A}{C}}\\
& \inference{\jvterm{i}{\Gamma}{A}{x}}{\jvtermeq{i}{\Gamma}{A}{x}{x}}
& & \inference{\jvtermeq{i}{\Gamma}{A}{x}{y}}{\jvtermeq{i}{\Gamma}{A}{y}{x}}
& & \inference{\jvtermeq{i}{\Gamma}{A}{x}{y}\qquad\jvtermeq{i}{\Gamma}{A}{y}{z}}{\jvtermeq{i}{\Gamma}{A}{x}{z}}
\end{align*}
\egroup

The following convertibility rules are responsible for the strictness
of judgmental equality, which sets it apart from equivalences or identifications:

\begin{align*}
& \inference{\jvctxeq{\Gamma}{\Delta}\qquad\jvfam{i}{\Gamma}{A}}{\jvfam{i}{\Delta}{A}}
& & \inference{\jvctxeq{\Gamma}{\Delta}\qquad\jvfameq{i}{\Gamma}{A}{B}}{\jvfameq{i}{\Delta}{A}{B}}\\
& \inference{\jvctxeq{\Gamma}{\Delta}\qquad\jvterm{i}{\Gamma}{A}{x}}{\jvterm{i}{\Delta}{A}{x}}
& & \inference{\jvctxeq{\Gamma}{\Delta}\qquad\jvtermeq{i}{\Gamma}{A}{x}{y}}{\jvtermeq{i}{\Delta}{A}{x}{y}}\\
& \inference{\jvfameq{i}{\Gamma}{A}{B}\qquad \jvterm{i}{\Gamma}{A}{x}}{\jvterm{i}{\Gamma}{B}{x}}
& & \inference{\jvfameq{i}{\Gamma}{A}{B}\qquad\jvtermeq{i}{\Gamma}{A}{x}{y}}{\jvtermeq{i}{\Gamma}{B}{x}{y}}
\end{align*}

\subsection{The empty context}
There is an empty context and over any context there is an empty family of
contexts. We do not assume that the empty context is a type, that would be like
assuming that the multiplicative unit of a ring is prime. The empty family
always has a unique term.

\begin{align}
& \inference{}{\jctx{\emptyc}}\\
& \inference{\jctx{\Gamma}}{\jvfam{i}{\Gamma}{\emptyf[\Gamma]}}\\
& \inference{\jctx{\Gamma}}{\jvterm{i}{\Gamma}{\emptyf[\Gamma]}{\emptytm[\Gamma]}}\\
& \inference{\jvterm{i}{\Gamma}{\emptyf[\Gamma]}{x}}{\jvtermeq{i}{\Gamma}{\emptyf[\Gamma]}{x}{\emptytm[\Gamma]}}
\end{align}

Moreover, if $\Gamma$ is a context family over the
empty context, then $\Gamma$ is a context and every context is a context
family over the empty context. Note that this allows us to speak
of terms of contexts too.

\begin{align}
& \inference{\jctx{\Gamma}}{\jvfam{\nameless}{\emptyc}{\Gamma}} 
& & \inference{\jvfam{\nameless}{\emptyc}{\Gamma}}{\jctx{\Gamma}}\\
& \inference{\jctxeq{\Gamma}{\Delta}}{\jvfameq{\nameless}{\emptyc}{\Gamma}{\Delta}}
& & \inference{\jvfameq{\nameless}{\emptyc}{\Gamma}{\Delta}}{\jctxeq{\Gamma}{\Delta}}
\end{align}

\subsubsection{The empty context is compatible with itslef}
The empty context $\emptyc$ may be considered as a family of contexts over the empty
context. When we do this, we get $\emptyf[\emptyc]$.
\begin{equation}
\inference{}{\jvfameq{\nameless}{\emptyc}{\emptyc}{\emptyf[\emptyc]}}
\end{equation}
In the future, we shall denote $\emptyf[\Gamma]$ by $\emptyf$. The above rule
guarantees that this will not cause confusion. Likewise, we shall denote
$\emptytm[\Gamma]$ by $\emptytm$.

\subsection{Extension}
We introduce extension which not only extends a context $\Gamma$ and a family
$A$ over it to a context $\ctxext{\Gamma}{A}$, but which also extends a family $A$
in context $\Gamma$ and a family $P$ over it to a family $\ctxext{A}{P}$ over context
$\Gamma$. We do this to ensure that all of type theory can be done in a context.
For instance, we could say (1) that a context in context $\Gamma$ is the same thing
as a family over $\Gamma$; (2) When $A$ is a context in this sense, a family over
$A$ is the same thing as a family $P$ over $\ctxext{\Gamma}{A}$ and 
(3) when $P$ is a family over $A$ in this sense, a term of $P$ keeps its original meaning.

\begin{align}
& \inference{\jvfam{i}{\Gamma}{A}}{\jvfamcombi{{i}{x}}{{\Gamma}{A}}{P}}
& & \inference{\jctxeq{\Gamma}{\Delta}\qquad\jfameq{\Gamma}{A}{B}}{\jctxeq{\ctxext{\Gamma}{A}}{\ctxext{\Delta}{B}}}\\
& \inference{\jfam{\ctxext{\Gamma}{A}}{P}}{\jfam{\Gamma}{\ctxext{A}{P}}}
& & \inference{\jfameq{\Gamma}{A}{B}\qquad\jfameq{\ctxext{\Gamma}{A}}{P}{Q}}{\jfameq{\Gamma}{\ctxext{A}{P}}{\ctxext{B}{Q}}}
\end{align}

\subsubsection{Extension is compatible with the empty context}
The following rule asserts that extension by $\emptyc$ leaves the contexts unchanged.
\begin{align}
& \inference{\jctx{\Gamma}}{\jctxeq{\ctxext{\emptyc}{\Gamma}}{\Gamma}}\\
& \inference{\jctx{\Gamma}}{\jctxeq{\ctxext{\Gamma}{\emptyf}}{\Gamma}}\\
& \inference{\jfam{\Gamma}{A}}{\jfameq{\Gamma}{\ctxext{\emptyf}{A}}{A}}
\end{align}

\subsubsection{Extension is compatible with itself}\label{comp-ee}
The inference rules asserting that extension is compatible with itself assert
that contexts are unstructured lists of type declarations. This rule is
unavoidable if we want that for a family $A$ in context $\Gamma$, a family over
$A$ is the same thing as a family over $\ctxext{\Gamma}{A}$. 

\begin{align}
& \inference{\jfam{\Gamma}{A}\qquad\jfam{\ctxext{\Gamma}{A}}{P}}
  {\jctxeq{\ctxext{{\Gamma}{A}}{P}}{\ctxext{\Gamma}{{A}{P}}}}\\
& \inference{\jfam{\ctxext{\Gamma}{A}}{P}\qquad\jfam{\ctxext{{\Gamma}{A}}{P}}{Q}}
  {\jfameq{\Gamma}{\ctxext{{A}{P}}{Q}}{\ctxext{A}{{P}{Q}}}}
\end{align}


\section{Chalmers type theory}
In this section we will present the type theory that Coquand and Dybjer are using.
It is a weak type theory (I think), with not so many operations and judgmental equalities.
We will show how every formula of Chalmers type theory can be interpreted in
structural type theory.
