\section{Type theory before type constructors}\label{tt}
In this section we give a description of type theory before basic
constructors and with explicit extension, weakening and substitution. We will
formulate the type theory in such a way that contexts aren't lists of variable
declarations. The reasons for this are twofold: (1) in the models of type theory
such as a univalent universe or the graph model, contexts are types and graphs
respectively -- they are objects rather than lists of variable declarations; we
intend to give a general algebraic description of higher categories. Besides,
we will not have to be burdened with comments about variables being bounded or not, or fresh or
not occuring at all.

We will develop a theory which is in fact a theory of contexts and families of
contexts where a family of context can be a type, behind which we have the
intuition that it is an atomic or irreducible family of contexts. We get immediately
that every construction can be made in an arbitrary context. 

It should be noted that this is just a prototype description. It may be the case
that various other elements have to be added yet, such as terms
$\jterm{\ctxext{\Gamma}{\subst{x}{P}}}{\ctxwk{\subst{x}{P}}{\ctxext{A}{P}}}{i}$
including the fiber $\subst{x}{P}$ into the extended family $\ctxext{A}{P}$ over
$\Gamma$. Moreover, it hasn't been thoroughly tested whether the theory presented
here lives up to its promise.

Much of the rules we state are just compatibility rules of extension, weakening
and substitution with each other. In a way, these rules assert that our contexts
are just structureless lists of contexts and that likewise terms are structureless
lists of terms. They are structureless in the sense that the order in which
they are formed by pairing up is irrelevant. We note that this causes complications
in the traditional way that categorical sematics of type theory is implemented,
where contexts become objects of the category which is supposed to model type
theory. The reason for this is that context extension will not satisfy all the
compatibility rules we're about to state. The first step to resolving this is taking
the types in the empty context as the objects. 

To get the overview of the compatibility rules, we list the sections
where these compatibility rules are described in the following table (in this
table, the
subsection mentioned in row $X$ and column $Y$ consideres the rules of the
operation $Y\circ X$):
\begin{center}
\begin{tabular}{r|ccc}
& extension & weakening & substitution\\
\hline
extension & \autoref{comp-ee} & \autoref{comp-ew} & \\
weakening & \autoref{comp-we} & \autoref{comp-ww} & \autoref{comp-ws}\\
substitution & \autoref{comp-se} & \autoref{comp-sw} & \autoref{comp-ss}
\end{tabular}
\end{center}
Since extension by a context acts trivially on families and terms there are
no rules added for extension followed by substitution.

In \autoref{extension-on-terms} we come back to the operation of extension, but
now for terms. The rules in this section explain what it means to be a term of
an extended family, namely to be an extended term. The compatibility rules for
extended terms are then similar as the compatibility rules that have appeared
earlier: there is a compatibility rule for the extension of an extension, for
the weakening of an extended term, for the substutution of an extended term by
an arbitrary term and for substitution by an extended term. The last set of
compatibility rules is a form of the Curry-Howard isomorphism -- this famous
correspondence naturally comes out of our scheme of compatibility rules.

\subsection{The basic judgments}
The type theory we describe here is a theory of contexts, families of
contexts and terms thereof. The families of contexts are by some authors called
dependent contexts, but they are handled a bit differently here because they
become the primary object of study. Dependent contexts can be types; they could
be seen as atomic or indecomposable dependent contexts.

Thus we make eight types of judgments in our type theory: ``$\Gamma$ is a context'',
``$A$ is a family of contexts over $\Gamma$'', ``$A$ is a type in context $\Gamma$''
and ``$x$ is a term of the family $A$ of contexts over $\Gamma$''. The other four
judgments are for judgmental equality. 

\begin{align*}
\jctx*{\Gamma} & \jctxeq*{\Gamma}{\Gamma'}\\
\jfam*{\Gamma}{A} & \jfameq*{\Gamma}{A}{B}\\
\jtype*{\Gamma}{A} & \jtypeeq*{\Gamma}{A}{B}\\
\jterm*{\Gamma}{A}{x} & \jtermeq*{\Gamma}{A}{x}{y}.
\end{align*}

If $A$ is a type
in context $\Gamma$, then $A$ is also a family of contexts over $\Gamma$. Being
a term of type $A$ means the same thing as being a term of the family $A$ of contexts.
Two types in context $\Gamma$ are judgmentally equal precisely when they are equal
as context families. Moreover, if a family $B$ of contexts over $\Gamma$ is
judgmentally equal to a type $A$ in context $\Gamma$, then $B$ is a type in
context $\Gamma$. This is expressed by the following four inference rules:

\begin{align*}
& \inference{\jfam{\Gamma}{A}}{\jfam{\Gamma}{A}} & & \inference{\jfameq{\Gamma}{A}{B}}{\jfameq{\Gamma}{A}{B}}\\
& \inference{\jfam{\Gamma}{A}\quad\jfameq{\Gamma}{A}{B}}{\jfam{\Gamma}{B}}
& & \inference{\jfam{\Gamma}{A}\quad\jfameq{\Gamma}{A}{B}}{\jfameq{\Gamma}{A}{B}}
\end{align*}


\subsection{The basic rules for judgmental equality}
The rules for judgmental equality establish that it is an equivalence relation
in all three cases (contexts, types and terms).
\bgroup\small
\begin{align*}
& \inference{\jctx{\Gamma}}{\jctxeq{\Gamma}{\Gamma}} 
& & \inference{\jctxeq{\Gamma}{\Delta}}{\jctxeq{\Delta}{\Gamma}} 
& & \inference{\jctxeq{\Gamma}{\Delta}\qquad\jctxeq{\Delta}{\greek{E}}}{\jctxeq{\Gamma}{\greek{E}}}\\
& \inference{\jfam{\Gamma}{A}}{\jfameq{\Gamma}{A}{A}} 
& & \inference{\jfameq{\Gamma}{A}{B}}{\jfameq{\Gamma}{B}{A}}
& & \inference{\jfameq{\Gamma}{A}{B}\qquad\jfameq{\Gamma}{B}{C}}{\jfameq{\Gamma}{A}{C}}\\
& \inference{\jterm{\Gamma}{A}{x}}{\jtermeq{\Gamma}{A}{x}{x}}
& & \inference{\jtermeq{\Gamma}{A}{x}{y}}{\jtermeq{\Gamma}{A}{y}{x}}
& & \inference{\jtermeq{\Gamma}{A}{x}{y}\qquad\jtermeq{\Gamma}{A}{y}{z}}{\jtermeq{\Gamma}{A}{x}{z}}
\end{align*}
\egroup

The following convertibility rules are responsible for the strictness
of judgmental equality, which sets it apart from equivalences or identifications:

\begin{align*}
& \inference{\jctxeq{\Gamma}{\Delta}\qquad\jfam{\Gamma}{A}}{\jfam{\Delta}{A}}
& & \inference{\jctxeq{\Gamma}{\Delta}\qquad\jfameq{\Gamma}{A}{B}}{\jfameq{\Delta}{A}{B}}\\
& \inference{\jctxeq{\Gamma}{\Delta}\qquad\jterm{\Gamma}{A}{x}}{\jterm{\Delta}{A}{x}}
& & \inference{\jctxeq{\Gamma}{\Delta}\qquad\jtermeq{\Gamma}{A}{x}{y}}{\jtermeq{\Delta}{A}{x}{y}}\\
& \inference{\jfameq{\Gamma}{A}{B}\qquad \jterm{\Gamma}{A}{x}}{\jterm{\Gamma}{B}{x}}
& & \inference{\jfameq{\Gamma}{A}{B}\qquad\jtermeq{\Gamma}{A}{x}{y}}{\jtermeq{\Gamma}{B}{x}{y}}
\end{align*}

\subsection{The empty context}
There is an empty context and over any context there is an empty family of
contexts. We do not assume that the empty context is a type, that would be like
assuming that the multiplicative unit of a ring is prime. The empty family
always has a unique term. 

\begin{align}
& \inference{}{\jctx{\emptyc}}\\
& \inference{\jctx{\Gamma}}{\jfam{\Gamma}{\emptyf\Gamma}}\\
& \inference{\jctx{\Gamma}}{\jterm{\Gamma}{\emptyf[\Gamma]}{\emptytm[\Gamma]}}\\
& \inference{\jterm{\Gamma}{\emptyf[\Gamma]}{x}}{\jtermeq{\Gamma}{\emptyf[\Gamma]}{x}{\emptytm[\Gamma]}}
\end{align}

Moreover, if $\Gamma$ is a context family over the
empty context, then $\Gamma$ is a context and every context is a context
family over the empty context. Note that this allows us to speak
of terms of contexts too.

\begin{align}
& \inference{\jctx{\Gamma}}{\jfam{\emptyc}{\Gamma}} 
& & \inference{\jfam{\emptyc}{\Gamma}}{\jctx{\Gamma}}\\
& \inference{\jctxeq{\Gamma}{\Delta}}{\jfameq{\emptyc}{\Gamma}{\Delta}}
& & \inference{\jfameq{\emptyc}{\Gamma}{\Delta}}{\jctxeq{\Gamma}{\Delta}}
\end{align}

\subsubsection{The empty context is compatible with itslef}
The empty context $\emptyc$ may be considered as a family of contexts over the empty
context. When we do this, we get $\emptyf[\emptyc]$.
\begin{equation}
\inference{}{\jfameq{\emptyc}{\emptyc}{\emptyf[\emptyc]}}
\end{equation}
In the future, we shall denote $\emptyf[\Gamma]$ by $\emptyf$. The above rule
guarantees that this will not cause confusion. Likewise, we shall denote
$\emptytm[\Gamma]$ by $\emptytm$.

\subsection{Extension}
We introduce extension which not only extends a context $\Gamma$ and a type
$A$ over it to a context $\ctxext{\Gamma}{A}$, but which also extends a type $A$
in context $\Gamma$ and a family $P$ over it to a type $\ctxext{A}{P}$ in context
$\Gamma$. We do this to ensure that all of type theory can be done in a context.
For instance, we could say (1) that a context in context $\Gamma$ is the same thing
as a type in context $\Gamma$; (2) When $A$ is a context in this sense, a type in
context $A$ is the same thing as a family $P$ over $A$ and (3) when $P$ is a type
in context $A$ in this sense, a term of $P$ keeps its original meaning.

\begin{align}
& \inference{\jfam{\Gamma}{A}}{\jctx{\ctxext{\Gamma}{A}}}
& & \inference{\jctxeq{\Gamma}{\Delta}\qquad\jfameq{\Gamma}{A}{B}}{\jctxeq{\ctxext{\Gamma}{A}}{\ctxext{\Delta}{B}}}\\
& \inference{\jfam{\ctxext{\Gamma}{A}}{P}}{\jfam{\Gamma}{\ctxext{A}{P}}}
& & \inference{\jfameq{\Gamma}{A}{B}\qquad\jfameq{\ctxext{\Gamma}{A}}{P}{Q}}{\jfameq{\Gamma}{\ctxext{A}{P}}{\ctxext{B}{Q}}}
\end{align}

\subsubsection{Extension is compatible with the empty context}
The following rule asserts that extension by $\emptyc$ leaves the contexts unchanged.
\begin{align}
& \inference{\jctx{\Gamma}}{\jctxeq{\ctxext{\emptyc}{\Gamma}}{\Gamma}}\\
& \inference{\jctx{\Gamma}}{\jctxeq{\ctxext{\Gamma}{\emptyf}}{\Gamma}}\\
& \inference{\jfam{\Gamma}{A}}{\jfameq{\Gamma}{\ctxext{\emptyf}{A}}{A}}
\end{align}

\subsubsection{Extension is compatible with itself}\label{comp-ee}
The inference rules asserting that extension is compatible with itself assert
that contexts are unstructured lists of type declarations. This rule is
unavoidable if we want that for a type $A$ in context $\Gamma$, a type
in context $A$ is the same thing as a type in context $\ctxext{\Gamma}{A}$. 

\begin{align}
& \inference{\jfam{\Gamma}{A}\qquad\jfam{\ctxext{\Gamma}{A}}{P}}
  {\jctxeq{\ctxext{{\Gamma}{A}}{P}}{\ctxext{\Gamma}{{A}{P}}}}\\
& \inference{\jfam{\ctxext{\Gamma}{A}}{P}\qquad\jfam{\ctxext{{\Gamma}{A}}{P}}{Q}}
  {\jfameq{\Gamma}{\ctxext{{A}{P}}{Q}}{\ctxext{A}{{P}{Q}}}}
\end{align}

\subsection{The type theoretic operation of weakening}
When $A$ is a context family over a context $\Gamma$, we wish to define a weakening
operation $\ctxwk{A}{}$. The weakening operation acts on context families $B$ 
over $\Gamma$, terms thereof, context families over $B$ and terms thereof.
It weakens those, which means that it ``adds $A$ to the context''. The context
family $\ctxwk{A}{B}$ can be seen as the constant family $B$ over $\ctxext{\Gamma}{A}$.
Likewise, when $y$ is a term of $B$, the term $\ctxwk{A}{y}$ of $\ctxwk{A}{B}$
can be seen as the constant term with value $y$.
 
 In the following inference rules we assume that $\jfam{\Gamma}{A}$ and in the
 rules asserting a judgmental equality we assume furthermore that 
 $\jfameq{\Gamma}{A}{A'}$.
\begin{align}
& \inference{\jfam{\Gamma}{B}}{\jfam{\ctxext{\Gamma}{A}}{\ctxwk{A}{B}}}
& & \inference{\jfameq{\Gamma}{B}{B'}}{\jfameq{\ctxext{\Gamma}{A}}{\ctxwk{A}{B}}{\ctxwk{A'}{B'}}}\\
& \inference{\jfam{\ctxext{\Gamma}{B}}{Q}}
{\jfam{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}}
& & \inference{\jfameq{\ctxext{\Gamma}{B}}{Q}{Q'}}
{\jfameq{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}{\ctxwk{A'}{Q'}}}\\
& \inference{\jterm{\Gamma}{B}{y}}{\jterm{\ctxext{\Gamma}{A}}{\ctxwk{A}{B}}{\ctxwk{A}{y}}}
& & \inference{\jtermeq{\Gamma}{B}{y}{y'}}{\jtermeq{\ctxext{\Gamma}{A}}{\ctxwk{A}{B}}{\ctxwk{A}{y}}{\ctxwk{A'}{y'}}}\\
& \inference{\jterm{\ctxext{\Gamma}{B}}{Q}{g}}{\jterm{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}{\ctxwk{A}{g}}}
& & \inference{\jtermeq{\ctxext{\Gamma}{B}}{Q}{g}{g'}}
{\jtermeq{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}{\ctxwk{A}{g}}{\ctxwk{A'}{g'}}}
\end{align}

We add rules asserting that a weakened type is again a type:

\begin{align}
& \inference{\jfam{\Gamma}{B}\quad\jtype{\ctxext{\Gamma}{B}}{Q}}{\jtype{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}}
\end{align}

\subsubsection{Weakening is compatible with the empty context}
The following rules express that when the empty context or context family is
weakened, the result is the empty context family.
\begin{align}
& \inference{\jctx{\Gamma}}{\jfameq{\Gamma}{\ctxwk{\Gamma}{\emptyc}}{\emptyf}}\\
& \inference{\jfam{\Gamma}{A}}{\jfameq{\ctxext{\Gamma}{A}}{\ctxwk{A}{\emptyf}}{\emptyf}}
\end{align}
Weakening by the empty family $\emptyf$ over a context $\Gamma$ leaves families, 
their terms, families over those families and
terms of those unchanged:
\begin{align}
& \inference{\jfam{\Gamma}{B}}{\jfameq{\Gamma}{\ctxwk{\emptyf}{B}}{B}}\\
& \inference{\jterm{\Gamma}{B}{y}}{\jtermeq{\Gamma}{B}{\ctxwk{\emptyf}{y}}{y}}\\
& \inference{\jfam{\ctxext{\Gamma}{B}}{Q}}{\jfameq{\ctxext{\Gamma}{B}}{\ctxwk{\emptyf}{Q}}{Q}}\\
& \inference{\jterm{\ctxext{\Gamma}{B}}{Q}{g}}{\jtermeq{\ctxext{\Gamma}{B}}{Q}{\ctxwk{\emptyf}{g}}{g}}
\end{align}

\subsubsection{Weakening is compatible with extension}\label{comp-we}

The following rules assert the compatibility of extension with weakening: for
every family $A$ over $\Gamma$ and every family $Q$ over $\ctxext{\Gamma}{B}$
there is a
judgmental equality $\ctxwk{A}{\ctxext{B}{Q}}\jdeq\ctxext{\ctxwk{A}{B}}
{\ctxwk{A}{Q}}$. 

When thinking of terms of $\ctxwk{A}{B}$ as morphisms of families from $A$ to
$B$, this looks already like form of type theoretic choice. It is weaker in that
it is not stated with function types, yet it is stronger in that it states a
judgmental equality between two families. When one makes the weakening operation
notationally invisible -- as is in fact the usual practice in type theory -- the
following compatibility rules become completely obvious.

In the following inference rules we assume that $\jfam{\Gamma}{A}$.
\begin{align}
& \inference
  {\jfam{\ctxext{\Gamma}{B}}{Q}}
  {\jfameq{\ctxext{\Gamma}{A}}{\ctxwk{A}{\ctxext{B}{Q}}}{\ctxext{\ctxwk{A}{B}}{\ctxwk{A}{Q}}}}\\
& \inference
  {\jfam{\ctxext{{\Gamma}{B}}{Q}}{R}}
  {\jfameq
    {\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}
    {\ctxwk{A}{\ctxext{Q}{R}}}
    {\ctxext{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}}
\end{align}

\subsubsection{Weakening is compatible with itself}\label{comp-ww}
We state judgmental equality rules expressing
that weakening is compatible with itself. These rules state that the following
diagram commutes given any two families $A$ and $B$ in context $\Gamma$:
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\jfam{\Gamma}{\blank} \ar{r}{C\mapsto\ctxwk{B}{C}} \ar{d}[swap]{C\mapsto\ctxwk{A}{C}} & \jfam{\ctxext{\Gamma}{B}}{\blank} \ar{d}{Q\mapsto\ctxwk{A}{Q}}\\
\jfam{\ctxext{\Gamma}{A}}{\blank} \ar{r}[swap]{P\mapsto\ctxwk{{A}{B}}{P}} & \jfam{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\blank}
\end{tikzcd}
\end{equation*}
Thus, we get the following set of inference rules:
\begin{align}
& \inference{\jfam{\Gamma}{A}\qquad\jfam{\Gamma}{B}\qquad\jfam{\Gamma}{C}}
          {\jfameq{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{{B}{C}}}
            {\ctxwk{{A}{B}}{{A}{C}}}}\\
& \inference{\jfam{\Gamma}{A}\qquad\jfam{\Gamma}{B}\qquad\jterm{\Gamma}{C}{z}}
          {\jtermeq{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{{A}{B}}{{A}{C}}}
            {\ctxwk{A}{{B}{z}}}
            {\ctxwk{{A}{B}}{{A}{z}}}}\label{comp-ww-inf2}\\
& \inference{\jfam{\Gamma}{A}\qquad\jfam{\Gamma}{B}\qquad\jfam{\ctxext{\Gamma}{C}}{R}}
          {\jfameq{\ctxext{{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{{A}{B}}{{A}{C}}}}
            {\ctxwk{A}{{B}{R}}}
            {\ctxwk{{A}{B}}{{A}{R}}}}\\
& \inference{\jfam{\Gamma}{A}\qquad\jfam{\Gamma}{B}\qquad\jterm{\Gamma}{R}{t}}
          {\jtermeq{\ctxext{{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{{A}{B}}{{A}{C}}}}
            {\ctxwk{{A}{B}}{{A}{R}}}{\ctxwk{A}{{B}{t}}}{\ctxwk{{A}{B}}{{A}{t}}}}
            \label{comp-ww-inf4}
\end{align}
Note that strictly speaking, we did not need to require the inference in
\autoref{comp-ww-inf2} since this follows from the inference in \autoref{comp-ww-inf4}
and the fact that the weakening of the empty family is again the empty family.

\subsubsection{Extension is compatible with weakening}\label{comp-ew}
The rules expressing that extension is compatible with weakening assert that
weakening by an extension is the same thing as weakening twice in the
appropriate way.

In the following inference rules we assume that
$\jfam{\Gamma}{A}$ and $\jfam{\ctxext{\Gamma}{A}}{P}$. 
\begin{align}
& \inference{\jfam{\Gamma}{B}}
    {\jfameq{\ctxext{{\Gamma}{A}}{P}}{\ctxwk{\ctxext{A}{P}}{B}}{\ctxwk{P}{{A}{B}}}}\\
& \inference{\jterm{\Gamma}{B}{y}}
    {\jtermeq{\ctxext{{\Gamma}{A}}{P}}{\ctxwk{P}{{A}{B}}}{\ctxwk{\ctxext{A}{P}}{y}}{\ctxwk{P}{{A}{y}}}}\\
& \inference{\jfam{\ctxext{\Gamma}{B}}{Q}}
    {\jfameq{\ctxext{{{\Gamma}{A}}{P}}{\ctxwk{P}{{A}{B}}}}{\ctxwk{\ctxext{A}{P}}{Q}}{\ctxwk{P}{{A}{Q}}}}\\
& \inference{\jterm{\ctxext{\Gamma}{B}}{Q}{g}}
    {\jtermeq{\ctxext{{{\Gamma}{A}}{P}}{\ctxwk{P}{{A}{B}}}}{\ctxwk{P}{{A}{Q}}}{\ctxwk{\ctxext{A}{P}}{g}}{\ctxwk{P}{{A}{g}}}}
\end{align}

\subsection{The type theoretic operation of substitution}
Given a family $P$ over $A$ and a term $x$ of $A$, substitution gives a way to
consider the fiber $\subst{x}{P}$ of $P$ at $x$. Also, we get a way to evaluate
terms $f$ of $P$ at $x$. This will give us ways to compose functions too. In
this section, we shall first introduce the operations `substitution of a term $x$'
for types, terms and families. Then we shall explain how substitution interacts
with itself, extension and weakening.

In the rules introducing the various substitutions we assume $\jterm{\Gamma}{A}{x}$;
in the rules introducing the definitional equalities we assume $\jtermeq{\Gamma}{A}{x}{x'}$.

\begin{align}
& \inference{\jfam{\ctxext{\Gamma}{A}}{P}}{\jfam{\Gamma}{\subst{x}{P}}}
& & \inference{\jfameq{\ctxext{\Gamma}{A}}{P}{P'}}{\jfameq{\Gamma}{\subst{x}{P}}{\subst{x'}{P'}}}\\
& \inference{\jfam{\ctxext{{\Gamma}{A}}{P}}{Q}}{\jfam{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}}
& & \inference{\jfameq{\ctxext{{\Gamma}{A}}{P}}{Q}{Q'}}{\jfameq{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}{\subst{x'}{Q'}}}\\
& \inference{\jterm{\ctxext{\Gamma}{A}}{P}{f}}{\jterm{\Gamma}{\subst{x}{P}}{\subst{x}{f}}}
& & \inference{\jtermeq{\ctxext{\Gamma}{A}}{P}{f}{f'}}{\jtermeq{\Gamma}{\subst{x}{P}}{\subst{x}{f}}{\subst{x'}{f'}}}\\
& \inference{\jterm{\ctxext{{\Gamma}{A}}{P}}{Q}{g}}{\jterm{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}{\subst{x}{g}}}
& &\inference{\jtermeq{\ctxext{{\Gamma}{A}}{P}}{Q}{g}{g'}}{\jtermeq{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}{\subst{x}{g}}{\subst{x'}{g'}}}
\end{align}

We also add the following rule asserting that substitution preserves the
property of being a type:
\begin{align}
& \inference{\jterm{\Gamma}{A}{x}\quad\jtype{\ctxext{{\Gamma}{A}}{P}}{Q}}{\jtype{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}}
\end{align}

\subsubsection{Substitution is compatible with the empty context}
The fibers of the empty family are the empty families:
\begin{equation}
\inference{\jterm{\Gamma}{A}{x}}{\jfameq{\Gamma}{\subst{x}{\emptyf}}{\emptyf}}
\end{equation}

The following rules assert that substituting by the term $\jterm{\Gamma}{\emptyf}{\emptytm}$
leaves everything unchanged.
\begin{align}
& \inference{\jfam{\Gamma}{A}}{\jfameq{\Gamma}{\subst{\emptytm}{A}}{A}}\\
& \inference{\jterm{\Gamma}{A}{x}}{\jtermeq{\Gamma}{A}{\subst{\emptytm}{x}}{x}}\\
& \inference{\jfam{\ctxext{\Gamma}{A}}{P}}{\jfameq{\ctxext{\Gamma}{A}}{\subst{\emptytm}{P}}{P}}\\
& \inference{\jterm{\ctxext{\Gamma}{A}}{P}{f}}{\jtermeq{\ctxext{\Gamma}{A}}{P}{\subst{\emptytm}{f}}{f}}.
\end{align}

\subsubsection{Substitution is compatible with extension}\label{comp-se}
Suppose $\jterm{\Gamma}{A}{x}$ in all of the following inference rules.
\begin{align}
& \inference{\jfam{\ctxext{{\Gamma}{A}}{P}}{Q}}
  {\jfameq{\Gamma}{\subst{x}{\ctxext{P}{Q}}}{\ctxext{\subst{x}{P}}{\subst{x}{Q}}}}\\
& \inference{\jfam{\ctxext{{{\Gamma}{A}}{P}}{Q}}{R}}
  {\jfameq{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{\ctxext{Q}{R}}}{\ctxext{\subst{x}{Q}}{\subst{x}{R}}}}
\end{align}

\subsubsection{Substitution is compatible with weakening}\label{comp-sw}
The rules asserting the compatibility of substitution with weakening assert
that the following diagram commutes for any $\jterm{\Gamma}{A}{x}$ and any
$\jfam{\ctxext{\Gamma}{A}}{P}$:
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\jfam{\ctxext{\Gamma}{A}}{\blank} \ar{d}[swap]{Q\mapsto\subst{x}{Q}} \ar{r}{Q\mapsto\ctxwk{P}{Q}} & \jfam{\ctxext{{\Gamma}{A}}{P}}{\blank} \ar{d}{R\mapsto\subst{x}{R}}\\ 
\jfam{\Gamma}{\blank} \ar{r}[swap]{B\mapsto\ctxwk{\subst{x}{P}}{B}} & \jfam{\ctxext{\Gamma}{\subst{x}{P}}}{\blank}
\end{tikzcd}
\end{equation*}
In the following inference rules we assume that $\jterm{\Gamma}{A}{x}$ and
$\jfam{\ctxext{\Gamma}{A}}{P}$:
\begin{align}
& \inference
    {\jfam{\ctxext{\Gamma}{A}}{Q}}
    {\jfameq{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{\ctxwk{P}{Q}}}{\ctxwk{\subst{x}{P}}{\subst{x}{Q}}}}\\
& \inference
    {\jfam{\ctxext{{\Gamma}{A}}{Q}}{R}}
    {\jfameq{\ctxext{{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}}{\subst{x}{\ctxwk{P}{R}}}{\ctxwk{\subst{x}{P}}{\subst{x}{R}}}}\\
& \inference
    {\jterm{\ctxext{\Gamma}{A}}{Q}{g}}
    {\jtermeq
      {\ctxext{\Gamma}{\subst{x}{P}}}
      {\subst{x}{\ctxwk{P}{Q}}}
      {\subst{x}{\ctxwk{P}{g}}}
      {\ctxwk{\subst{x}{P}}{\subst{x}{g}}}}\\
& \inference
    {\jterm{\ctxext{{\Gamma}{A}}{Q}}{R}{h}}
    {\jtermeq
      {\ctxext{{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}}
      {\subst{x}{\ctxwk{P}{R}}}
      {\subst{x}{\ctxwk{P}{h}}}
      {\ctxwk{\subst{x}{P}}{\subst{x}{h}}}}
\end{align}

\subsubsection{Substitution is compatible with substitution}\label{comp-ss}

We require that substitution is compatible with itself, which is roughly the
assertion that substitution is associative. However, we cannot just state that
$\subst{x}{{f}{g}}\jdeq\subst{{x}{f}}{g}$ since the expression $\subst{{x}{f}}{g}$
is not well-formed. The term $\subst{x}{f}$ can be substituted in (terms of) families over
$\subst{x}{P}$; the term $\subst{x}{g}$ is such. Therefore, associativity of
substitution takes the form $\subst{x}{{f}{g}}\jdeq\subst{{x}{f}}{{x}{g}}$.
Note that the term $\subst{{x}{f}}{{x}{g}}$ may be written down more conveniently
as $\subst{x,\subst{x}{f}}{g}$, although we will not do that here.

In the following inference rules we assume
$\jterm{\Gamma}{A}{x}$ and $\jterm{\ctxext{\Gamma}{A}}{P}{f}$.

\begin{align}
&\inference{\jfam{\ctxext{{\Gamma}{A}}{P}}{Q}}
{\jfameq{\Gamma}{\subst{x}{{f}{Q}}}{\subst{{x}{f}}{{x}{Q}}}}\label{comp-ss-1}\\
&\inference{\jterm{\ctxext{{\Gamma}{A}}{P}}{Q}{g}}
{\jtermeq{\Gamma}{\subst{x}{{f}{Q}}}{\subst{x}{{f}{g}}}{\subst{{x}{f}}{{x}{g}}}}\label{comp-ss-2}\\
&\inference{\jfam{\ctxext{{{\Gamma}{A}}{P}}{Q}}{R}}
{\jfameq{\ctxext{\Gamma}{\subst{x}{{f}{Q}}}}{\subst{x}{{f}{R}}}{\subst{{x}{f}}{{x}{R}}}}\label{comp-ss-3}\\
&\inference{\jterm{\ctxext{{{\Gamma}{A}}{P}}{Q}}{R}{h}}
{\jtermeq{\ctxext{\Gamma}{\subst{x}{{f}{Q}}}}{\subst{x}{{f}{R}}}{\subst{x}{{f}{h}}}{\subst{{x}{f}}{{x}{h}}}}\label{comp-ss-4}
\end{align}

\subsubsection{Weakening is compatible with substitution}\label{comp-ws}
We already have rules for the compatibility of substitution with weakening, but
we still need the rules the other way around, asserting that there is a 
judgmental equality $\ctxwk{A}{\subst{y}{Q}}\jdeq\subst{\ctxwk{A}{y}}{\ctxwk{A}{Q}}$
together with all its variants.

In the following inference rules we assume that $\jfam{\Gamma}{A}$ and that
$\jterm{\Gamma}{B}{y}$.

\begin{align}
& \inference{\jfam{\ctxext{\Gamma}{B}}{Q}}{\jfameq{\ctxext{\Gamma}{A}}{\ctxwk{A}{\subst{y}{Q}}}{\subst{\ctxwk{A}{y}}{\ctxwk{A}{Q}}}}\\
& \inference{\jfam{\ctxext{{\Gamma}{B}}{Q}}{R}}{\jfameq{\ctxext{{\Gamma}{A}}{\ctxwk{A}{Q}}}{\ctxwk{A}{\subst{y}{R}}}{\subst{\ctxwk{A}{y}}{\ctxwk{A}{R}}}}\\
& \inference{\jterm{\ctxext{\Gamma}{B}}{Q}{g}}{\jtermeq{\ctxext{\Gamma}{A}}{\ctxwk{A}{\subst{y}{Q}}}{\ctxwk{A}{\subst{y}{g}}}{\subst{\ctxwk{A}{y}}{\ctxwk{A}{g}}}}\\
& \inference{\jterm{\ctxext{{\Gamma}{B}}{Q}}{R}{h}}{\jtermeq{\ctxext{{\Gamma}{A}}{\ctxwk{A}{\subst{y}{Q}}}}{\ctxwk{A}{\subst{y}{R}}}{\ctxwk{A}{\subst{y}{h}}}{\subst{\ctxwk{A}{y}}{\ctxwk{A}{h}}}}
\end{align}

\subsection{Composition and identity functions}
\subsubsection{The defining property of weakening}
The judgmental equalities we're about to describe assert that substituting a term
in the weakening a thing gives you the thing back. In the case of contexts we get that each fiber
$\subst{x}{\ctxwk{A}{B}}$ is just $B$ and in the case of terms we get 
that $\ctxwk{A}{y}$ is the constant function
mapping everything to $y:B$. Thus, these rules actually establish the weakening
as the weakening. After stating the rules we will describe what it means to
compose context morphisms (terms of weakened contexts).

\begin{align}
& \inference{\jfam{\Gamma}{A}\qquad\jfam{\Gamma}{B}\qquad\jterm{\Gamma}{A}{x}}{\jfameq{\Gamma}{\subst{x}{\ctxwk{A}{B}}}{B}}\label{defn-ws-1}\\
& \inference{\jterm{\Gamma}{A}{x}\qquad\jterm{\Gamma}{B}{y}}{\jtermeq{\Gamma}{B}{\subst{x}{\ctxwk{A}{y}}}{y}}\label{defn-ws-2}\\
& \inference{\jfam{\Gamma}{A}\qquad\jfam{\ctxext{\Gamma}{B}}{Q}\qquad\jterm{\Gamma}{A}{x}}{\jfameq{\ctxext{\Gamma}{B}}{\subst{x}{\ctxwk{A}{Q}}}{Q}}\label{defn-ws-3}\\
& \inference{\jterm{\Gamma}{A}{x}\qquad\jterm{\ctxext{\Gamma}{B}}{Q}{g}}{\jtermeq{\ctxext{\Gamma}{B}}{Q}{\subst{x}{\ctxwk{A}{g}}}{g}}\label{defn-ws-4}
\end{align}

Using the rules of the compatibility of substitution with weakening and of the
compatibility of weakening with itself, we see that we can show
\begin{equation*}
\jfameq{\ctxext{\Gamma}{A}}{\subst{f}{\ctxwk{A}{{B}{C}}}}{\ctxwk{A}{C}}
\end{equation*}
for any three families $A$, $B$ and $C$ in context $\Gamma$ and any $\jterm{\ctxext{\Gamma}{A}}{\ctxwk{A}{B}}{f}$.
It follows that for $\jterm{\ctxext{\Gamma}{B}}{\ctxwk{B}{C}}{g}$ we have
\begin{equation*}
\jterm{\ctxext{\Gamma}{A}}{\ctxwk{A}{C}}{\subst{f}{\ctxwk{A}{g}}}
\end{equation*}
The term $\jcomp{A}{f}{g}$ is the composition of $g$ with $f$. We may call
a term $\jterm{\ctxext{\Gamma}{A}}{\ctxwk{A}{B}}{f}$ a morphism from $A$ to $B$.

\subsubsection{Identity functions}
Without a rule explicitly asserting the existence of an identity morphism we don't
get one, hence we do that here. The identity morphism is a term which introduced
in ordinary type theory via the variable rule. The variable rule is a bit more
general: it asserts that
\begin{equation*}
\jterm{\Gamma,\,x_1:A_1,\ldots,\,x_n:A_n}{A_i}{x_i}
\end{equation*}
for every $1\leq i\leq n$. Thus, it establishes the projections. In our setting,
we get the projections from the identity morphisms together with weakening. We
already have weakening, so here it suffices to introduce the identity morphisms.
\begin{align}
& \inference{\jfam{\Gamma}{A}}{\jterm{\ctxext{\Gamma}{A}}{\ctxwk{A}{A}}{\idfunc[A]}}
& & \inference{\jfameq{\Gamma}{A}{A'}}{\jtermeq{\ctxext{\Gamma}{A}}{\ctxwk{A}{A}}{\idfunc[A]}{\idfunc[A']}}
\end{align}
Identity functions are determined by their behavior with respect to substitution combined with
weakening. The identity functions will also be subject to compatibility rules.
\begin{align}
& \inference{\jterm{\Gamma}{A}{x}}{\jtermeq{\Gamma}{A}{\subst{x}{\idfunc[A]}}{x}}\label{idfunc-subst-defn}\\
& \inference{\jfam{\ctxext{\Gamma}{A}}{P}}{\jfameq{\ctxext{\Gamma}{A}}{\subst{\idfunc[A]}{\ctxwk{A}{P}}}{P}}\label{idfunc-wk-defn}\\
& \inference{\jterm{\ctxext{\Gamma}{A}}{P}{f}}{\jtermeq{\ctxext{\Gamma}{A}}{P}{\subst{\idfunc[A]}{\ctxwk{A}{f}}}{f}}\label{idfunc-precomp} \\
& \inference{\jterm{\ctxext{\Gamma}{B}}{\ctxwk{B}{A}}{g}}{\jtermeq{\ctxext{\Gamma}{B}}{\ctxwk{B}{A}}{\subst{g}{\ctxwk{B}{\idfunc[A]}}}{g}}\label{idfunc-postcomp}
\end{align}

The identity function of an extended family is the extension of the identity
functions on the components in the apropriate way. To find out what the
apropriate way is, note that
\begin{align*}
\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}} & \jdeq \ctxwk{P}{{A}{\ctxext{A}{P}}}\\
& \jdeq \ctxext{\ctxwk{P}{{A}{A}}}{\ctxwk{P}{{A}{P}}}
\end{align*}
We have the term $\jterm{\ctxext{\Gamma}{{A}{P}}}{\ctxwk{P}{A}}{\ctxwk{P}{\idfunc[A]}}$.
Thus we need to find out what $\subst{\ctxwk{P}{\idfunc[A]}}{\ctxwk{P}{{A}{P}}}$ is:
\begin{align*}
\subst{\ctxwk{P}{\idfunc[A]}}{\ctxwk{P}{{A}{P}}} & \jdeq \ctxwk{P}{\subst{\idfunc[A]}{\ctxwk{A}{P}}}\\
& \jdeq \ctxwk{P}{P},
\end{align*}
where we find the term $\idfunc[P]$. Therefore, we have the following inference rule:
\begin{equation}\label{idfunc-ext-comp}
\inference{\jfam{\Gamma}{A}\quad\jfam{\ctxext{\Gamma}{A}}{P}}{\jtermeq{\ctxext{\Gamma}{{A}{P}}}{\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}}{\idfunc[\ctxext{A}{P}]}{\subst{\idfunc[P]}{{\ctxwk{P}{\idfunc[A]}}{\idfunc[\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}]}}}}
\end{equation}

The identity function of a weakened family is the weakened identity function:
\begin{equation}\label{idfunc-wk-comp}
\inference{\jfam{\Gamma}{A}\quad\jfam{\Gamma}{B}}{\jtermeq{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{{A}{B}}{{A}{B}}}{\idfunc[\ctxwk{A}{B}]}{\ctxwk{A}{\idfunc[B]}}}
\end{equation}

The identity function of a substituted family is the substitution of the identity function
\begin{equation}\label{idfunc-subst-comp}
\inference{\jterm{\Gamma}{A}{x}\quad\jfam{\ctxext{\Gamma}{A}}{P}}{\jtermeq{\ctxext{\Gamma}{\subst{x}{P}}}{\ctxwk{\subst{x}{P}}{\subst{x}{P}}}{\idfunc[\subst{x}{P}]}{\subst{x}{\idfunc[P]}}}
\end{equation}

\subsection{Extension on terms}\label{extension-on-terms}
When $\jterm{\Gamma}{A}{x}$ and $\jterm{\Gamma}{\subst{x}{P}}{u}$ are terms,
we obtain the term $\jterm{\Gamma}{\ctxext{A}{P}}{\subst{u}{{x}{\idfunc[\ctxext{A}{P}]}}}$. 
We define 
\begin{equation*}
\ctxext{x}{u}\defeq\subst{u}{{x}{\idfunc[\ctxext{A}{P}]}}.
\end{equation*}
Thus
$\ctxext{x}{u}$ is the pairing of $x$ and $u$. Note that because
$\ctxwk{P}{{A}{\ctxext{A}{P}}}\jdeq\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}$, the
pairing function is just $\idfunc[\ctxext{A}{P}]$. 

There is also a decomposition of terms $\jterm{\Gamma}{\ctxext{A}{P}}{w}$ into
components: the projections. We define
\begin{align*}
\cprojfstf{A}{P} & \defeq \ctxwk{P}{\idfunc[A]}\\
\cprojsndf{A}{P} & \defeq \idfunc[P]
\end{align*}

The constructions of the terms $\ctxext{x}{u}$ and $\cprojfst{A}{P}{w}$ and
$\cprojsnd{A}{P}{w}$ are subject to various rules, with all of them being
consequences of earlier introduced inference rules.

\begin{lem} The following inference rules expressing that pairing is a strict
inverse to the combination of decompositions, are valid:
\begin{align*}
& \inference{\jterm{\Gamma}{\ctxext{A}{P}}{w}}{\jtermeq{\Gamma}{\ctxext{A}{P}}{\ctxext{\cprojfst{A}{P}{w}}{\cprojsnd{A}{P}{w}}}{w}}\\
& \inference{\jterm{\Gamma}{A}{x}\quad\jterm{\Gamma}{\subst{x}{P}}{u}}{\jtermeq{\Gamma}{A}{\cprojfst{A}{P}{\ctxext{x}{u}}}{x}}\\
& \inference{\jterm{\Gamma}{A}{x}\quad\jterm{\Gamma}{\subst{x}{P}}{u}}{\jtermeq{\Gamma}{\subst{x}{P}}{\cprojsnd{A}{P}{\ctxext{x}{u}}}{u}}
\end{align*}
\end{lem}

\begin{proof}
To prove the first judgmental equality, note that
\begin{align*}
w & \jdeq \subst{w}{\idfunc[\ctxext{A}{P}]} \tag{by \autoref{idfunc-subst-defn}}\\
& \jdeq \subst{w}{\subst{\idfunc[P]}{{\ctxwk{P}{\idfunc[A]}}{\idfunc[\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}]}}}
  \tag{by \autoref{idfunc-ext-comp}}\\
& \jdeq \subst{{w}{\idfunc[P]}}{\subst{w}{{\ctxwk{P}{\idfunc[A]}}{\idfunc[\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}]}}}\tag{by \autoref{comp-ss-4}}\\
& \jdeq \subst{{w}{\idfunc[P]}}{{\subst{w}{\ctxwk{P}{\idfunc[A]}}}{\subst{w}{\idfunc[\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}]}}}\tag{by \autoref{comp-ss-2}}\\
& \jdeq \subst{{w}{\idfunc[P]}}{{\subst{w}{\ctxwk{P}{\idfunc[A]}}}{\subst{w}{\ctxwk{\ctxext{A}{P}}{\idfunc[\ctxext{A}{P}]}}}}\tag{by \autoref{idfunc-wk-comp}}\\
& \jdeq \subst{{w}{\idfunc[P]}}{{\subst{w}{\ctxwk{P}{\idfunc[A]}}}{\idfunc[\ctxext{A}{P}]}}\tag{by \autoref{defn-ws-2}}\\
& \jdeq \ctxext{\cprojfst{A}{P}{w}}{\cprojsnd{A}{P}{w}}\tag{by definition}
\end{align*}
\end{proof}

\begin{lem}
The following compatibility rules for two consecutive term extensions is valid:
\begin{align*}
& \inference{\jterm{\Gamma}{A}{x}\quad\jterm{\Gamma}{\subst{x}{P}}{u}\quad\jterm{\Gamma}{\subst{\ctxext{x}{u}}{Q}}{v}}
{\jtermeq{\Gamma}{\ctxext{{A}{P}}{Q}}{\ctxext{x}{{u}{v}}}{\ctxext{{x}{u}}{v}}}\\
& \inference{\jterm{\Gamma}{\ctxext{{A}{P}}{Q}}{w}}
  {\jtermeq{\Gamma}{A}{\cprojfst{A}{P}{\cprojfst{\ctxext{A}{P}}{Q}{w}}}{\cprojfst{A}{\ctxext{P}{Q}}{w}}}\\
& \inference{\jterm{\Gamma}{\ctxext{{A}{P}}{Q}}{w}}
  {\jtermeq{\Gamma}{\subst{\cprojfst{A}{\ctxext{P}{Q}}{w}}{P}}
  {\cprojsnd{A}{P}{\cprojfst{\ctxext{A}{P}}{Q}{w}}}
  {\cprojfst{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}}\\
& \inference{\jterm{\Gamma}{\ctxext{{A}{P}}{Q}}{w}}
  {\jtermeq{\Gamma}{\subst{\cprojfst{\ctxext{A}{P}}{Q}{w}}{Q}}
  {\cprojsnd{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}
  {\cprojsnd{\ctxext{A}{P}}{Q}{w}}}
\end{align*}
\end{lem}

\begin{lem}
When we weaken a term $\ctxext{y}{v}$ of $\ctxext{B}{Q}$ in context $\Gamma$ by
a type $A$, the term that we get is $\ctxext{\ctxwk{A}{y}}{\ctxwk{A}{v}}$. More
precisely, the following inference rules are valid:
\begin{align*}
& \inference{\jterm{\ctxext{\Gamma}{B}}{Q}{g}\quad\jterm{\ctxext{\Gamma}{B}}{\subst{g}{R}}{t}}{\jtermeq{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{\ctxext{Q}{R}}}{\ctxwk{A}{\ctxext{g}{t}}}{\ctxext{\ctxwk{A}{g}}{\ctxwk{A}{t}}}}
% \\
%& \inference{\jterm{\Gamma}{\ctxwk{A}{\ctxext{B}{Q}}}{\ctxwk{A}{w}}}{\jtermeq{\ctxext{\Gamma}{A}}{\ctxwk{A}{B}}{\cprojfst{\ctxwk{A}{B}}{\ctxwk{A}{Q}}{\ctxwk{A}{w}}}{\ctxwk{A}{(\cprojfst{B}{Q}{w})}}}\\
\end{align*}
\end{lem}

\begin{lem}
When we substitute an extended term $\ctxext{f}{g}$ of $\ctxext{P}{Q}$ by a term
$x$ of $A$, the term that we get is $\ctxext{\subst{x}{f}}{\subst{x}{g}}$.
More precisely, the following inference rules are valid:
\begin{align*}
& \inference{\jterm{\ctxext{\Gamma}{A}}{P}{f}\quad\jterm{\ctxext{\Gamma}{A}}{\subst{f}{Q}}{g}}{\jtermeq{\Gamma}{\ctxext{\subst{x}{P}}{\subst{x}{Q}}}{\subst{x}{\ctxext{f}{g}}}{\ctxext{\subst{x}{f}}{\subst{x}{g}}}}\\
& \inference{\jterm{\ctxext{{\Gamma}{A}}{P}}{Q}{g}\quad\jterm{\ctxext{{\Gamma}{A}}{P}}{\subst{g}{R}}{t}}{\jtermeq{\ctxext{\Gamma}{\subst{x}{P}}}{\ctxext{\subst{x}{Q}}{\subst{x}{R}}}{\subst{x}{\ctxext{g}{t}}}{\ctxext{\subst{x}{g}}{\subst{x}{t}}}}
\end{align*}
\end{lem}
Finally, when we substitute by an extended term we get an equal result as when we
substitute two consecutive times. This looks like the Curry-Howard isomorphism.

\begin{lem}
The following inference rules are valid:
\begin{align*}
& \inference{\jterm{\Gamma}{A}{x}\quad\jterm{\Gamma}{\subst{x}{P}}{u}\quad\jfam{\ctxext{{\Gamma}{A}}{P}}{Q}}
  {\jfameq{\Gamma}{\subst{\ctxext{x}{u}}{Q}}{\subst{u}{{x}{Q}}}}\\
& \inference{\jterm{\Gamma}{A}{x}\quad\jterm{\Gamma}{\subst{x}{P}}{u}\quad\jterm{\ctxext{{\Gamma}{A}}{P}}{Q}{g}}
  {\jtermeq{\Gamma}{\subst{u}{{x}{Q}}}{\subst{\ctxext{x}{u}}{g}}{\subst{u}{{x}{g}}}}\\
& \inference{\jterm{\Gamma}{A}{x}\quad\jterm{\Gamma}{\subst{x}{P}}{u}\quad\jfam{\ctxext{{{\Gamma}{A}}{P}}{Q}}{R}}
  {\jfameq{\ctxext{\Gamma}{\subst{u}{{x}{Q}}}}{\subst{\ctxext{x}{u}}{R}}{\subst{u}{{x}{R}}}}\\
& \inference{\jterm{\Gamma}{A}{x}\quad\jterm{\Gamma}{\subst{x}{P}}{u}\quad\jterm{\ctxext{{{\Gamma}{A}}{P}}{Q}}{R}{t}}
  {\jtermeq{\ctxext{\Gamma}{\subst{u}{{x}{Q}}}}{\subst{u}{{x}{R}}}{\subst{\ctxext{x}{u}}{t}}{\subst{u}{{x}{t}}}}
\end{align*}
\end{lem}
