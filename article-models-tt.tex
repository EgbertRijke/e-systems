\section{The theory of contexts, families and terms}\label{tt}
In this section we give a description of dependent type theory before type
constructors. Apart from contexts, families and terms -- which provide for the
core of the language of dependent logic -- the basic ingredients
of this theory will be the operations of extension, weakening and substitution
and the identity terms. An empty context (and empty families) are also included
in the theory. The resulting theory can be seen as a manifestation of the 
structure underlying dependent type theory.

We will
formulate the type theory in such a way that contexts aren't defined
to be lists of variable declarations. The variable-free (or name-free) approach 
we take here is rather different than those appearing in 
\cite{hofmann1995extensional,TheBook} but it has appeared in the work of Coquand
and in \cite{Dybjer1996}.
The main reason we don't let variable declarations in is that we don't see them 
in the internal models either. This way we also set out to a more algebraic 
approach of type theory and higher category theory. Thirdly, we will not have to
be burdened with superficial comments about variables being bounded or not, or 
fresh or free or not occuring at all.

In our treatment, a context can be the empty context or it can be a binary
planar tree of which `the leaves are (families of) contexts'. 
The judgmental equality relation on contexts is an equivalence relation which 
expresses that binary planar
trees of contexts are judgmentally equal if their leaves are, taking only
(the isomorphism class of) 
the order of the leaves into account \emph{and not the actual shape of the three}.
The intuition behind this equivalence relation is indeed that unstructured
(i.e.~unbracketed) lists such as the lists of variable declarations which
usually appear in type theoretical syntax, may be regarded as contexts.

Besides contexts, families and terms there will also be a notion of `type in
a context'. Only a family of contexts over a context $\Gamma$ is eligible to
be a type in the context $\Gamma$ and we have the intuition that `being a type'
expresses the property of `being an atomic or irreducible family of contexts'.
We will not axiomatize that every context is either judgmentally equal to the
empty context or judgmentally equal to the extension of a context by a type,
although it is certainly worth investigating the class of contexts which fall
under this category.

We will formulate fairly strict rules governing the judgmental equalities,
expressing that extension, weakening and substitution are combatible with
each other in a judgmental manner. This does not, however, diminish the role
of isomorphisms or of homotopies could play in the theory once identity types
are added. Indeed, types could still have non-trivial identity relations and
the category of types in a certain context could genuinely display higher
categorical structure, or so we conjecture.

Much of the rules we state are just compatibility rules of extension, weakening
and substitution with each other. In a way, these rules assert that our contexts
are just structureless lists of contexts and that likewise terms are structureless
lists of terms. They are structureless in the sense that the order in which
they are formed by pairing up is irrelevant. We note that this causes complications
in the traditional way that categorical sematics of type theory is implemented,
where contexts become objects of the category which is supposed to model type
theory. The reason for this is that context extension will not satisfy all the
compatibility rules we're about to state. The first step to resolving this is taking
the types in the empty context as the objects. 

To get the overview of the compatibility rules, we list the sections
where these compatibility rules are described in the following table (in this
table, the
subsection mentioned in row $X$ and column $Y$ consideres the rules of the
operation $Y\circ X$):
\begin{center}
\begin{tabular}{r|ccc}
& extension & weakening & substitution\\
\hline
extension & \autoref{comp-ee} & \autoref{comp-ew} & \\
weakening & \autoref{comp-we} & \autoref{comp-ww} & \autoref{comp-ws}\\
substitution & \autoref{comp-se} & \autoref{comp-sw} & \autoref{comp-ss}
\end{tabular}
\end{center}

In \autoref{digging_deeper} we use the framework we have developed in this
section to derive new notions and their properties. In particular, we will
develop the notion of \emph{extension on terms} together with the projection
maps from an extension to the `base' context of family, the 
\emph{family pullback} which is a version of pullbacks for families and thirdly
the \emph{inductive morphisms} which are morphisms of type theory that allow
to find terms of families over the codomain context by pulling them back to
the domain context and finding a term there.

In \autoref{extension-on-terms} on the extension operation on terms we will
derive all the compatibility rules that one would expect to hold for extension
on terms. The key to most of these results is the currying operation, which
could be seen as the missing feature in the table above. The extension on terms
operation depends in an essential way on the substitution operation, on the
identity terms and therefore indirectly also on the weakening operation. Thus,
we will see here all of the features of the theory we develop in
\autoref{judgments} through \autoref{categorical_properties} come to the 
surface.

Next, we introduce the inclusion of the fibers $\subst{x}{P}$ into the extension
$\ctxext{A}{P}$ as a morphism in context $\Gamma$. As was the case with
extension on terms and with projections, there will be a ton of compatibility
properties which we will prove about these inclusions. 

It should be kept in mind though that in the current formulation there is no
sealed deal establishing a relationship between families over a context
and any kind of morphisms -- neither with morphisms having the `base' of the
family as its codomain nor with families into a universe (universes will be
introduced in \autoref{universes}). The only thing we know here is
that a family $P$ over $\ctxext{\Gamma}{A}$ determines a context morphism
from $\ctxext{A}{P}$ to $A$ in context $\Gamma$, the projection. 
We do not see this as
a shortcoming of the theory of contexts families and terms. Rather, such a
correspondence is a feature of a theory which does incorporate universes. The
fact that we're lacking a clear connection between families and (a specified
class of) morphisms, however, does show up in our treatment of the notion we
called familie pullbacks. For instance, we can't show that a square of families
is a pullback precisely when the corresponding square of projections is a
pullback: only the backwards direction holds. 
The discrepancies continue: ordinary pullbacks do not always exist
whereas family pullbacks do but the composition of two family pullback squares
need not be a family pullback square again whereas the pasting lemma of
ordinary pullbacks holds as usually.
We feel that pointing out what we can and can't do in the current setting is
an important aspect of developing an intuition with the system and therefore
we include this subsubsection even though the theory of family pullbacks
might feel a bit different than the usual theory of pullbacks.

In the last subsubsection we give a treatment of inductive morphisms. These
morphisms appear also in the introduction of the many inductive type
constructors in \autoref{tt_constructors} and therefore a general treatment of
the subject is insightful.

\subsection{Judgments and inference rules}\label{judgments}
The type theory we describe here is a theory of contexts, families of
contexts and terms thereof. The families of contexts are by some authors called
dependent contexts, but they are handled a bit differently here because they
become the primary object of study. Dependent contexts can be types; they could
be seen as atomic or indecomposable dependent contexts.

Thus we make eight kinds of judgments in our type theory: ``$\Gamma$ is a context'',
``$A$ is a family of contexts over $\Gamma$'', ``$A$ is a type in context $\Gamma$''
and ``$x$ is a term of the family $A$ of contexts over $\Gamma$''. The other four
judgments are for judgmental equality. 

\begin{align*}
\jctx*{\Gamma} 
& \jctxeq*{\Gamma}{\Gamma'}
  \\
\jfam*{\Gamma}{A} 
& \jfameq*{\Gamma}{A}{B}
  \\
\jtype*{\Gamma}{A} 
& \jtypeeq*{\Gamma}{A}{B}
  \\
\jterm*{\Gamma}{A}{x} 
& \jtermeq*{\Gamma}{A}{x}{y}.
\end{align*}

We note that what we call families over contexts
here could also have been named dependent contexts or telescopes, see
\cite{deBruijn1991,hofmann1995extensional}. The term family is in agreement
with the terminology scheme of \cite{TheBook}, though the reader should be
warned that the notion of familie means something slightly different there than
it does here.

If $A$ is a type
in context $\Gamma$, then $A$ is also a family of contexts over $\Gamma$. Being
a term of type $A$ means the same thing as being a term of the family $A$ of contexts.
Two types in context $\Gamma$ are judgmentally equal precisely when they are equal
as context families. Moreover, if a family $B$ of contexts over $\Gamma$ is
judgmentally equal to a type $A$ in context $\Gamma$, then $B$ is a type in
context $\Gamma$. This is expressed by the following four inference rules:

\begin{align*}
& \inference
  { \jtype{\Gamma}{A}
    }
  { \jfam{\Gamma}{A}
    }
& & \inference
    { \jtypeeq{\Gamma}{A}{B}
      }
    { \jfameq{\Gamma}{A}{B}
      }
    \\
& \inference
  { \jtype{\Gamma}{A}
    \jfameq{\Gamma}{A}{B}
    }
  { \jtype{\Gamma}{B}
    }
& & \inference
    { \jtype{\Gamma}{A}
      \jfameq{\Gamma}{A}{B}
      }
    { \jtypeeq{\Gamma}{A}{B}
      }
\end{align*}

\subsection{The basic rules for judgmental equality}
The rules for judgmental equality establish that it is an equivalence relation
in all three cases (contexts, types and terms).
\bgroup\small
\begin{align*}
& \inference
  { \jctx{\Gamma}
    }
  { \jctxeq{\Gamma}{\Gamma}
    } 
& & \inference
    { \jctxeq{\Gamma}{\Delta}
      }
    { \jctxeq{\Delta}{\Gamma}
      } 
& & \inference
    { \jctxeq{\Gamma}{\Delta}
      \jctxeq{\Delta}{\greek{E}}
      }
    { \jctxeq{\Gamma}{\greek{E}}
      }
    \\
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jfameq{\Gamma}{A}{A}
    } 
& & \inference
    { \jfameq{\Gamma}{A}{B}
      }
    { \jfameq{\Gamma}{B}{A}
      }
& & \inference
    { \jfameq{\Gamma}{A}{B}
      \jfameq{\Gamma}{B}{C}
      }
    { \jfameq{\Gamma}{A}{C}
      }
    \\
& \inference
  { \jterm{\Gamma}{A}{x}
    }
  { \jtermeq{\Gamma}{A}{x}{x}
    }
& & \inference
    { \jtermeq{\Gamma}{A}{x}{y}
      }
    { \jtermeq{\Gamma}{A}{y}{x}
      }
& & \inference
    { \jtermeq{\Gamma}{A}{x}{y}
      \jtermeq{\Gamma}{A}{y}{z}
      }
    { \jtermeq{\Gamma}{A}{x}{z}
      }
\end{align*}
\egroup

The following convertibility rules are responsible for the strictness
of judgmental equality, which sets it apart from equivalences or identifications:

\begin{align*}
& \inference
  { \jctxeq{\Gamma}{\Delta}
    \jfam{\Gamma}{A}
    }
  { \jfam{\Delta}{A}
    }
& & \inference
    { \jctxeq{\Gamma}{\Delta}
      \jfameq{\Gamma}{A}{B}
      }
    { \jfameq{\Delta}{A}{B}
      }
    \\
& \inference
  { \jctxeq{\Gamma}{\Delta}
    \jterm{\Gamma}{A}{x}
    }
  { \jterm{\Delta}{A}{x}
    }
& & \inference
    { \jctxeq{\Gamma}{\Delta}
      \jtermeq{\Gamma}{A}{x}{y}
      }
    { \jtermeq{\Delta}{A}{x}{y}
      }
    \\
& \inference
  { \jfameq{\Gamma}{A}{B}
    \jterm{\Gamma}{A}{x}
    }
  { \jterm{\Gamma}{B}{x}
    }
& & \inference
    { \jfameq{\Gamma}{A}{B}
      \jtermeq{\Gamma}{A}{x}{y}
      }
    { \jtermeq{\Gamma}{B}{x}{y}
      }
\end{align*}

\subsection{The empty context}
There is an empty context and over any context there is an empty family of
contexts. We do not assume that the empty context is a type, that would be like
assuming that the multiplicative unit of a ring is prime. The empty family
always has a unique term. 

\begin{align}
& \inference
  { }
  { \jctx{\emptyc}
    }
  \\
& \inference
  { \jctx{\Gamma}
    }
  { \jfam{\Gamma}{\emptyf[\Gamma]}
    }
  \\
& \inference
  { \jctx{\Gamma}
    }
  { \jterm{\Gamma}{\emptyf[\Gamma]}{\emptytm[\Gamma]}
    }
  \\
& \inference
  { \jterm{\Gamma}{\emptyf[\Gamma]}{x}
    }
  { \jtermeq
      {\Gamma}
      {\emptyf[\Gamma]}
      {x}
      {\emptytm[\Gamma]}
    }
\end{align}

Moreover, if $\Gamma$ is a context family over the
empty context, then $\Gamma$ is a context and every context is a context
family over the empty context. Note that this allows us to speak
of terms of contexts too.

\begin{align}
& \inference
  { \jctx{\Gamma}
    }
  { \jfam{\emptyc}{\Gamma}
    } 
& & \inference
    { \jfam{\emptyc}{\Gamma}
      }
    { \jctx{\Gamma}
      }
    \\
& \inference
  { \jctxeq{\Gamma}{\Delta}
    }
  { \jfameq{\emptyc}{\Gamma}{\Delta}
    }
& & \inference
    { \jfameq{\emptyc}{\Gamma}{\Delta}
      }
    { \jctxeq{\Gamma}{\Delta}
      }
\end{align}

\subsubsection{The empty context is compatible with itslef}
The empty context $\emptyc$ may be considered as a family of contexts over the empty
context. When we do this, we get $\emptyf[\emptyc]$.
\begin{equation}
\inference
  { }
  { \jfameq
      {\emptyc}
      {\emptyc}
      {\emptyf[\emptyc]}
    }
\end{equation}
In the future, we shall denote $\emptyf[\Gamma]$ by $\emptyf$. The above rule
guarantees that this will not cause confusion. Likewise, we shall denote
$\emptytm[\Gamma]$ by $\emptytm$.

\subsection{Extension}
We introduce extension which not only extends a context $\Gamma$ and a family
$A$ over it to a context $\ctxext{\Gamma}{A}$, but which also extends a family $A$
in context $\Gamma$ and a family $P$ over it to a family $\ctxext{A}{P}$ over context
$\Gamma$. We do this to ensure that all of type theory can be done in a context.
For instance, we could say (1) that a context in context $\Gamma$ is the same thing
as a family over $\Gamma$; (2) When $A$ is a context in this sense, a family over
$A$ is the same thing as a family $P$ over $\ctxext{\Gamma}{A}$ and 
(3) when $P$ is a family over $A$ in this sense, a term of $P$ keeps its original meaning.

\begin{align}
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jctx{\ctxext{\Gamma}{A}}
    }
& & \inference
    { \jctxeq{\Gamma}{\Delta}
      \jfameq{\Gamma}{A}{B}
      }
    { \jctxeq{\ctxext{\Gamma}{A}}{\ctxext{\Delta}{B}}
      }
    \\
& \inference
  { \jfam{{\Gamma}{A}}{P}
    }
  { \jfam{\Gamma}{\ctxext{A}{P}}
    }
& & \inference
    { \jfameq{\Gamma}{A}{B} 
      \jfameq{{\Gamma}{A}}{P}{Q}
      }
    { \jfameq{\Gamma}{\ctxext{A}{P}}{\ctxext{B}{Q}}
      }
\end{align}

\subsubsection{Extension is compatible with the empty context}
The following rule asserts that extension by $\emptyc$ leaves the contexts unchanged.
\begin{align}
& \inference
  { \jctx{\Gamma}
    }
  { \jctxeq{\ctxext{\emptyc}{\Gamma}}{\Gamma}
    }
  \\
& \inference
  { \jctx{\Gamma}
    }
  { \jctxeq{\ctxext{\Gamma}{\emptyf}}{\Gamma}
    }
  \\
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jfameq{\Gamma}{\ctxext{\emptyf}{A}}{A}
    }
\end{align}

\subsubsection{Extension is compatible with itself}\label{comp-ee}
The inference rules asserting that extension is compatible with itself assert
that contexts are unstructured lists of type declarations. This rule is
unavoidable if we want that for a family $A$ in context $\Gamma$, a family over
$A$ is the same thing as a family over $\ctxext{\Gamma}{A}$. 

\begin{align}
& \inference
  { \jfam{\Gamma}{A}
    \jfam{{\Gamma}{A}}{P}
    }
  { \jctxeq{\ctxext{{\Gamma}{A}}{P}}{\ctxext{\Gamma}{{A}{P}}}
    }
  \\
& \inference
  { \jfam{{\Gamma}{A}}{P}
    \jfam{{{\Gamma}{A}}{P}}{Q}
    }
  { \jfameq{\Gamma}{\ctxext{{A}{P}}{Q}}{\ctxext{A}{{P}{Q}}}
    }
\end{align}

\subsection{The type theoretic operation of weakening}
When $A$ is a context family over a context $\Gamma$, we wish to define a weakening
operation $\ctxwk{A}{}$. The weakening operation acts on context families $B$ 
over $\Gamma$, terms thereof, context families over $B$ and terms thereof.
It weakens those, which means that it ``adds $A$ to the context''. The context
family $\ctxwk{A}{B}$ can be seen as the constant family $B$ over $\ctxext{\Gamma}{A}$.
Likewise, when $y$ is a term of $B$, the term $\ctxwk{A}{y}$ of $\ctxwk{A}{B}$
can be seen as the constant term with value $y$.
 
 In the following inference rules we assume that $\jfam{\Gamma}{A}$ and in the
 rules asserting a judgmental equality we assume furthermore that 
 $\jfameq{\Gamma}{A}{A'}$.
\begin{align}
& \inference
  { \jfam{\Gamma}{B}
    }
  { \jfam{{\Gamma}{A}}{\ctxwk{A}{B}}
    }
& & \inference
    { \jfameq{\Gamma}{B}{B'}
      }
    { \jfameq{{\Gamma}{A}}{\ctxwk{A}{B}}{\ctxwk{A'}{B'}}
      }
    \\
& \inference
  { \jfam{{\Gamma}{B}}{Q}
    }
  { \jfam{{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}
    }
& & \inference
    { \jfameq{{\Gamma}{B}}{Q}{Q'}
      }
    { \jfameq
        {{{\Gamma}{A}}{\ctxwk{A}{B}}}
        {\ctxwk{A}{Q}}
        {\ctxwk{A'}{Q'}}
      }
    \\
& \inference
  { \jterm{\Gamma}{B}{y}
    }
  { \jterm{{\Gamma}{A}}{\ctxwk{A}{B}}{\ctxwk{A}{y}}
    }
& & \inference
    { \jtermeq{\Gamma}{B}{y}{y'}
      }
    { \jtermeq
        {{\Gamma}{A}}
        {\ctxwk{A}{B}}
        {\ctxwk{A}{y}}
        {\ctxwk{A'}{y'}}
      }
    \\
& \inference
  { \jterm{{\Gamma}{B}}{Q}{g}
    }
  { \jterm{{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}{\ctxwk{A}{g}}
    }
& & \inference
    { \jtermeq{{\Gamma}{B}}{Q}{g}{g'}
      }
    { \jtermeq
        {{{\Gamma}{A}}{\ctxwk{A}{B}}}
        {\ctxwk{A}{Q}}
        {\ctxwk{A}{g}}
        {\ctxwk{A'}{g'}}
      }
\end{align}

We add rules asserting that a weakened type is again a type:

\begin{align}
& \inference
  { \jfam{\Gamma}{B}
    \jtype{\ctxext{\Gamma}{B}}{Q}
    }
  { \jtype{\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}
    }
\end{align}

\subsubsection{Weakening is compatible with the empty context}
The following rules express that when the empty context or context family is
weakened, the result is the empty context family.
\begin{align}
& \inference
  { \jctx{\Gamma}
    }
  { \jfameq{\Gamma}{\ctxwk{\Gamma}{\emptyc}}{\emptyf}
    }
  \\
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jfameq{{\Gamma}{A}}{\ctxwk{A}{\emptyf}}{\emptyf}
    }
\end{align}
Weakening by the empty family $\emptyf$ over a context $\Gamma$ leaves families, 
their terms, families over those families and
terms of those unchanged:
\begin{align}
& \inference
  { \jfam{\Gamma}{B}
    }
  { \jfameq{\Gamma}{\ctxwk{\emptyf}{B}}{B}
    }
  \\
& \inference
  { \jterm{\Gamma}{B}{y}
    }
  { \jtermeq{\Gamma}{B}{\ctxwk{\emptyf}{y}}{y}
    }
  \\
& \inference
  { \jfam{{\Gamma}{B}}{Q}
    }
  { \jfameq{{\Gamma}{B}}{\ctxwk{\emptyf}{Q}}{Q}
    }
  \\
& \inference
  { \jterm{{\Gamma}{B}}{Q}{g}
    }
  { \jtermeq{{\Gamma}{B}}{Q}{\ctxwk{\emptyf}{g}}{g}
    }
\end{align}

\subsubsection{Weakening is compatible with extension}\label{comp-we}

The following rules assert the compatibility of extension with weakening: for
every family $A$ over $\Gamma$ and every family $Q$ over $\ctxext{\Gamma}{B}$
there is a
judgmental equality $\ctxwk{A}{\ctxext{B}{Q}}\jdeq\ctxext{\ctxwk{A}{B}}
{\ctxwk{A}{Q}}$. 

When thinking of terms of $\ctxwk{A}{B}$ as morphisms of families from $A$ to
$B$, this looks already like form of type theoretic choice. It is weaker in that
it is not stated with function types, yet it is stronger in that it states a
judgmental equality between two families. When one makes the weakening operation
notationally invisible -- as is in fact the usual practice in type theory -- the
following compatibility rules become completely obvious.

In the following inference rules we assume that $\jfam{\Gamma}{A}$.
\begin{align}
& \inference
  { \jfam{{{\Gamma}{B}}{Q}}{R}
    }
  { \jfameq
      {\ctxext{{\Gamma}{A}}{\ctxwk{A}{B}}}
      {\ctxwk{A}{\ctxext{Q}{R}}}
      {\ctxext{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}
    }
\end{align}

\subsubsection{Weakening is compatible with itself}\label{comp-ww}
We state judgmental equality rules expressing
that weakening is compatible with itself. These rules state that the following
diagram commutes given any two families $A$ and $B$ in context $\Gamma$:
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\jfam{\Gamma}{\blank} 
  \ar{r}{C\mapsto\ctxwk{B}{C}} 
  \ar{d}[swap]{C\mapsto\ctxwk{A}{C}} 
& \jfam{{\Gamma}{B}}{\blank} 
  \ar{d}{Q\mapsto\ctxwk{A}{Q}}
  \\
\jfam{{\Gamma}{A}}{\blank} 
  \ar{r}[swap]{P\mapsto\ctxwk{{A}{B}}{P}} 
& \jfam{{{\Gamma}{A}}{\ctxwk{A}{B}}}{\blank}
\end{tikzcd}
\end{equation*}
Thus, we get the following set of inference rules:
\begin{align}
& \inference
  { \jfam{\Gamma}{A}
    \jfam{\Gamma}{B}
    \jfam{{\Gamma}{C}}{R}
    }
  { \jfameq
      {{{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{{A}{B}}{{A}{C}}}}
      {\ctxwk{A}{{B}{R}}}
      {\ctxwk{{A}{B}}{{A}{R}}}
    }
  \label{comp-ww-f}\\
& \inference
  { \jfam{\Gamma}{A}
    \jfam{\Gamma}{B}
    \jterm{{\Gamma}{C}}{R}{t}
    }
  { \jtermeq
      {{{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{{A}{B}}{{A}{C}}}}
      {\ctxwk{{A}{B}}{{A}{R}}}
      {\ctxwk{A}{{B}{t}}}
      {\ctxwk{{A}{B}}{{A}{t}}}
    }
  \label{comp-ww-t}
\end{align}

\subsubsection{Extension is compatible with weakening}\label{comp-ew}
The rules expressing that extension is compatible with weakening assert that
weakening by an extension is the same thing as weakening twice in the
appropriate way.

In the following inference rules we assume that
$\jfam{\Gamma}{A}$ and $\jfam{{\Gamma}{A}}{P}$. 
\begin{align}
& \inference
  { \jfam{{\Gamma}{B}}{Q}
    }
  { \jfameq
      {{{{\Gamma}{A}}{P}}{\ctxwk{P}{{A}{B}}}}
      {\ctxwk{\ctxext{A}{P}}{Q}}
      {\ctxwk{P}{{A}{Q}}}
    }
  \label{comp-ew-f}\\
& \inference
  { \jterm{{\Gamma}{B}}{Q}{g}
    }
  { \jtermeq
      {{{{\Gamma}{A}}{P}}{\ctxwk{P}{{A}{B}}}}
      {\ctxwk{P}{{A}{Q}}}
      {\ctxwk{\ctxext{A}{P}}{g}}
      {\ctxwk{P}{{A}{g}}}
    } 
  \label{comp-ew-t}
\end{align}

\subsection{The type theoretic operation of substitution}
Given a family $P$ over $A$ and a term $x$ of $A$, substitution gives a way to
consider the fiber $\subst{x}{P}$ of $P$ at $x$. Also, we get a way to evaluate
terms $f$ of $P$ at $x$. This will give us ways to compose functions too. In
this section, we shall first introduce the operations `substitution of a term $x$'
for families $P$ over $\ctxext{\Gamma}{A}$, terms $f$ of those, families $Q$ over
$\ctxext{{\Gamma}{A}}{P}$ and terms $g$ of those. 
Then we shall explain how substitution interacts
with itself, extension and weakening.

In the rules introducing the various substitutions we assume $\jterm{\Gamma}{A}{x}$;
in the rules introducing the definitional equalities we assume $\jtermeq{\Gamma}{A}{x}{x'}$.

\begin{align}
& \inference
  { \jfam{{\Gamma}{A}}{P}
    }
  { \jfam{\Gamma}{\subst{x}{P}}
    }
& & \inference
    { \jfameq{{\Gamma}{A}}{P}{P'}
      }
    { \jfameq{\Gamma}{\subst{x}{P}}{\subst{x'}{P'}}
      }
    \\
& \inference
  { \jfam{{{\Gamma}{A}}{P}}{Q}
    }
  { \jfam{{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}
    }
& & \inference
    { \jfameq{{{\Gamma}{A}}{P}}{Q}{Q'}
      }
    { \jfameq{{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}{\subst{x'}{Q'}}
      }
    \\
& \inference
  { \jterm{{\Gamma}{A}}{P}{f}
    }
  { \jterm{\Gamma}{\subst{x}{P}}{\subst{x}{f}}
    }
& & \inference
    { \jtermeq{{\Gamma}{A}}{P}{f}{f'}
      }
    { \jtermeq{\Gamma}{\subst{x}{P}}{\subst{x}{f}}{\subst{x'}{f'}}
      }
    \\
& \inference
  { \jterm{{{\Gamma}{A}}{P}}{Q}{g}
    }
  { \jterm{{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}{\subst{x}{g}}
    }
& & \inference
    { \jtermeq{{{\Gamma}{A}}{P}}{Q}{g}{g'}
      }
    { \jtermeq
        {{\Gamma}{\subst{x}{P}}}
        {\subst{x}{Q}}
        {\subst{x}{g}}
        {\subst{x'}{g'}}
      }
\end{align}

We also add the following rule asserting that substitution preserves the
property of being a type:
\begin{align}
& \inference
  { \jterm{\Gamma}{A}{x}
    \jtype{\ctxext{{\Gamma}{A}}{P}}{Q}
    }
  { \jtype{\ctxext{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}
    }
\end{align}

\subsubsection{Substitution is compatible with the empty context}
The fibers of the empty family are the empty families:
\begin{align}
& \inference
  { \jterm{\Gamma}{A}{x}
    }
  { \jfameq{\Gamma}{\subst{x}{\emptyf}}{\emptyf}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jfam{{\Gamma}{A}}{P}
    }
  { \jfameq
      {{\Gamma}{\subst{x}{P}}}
      {\subst{x}{\emptyf}}
      {\emptyf}
    }
\end{align}

The following rules assert that substituting by the term $\jterm{\Gamma}{\emptyf}{\emptytm}$
leaves everything unchanged.
\begin{align}
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jfameq{\Gamma}{\subst{\emptytm}{A}}{A}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    }
  { \jtermeq{\Gamma}{A}{\subst{\emptytm}{x}}{x}
    }
  \\
& \inference
  { \jfam{{\Gamma}{A}}{P}
    }
  { \jfameq{{\Gamma}{A}}{\subst{\emptytm}{P}}{P}
    }
  \\
& \inference
  { \jterm{{\Gamma}{A}}{P}{f}
    }
  { \jtermeq{{\Gamma}{A}}{P}{\subst{\emptytm}{f}}{f}
    }.
\end{align}

\subsubsection{Substitution is compatible with extension}\label{comp-se}
Suppose $\jterm{\Gamma}{A}{x}$ in all of the following inference rule.
\begin{align}
& \inference
  { \jfam{{{{\Gamma}{A}}{P}}{Q}}{R}
    }
  { \jfameq
      {{\Gamma}{\subst{x}{P}}}
      {\subst{x}{\ctxext{Q}{R}}}
      {\ctxext{\subst{x}{Q}}{\subst{x}{R}}}
    }
\end{align}

\subsubsection{Substitution is compatible with weakening}\label{comp-sw}
The rules asserting the compatibility of substitution with weakening assert
that the following diagram commutes for any $\jterm{\Gamma}{A}{x}$ and any
$\jfam{{\Gamma}{A}}{P}$:
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\jfam{{\Gamma}{A}}{\blank} 
  \ar{d}[swap]{Q\mapsto\subst{x}{Q}} 
  \ar{r}{Q\mapsto\ctxwk{P}{Q}} 
& \jfam{{{\Gamma}{A}}{P}}{\blank} 
    \ar{d}{R\mapsto\subst{x}{R}}
  \\ 
\jfam{\Gamma}{\blank} 
  \ar{r}[swap]{B\mapsto\ctxwk{\subst{x}{P}}{B}} 
& \jfam{{\Gamma}{\subst{x}{P}}}{\blank}
\end{tikzcd}
\end{equation*}
We plug in an extra layer of families to cover the most general case at once.
In the following inference rules we assume that $\jterm{\Gamma}{A}{x}$ and
$\jfam{{\Gamma}{A}}{P}$:
\begin{align}
& \inference
  { \jfam{{{\Gamma}{A}}{Q}}{R}
    }
  { \jfameq
      {{{\Gamma}{\subst{x}{P}}}{\subst{x}{\ctxwk{P}{Q}}}}
      {\subst{x}{\ctxwk{P}{R}}}
      {\ctxwk{\subst{x}{P}}{\subst{x}{R}}}
    }
  \label{comp-sw-f}\\
& \inference
  { \jterm{{{\Gamma}{A}}{Q}}{R}{h}
    }
  { \jtermeq
      {\ctxext{{\Gamma}{\subst{x}{P}}}{\subst{x}{\ctxwk{P}{Q}}}}
      {\subst{x}{\ctxwk{P}{R}}}
      {\subst{x}{\ctxwk{P}{h}}}
      {\ctxwk{\subst{x}{P}}{\subst{x}{h}}}
    }
  \label{comp-sw-t}
\end{align}

\subsubsection{Substitution is compatible with substitution}\label{comp-ss}

We require that substitution is compatible with itself, which is roughly the
assertion that substitution is associative. However, we cannot just state that
$\subst{x}{{f}{g}}\jdeq\subst{{x}{f}}{g}$ since the expression $\subst{{x}{f}}{g}$
is not well-formed. The term $\subst{x}{f}$ can be substituted in (terms of) families over
$\subst{x}{P}$; the term $\subst{x}{g}$ is such. Therefore, associativity of
substitution takes the form $\subst{x}{{f}{g}}\jdeq\subst{{x}{f}}{{x}{g}}$.
Note that the term $\subst{{x}{f}}{{x}{g}}$ may be written down more conveniently
as $\subst{x,\subst{x}{f}}{g}$, although we will not do that here.

In the following inference rules we assume
$\jterm{\Gamma}{A}{x}$ and $\jterm{{\Gamma}{A}}{P}{f}$.

\begin{align}
& \inference
  { \jfam{{{{\Gamma}{A}}{P}}{Q}}{R}
    }
  { \jfameq
      {{\Gamma}{\subst{x}{{f}{Q}}}}
      {\subst{x}{{f}{R}}}
      {\subst{{x}{f}}{{x}{R}}}
    }
  \label{comp-ss-f}\\
& \inference
  { \jterm{{{{\Gamma}{A}}{P}}{Q}}{R}{h}
    }
  { \jtermeq
      {{\Gamma}{\subst{x}{{f}{Q}}}}
      {\subst{x}{{f}{R}}}
      {\subst{x}{{f}{h}}}
      {\subst{{x}{f}}{{x}{h}}}
    }
  \label{comp-ss-t}
\end{align}

\subsubsection{Weakening is compatible with substitution}\label{comp-ws}
We already have rules for the compatibility of substitution with weakening, but
we still need the rules the other way around, asserting that there is a 
judgmental equality $\ctxwk{A}{\subst{y}{Q}}\jdeq\subst{\ctxwk{A}{y}}{\ctxwk{A}{Q}}$
together with all its variants.

In the following inference rules we assume that $\jfam{\Gamma}{A}$ and that
$\jterm{\Gamma}{B}{y}$.

\begin{align}
& \inference
  { \jfam{{{\Gamma}{B}}{Q}}{R}
    }
  { \jfameq
      {{{\Gamma}{A}}{\ctxwk{A}{\subst{y}{Q}}}}
      {\ctxwk{A}{\subst{y}{R}}}
      {\subst{\ctxwk{A}{y}}{\ctxwk{A}{R}}}
    }
  \label{comp-ws-f}\\
& \inference
  { \jterm{{{\Gamma}{B}}{Q}}{R}{h}
    }
  { \jtermeq
      {{{\Gamma}{A}}{\ctxwk{A}{\subst{y}{Q}}}}
      {\ctxwk{A}{\subst{y}{R}}}
      {\ctxwk{A}{\subst{y}{h}}}
      {\subst{\ctxwk{A}{y}}{\ctxwk{A}{h}}}
    }
  \label{comp-ws-t}
\end{align}

\subsection{Composition and identity terms}\label{categorical_properties}
\subsubsection{The defining property of weakening}
The judgmental equalities we're about to describe assert that substituting a term
in the weakening a thing gives you the thing back. In the case of contexts we get that each fiber
$\subst{x}{\ctxwk{A}{B}}$ is just $B$ and in the case of terms we get 
that $\ctxwk{A}{y}$ is the constant function
mapping everything to $y:B$. Thus, these rules actually establish the weakening
as the weakening. After stating the rules we will describe what it means to
compose context morphisms (terms of weakened contexts).

\begin{align}
& \inference
  { \jfam{\Gamma}{A}
    \jfam{{\Gamma}{B}}{Q}
    \jterm{\Gamma}{A}{x}
    }
  { \jfameq{{\Gamma}{B}}{\subst{x}{\ctxwk{A}{Q}}}{Q}
    }
  \label{defn-ws-3}\\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{{\Gamma}{B}}{Q}{g}
    }
  { \jtermeq{{\Gamma}{B}}{Q}{\subst{x}{\ctxwk{A}{g}}}{g}
    }
  \label{defn-ws-4}
\end{align}

Using the rules of the compatibility of substitution with weakening and of the
compatibility of weakening with itself, we see that we can show

\begin{lem}
The inference rule
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    \jfam{\Gamma}{B}
    \jfam{\Gamma}{C}
    \jhom{\Gamma}{A}{B}{f}
    }
  { \jfameq
    {{\Gamma}{A}}
    {\subst{f}{\ctxwk{A}{{B}{C}}}}
    {\ctxwk{A}{C}}
    }
\end{equation*}
is valid.
\end{lem}

\begin{proof}
Let $\jfam{\Gamma}{A}$, $\jfam{\Gamma}{B}$, $\jfam{\Gamma}{C}$ and $\jhom{\Gamma}{A}{B}{f}$.
Then we have the judgmental equalities
\begin{align*}
\subst{f}{\ctxwk{A}{{B}{C}}}
& \jdeq 
  \subst{f}{\ctxwk{{A}{B}}{{A}{C}}}
  \\
& \jdeq 
  \ctxwk{A}{C}.
  \qedhere
\end{align*}
\end{proof}

It follows that for $\jterm{{\Gamma}{B}}{\ctxwk{B}{C}}{g}$ we can compose $f$
with $g$ to obtain a term of $\ctxwk{A}{C}$ in context $\ctxext{\Gamma}{A}$.
In the following definition, we work with in a slightly greater generality.

\begin{defn}
We define the judgment
\begin{equation*}
\jhom{\Gamma}{A}{B}{f},
\end{equation*}
which is pronounced as `$f$ is a morphism from $A$ to $B$ in context $\Gamma$',
to be the judgment
\begin{equation*}
\unfold{\jhom{\Gamma}{A}{B}{f}}.
\end{equation*}
Likewise, we define the judgment
\begin{equation*}
\jhomeq{\Gamma}{A}{B}{f}{f'}
\end{equation*}
to be the judgment
\begin{equation*}
\unfold{\jhomeq{\Gamma}{A}{B}{f}{f'}}.
\end{equation*}
\end{defn}

\begin{defn}
Let $\jhom{\Gamma}{A}{B}{f}$ and consider a term $\jterm{{\Gamma}{B}}{Q}{g}$.
We define
\begin{align*}
\jfamdefn*
  {{\Gamma}{A}}
  {\jcomp{A}{f}{Q}}
  {\unfold{\jcomp{A}{f}{Q}}}\\
\jtermdefn*
  {{\Gamma}{A}}
  {\jcomp{A}{f}{Q}}
  {\jcomp{A}{f}{g}}
  {\unfold{\jcomp{A}{f}{g}}}.
\end{align*}
Likewise, when we have a family $\jfam{{{\Gamma}{B}}{Q}}{R}$ and a term
$\jterm{{{\Gamma}{B}}{Q}}{R}{h}$, we define
\begin{align*}
\jfamdefn*
  {{{\Gamma}{A}}{\jcomp{A}{f}{Q}}}
  {\jcomp{A}{f}{R}}
  {\unfold{\jcomp{A}{f}{R}}}
  \\
\jtermdefn*
  {{{\Gamma}{A}}{\jcomp{A}{f}{Q}}}
  {\jcomp{A}{f}{R}}
  {\jcomp{A}{f}{h}}
  {\unfold{\jcomp{A}{f}{h}}}.
\end{align*}
\end{defn}

We have lots of compatibility properties for composition:

\begin{lem}
We have the following inference rules about the situation where something is
substituted by a composition:
\begin{align*}
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    \jhom{\Gamma}{B}{C}{g}
    \jfam{{{\Gamma}{A}}{\ctxwk{A}{C}}}{R}
    }
  { \jfameq
      {{\Gamma}{A}}
      {\subst{\jcomp{A}{f}{g}}{R}}
      {\subst{f}{{\ctxwk{A}{g}}{\ctxwk{{A}{B}}{R}}}}
    }
  \\
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    \jhom{\Gamma}{B}{C}{g}
    \jterm{{{\Gamma}{A}}{\ctxwk{A}{C}}}{R}{h}
    }
  { \jfameq
    {{\Gamma}{A}}
    {\subst{\jcomp{A}{f}{g}}{h}}
    {\subst{f}{{\ctxwk{A}{g}}{\ctxwk{{A}{B}}{h}}}}
    }
\end{align*}
We also have the following related inference rules, asserting that composition
is strictly associative:
\begin{align*}
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    \jhom{\Gamma}{B}{C}{g}
    \jfam{{\Gamma}{C}}{R}
    }
  { \jfameq
      {{\Gamma}{A}}
      {\jcomp{A}{{A}{f}{g}}{R}}
      {\jcomp{A}{f}{{B}{g}{R}}}
    }
  \\
& \inference
    { \jhom{\Gamma}{A}{B}{f}
      \jhom{\Gamma}{B}{C}{g}
      \jterm{{\Gamma}{C}}{R}{h}
      }
    { \jtermeq
        {{\Gamma}{A}}
        {\jcomp{A}{{A}{f}{g}}{R}}
        {\jcomp{A}{{A}{f}{g}}{h}}
        {\jcomp{A}{f}{{B}{g}{h}}}
      }
\end{align*}
\end{lem}

\begin{proof}
Consider family morphisms $\jhom{\Gamma}{A}{B}{f}$ and $\jhom{\Gamma}{B}{C}{g}$
and a family $\jfam{{{\Gamma}{A}}{\ctxwk{A}{C}}}{R}$. Then we have the judgmental
equalities
\begin{align*}
\subst{\jcomp{A}{f}{g}}{R} 
& \jdeq 
  \subst{{f}{\ctxwk{A}{g}}}{R}
  \\
& \jdeq 
  \subst{{f}{\ctxwk{A}{g}}}{\subst{f}{\ctxwk{{A}{B}}{R}}}
  \\
& \jdeq 
  \subst{f}{{\ctxwk{A}{g}}{\ctxwk{{A}{B}}{R}}}
\end{align*}
The proof that 
$\subst{\jcomp{A}{f}{g}}{h}\jdeq\subst{f}{{\ctxwk{A}{g}}{\ctxwk{{A}{B}}{h}}}$
is similar.

Now suppose that $\jfam{{\Gamma}{C}}{R}$ instead. Then we have
\begin{align*}
\jcomp{A}{{A}{f}{g}}{R} 
& \jdeq 
  \subst{\jcomp{A}{f}{g}}{\ctxwk{A}{R}}
  \\
& \jdeq 
  \subst{{f}{\ctxwk{A}{g}}}{\ctxwk{A}{R}}
  \\
& \jdeq 
  \subst{f}{{\ctxwk{A}{g}}{\ctxwk{{A}{B}}{{A}{R}}}}
  \\
& \jdeq 
  \subst{f}{{\ctxwk{A}{g}}{\ctxwk{A}{{B}{R}}}}
  \\
& \jdeq 
  \subst{f}{\ctxwk{A}{\subst{g}{\ctxwk{B}{R}}}}
  \\
& \jdeq 
  \subst{f}{\ctxwk{A}{\jcomp{B}{g}{R}}}
  \\
& \jdeq 
  \jcomp{A}{f}{{B}{g}{R}}.
\end{align*}
Again, the proof is similar for terms $h$ of $R$ in context $\ctxext{\Gamma}{C}$.
\end{proof}

\begin{lem}
We have the following inference rules about the compatibility of composition with
weakening:
\begin{align*}
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    \jhom{\Gamma}{B}{C}{g}
    \jfam{{\Gamma}{A}}{P}
    }
  { \jhomeq
      {\Gamma}
      {{A}{P}}
      {C}
      {\ctxwk{P}{\jcomp{A}{f}{g}}}
      {\jcomp{{A}{P}}{\ctxwk{P}{f}}{g}}
    }
  \\
& \inference
  { \jterm{\Gamma}{B}{y}
    \jhom{\Gamma}{B}{C}{g}
    }
  { \jhomeq
      {\Gamma}
      {A}
      {C}
      {\jcomp{A}{\ctxwk{A}{y}}{g}}
      {\ctxwk{A}{\subst{y}{g}}}
    }
  \\
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    \jterm{\Gamma}{C}{z}
    }
  { \jhomeq
      {\Gamma}
      {A}
      {C}
      {\jcomp{A}{f}{\ctxwk{B}{z}}}
      {\ctxwk{A}{z}}
    }
\end{align*}
\end{lem}

\begin{proof}
Let $\jhom{\Gamma}{A}{B}{f}$, $\jhom{\Gamma}{B}{C}{g}$ and $\jfam{{\Gamma}{A}}{P}$.
Then we have the judgmental equalities
\begin{align*}
\ctxwk{P}{\jcomp{A}{f}{g}} 
& \jdeq 
  \ctxwk{P}{\subst{f}{\ctxwk{A}{g}}}
  \\
& \jdeq 
  \subst{\ctxwk{P}{f}}{\ctxwk{P}{{A}{g}}}
  \\
& \jdeq 
  \subst{\ctxwk{P}{f}}{\ctxwk{\ctxext{A}{P}}{g}}
  \\
& \jdeq 
  \jcomp{{A}{P}}{\ctxwk{P}{f}}{g}.
\end{align*}
Now let $\jterm{\Gamma}{B}{y}$ and $\jhom{\Gamma}{B}{C}{g}$. Then we have the
judgmental equalities
\begin{align*}
\jcomp{A}{\ctxwk{A}{y}}{g}
& \jdeq 
  \subst{\ctxwk{A}{y}}{\ctxwk{A}{g}}
  \\
& \jdeq 
  \ctxwk{A}{\subst{y}{g}}.
\end{align*}
For the third assertion, let $\jhom{\Gamma}{A}{B}{f}$ and $\jterm{\Gamma}{C}{z}$.
Then we have the judgmental equalities
\begin{align*}
\jcomp{A}{f}{\ctxwk{B}{z}} 
& \jdeq 
  \subst{f}{\ctxwk{A}{{B}{z}}}
  \\
& \jdeq 
  \subst{f}{\ctxwk{{A}{B}}{{A}{z}}}
  \\
& \jdeq 
  \ctxwk{A}{z}.
  \qedhere
\end{align*}
\end{proof}

\begin{lem}
We have the following inference rules about the compatibility of composition with
substitution:
\begin{align*}
& \inference
  { \jhom{{\Gamma}{A}}{P}{Q}{f}
    \jhom{{\Gamma}{A}}{Q}{R}{g}
    \jterm{\Gamma}{A}{x}
    }
  { \jhomeq
      {\Gamma}
      {\subst{x}{P}}
      {\subst{x}{R}}
      {\subst{x}{\jcomp{P}{f}{g}}}
      {\jcomp{\subst{x}{P}}{\subst{x}{f}}{\subst{x}{g}}}
    }
  \\
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    \jhom{\Gamma}{B}{C}{g}
    \jterm{\Gamma}{A}{x}
    }
  { \jtermeq
      {\Gamma}
      {C}
      {\subst{x}{\jcomp{A}{f}{g}}}
      {\subst{{x}{f}}{g}}
    }
\end{align*}
\end{lem}

\begin{proof}
Let $\jhom{{\Gamma}{A}}{P}{Q}{f}$, $\jhom{{\Gamma}{A}}{Q}{R}{g}$ and 
$\jterm{\Gamma}{A}{x}$.
Then we have the judgmental equalities
\begin{align*}
\subst{x}{\jcomp{A}{f}{g}}
& \jdeq 
  \subst{x}{{f}{\ctxwk{P}{g}}}
  \\
& \jdeq 
  \subst{{x}{f}}{{x}{\ctxwk{P}{g}}}
  \\
& \jdeq 
  \subst{{x}{f}}{\ctxwk{\subst{x}{P}}{\subst{x}{g}}}
  \\
& \jdeq 
  \jcomp{\subst{x}{P}}{\subst{x}{f}}{\subst{x}{g}}.
\end{align*}
Now let $\jhom{\Gamma}{A}{B}{f}$, $\jhom{\Gamma}{B}{C}{g}$ and $\jterm{\Gamma}{A}{x}$.
Then we have the judgmental equalities
\begin{align*}
\subst{x}{\jcomp{A}{f}{g}}
& \jdeq 
  \subst{x}{{f}{\ctxwk{A}{g}}}
  \\
& \jdeq 
  \subst{{x}{f}}{{x}{\ctxwk{A}{g}}}
  \\
& \jdeq 
  \subst{{x}{f}}{g}.
  \qedhere
\end{align*}
\end{proof}

There is also a notion of morphism \emph{over} a morphism. We will develop this
notion because it will be needed in the theory of models later on.

\begin{defn}
Let $\jhom{\Gamma}{A}{B}{f}$ be a morphism from $A$ to $B$ in context $\Gamma$
and consider $\jfam{{\Gamma}{A}}{P}$ and $\jfam{{\Gamma}{B}}{Q}$. We define the
judgment
\begin{equation*}
\jfhom{\Gamma}{A}{B}{f}{P}{Q}{F},
\end{equation*}
which is pronounced as `$F$ is a morphism from $P$ to $Q$ over $f$ in context
$\Gamma$', to be the judgment
\begin{equation*}
\unfold{\jfhom{\Gamma}{A}{B}{f}{P}{Q}{F}}.
\end{equation*}
\end{defn}

\begin{rmk}
The judgment $\jfhom{\Gamma}{A}{B}{f}{P}{Q}{F}$ means the same thing as
\begin{equation*}
\jhom{{\Gamma}{A}}{P}{\jcomp{A}{f}{Q}}{F}.
\end{equation*}
\end{rmk}

Suppose we have morphisms $\jhom{\Gamma}{A}{B}{f}$ and $\jhom{\Gamma}{B}{C}{g}$
and that we have the morphisms $\jfhom{\Gamma}{A}{B}{f}{P}{Q}{F}$ and
$\jfhom{\Gamma}{B}{C}{g}{Q}{R}{G}$ over them. Then we have
\begin{equation*}
\jhom
  {{\Gamma}{A}}
  {\jcomp{A}{f}{Q}}
  {\jcomp{A}{f}{{B}{g}{R}}}
  {\unfold{\jcomp{A}{f}{G}}}
\end{equation*}
Because we also have $\jhom{{\Gamma}{A}}{P}{\jcomp{A}{f}{Q}}{F}$, we have the
composition
\begin{equation*}
\jhom
  {{\Gamma}{A}}
  {P}
  {\jcomp{A}{f}{{B}{g}{R}}}
  {\jcomp{P}{F}{\unfold{\jcomp{A}{f}{G}}}}.
\end{equation*}
Because of 
the judgmental equality $\jcomp{A}{f}{{B}{g}{R}}\jdeq
\jcomp{A}{{A}{f}{g}}{R}$, it follows that 
$\jcomp{P}{F}{\unfold{\jcomp{A}{f}{G}}}$ is a morphism from $P$ to $R$ over
$\jcomp{A}{f}{g}$. We make the following definition:

\begin{defn}
Let $\jhom{\Gamma}{A}{B}{f}$ and $\jhom{\Gamma}{B}{C}{g}$
be morphisms and let $\jfhom{\Gamma}{A}{B}{f}{P}{Q}{F}$ and
$\jfhom{\Gamma}{B}{C}{g}{Q}{R}{G}$ be morphisms over them. Then we define
\begin{equation*}
\jfhomdefn
  {\Gamma}
  {A}
  {C}
  {\jcomp{A}{f}{g}}
  {P}
  {R}
  {\jfcomp{A}{f}{P}{F}{G}}
  {\unfold{\jfcomp{A}{f}{P}{F}{G}}}.
\end{equation*}
\end{defn}

This composition is also judgmentally associative.

\subsubsection{identity terms}
Without a rule explicitly asserting the existence of an identity morphism we don't
get one, hence we do that here. The identity morphism is a term which introduced
in ordinary type theory via the variable rule. The variable rule is a bit more
general: it asserts that
\begin{equation*}
\jterm{\Gamma,\,x_1:A_1,\ldots,\,x_n:A_n}{A_i}{x_i}
\end{equation*}
for every $1\leq i\leq n$. Thus, it establishes the projections. In our setting,
we get the projections from the identity morphisms together with weakening. We
already have weakening, so here it suffices to introduce the identity morphisms.
\begin{align}
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jhom{\Gamma}{A}{A}{\idtm{A}}
    }
& & \inference
    { \jfameq{\Gamma}{A}{A'}
      }
    { \jhomeq{\Gamma}{A}{A}{\idtm{A}}{\idtm{A'}}
      }
\end{align}
Identity terms are determined by their behavior with respect to substitution combined with
weakening. The identity terms will also be subject to compatibility rules.
\begin{align}
& \inference
  { \jterm{\Gamma}{A}{x}
    }
  { \jtermeq{\Gamma}{A}{\subst{x}{\idtm{A}}}{x}
    }
  \label{idfunc-subst-defn}\\
& \inference
  { \jfam{{\Gamma}{A}}{P}
    }
  { \jfameq{{\Gamma}{A}}{\subst{\idtm{A}}{\ctxwk{A}{P}}}{P}
    }
  \label{idfunc-wk-defn}\\
& \inference
  { \jfam{{\Gamma}{A}}{P}
    }
  { \jfameq
      {{\Gamma}{A}}
      {\subst{\idtm{A}}{\ctxwk{{A}{A}}{P}}}
      {P}
    }
  \label{idfunc-wk-defn2}\\
& \inference
  { \jterm{{\Gamma}{A}}{P}{f}
    }
  { \jtermeq
      {{\Gamma}{A}}
      {P}
      {\subst{\idtm{A}}{\ctxwk{A}{f}}}
      {f}
    }
  \label{idfunc-precomp}\\
& \inference
  { \jterm{{\Gamma}{A}}{P}{f}
    }
  { \jtermeq
      {{\Gamma}{A}}
      {P}
      {\subst{\idtm{A}}{\ctxwk{{A}{A}}{f}}}
      {f}
    }
  \label{idfunc-precomp}\\
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    }
  { \jhomeq{\Gamma}{A}{B}{\jcomp{A}{f}{\idtm{B}}}{f}
    }
  \label{idfunc-postcomp}
\end{align}

We won't state a compatibility rule stating that the identity term is
compatible with extension because we will be able to prove that. Instead, we
will just state the compatibility rules for the identity term combined with
weakening and with substitution.

The identity term of a weakened family is the weakened identity term:
\begin{equation}\label{idfunc-wk-comp}
\inference
  { \jfam{\Gamma}{A}
    \jfam{\Gamma}{B}
    }
  { \jhomeq
      {{\Gamma}{A}}
      {\ctxwk{A}{B}}
      {\ctxwk{A}{B}}
      {\ctxwk{A}{\idtm{B}}}
      {\idtm{\ctxwk{A}{B}}}
    }
\end{equation}

The identity term of a substituted family is the substitution of the identity term
\begin{equation}\label{idfunc-subst-comp}
\inference
  { \jterm{\Gamma}{A}{x}
    \jfam{{\Gamma}{A}}{P}
    }
  { \jhomeq
      {\Gamma}
      {\subst{x}{P}}
      {\subst{x}{P}}
      {\subst{x}{\idtm{P}}}
      {\idtm{\subst{x}{P}}}
    }
\end{equation}

Now let $\jfam{{\Gamma}{A}}{P}$ and $\jfam{{\Gamma}{A}}{Q}$ be families. A
morphism from $P$ to $Q$ over the identity term $\idtm{A}$ in context
$\Gamma$ is the same thing as a morphism from $P$ to $Q$ in context
$\ctxext{\Gamma}{A}$:

\begin{lem}\label{hom-over-id-is-hom}
We have the following valid inference rules:
\begin{align*}
& \inference
  { \jfam{{\Gamma}{A}}{P}
    \jfam{{\Gamma}{A}}{Q}
    \jfhom{\Gamma}{A}{A}{\idtm{A}}{P}{Q}{f}
    }
  { \jhom{{\Gamma}{A}}{P}{Q}{f}
    }
  \\
& \inference
  { \jfam{{\Gamma}{A}}{P}
    \jfam{{\Gamma}{A}}{Q}
    \jhom{{\Gamma}{A}}{P}{Q}{f}
    }
  { \jfhom{\Gamma}{A}{A}{\idtm{A}}{P}{Q}{f}
    }
\end{align*}
\end{lem}

\begin{proof}
If we unfold the judgments $\jhom{{\Gamma}{A}}{P}{Q}{f}$ and
$\jfhom{\Gamma}{A}{A}{\idtm{A}}{P}{Q}{f}$, we get the judgments
\begin{align*}
& \unfold{\jhom{{\Gamma}{A}}{P}{Q}{f}}
  \\
& \unfold{\jfhom{\Gamma}{A}{A}{\idtm{A}}{P}{Q}{f}}
\end{align*}
respectively. Therefore, we only need to verify that
$\ctxwk{P}{\subst{\idtm{A}}{\ctxwk{A}{Q}}}\jdeq\ctxwk{P}{Q}$, which is indeed
the case by \autoref{idfunc-wk-defn}.
\end{proof}

\subsection{Digging a little deeper in the theory of contexts, families and terms}
\label{digging_deeper}

There is a good amount of things we can already state and prove about in the
theory we have developed so far. We will develop a bit more theory that will
come in handy later on.

\emph{This subsection contains no new assumptions.}

\subsubsection{Projections and extension on terms}\label{extension-on-terms}
In this subsubsection we consider the notion of extension on terms, which has now
become definable inside our theory. Moreover, every compatibility rule one may
dream of is provable as well, using the compatibility rules we have introduced
earlier.

\begin{defn}
When $\jterm{\Gamma}{A}{x}$ and $\jterm{\Gamma}{\subst{x}{P}}{u}$ are terms,
we define 
\begin{equation*}
\jtermdefn
  {\Gamma}
  {\ctxext{A}{P}}
  {\tmext{A}{P}{x}{u}}
  {\unfold{\tmext{A}{P}{x}{u}}}.
\end{equation*} 
\end{defn}

Thus, the term $\tmext{A}{P}{x}{u}$ is the pairing of $x$ and $u$. Note that because
we have the judgmental equality 
$\ctxwk{P}{{A}{\ctxext{A}{P}}}\jdeq\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}$ in the
context $\ctxext{{\Gamma}{A}}{P}$, the
pairing function could just be defined as $\idtm{\ctxext{A}{P}}$. 

When we substitute by an extended term we get an equal result as when we
substitute two consecutive times, like the way currying works.

\begin{lem}
The following inference rules are valid:
\begin{align*}
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    \jfam{{{\Gamma}{A}}{P}}{Q}
    }
  { \jfameq
      {\Gamma}
      {\subst{\tmext{A}{P}{x}{u}}{Q}}
      {\subst{u}{{x}{Q}}}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    \jterm{{{\Gamma}{A}}{P}}{Q}{g}
    }
  { \jtermeq
      {\Gamma}
      {\subst{u}{{x}{Q}}}
      {\subst{\tmext{A}{P}{x}{u}}{g}}
      {\subst{u}{{x}{g}}}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    \jfam{{{{\Gamma}{A}}{P}}{Q}}{R}
    }
  { \jfameq
      {{\Gamma}{\subst{u}{{x}{Q}}}}
      {\subst{\tmext{A}{P}{x}{u}}{R}}
      {\subst{u}{{x}{R}}}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    \jterm{{{{\Gamma}{A}}{P}}{Q}}{R}{t}
    }
  { \jtermeq
      {{\Gamma}{\subst{u}{{x}{Q}}}}
      {\subst{u}{{x}{R}}}
      {\subst{\tmext{A}{P}{x}{u}}{t}}
      {\subst{u}{{x}{t}}}
    }
\end{align*}
\end{lem}

\begin{proof}
We prove only the first judgmental equality. All the others are similar.
Let $\jterm{\Gamma}{A}{x}$ and $\jterm{\Gamma}{\subst{x}{P}}{u}$
be terms and let $\jfam{{{\Gamma}{A}}{P}}{Q}$ be a family. Then we have
\begin{align*}
\subst
  {\tmext{A}{P}{x}{u}}
  {Q} 
& \jdeq 
  \subst
    {{u}{{x}{\idtm{\ctxext{A}{P}}}}}
    {Q}
  \tag{by definition}\\
& \jdeq 
  \subst
    {{u}{{x}{\idtm{\ctxext{A}{P}}}}}
    {{x}{\ctxwk{A}{Q}}}
  \tag{by \autoref{defn-ws-3}}\\
& \jdeq 
  \subst
    {{u}{{x}{\idtm{\ctxext{A}{P}}}}}
    {{u}{\ctxwk{\subst{x}{P}}{\subst{x}{\ctxwk{A}{Q}}}}}
  \tag{by \autoref{defn-ws-3}}\\
& \jdeq 
  \subst
    {{u}{{x}{\idtm{\ctxext{A}{P}}}}}
    {{u}{{x}{\ctxwk{P}{{A}{Q}}}}}
  \tag{by \autoref{comp-sw-f}}\\
& \jdeq 
  \subst
    {u}
    {{{x}{\idtm{\ctxext{A}{P}}}}{{x}{\ctxwk{{P}{{A}{Q}}}}}}
  \tag{by \autoref{comp-ss-f}}\\
& \jdeq 
  \subst
    {u}
    {{x}{{\idtm{\ctxext{A}{P}}}{\ctxwk{P}{{A}{Q}}}}}
  \tag{by \autoref{comp-ss-f}}\\
& \jdeq 
  \subst
    {u}
    {{x}{{\idtm{\ctxext{A}{P}}}{\ctxwk{\ctxext{A}{P}}{Q}}}}
  \tag{by \autoref{comp-ew-f}}\\
& \jdeq 
  \subst
    {u}
    {{x}{Q}}
  \tag{by \autoref{idfunc-wk-defn}}
\end{align*}
\end{proof}

We have seen above that the pairing function into $\ctxext{A}{P}$ is just the identity term on
$\ctxext{A}{P}$. To analyze the pairing functin a little further, we will also
need the projection maps from $\ctxext{A}{P}$ to $A$ and from $\ctxext{A}{P}$
to $P$. We will now define these and see that the identity term of an
extended family is the extension (or pairing) of the identity
functions on the components in the apropriate way.

To find out what the
apropriate way is, note that
\begin{align*}
\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}} 
& \jdeq 
  \ctxwk{P}{{A}{\ctxext{A}{P}}}
  \\
& \jdeq 
  \ctxext{\ctxwk{P}{{A}{A}}}{\ctxwk{P}{{A}{P}}}
\end{align*}
We have the term $\jterm{{\Gamma}{{A}{P}}}{\ctxwk{P}{A}}{\ctxwk{P}{\idtm{A}}}$.
Thus we need to find out what $\subst{\ctxwk{P}{\idtm{A}}}{\ctxwk{P}{{A}{P}}}$ is:
\begin{align*}
\subst{\ctxwk{P}{\idtm{A}}}{\ctxwk{P}{{A}{P}}} 
& \jdeq 
  \ctxwk{P}{\subst{\idtm{A}}{\ctxwk{A}{P}}}
  \\
& \jdeq 
  \ctxwk{P}{P},
\end{align*}
where we find the term $\idtm{P}$. Therefore we define:

\begin{defn}
Let $\jfam{\Gamma}{A}$ and $\jfam{{\Gamma}{A}}{P}$ be families. We define
\begin{align*}
\jhomdefn*
  {\Gamma}
  {{A}{P}}
  {A}
  {\cprojfstf{A}{P}}
  {\unfold{\cprojfstf{A}{P}}}
  \\
\jtermdefn*
  {\ctxext{\Gamma}{{A}{P}}}
  {\ctxwk{P}{P}}
  {\cprojsndf{A}{P}}
  {\unfold{\cprojsndf{A}{P}}}
\end{align*}
\end{defn}

We find the following inference rule, which expresses that the identity term
is compatible with extension:

\begin{lem}
For any $\jfam{\Gamma}{A}$ and $\jfam{{\Gamma}{A}}{P}$ we have
\begin{equation}\label{idfunc-ext-comp}
\inference
  { \jfam{\Gamma}{A}
    \jfam{{\Gamma}{A}}{P}
    }
  { \jhomeq
      {\Gamma}
      {{A}{P}}{{A}{P}}
      {\idtm{\ctxext{A}{P}}}
      { \tmext
          {\ctxwk{\ctxext{A}{P}}{A}}
          {\ctxwk{\ctxext{A}{P}}{P}}
          {\cprojfstf{A}{P}}
          {\cprojsndf{A}{P}}
        }
    }
\end{equation}
\end{lem}

\begin{proof}
Consider the families $\jfam{\Gamma}{A}$ and $\jfam{{\Gamma}{A}}{P}$. Then
we have the judgmental equalities
\begin{align*}
\tmext
  {\ctxwk{\ctxext{A}{P}}{A}}
  {\ctxwk{\ctxext{A}{P}}{P}}
  {\cprojfstf{A}{P}}
  {\cprojsndf{A}{P}}
& \jdeq 
  \unfold
  { \tmext
      {\ctxwk{\ctxext{A}{P}}{A}}
      {\ctxwk{\ctxext{A}{P}}{P}}
      {\cprojfstf{A}{P}}
      {\cprojsndf{A}{P}}
    }
  \\
& \jdeq 
  \subst
    { \idtm{P}
      }
    { {\ctxwk{P}{\idtm{A}}}
      {\idtm{\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}}}
      }
  \\
& \jdeq 
  \subst
    { \idtm{P}
      }
    { {\ctxwk{P}{\idtm{A}}}
      {\ctxwk{\ctxext{A}{P}}{\idtm{\ctxext{A}{P}}}}
      }
  \\
& \jdeq 
  \subst
    { \idtm{P}
      }
    { {\ctxwk{P}{\idtm{A}}}
      {\ctxwk{P}{{A}{\idtm{\ctxext{A}{P}}}}}
      }
  \\
& \jdeq 
  \subst
    { \idtm{P}
      }
    {\ctxwk
      {P}
      { \subst
        {\idtm{A}}
        {\ctxwk{A}{\idtm{\ctxext{A}{P}}}}
        }
      }
  \\
& \jdeq 
  \subst
    { \idtm{A}
      }
    { \ctxwk{A}{\idtm{\ctxext{A}{P}}}
      }
  \\
& \jdeq 
  \idtm{\ctxext{A}{P}}.
  \qedhere
\end{align*}
\end{proof}

\begin{lem}
The following inference is valid:
\begin{equation*}
\inference
  { \jfam{{\Gamma}{A}}{P}
    \jfam{{\Gamma}{A}}{Q}
    }
  { \jfameq
      {{\Gamma}{{A}{P}}}
      {\subst{\cprojfstf{A}{P}}{\ctxwk{\ctxext{A}{P}}{Q}}}
      {\ctxwk{P}{Q}}
    }
\end{equation*}
\end{lem}

\begin{proof}
Let $\jfam{{\Gamma}{A}}{P}$ and $\jfam{{\Gamma}{A}}{Q}$ be
families. Then we have
\begin{align*}
\subst{\cprojfstf{A}{P}}{\ctxwk{\ctxext{A}{P}}{Q}} 
& \jdeq 
  \subst{\ctxwk{P}{\idtm{A}}}{\ctxwk{\ctxext{A}{P}}{Q}} 
  \tag{by definition}\\
& \jdeq 
  \subst{\ctxwk{P}{\idtm{A}}}{\ctxwk{P}{{A}{Q}}} 
  \tag{by \autoref{comp-ww-f}}\\
& \jdeq 
  \ctxwk{P}{\subst{\idtm{A}}{\ctxwk{A}{Q}}} 
  \tag{by \autoref{comp-ws-f}}\\
& \jdeq 
  \ctxwk{P}{Q} 
  \tag{by \autoref{idfunc-wk-defn}}
\end{align*}
\end{proof}

The constructions of the terms $\tmext{A}{P}{x}{u}$ and $\cprojfst{A}{P}{w}$ and
$\cprojsnd{A}{P}{w}$ are subject to various rules, with all of them being
consequences of earlier introduced inference rules.

\begin{lem} The following inference rules expressing that pairing is a strict
inverse to the combination of decompositions, are valid:
\begin{align*}
& \inference
  { \jterm{\Gamma}{\ctxext{A}{P}}{w}
    }
  { \jtermeq
      {\Gamma}
      {\ctxext{A}{P}}
      {\tmext{A}{P}{\cprojfst{A}{P}{w}}{\cprojsnd{A}{P}{w}}}
      {w}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    }
  { \jtermeq
      {\Gamma}
      {A}
      {\cprojfst{A}{P}{\tmext{A}{P}{x}{u}}}
      {x}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    }
  { \jtermeq
      {\Gamma}
      {\subst{x}{P}}
      {\cprojsnd{A}{P}{\tmext{A}{P}{x}{u}}}
      {u}
    }
\end{align*}
\end{lem}

\begin{proof}
To prove the first judgmental equality, note that
\begin{align*}
w 
& \jdeq 
  \subst{w}{\idtm{\ctxext{A}{P}}} 
  \tag{by \autoref{idfunc-subst-defn}}\\
& \jdeq 
  \subst
    { w}
    { { \idtm{P}}
      { { \ctxwk{P}{\idtm{A}}}
        { \idtm{\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}}}
        }
      }
  \tag{by \autoref{idfunc-ext-comp}}\\
& \jdeq 
  \subst
    { {w}
      {\idtm{P}}
      }
    { {w}
      { { \ctxwk{P}{\idtm{A}}
          }
        { \idtm{\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}}
          }
        }
      }
  \tag{by \autoref{comp-ss-t}}\\
& \jdeq 
  \subst
    { {w}
      {\idtm{P}}
      }
    { { {w}
        {\ctxwk{P}{\idtm{A}}}
        }
      { {w}
        {\idtm{\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}}}
        }
      }
  \tag{by \autoref{comp-ss-t}}\\
& \jdeq 
  \subst
    { {w}
      {\idtm{P}}
      }
    { { {w}
        {\ctxwk{P}{\idtm{A}}}
        }
      { {w}
        {\ctxwk{\ctxext{A}{P}}{\idtm{\ctxext{A}{P}}}}
        }
      }
  \tag{by \autoref{idfunc-wk-comp}}\\
& \jdeq 
  \subst
    { {w}
      {\idtm{P}}
      }
    { { {w}
        {\ctxwk{P}{\idtm{A}}}
        }
      { \idtm{\ctxext{A}{P}}
        }
      }
  \tag{by \autoref{defn-ws-4}}\\
& \jdeq 
  \tmext{A}{P}{\cprojfst{A}{P}{w}}{\cprojsnd{A}{P}{w}}
  \tag{by definition}
\end{align*}
To prove the second judgmental equality, let $\jterm{\Gamma}{A}{x}$ and
$\jterm{\Gamma}{\subst{x}{P}}{u}$. Then we have
\begin{align*}
\cprojfst{A}{P}{\tmext{A}{P}{x}{u}}
& \jdeq 
  \subst{\tmext{A}{P}{x}{u}}{\ctxwk{P}{\idtm{A}}}
  \\
& \jdeq 
  \subst{u}{{x}{\ctxwk{P}{\idtm{A}}}} 
  \\
& \jdeq 
  \subst{u}{\ctxwk{\subst{x}{P}}{\subst{x}{\idtm{A}}}}
  \\
& \jdeq 
  \subst{x}{\idtm{A}}
  \\
& \jdeq 
  x.
\end{align*}
To prove the third judgmental equality, note that
\begin{align*}
\cprojsnd{A}{P}{\tmext{A}{P}{x}{u}}
& \jdeq 
  \subst{\tmext{A}{P}{x}{u}}{\idtm{P}}
  \\
& \jdeq 
  \subst{u}{{x}{\idtm{P}}}
  \\
& \jdeq 
  \subst{u}{\idtm{\subst{x}{P}}}
  \\
& \jdeq 
  u.
  \qedhere
\end{align*}
\end{proof}

\begin{lem}
The following compatibility rules for two consecutive term extensions is valid:
\begin{align*}
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    \jterm{\Gamma}{\subst{\tmext{A}{P}{x}{u}}{Q}}{v}
    }
  { \jtermeq
      {\Gamma}
      {\ctxext{{A}{P}}{Q}}
      {\tmext{A}{{P}{Q}}{x}{{\subst{x}{P}}{\subst{x}{Q}}{u}{v}}}
      {\tmext{{A}{P}}{Q}{{A}{P}{x}{u}}{v}}
    }
  \\
& \inference
  { \jfam{{{\Gamma}{A}}{P}}{Q}
    }
  { \jhomeq
      {\Gamma}
      {\ctxext{{A}{P}}{Q}}
      {A}
      {\jcomp{}{\cprojfstf{{A}{P}}{Q}}{\cprojfstf{A}{P}}}
      {\cprojfstf{A}{{P}{Q}}}
    }
  \\
& \inference
  { \jfam{{{\Gamma}{A}}{P}}{Q}
    }
  { \jhomeq
      {{\Gamma}{A}}
      {{P}{Q}}
      {P}
      {\jcomp{}{\cprojfstf{{A}{P}}{Q}}{\cprojsndf{A}{P}}}
      {\jcomp{}{\cprojsndf{A}{{P}{Q}}}{\cprojfstf{P}{Q}}}
    }
  \\
& \inference
    { \jfam{{{\Gamma}{A}}{P}}{Q}
      }
    { \jhomeq
        {{{\Gamma}{A}}{P}}
        {Q}
        {Q}
        {\cprojsndf{{A}{P}}{Q}}
        {\jcomp{}{\cprojsndf{A}{{P}{Q}}}{\cprojsndf{P}{Q}}}
      }
\end{align*}
\end{lem}

\begin{proof}
Consider terms $\jterm{\Gamma}{A}{x}$, $\jterm{\Gamma}{\subst{x}{P}}{u}$ and
$\jterm{\Gamma}{\subst{u}{{x}{Q}}}{v}$. Then we have
\begin{align*}
\tmext{x}{{u}{v}}
& \jdeq 
  \subst
    {\tmext{u}{v}}{{x}{\idtm{\ctxext{A}{{P}{Q}}}}}
  \\
& \jdeq 
  \subst{v}{{u}{{x}{\idtm{\ctxext{A}{{P}{Q}}}}}}
  \\
& \jdeq 
  \subst{v}{{u}{{x}{\idtm{\ctxext{{A}{P}}{Q}}}}}
  \\
& \jdeq 
  \subst{v}{{\tmext{x}{u}}{\idtm{\ctxext{{A}{P}}{Q}}}}
  \\
& \jdeq 
  \tmext{{x}{u}}{v}.
\end{align*}
To prove the judmental equality
\begin{equation*}
\jhomeq
  {\Gamma}
  {\ctxext{{A}{P}}{Q}}
  {A}
  {\jcomp{}{\cprojfstf{{A}{P}}{Q}}{\cprojfstf{A}{P}}}
  {\cprojfstf{A}{{P}{Q}}}
\end{equation*}
note that we have the judgmental equalities
\begin{align*}
\jcomp{{{A}{P}}{Q}}{\cprojfstf{{A}{P}}{Q}}{\cprojfstf{A}{P}}
& \jdeq 
  \unfoldall{\jcomp{{{A}{P}}{Q}}{\cprojfstf{{A}{P}}{Q}}{\cprojfstf{A}{P}}}
  \\
& \jdeq 
  \subst
    {\ctxwk{Q}{\idtm{{A}{P}}}}
    {\ctxwk{Q}{{\ctxext{A}{P}}{{P}{\idtm{A}}}}}
  \\
& \jdeq
  \ctxwk{Q}{\subst{\idtm{{A}{P}}}{\ctxwk{\ctxext{A}{P}}{{P}{\idtm{A}}}}}
  \\
& \jdeq
  \ctxwk{Q}{{P}{\idtm{A}}}
  \\
& \jdeq
  \ctxwk{\ctxext{P}{Q}}{\idtm{A}}
  \\
& \jdeq
  \cprojfstf{A}{{P}{Q}}
\end{align*}
To prove the judgmental equality
\begin{equation*}
\jhomeq
  {{\Gamma}{A}}
  {{P}{Q}}
  {P}
  {\jcomp{}{\cprojfstf{{A}{P}}{Q}}{\cprojsndf{A}{P}}}
  {\jcomp{}{\cprojsndf{A}{{P}{Q}}}{\cprojfstf{P}{Q}}}
\end{equation*}
note that we have the judgmental equalities
\begin{align*}
\jcomp{{{A}{P}}{Q}}{\cprojfstf{{A}{P}}{Q}}{\cprojsndf{A}{P}}
& \jdeq 
  \unfoldall{\jcomp{{{A}{P}}{Q}}{\cprojfstf{{A}{P}}{Q}}{\cprojsndf{A}{P}}}
  \\
& \jdeq
  \subst{\ctxwk{Q}{\idtm{{A}{P}}}}{\ctxwk{Q}{{\ctxext{A}{P}}{\idtm{P}}}}
  \\
& \jdeq
  \ctxwk{Q}{\idtm{P}}
  \\
& \jdeq
  \unfoldall{\jcomp{{P}{Q}}{\cprojsndf{A}{{P}{Q}}}{\cprojfstf{P}{Q}}}
  \\
& \jdeq
  \jcomp{{P}{Q}}{\cprojsndf{A}{{P}{Q}}}{\cprojfstf{P}{Q}}
\end{align*}
\begin{comment}
%%%% This was a proof of an old version of the statement
Now consider a term $\jterm{\Gamma}{\ctxext{A}{{P}{Q}}}{w}$. Then we have
\begin{align*}
w 
& \jdeq 
  \tmext
    {A}
    {{P}{Q}}
    {\cprojfst{A}{\ctxext{P}{Q}}{w}}
    {\cprojsnd{A}{\ctxext{P}{Q}}{w}}
  \\
& \jdeq 
  \tmext
    {A}
    {{P}{Q}}
    {\cprojfst{A}{\ctxext{P}{Q}}{w}}
    { {P}
      {Q}
      {\cprojfst{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}
      {\cprojsnd{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}
      }
  \\
& \jdeq 
  \tmext
    {{A}{P}}
    {Q}
    { {} % need to provide base and family, but there's no unfold.
      {}
      {\cprojfst{A}{\ctxext{P}{Q}}{w}}
      {\cprojfst{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}
      }
    { \cprojsnd{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}
      }
\end{align*}
Thus we see that 
\begin{align*}
\cprojfst{\ctxext{A}{P}}{Q}{w} 
& \jdeq 
  \tmext
    {A}
    {P}
    {\cprojfst{A}{\ctxext{P}{Q}}{w}}
    {\cprojfst{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}
  \\ 
\cprojsnd{\ctxext{A}{P}}{Q}{w} 
& \jdeq 
  \cprojsnd{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}},
\end{align*}
proving the fourth judgmental equality, and therefore also that
\begin{align*}
\cprojfst{A}{P}{\cprojfst{\ctxext{A}{P}}{Q}{w}} 
& \jdeq 
  \cprojfst{A}{\ctxext{P}{Q}}{w}
  \\
\cprojsnd{A}{P}{\cprojfst{\ctxext{A}{P}}{Q}{w}} 
& \jdeq 
  \cprojfst{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}},
\end{align*}
proving the second and the third judgmental equalities.
\end{comment}
\end{proof}

\begin{lem}
When we weaken a term $\tmext{B}{Q}{y}{v}$ of $\ctxext{B}{Q}$ in context $\Gamma$ by
a family $A$, the term that we get is $\tmext{\ctxwk{A}{B}}{\ctxwk{A}{Q}}{\ctxwk{A}{y}}{\ctxwk{A}{v}}$. More
precisely, the following inference rules are valid:
\begin{align*}
& \inference
  { \jterm{{\Gamma}{B}}{Q}{g}
    \jterm{{\Gamma}{B}}{\subst{g}{R}}{t}
    }
  { \jtermeq
      {{{\Gamma}{A}}{\ctxwk{A}{B}}}
      {\ctxwk{A}{\ctxext{Q}{R}}}
      {\ctxwk{A}{\tmext{Q}{R}{g}{t}}}
      {\tmext{\ctxwk{A}{Q}}{\ctxwk{A}{R}}{\ctxwk{A}{g}}{\ctxwk{A}{t}}}
    }
  \\
& \inference
  { \jfam{{{\Gamma}{B}}{Q}}{R}
    }
  { \jhomeq
      {{{\Gamma}{A}}{\ctxwk{A}{B}}}
      {{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}
      {\ctxwk{A}{Q}}
      {\cprojfstf{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}
      {\ctxwk{A}{\cprojfstf{Q}{R}}}
    }
  \\
& \inference
  { \jfam{{{\Gamma}{B}}{Q}}{R}
    }
  { \jhomeq
      {{{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}}
      {\ctxwk{A}{R}}
      {\ctxwk{A}{R}}
      {\cprojsndf{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}
      {\ctxwk{A}{\cprojsndf{Q}{R}}}
    }
\end{align*}
\end{lem}

\begin{proof}
Consider $\jterm{{\Gamma}{B}}{Q}{g}$ and $\jterm{{\Gamma}{B}}{\subst{g}{R}}{t}$.
Then we have the judgmental equalities
\begin{align*}
\ctxwk{A}{\ctxext{Q}{R}{g}{t}}
& \jdeq 
  \ctxwk{A}{\subst{t}{{g}{\idtm{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{\ctxwk{A}{t}}{\ctxwk{A}{\subst{g}{\idtm{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{\ctxwk{A}{t}}{{\ctxwk{A}{g}}{\ctxwk{A}{\idtm{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{\ctxwk{A}{t}}{{\ctxwk{A}{g}}{\idtm{\ctxwk{A}{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{\ctxwk{A}{t}}{{\ctxwk{A}{g}}{\idtm{\ctxext{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}}}
  \\
& \jdeq 
  \tmext{\ctxwk{A}{Q}}{\ctxwk{A}{R}}{\ctxwk{A}{g}}{\ctxwk{A}{t}}
  \qedhere
\end{align*}
\end{proof}

\begin{lem}
When we substitute an extended term $\tmext{P}{Q}{f}{g}$ of $\ctxext{P}{Q}$ by a term
$x$ of $A$, the term that we get is $\tmext{\subst{x}{P}}{\subst{x}{Q}}{\subst{x}{f}}{\subst{x}{g}}$.
More precisely, the following inference rules are valid:
\begin{align*}
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{{{\Gamma}{A}}{P}}{Q}{g}
    \jterm{{{\Gamma}{A}}{P}}{\subst{g}{R}}{t}
    }
  { \jtermeq
      {{\Gamma}{\subst{x}{P}}}
      {\ctxext{\subst{x}{Q}}{\subst{x}{R}}}
      {\subst{x}{\tmext{Q}{R}{g}{t}}}
      {\tmext{\subst{x}{Q}}{\subst{x}{R}}{\subst{x}{g}}{\subst{x}{t}}}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jfam{{{\Gamma}{A}}{P}}{Q}
    }
  { \jhomeq
      {\Gamma}
      {{\subst{x}{P}}{\subst{x}{Q}}}
      {\subst{x}{P}}
      {\cprojfstf{\subst{x}{P}}{\subst{x}{Q}}}
      {\subst{x}{\cprojfstf{P}{Q}}}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jfam{{{\Gamma}{A}}{P}}{Q}
    }
  { \jhomeq
      {{\Gamma}{\subst{x}{P}}}
      {\subst{x}{Q}}
      {\subst{x}{Q}}
      {\cprojsndf{\subst{x}{P}}{\subst{x}{Q}}}
      {\subst{x}{\cprojsndf{P}{Q}}}
    }
\end{align*}
\end{lem}

\begin{proof}
Consider $\jterm{{\Gamma}{B}}{Q}{g}$ and $\jterm{{\Gamma}{B}}{\subst{g}{R}}{t}$.
Then we have the judgmental equalities
\begin{align*}
\subst{x}{\tmext{Q}{R}{g}{t}}
& \jdeq 
  \subst{x}{{t}{{g}{\idtm{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{{x}{t}}{{x}{{g}{\idtm{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{{x}{t}}{{{x}{g}}{{x}{\idtm{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{{x}{t}}{{{x}{g}}{\idtm{\subst{x}{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{{x}{t}}{{{x}{g}}{\idtm{\ctxext{\subst{x}{Q}}{\subst{x}{R}}}}}
  \\
& \jdeq 
  \tmext{\subst{x}{Q}}{\subst{x}{R}}{\subst{x}{g}}{\subst{x}{t}}.
  \qedhere
\end{align*}
\end{proof}

\subsubsection{More on morphisms}

For the following lemma, recall that the judgment $\jhom{\Gamma}{A}{{B}{Q}}{f}$
unfolds as
\begin{equation*}
\unfold{\jhom{\Gamma}{A}{{B}{Q}}{f}}
\end{equation*}
and that we have the judgmental equality 
$ \jfameq
    {{\Gamma}{A}}
    {\ctxwk{A}{\ctxext{B}{Q}}}
    {\ctxext{\ctxwk{A}{B}}{\ctxwk{A}{Q}}}.
  $
Therefore, each morphism into an extended family can itself be described as
an extended term. The following lemma explains how this goes.

\begin{lem}
Let $\jhom{\Gamma}{A}{{B}{Q}}{f}$ be a morphism from $A$ to $\ctxext{B}{Q}$
in a context $\Gamma$. Then we have
\begin{equation*}
\jhomeq
  {\Gamma}
  {A}
  {{B}{Q}}
  {f}
  {\tmext{\jcomp{}{f}{\cprojfstf{B}{Q}}}{\jcomp{}{f}{\cprojsndf{B}{Q}}}}.
\end{equation*}
Alternatively, when $\jhom{\Gamma}{A}{B}{f_0}$ and 
$\jterm{{\Gamma}{A}}{\jcomp{}{f_0}{Q}}{f_1}$ we obtain a morphism
$\jhom{\Gamma}{A}{{B}{Q}}{\tmext{f_0}{f_1}}$ with the property that
\begin{align*}
\jhomeq*{\Gamma}{A}{B}{\jcomp{}{\tmext{f_0}{f_1}}{\cprojfstf{B}{Q}}}{f_0}\\
\jtermeq*{{\Gamma}{A}}{\jcomp{}{f_0}{Q}}{\jcomp{}{\tmext{f_0}{f_1}}{\cprojsndf{B}{Q}}}{f_1}.
\end{align*}
\end{lem}

\begin{proof}
Let $\jhom{\Gamma}{A}{{B}{Q}}{f}$ be a morphism in context $\Gamma$. Then we
have the judgmental equalities
\begin{align*}
\cprojfst{\ctxwk{A}{B}}{\ctxwk{A}{Q}}{f}
& \jdeq
  \subst{f}{\ctxwk{A}{\cprojfstf{B}{Q}}}
  \\
& \jdeq
  \jcomp{}{f}{\cprojfstf{B}{Q}}
  \\
\cprojsnd{\ctxwk{A}{B}}{\ctxwk{A}{Q}}{f}
& \jdeq
  \subst{f}{\ctxwk{A}{\cprojsndf{B}{Q}}}
  \\
& \jdeq
  \jcomp{}{f}{\cprojsndf{B}{Q}}
\end{align*}
The alternative formulation of the statement is a direct corollary.
\end{proof}

We also have the following lemma about the compatibility of pairing and composition:

\begin{lem}
The following inference rule is valid
\begin{align*}
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    \jhom{\Gamma}{B}{C}{g}
    \jfam{{\Gamma}{C}}{R}
    \jterm{{\Gamma}{B}}{\subst{g}{\ctxwk{B}{R}}}{w}
    }
  { \jhomeq
      {\Gamma}
      {A}
      {{C}{R}}
      {\jcomp{A}{f}{\tmext{\ctxwk{B}{C}}{\ctxwk{B}{R}}{g}{w}}}
      {\tmext{\ctxwk{A}{C}}{\ctxwk{A}{R}}{\jcomp{A}{f}{g}}{\jcomp{A}{f}{w}}}
    }
\end{align*}
\end{lem}

\begin{proof}
Let $\jhom{\Gamma}{A}{B}{f}$, $\jhom{\Gamma}{B}{C}{g}$, $\jfam{{\Gamma}{C}}{R}$
and $\jterm{{\Gamma}{B}}{\subst{g}{\ctxwk{B}{R}}}{w}$. Then we have the
judgmental equalities
\begin{align*}
\jcomp{A}{f}{\tmext{\ctxwk{B}{C}}{\ctxwk{B}{R}}{g}{w}}
& \jdeq 
  \subst{f}{\ctxwk{A}{\tmext{\ctxwk{B}{C}}{\ctxwk{B}{R}}{g}{w}}}
  \\
& \jdeq 
  \subst
    {f}
    {\tmext{\ctxwk{A}{{B}{C}}}{\ctxwk{A}{{B}{R}}}{\ctxwk{A}{g}}{\ctxwk{A}{w}}}
  \\
& \jdeq 
  \tmext
    {\ctxwk{A}{C}}
    {\ctxwk{A}{R}}
    {\subst{f}{\ctxwk{A}{g}}}
    {\subst{f}{\ctxwk{A}{w}}}
  \\
& \jdeq 
  \tmext{\ctxwk{A}{C}}{\ctxwk{A}{R}}{\jcomp{A}{f}{g}}{\jcomp{A}{f}{w}}.
  \qedhere
\end{align*}
\end{proof}

\begin{defn}
Let $\jhom{\Gamma}{A}{B}{f}$ be a morphism from $A$ to $B$ in context $\Gamma$
and let $\jfhom{\Gamma}{A}{B}{f}{P}{Q}{F}$ be a morphism over $f$ in context 
$\Gamma$. We define
\begin{equation*}
\jhomdefn{\Gamma}{{A}{P}}{{B}{Q}}{\jvcomp{P}{f}{F}}{\unfold{\jvcomp{P}{f}{F}}}
\end{equation*}
\end{defn}

\subsubsection{Fiber inclusions}
We will use the insights of \autoref{extension-on-terms} to define and study
\emph{fiber inclusions}. The fiber inclusion of the \emph{fiber}
$\subst{x}{P}$ into the extension $\ctxext{A}{P}$ is a morphism
$\jhom{\Gamma}{\subst{x}{P}}{{A}{P}}{\finc{x}{P}}$, for any family
$\jfam{{\Gamma}{A}}{P}$ and any term $\jterm{\Gamma}{A}{x}$. Then we will determine
the ways in which it is compatible with the other operators. Note that in this
subsubsection we will focus on the compatibility properties; the fact that
the fiber inclusions also appear in a pullback diagram will be established in
\autoref{pullback}. 

\begin{defn}
Let $\jterm{\Gamma}{A}{x}$ be a term and let $\jfam{{\Gamma}{A}}{P}$ be a
family. Then we define
\begin{equation*}
\jhomdefn{\Gamma}{\subst{x}{P}}{{A}{P}}{\finc{x}{P}}{\unfoldnext{\finc{x}{P}}}
\end{equation*}
\end{defn}

\subsubsection{Pullback squares and family pullback squares}
\label{pullback}
Now that we have introduced the notions of morphisms, composition and identity
terms, we can develop a diagramatic style of of displaying type dependencies
combined with morphisms. We give an informal, metatheoretical definition of
such diagrams by indicating what the various components mean. The definition
is informal because we will only use such diagrams occasionally to provide a
graphical indication of the situation in which we're working. In particular,
we will not shy away from using natural numbers and trust that the reader can
figure out what we mean.

\begin{defn}
A diagram is said to be a \emph{dependency diagram in context $\Gamma$}
if it is built up according to the following steps:
\begin{itemize}
\item The arrows appearing in a dependency diagram are either ordinary, like the
arrow%
$\begin{tikzcd}[ampersand replacement = \&]
X \ar{r} \& Y,
\end{tikzcd}$
or double-headed, like
$\begin{tikzcd}[ampersand replacement = \&]
X \ar[fib]{r} \& Y.
\end{tikzcd}$
\item An ordinary arrow 
\begin{equation*}
\begin{tikzcd}
A \ar{r}{f} & B
\end{tikzcd}
\end{equation*}
between two families $A$ and $B$ of contexts over $\Gamma$ indicates that
$f$ is a morphism from $A$ to $B$ in context $\Gamma$, i.e.~that we have the
judgment $\jhom{\Gamma}{A}{B}{f}$.
\item The set of double-headed arrows must form a forest and the root of
each maximal tree of double-headed arrows is a family of contexts over $\Gamma$.
In particular, if an object is not the domain of a double-headed arrow it must
be a family of contexts over $\Gamma$.
\item A sequence of double-headed 
arrows
\begin{equation*}
\begin{tikzcd}
P_{n} \ar[fib]{r} & \cdots \ar[fib]{r} & P_1 \ar[fib]{r} & A
\end{tikzcd}
\end{equation*}
indicates that $P_1$ is a family of contexts over $\ctxext{\Gamma}{A}$, that
$P_2$ is a family of contexts over $\ctxext{{\Gamma}{A}}{P_1}$, etcetera.
\item There can be two kinds of ladders of double-headed arrows:
\begin{equation*}
\begin{tikzcd}
P_{n} \ar{r}{F_{n}} \ar[fib]{d} & Q_{n} \ar[fib]{d}\\
\vdots \ar[fib]{d} & \vdots \ar[fib]{d}\\
P_1 \ar{r}{F_1} \ar[fib]{d} & Q_1 \ar[fib]{d}\\
A \ar{r}{f} & B
\end{tikzcd}
\qquad
\begin{tikzcd}[column sep = tiny]
P_{n+m} \ar{rr}{F_{n+m}} \ar[fib]{d} & & Q_{n+m} \ar[fib]{d}\\
\vdots \ar[fib]{d} & & \vdots \ar[fib]{d}\\
P_{n+1} \ar{rr}{F_{n+1}} \ar[fib]{dr} & & Q_{n+1} \ar[fib]{dl}\\
& P_n \ar[fib]{d}\\
& \vdots \ar[fib]{d}\\
& P_1 \ar[fib]{d}\\
& A
\end{tikzcd}
\end{equation*}
The ladder on the left 
indicates that $F_1$ is a morphism from $P_1$ to $Q_1$ \emph{over} $f$,
i.e.~that the judgment $\jfhom{\Gamma}{A}{B}{f}{P_1}{Q_1}{F_1}$ holds, that
$F_2$ is a morphism from $P_2$ to $Q_2$ over
the morphism $\tmext{\ctxwk{P_1}{f}}{F_1}$ from $\ctxext{A}{P_1}$ to
$\ctxext{B}{Q_1}$, etcetera.

The ladder on the right indicates that $F_{n+1}$ is a morphism from $P_{n+1}$ to
$Q_{n+1}$ in the appropriate context, that $F_{n+2}$ is a morphism from
$P_{n+2}$ to $Q_{n+2}$ over $F_{n+1}$, etcetera.
 
Note that the object(s) at the bottom of a ladder are always families of contexts
over $\Gamma$, so that the typing of the various ingredients makes sense.
\end{itemize}
Such a diagram is said to be commutative if the subdiagram consisting of only
the normal headed arrows is commutative in the usual sense (using judgmental
equality). Note that the ladders are inherently commutative.
\end{defn}

The most basic illustrative example of a commutative dependency diagram is
the diagram
\begin{equation*}
\begin{tikzcd}
P \ar[fib]{d} \ar{r}{F} & Q \ar[fib]{d} \\
A \ar{r}{f} & B
\end{tikzcd}
\end{equation*}
indicating a morphism $F$ from $P$ to $Q$ over the morphism $f$ from $A$ to
$B$ in a context $\Gamma$.

We can just copy the usual categorical definition of a pullback square to our
current situation, but we have to require that each arrow in the pullback square
is an ordinary arrow. When families (i.e. double-headed arrows) are involved
in the diagram, we make the following definition of a family pullback:

\begin{defn}
We say that a commutative dependency diagram of the form
\begin{equation*}
\begin{tikzcd}
P \ar[fib]{d} \ar{r}{F} & Q \ar[fib]{d} \\
A \ar{r}{f} & B
\end{tikzcd}
\end{equation*}
is a \emph{family pullback} if the following inference rules are valid:
\begin{align*}
& \inference
  { \jfam{{\Gamma}{A}}{P'}
    \jfhom{\Gamma}{A}{B}{f}{P'}{Q}{F'}
    }
  { \jhom{{\Gamma}{A}}{P'}{P}{u}
    }
  \\
& \inference
  { \jfam{{\Gamma}{A}}{P'}
    \jfhom{\Gamma}{A}{B}{f}{P'}{Q}{F'}
    }
  { \jfhomeq{\Gamma}{A}{B}{f}{P'}{Q}{\jcomp{}{u}{F}}{F'}
    }
  \\
& \inference
  { \jhom{{\Gamma}{A}}{P'}{P}{v}
    \jfhomeq{\Gamma}{A}{B}{f}{P'}{Q}{\jcomp{}{v}{F}}{F'}
    }
  { \jhomeq{{\Gamma}{A}}{P'}{P}{v}{u}
    }
\end{align*}
\end{defn}

The following lemma explains that when a square involving families is a
family pullback square whenever the corresponding square involving projections is a
pullback square. There is no proof in the the opposite direction.

\begin{lem}
A square
\begin{equation}\label{eq:fpb_to_pb_eqv_fpb}
\begin{tikzcd}
P \ar[fib]{d} \ar{r}{F} & Q \ar[fib]{d} \\
A \ar{r}{f} & B
\end{tikzcd}
\end{equation}
is a family pullback square whenever the square
\begin{equation}\label{eq:fpb_to_pb_eqv_pb}
\begin{tikzcd}[column sep = large]
\ctxext{A}{P} \ar{d}[swap]{\cprojfstf{A}{P}} \ar{r}{\tmext{\ctxwk{P}{f}}{F}} & \ctxext{B}{Q} \ar{d}{\cprojfstf{B}{Q}} \\
A \ar{r}{f} & B
\end{tikzcd}
\end{equation}
is a pullback square.
\end{lem}

The family pullback of a family along any morphism always exists. It is simply given
by the precomposition of the family with the morphism. Note that this fact does
not carry over to arbitrary pullbacks.

\begin{lem}
The diagram
\begin{equation*}
\begin{tikzcd}
\jcomp{}{f}{Q} \ar[fib]{d} \ar{r}{\idtm{\jcomp{}{f}{Q}}} & Q \ar[fib]{d} \\
A \ar{r}{f} & B
\end{tikzcd}
\end{equation*}
is a family pullback diagram.
\end{lem}

\begin{proof}
The proof is a triviality because $\jhom{{\Gamma}{A}}{P'}{\jcomp{}{f}{Q}}{F'}$
is the same judgment as $\jfhom{\Gamma}{A}{B}{f}{P'}{Q}{F'}$ and
$\jcomp{}{\idtm{\jcomp{}{f}{Q}}}{F'}\jdeq F'$.
\end{proof}

For arbitrary pullbacks we have the pasting lemma as usual, but for family
pullbacks we can only derive one of the parts of the pasting lemma.

\begin{lem}
Suppose we have the diagram
\begin{equation*}
\begin{tikzcd}
P \ar{r}{F} \ar[fib]{d} & Q \ar{r}{G} \ar[fib]{d} & R \ar[fib]{d}\\
A \ar{r}{f} & B \ar{r}{g} & C
\end{tikzcd}
\end{equation*}
where the square on the right and the outer rectangle are family pullback 
diagrams. Then the square on the left is a family pullback diagram.
\end{lem}

\begin{proof}
Let $\jfam{{\Gamma}{A}}{P'}$ be a family and let $\jfhom{\Gamma}{A}{B}{f}
{P'}{Q}{F}$ be a morphism over $f$.
\begin{itemize}
\item Then we compose $F'$ with $G$ to obtain a morphism over $\jcomp{}{f}{g}$.
\item Then we get $\jhom{{\Gamma}{A}}{P'}{P}{u}$ with a uniqueness property.
      The property that $\jcomp{}{u}{F}\jdeq F'$ follows from the assumption
      that the right square is a pullback.
\item Now assume that we have another such $v$. Compose it with $F$ and $G$.
      By the assumed properties this is the same as $u$ composed with $F$ and
      $G$. By the pullback condition we now get $u\jdeq v$. 
\end{itemize}
\end{proof}

\begin{lem}
For any $\jterm{\Gamma}{A}{x}$ and any $\jfam{{\Gamma}{A}}{P}$, the square
\begin{equation*}
\begin{tikzcd}
\subst{x}{P} \ar{d} \ar{r}{\finc{x}{P}} & \ctxext{A}{P} \ar{d}{\cprojfstf{A}{P}}\\
\emptyf \ar{r}{\ctxwk{\emptyf}{x}} & A
\end{tikzcd}
\end{equation*}
is a pullback square.
\end{lem}

In the following lemma we assert that pulling back a family $Q$ 
over $\ctxext{{\Gamma}{A}}{P}$ along a fiber
inclusion $\finc{x}{P}$ gives the family $\subst{x}{Q}$ over $\ctxext{\Gamma}{\subst{x}{P}}$. 

\begin{lem}
We have the following inference rule:
\begin{equation*}
\inference
  { \jfam{{{\Gamma}{A}}{P}}{Q}
    \jterm{\Gamma}{A}{x}
    }
  { \jfameq
      {{\Gamma}{\subst{x}{P}}}
      {\jcomp{}{\finc{x}{P}}{Q}}
      {\subst{x}{Q}}
    }
\end{equation*}
\end{lem}

\begin{proof}
We have the judgmental equalities:
\begin{align*}
\jcomp{\subst{x}{P}}{\finc{x}{P}}{Q}
& \jdeq
  \subst{\tmext{\ctxwk{\subst{x}{P}}{x}}{\idtm{\subst{x}{P}}}}{\ctxwk{\subst{x}{P}}{Q}}
  \\
& \jdeq
  \subst{\idtm{\subst{x}{P}}}{{\ctxwk{\subst{x}{P}}{x}}{\ctxwk{\subst{x}{P}}{Q}}}
  \\
& \jdeq
  \subst{\idtm{\subst{x}{P}}}{\ctxwk{\subst{x}{P}}{\subst{x}{Q}}}
  \\
& \jdeq
  \subst{x}{Q}.
\end{align*}
\end{proof}

\subsubsection{Another special case of projections}
In this subsubsection we investigate the special case of a projection which
appears as a morphism from $\ctxext{{A}{P}}{\ctxwk{P}{Q}}$ to $\ctxext{A}{Q}$
in context $\Gamma$, where we assume to have the families 
$\jfam{{\Gamma}{A}}{P}$ and $\jfam{{\Gamma}{A}}{Q}$. 

Note that we have the judgmental
equalities
\begin{align*}
\ctxwk{\ctxext{{A}{P}}{\ctxwk{P}{\mfam{A}}}}{\ctxext{A}{\mfam{A}}}
& \jdeq 
  \ctxext
    {\ctxwk{\ctxext{{A}{P}}{\ctxwk{P}{\mfam{A}}}}{A}}
    {\ctxwk{\ctxext{{A}{P}}{\ctxwk{P}{\mfam{A}}}}{\mfam{A}}}
  \\
& \jdeq
  \ctxext
    {\ctxwk{{P}{\mfam{A}}}{{\ctxext{A}{P}}{A}}}
    {\ctxwk{\ctxext{{A}{P}}{\ctxwk{P}{\mfam{A}}}}{\mfam{A}}}
\end{align*}
Note that we have the term $\ctxwk{{P}{\mfam{A}}}{\cprojfstf{A}{P}}$ of the
family $\ctxwk{{P}{\mfam{A}}}{{\ctxext{A}{P}}{A}}$. Therefore, we need to
find a term of type $\subst{\ctxwk{{P}{\mfam{A}}}{\cprojfstf{A}{P}}}
{\ctxwk{\ctxext{{A}{P}}{\ctxwk{P}{\mfam{A}}}}{\mfam{A}}}$. Note that we have
the judgmental equalities:
\begin{align*}
\subst
  {\ctxwk{{P}{\mfam{A}}}{\cprojfstf{A}{P}}}
  {\ctxwk{\ctxext{{A}{P}}{\ctxwk{P}{\mfam{A}}}}{\mfam{A}}}
& \jdeq
  \subst
    {\ctxwk{{P}{\mfam{A}}}{\cprojfstf{A}{P}}}
    {\ctxwk{{P}{\mfam{A}}}{{\ctxext{A}{P}}{\mfam{A}}}}
  \\
& \jdeq
  \ctxwk
    { {P}{\mfam{A}}
      }
    { \subst
        {\cprojfstf{A}{P}}
        {\ctxwk{\ctxext{A}{P}}{\mfam{A}}}
      }
  \\
& \jdeq
  \ctxwk
    { {P}{\mfam{A}}
      }
    { {P}{\mfam{A}}
      }
  \\
& \jdeq
  \ctxwk{P}{{\mfam{A}}{\mfam{A}}}
\end{align*}
We find the term $\ctxwk{P}{\idtm{\mfam{A}}}$ here. Thus we can now define
$\bar{\typefont{pr}}$ by:
\begin{equation}\label{barproj}
\jhomdefn
  {\Gamma}
  {{{A}{P}}{\mfam{A}}}
  {{A}{\mfam{A}}}
  {\bar{\typefont{pr}}}
  {\tmext{\ctxwk{{P}{\mfam{A}}}{\cprojfstf{A}{P}}}{\ctxwk{P}{\idtm{\mfam{A}}}}}
\end{equation}

\begin{lem}
We have the judgmental equality
\begin{equation*}
\jfameq
  {{{{\Gamma}{A}}{P}}{\ctxwk{P}{\mfam{A}}}}
  {\jcomp{}{\bar{\typefont{pr}}}{Q}}
  {\ctxwk{P}{Q}}
\end{equation*}
for any family $Q$ of contexts over $\ctxext{{\Gamma}{A}}{\mfam{A}}$ 
\end{lem}

\subsubsection{Inductive morphisms}
\begin{defn}
Let $\jhom{\Gamma}{A}{B}{f}$ be a context morphism. We say that $f$ is an 
\emph{inductive morphism} if the following inference rules are valid:
\begin{align*}
& \inference
  { \jfam{{\Gamma}{B}}{Q}
    \jterm{{\Gamma}{A}}{\jcomp{A}{f}{Q}}{g}
    }
  { \jterm{{\Gamma}{B}}{Q}{\jtcext{g}}
    }
& & \inference
  { \jfam{{\Gamma}{B}}{Q}
    \jterm{{\Gamma}{A}}{\jcomp{A}{f}{Q}}{g}
    }
  { \jtermeq{{\Gamma}{A}}{\jcomp{A}{f}{Q}}{\jcomp{A}{f}{\jtcext{g}}}{g}
    }
\end{align*}
\end{defn}

When $f$ is a context morphism from $A$ to $B$ in context $\Gamma$, 
finding a term of a family $Q$ over $\ctxext{\Gamma}{B}$ can be accomplished
by finding a term of the family $\jcomp{A}{f}{Q}$ over $\ctxext{\Gamma}{A}$.
Inductive morphisms come with a computation rule. Thus, term
constructors of inductively defined types are going to be the major source of
examples of inductive morphisms. Since identity terms behave
so nicely, they are inductive morphisms too.

\begin{lem}
The identity term
$\jhom{\Gamma}{A}{A}{\idtm{A}}$ is an inductive morphism
for each family $A$ of contexts over $\Gamma$
\end{lem}

\begin{itemize}
\item Extensions of inductive morphisms are inductive
\item Weakenings of inductive morphisms are inductive
\item Substitutions of inductive morphisms are inductive
\end{itemize}

