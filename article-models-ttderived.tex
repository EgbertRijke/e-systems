\section{Derived notions of the theory of contexts, families and terms}
\label{digging_deeper}

In this section we use the framework we have developed in \autoref{tt}
to derive new notions and their properties. In particular, we will
develop the notion of \emph{extension on terms} together with the projection
maps from an extension to the `base' context of family, the 
\emph{family pullback} which is a version of pullbacks for families and thirdly
the \emph{inductive morphisms} which are morphisms of type theory that allow
to find terms of families over the codomain context by pulling them back to
the domain context and finding a term there.
\emph{This section contains no new assumptions.}

In \autoref{extension-on-terms} on the extension operation on terms we will
derive all the compatibility rules that one would expect to hold for extension
on terms. The key to most of these results is the currying operation, which
could be seen as the missing feature in the table above. The extension on terms
operation depends in an essential way on the substitution operation, on the
identity terms and therefore indirectly also on the weakening operation. Thus,
we will see here all of the features of the theory we develop in
\autoref{tt} come to the 
surface.

Next, we introduce the inclusion of the fibers $\subst{x}{P}$ into the extension
$\ctxext{A}{P}$ as a morphism in context $\Gamma$. As was the case with
extension on terms and with projections, there will be a ton of compatibility
properties which we will prove about these inclusions. 

It should be kept in mind though that in the current formulation there is no
sealed deal establishing a relationship between families over a context
and any kind of morphisms -- neither with morphisms having the `base' of the
family as its codomain nor with families into a universe (universes will be
introduced in \autoref{universes}). The only thing we know here is
that a family $P$ over $\ctxext{\Gamma}{A}$ determines a context morphism
from $\ctxext{A}{P}$ to $A$ in context $\Gamma$, the projection. 
We do not see this as
a shortcoming of the theory of contexts families and terms. Rather, such a
correspondence is a feature of a theory which does incorporate universes. The
fact that we're lacking a clear connection between families and (a specified
class of) morphisms, however, does show up in our treatment of the notion we
called familie pullbacks. For instance, we can't show that a square of families
is a pullback precisely when the corresponding square of projections is a
pullback: only the backwards direction holds. 
The discrepancies continue: ordinary pullbacks do not always exist
whereas family pullbacks do but the composition of two family pullback squares
need not be a family pullback square again whereas the pasting lemma of
ordinary pullbacks holds as usually.
We feel that pointing out what we can and can't do in the current setting is
an important aspect of developing an intuition with the system and therefore
we include this subsection even though the theory of family pullbacks
might feel a bit different than the usual theory of pullbacks.

In the last subsection we give a treatment of inductive morphisms. These
morphisms appear also in the introduction of the many inductive type
constructors in \autoref{tt_constructors} and therefore a general treatment of
the subject is insightful.

\subsection{Morphisms}\label{categorical_properties}
Using the rules of the compatibility of substitution with weakening and of the
compatibility of weakening with itself, we see that we can show

\begin{lem}
The inference rule\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    \jfam{\Gamma}{B}
    \jfam{\Gamma}{C}
    \jhom{\Gamma}{A}{B}{f}
    }
  { \jfameq
    {{\Gamma}{A}}
    {\subst{f}{\ctxwk{A}{{B}{C}}}}
    {\ctxwk{A}{C}}
    }
\end{equation*}
is valid.
\end{lem}

\begin{proof}
Let $\jfam{\Gamma}{A}$, $\jfam{\Gamma}{B}$, $\jfam{\Gamma}{C}$ and $\jhom{\Gamma}{A}{B}{f}$.
Then we have the judgmental equalities\begin{align*}
\subst{f}{\ctxwk{A}{{B}{C}}}
& \jdeq 
  \subst{f}{\ctxwk{{A}{B}}{{A}{C}}}
  \\
& \jdeq 
  \ctxwk{A}{C}.
  \qedhere
\end{align*}
\end{proof}

It follows that for $\jterm{{\Gamma}{B}}{\ctxwk{B}{C}}{g}$ we can compose $f$
with $g$ to obtain a term of $\ctxwk{A}{C}$ in context $\ctxext{\Gamma}{A}$.
In the following definition, we work with in a slightly greater generality.

\begin{defn}
We define the judgment\begin{equation*}
\jhom{\Gamma}{A}{B}{f},
\end{equation*}
which is pronounced as `$f$ is a morphism from $A$ to $B$ in context $\Gamma$',
to be the judgment\begin{equation*}
\unfold{\jhom{\Gamma}{A}{B}{f}}.
\end{equation*}
Likewise, we define the judgment\begin{equation*}
\jhomeq{\Gamma}{A}{B}{f}{f'}
\end{equation*}
to be the judgment\begin{equation*}
\unfold{\jhomeq{\Gamma}{A}{B}{f}{f'}}.
\end{equation*}
\end{defn}

\begin{defn}
Let $\jhom{\Gamma}{A}{B}{f}$ and consider a term $\jterm{{\Gamma}{B}}{Q}{g}$.
We define\begin{align*}
\jfamdefn*
  {{\Gamma}{A}}
  {\jcomp{A}{f}{Q}}
  {\unfold{\jcomp{A}{f}{Q}}}\\
\jtermdefn*
  {{\Gamma}{A}}
  {\jcomp{A}{f}{Q}}
  {\jcomp{A}{f}{g}}
  {\unfold{\jcomp{A}{f}{g}}}.
\end{align*}
Likewise, when we have a family $\jfam{{{\Gamma}{B}}{Q}}{R}$ and a term
$\jterm{{{\Gamma}{B}}{Q}}{R}{h}$, we define\begin{align*}
\jfamdefn*
  {{{\Gamma}{A}}{\jcomp{A}{f}{Q}}}
  {\jcomp{A}{f}{R}}
  {\unfold{\jcomp{A}{f}{R}}}
  \\
\jtermdefn*
  {{{\Gamma}{A}}{\jcomp{A}{f}{Q}}}
  {\jcomp{A}{f}{R}}
  {\jcomp{A}{f}{h}}
  {\unfold{\jcomp{A}{f}{h}}}.
\end{align*}
\end{defn}

We have lots of compatibility properties for composition:

\begin{lem}
We have the following inference rules about the situation where something is
substituted by a composition:\begin{align*}
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    \jhom{\Gamma}{B}{C}{g}
    \jfam{{{\Gamma}{A}}{\ctxwk{A}{C}}}{R}
    }
  { \jfameq
      {{\Gamma}{A}}
      {\subst{\jcomp{A}{f}{g}}{R}}
      {\subst{f}{{\ctxwk{A}{g}}{\ctxwk{{A}{B}}{R}}}}
    }
  \\
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    \jhom{\Gamma}{B}{C}{g}
    \jterm{{{\Gamma}{A}}{\ctxwk{A}{C}}}{R}{h}
    }
  { \jfameq
    {{\Gamma}{A}}
    {\subst{\jcomp{A}{f}{g}}{h}}
    {\subst{f}{{\ctxwk{A}{g}}{\ctxwk{{A}{B}}{h}}}}
    }
\end{align*}
We also have the following related inference rules, asserting that composition
is strictly associative:\begin{align*}
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    \jhom{\Gamma}{B}{C}{g}
    \jfam{{\Gamma}{C}}{R}
    }
  { \jfameq
      {{\Gamma}{A}}
      {\jcomp{A}{{A}{f}{g}}{R}}
      {\jcomp{A}{f}{{B}{g}{R}}}
    }
  \\
& \inference
    { \jhom{\Gamma}{A}{B}{f}
      \jhom{\Gamma}{B}{C}{g}
      \jterm{{\Gamma}{C}}{R}{h}
      }
    { \jtermeq
        {{\Gamma}{A}}
        {\jcomp{A}{{A}{f}{g}}{R}}
        {\jcomp{A}{{A}{f}{g}}{h}}
        {\jcomp{A}{f}{{B}{g}{h}}}
      }
\end{align*}
\end{lem}

\begin{proof}
Consider family morphisms $\jhom{\Gamma}{A}{B}{f}$ and $\jhom{\Gamma}{B}{C}{g}$
and a family $\jfam{{{\Gamma}{A}}{\ctxwk{A}{C}}}{R}$. Then we have the judgmental
equalities\begin{align*}
\subst{\jcomp{A}{f}{g}}{R} 
& \jdeq 
  \subst{{f}{\ctxwk{A}{g}}}{R}
  \\
& \jdeq 
  \subst{{f}{\ctxwk{A}{g}}}{\subst{f}{\ctxwk{{A}{B}}{R}}}
  \\
& \jdeq 
  \subst{f}{{\ctxwk{A}{g}}{\ctxwk{{A}{B}}{R}}}
\end{align*}
The proof that 
$\subst{\jcomp{A}{f}{g}}{h}\jdeq\subst{f}{{\ctxwk{A}{g}}{\ctxwk{{A}{B}}{h}}}$
is similar.

Now suppose that $\jfam{{\Gamma}{C}}{R}$ instead. Then we have\begin{align*}
\jcomp{A}{{A}{f}{g}}{R} 
& \jdeq 
  \subst{\jcomp{A}{f}{g}}{\ctxwk{A}{R}}
  \\
& \jdeq 
  \subst{{f}{\ctxwk{A}{g}}}{\ctxwk{A}{R}}
  \\
& \jdeq 
  \subst{f}{{\ctxwk{A}{g}}{\ctxwk{{A}{B}}{{A}{R}}}}
  \\
& \jdeq 
  \subst{f}{{\ctxwk{A}{g}}{\ctxwk{A}{{B}{R}}}}
  \\
& \jdeq 
  \subst{f}{\ctxwk{A}{\subst{g}{\ctxwk{B}{R}}}}
  \\
& \jdeq 
  \subst{f}{\ctxwk{A}{\jcomp{B}{g}{R}}}
  \\
& \jdeq 
  \jcomp{A}{f}{{B}{g}{R}}.
\end{align*}
Again, the proof is similar for terms $h$ of $R$ in context $\ctxext{\Gamma}{C}$.
\end{proof}

\begin{lem}
We have the following inference rules about the compatibility of composition with
weakening:\begin{align*}
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    \jhom{\Gamma}{B}{C}{g}
    \jfam{{\Gamma}{A}}{P}
    }
  { \jhomeq
      {\Gamma}
      {{A}{P}}
      {C}
      {\ctxwk{P}{\jcomp{A}{f}{g}}}
      {\jcomp{{A}{P}}{\ctxwk{P}{f}}{g}}
    }
  \\
& \inference
  { \jterm{\Gamma}{B}{y}
    \jhom{\Gamma}{B}{C}{g}
    }
  { \jhomeq
      {\Gamma}
      {A}
      {C}
      {\jcomp{A}{\ctxwk{A}{y}}{g}}
      {\ctxwk{A}{\subst{y}{g}}}
    }
  \\
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    \jterm{\Gamma}{C}{z}
    }
  { \jhomeq
      {\Gamma}
      {A}
      {C}
      {\jcomp{A}{f}{\ctxwk{B}{z}}}
      {\ctxwk{A}{z}}
    }
\end{align*}
\end{lem}

\begin{proof}
Let $\jhom{\Gamma}{A}{B}{f}$, $\jhom{\Gamma}{B}{C}{g}$ and $\jfam{{\Gamma}{A}}{P}$.
Then we have the judgmental equalities\begin{align*}
\ctxwk{P}{\jcomp{A}{f}{g}} 
& \jdeq 
  \ctxwk{P}{\subst{f}{\ctxwk{A}{g}}}
  \\
& \jdeq 
  \subst{\ctxwk{P}{f}}{\ctxwk{P}{{A}{g}}}
  \\
& \jdeq 
  \subst{\ctxwk{P}{f}}{\ctxwk{\ctxext{A}{P}}{g}}
  \\
& \jdeq 
  \jcomp{{A}{P}}{\ctxwk{P}{f}}{g}.
\end{align*}
Now let $\jterm{\Gamma}{B}{y}$ and $\jhom{\Gamma}{B}{C}{g}$. Then we have the
judgmental equalities\begin{align*}
\jcomp{A}{\ctxwk{A}{y}}{g}
& \jdeq 
  \subst{\ctxwk{A}{y}}{\ctxwk{A}{g}}
  \\
& \jdeq 
  \ctxwk{A}{\subst{y}{g}}.
\end{align*}
For the third assertion, let $\jhom{\Gamma}{A}{B}{f}$ and $\jterm{\Gamma}{C}{z}$.
Then we have the judgmental equalities\begin{align*}
\jcomp{A}{f}{\ctxwk{B}{z}} 
& \jdeq 
  \subst{f}{\ctxwk{A}{{B}{z}}}
  \\
& \jdeq 
  \subst{f}{\ctxwk{{A}{B}}{{A}{z}}}
  \\
& \jdeq 
  \ctxwk{A}{z}.
  \qedhere
\end{align*}
\end{proof}

\begin{lem}
We have the following inference rules about the compatibility of composition with
substitution:\begin{align*}
& \inference
  { \jhom{{\Gamma}{A}}{P}{Q}{f}
    \jhom{{\Gamma}{A}}{Q}{R}{g}
    \jterm{\Gamma}{A}{x}
    }
  { \jhomeq
      {\Gamma}
      {\subst{x}{P}}
      {\subst{x}{R}}
      {\subst{x}{\jcomp{P}{f}{g}}}
      {\jcomp{\subst{x}{P}}{\subst{x}{f}}{\subst{x}{g}}}
    }
  \\
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    \jhom{\Gamma}{B}{C}{g}
    \jterm{\Gamma}{A}{x}
    }
  { \jtermeq
      {\Gamma}
      {C}
      {\subst{x}{\jcomp{A}{f}{g}}}
      {\subst{{x}{f}}{g}}
    }
\end{align*}
\end{lem}

\begin{proof}
Let $\jhom{{\Gamma}{A}}{P}{Q}{f}$, $\jhom{{\Gamma}{A}}{Q}{R}{g}$ and 
$\jterm{\Gamma}{A}{x}$.
Then we have the judgmental equalities\begin{align*}
\subst{x}{\jcomp{A}{f}{g}}
& \jdeq 
  \subst{x}{{f}{\ctxwk{P}{g}}}
  \\
& \jdeq 
  \subst{{x}{f}}{{x}{\ctxwk{P}{g}}}
  \\
& \jdeq 
  \subst{{x}{f}}{\ctxwk{\subst{x}{P}}{\subst{x}{g}}}
  \\
& \jdeq 
  \jcomp{\subst{x}{P}}{\subst{x}{f}}{\subst{x}{g}}.
\end{align*}
Now let $\jhom{\Gamma}{A}{B}{f}$, $\jhom{\Gamma}{B}{C}{g}$ and $\jterm{\Gamma}{A}{x}$.
Then we have the judgmental equalities\begin{align*}
\subst{x}{\jcomp{A}{f}{g}}
& \jdeq 
  \subst{x}{{f}{\ctxwk{A}{g}}}
  \\
& \jdeq 
  \subst{{x}{f}}{{x}{\ctxwk{A}{g}}}
  \\
& \jdeq 
  \subst{{x}{f}}{g}.
  \qedhere
\end{align*}
\end{proof}

There is also a notion of morphism \emph{over} a morphism. We will develop this
notion because it will be needed in the theory of models later on.

\begin{defn}
Let $\jhom{\Gamma}{A}{B}{f}$ be a morphism from $A$ to $B$ in context $\Gamma$
and consider $\jfam{{\Gamma}{A}}{P}$ and $\jfam{{\Gamma}{B}}{Q}$. We define the
judgment\begin{equation*}
\jfhom{\Gamma}{A}{B}{f}{P}{Q}{F},
\end{equation*}
which is pronounced as `$F$ is a morphism from $P$ to $Q$ over $f$ in context
$\Gamma$', to be the judgment\begin{equation*}
\unfold{\jfhom{\Gamma}{A}{B}{f}{P}{Q}{F}}.
\end{equation*}
\end{defn}

\begin{rmk}
The judgment $\jfhom{\Gamma}{A}{B}{f}{P}{Q}{F}$ means the same thing as\begin{equation*}
\jhom{{\Gamma}{A}}{P}{\jcomp{A}{f}{Q}}{F}.
\end{equation*}
\end{rmk}

Suppose we have morphisms $\jhom{\Gamma}{A}{B}{f}$ and $\jhom{\Gamma}{B}{C}{g}$
and that we have the morphisms $\jfhom{\Gamma}{A}{B}{f}{P}{Q}{F}$ and
$\jfhom{\Gamma}{B}{C}{g}{Q}{R}{G}$ over them. Then we have\begin{equation*}
\jhom
  {{\Gamma}{A}}
  {\jcomp{A}{f}{Q}}
  {\jcomp{A}{f}{{B}{g}{R}}}
  {\unfold{\jcomp{A}{f}{G}}}
\end{equation*}
Because we also have $\jhom{{\Gamma}{A}}{P}{\jcomp{A}{f}{Q}}{F}$, we have the
composition\begin{equation*}
\jhom
  {{\Gamma}{A}}
  {P}
  {\jcomp{A}{f}{{B}{g}{R}}}
  {\jcomp{P}{F}{\unfold{\jcomp{A}{f}{G}}}}.
\end{equation*}
Because of 
the judgmental equality $\jcomp{A}{f}{{B}{g}{R}}\jdeq
\jcomp{A}{{A}{f}{g}}{R}$, it follows that 
$\jcomp{P}{F}{\unfold{\jcomp{A}{f}{G}}}$ is a morphism from $P$ to $R$ over
$\jcomp{A}{f}{g}$. We make the following definition:

\begin{defn}
Let $\jhom{\Gamma}{A}{B}{f}$ and $\jhom{\Gamma}{B}{C}{g}$
be morphisms and let $\jfhom{\Gamma}{A}{B}{f}{P}{Q}{F}$ and
$\jfhom{\Gamma}{B}{C}{g}{Q}{R}{G}$ be morphisms over them. Then we define\begin{equation*}
\jfhomdefn
  {\Gamma}
  {A}
  {C}
  {\jcomp{A}{f}{g}}
  {P}
  {R}
  {\jfcomp{A}{f}{P}{F}{G}}
  {\unfold{\jfcomp{A}{f}{P}{F}{G}}}.
\end{equation*}
\end{defn}

This composition is also judgmentally associative.

Now let $\jfam{{\Gamma}{A}}{P}$ and $\jfam{{\Gamma}{A}}{Q}$ be families. A
morphism from $P$ to $Q$ over the identity term $\idtm{A}$ in context
$\Gamma$ is the same thing as a morphism from $P$ to $Q$ in context
$\ctxext{\Gamma}{A}$:

\begin{lem}\label{hom-over-id-is-hom}
We have the following valid inference rules:\begin{align*}
& \inference
  { \jfam{{\Gamma}{A}}{P}
    \jfam{{\Gamma}{A}}{Q}
    \jfhom{\Gamma}{A}{A}{\idtm{A}}{P}{Q}{f}
    }
  { \jhom{{\Gamma}{A}}{P}{Q}{f}
    }
  \\
& \inference
  { \jfam{{\Gamma}{A}}{P}
    \jfam{{\Gamma}{A}}{Q}
    \jhom{{\Gamma}{A}}{P}{Q}{f}
    }
  { \jfhom{\Gamma}{A}{A}{\idtm{A}}{P}{Q}{f}
    }
\end{align*}
\end{lem}

\begin{proof}
If we unfold the judgments $\jhom{{\Gamma}{A}}{P}{Q}{f}$ and
$\jfhom{\Gamma}{A}{A}{\idtm{A}}{P}{Q}{f}$, we get the judgments\begin{align*}
& \unfold{\jhom{{\Gamma}{A}}{P}{Q}{f}}
  \\
& \unfold{\jfhom{\Gamma}{A}{A}{\idtm{A}}{P}{Q}{f}}
\end{align*}
respectively. Therefore, we only need to verify that
$\ctxwk{P}{\subst{\idtm{A}}{\ctxwk{A}{Q}}}\jdeq\ctxwk{P}{Q}$, which is indeed
the case by \autoref{idfunc-wk-defn}.
\end{proof}

\subsection{Projections and extension on terms}\label{extension-on-terms}
In this subsection we consider the notion of extension on terms, which has now
become definable inside our theory. Moreover, every compatibility rule one may
dream of is provable as well, using the compatibility rules we have introduced
earlier.

\begin{defn}
When $\jterm{\Gamma}{A}{x}$ and $\jterm{\Gamma}{\subst{x}{P}}{u}$ are terms,
we define 
\begin{equation*}
\jtermdefn
  {\Gamma}
  {\ctxext{A}{P}}
  {\tmext{A}{P}{x}{u}}
  {\unfold{\tmext{A}{P}{x}{u}}}.
\end{equation*} 
\end{defn}

Thus, the term $\tmext{A}{P}{x}{u}$ is the pairing of $x$ and $u$. Note that because
we have the judgmental equality 
$\ctxwk{P}{{A}{\ctxext{A}{P}}}\jdeq\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}$ in the
context $\ctxext{{\Gamma}{A}}{P}$, the
pairing function could just be defined as $\idtm{\ctxext{A}{P}}$. 

When we substitute by an extended term we get an equal result as when we
substitute two consecutive times, like the way currying works.

\begin{lem}
The following inference rules are valid:
\begin{align*}
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    \jfam{{{\Gamma}{A}}{P}}{Q}
    }
  { \jfameq
      {\Gamma}
      {\subst{\tmext{A}{P}{x}{u}}{Q}}
      {\subst{u}{{x}{Q}}}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    \jterm{{{\Gamma}{A}}{P}}{Q}{g}
    }
  { \jtermeq
      {\Gamma}
      {\subst{u}{{x}{Q}}}
      {\subst{\tmext{A}{P}{x}{u}}{g}}
      {\subst{u}{{x}{g}}}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    \jfam{{{{\Gamma}{A}}{P}}{Q}}{R}
    }
  { \jfameq
      {{\Gamma}{\subst{u}{{x}{Q}}}}
      {\subst{\tmext{A}{P}{x}{u}}{R}}
      {\subst{u}{{x}{R}}}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    \jterm{{{{\Gamma}{A}}{P}}{Q}}{R}{t}
    }
  { \jtermeq
      {{\Gamma}{\subst{u}{{x}{Q}}}}
      {\subst{u}{{x}{R}}}
      {\subst{\tmext{A}{P}{x}{u}}{t}}
      {\subst{u}{{x}{t}}}
    }
\end{align*}
\end{lem}

\begin{proof}
We prove only the first judgmental equality. All the others are similar.
Let $\jterm{\Gamma}{A}{x}$ and $\jterm{\Gamma}{\subst{x}{P}}{u}$
be terms and let $\jfam{{{\Gamma}{A}}{P}}{Q}$ be a family. Then we have
\begin{align*}
\subst
  {\tmext{A}{P}{x}{u}}
  {Q} 
& \jdeq 
  \subst
    {{u}{{x}{\idtm{\ctxext{A}{P}}}}}
    {Q}
  \tag{by definition}\\
& \jdeq 
  \subst
    {{u}{{x}{\idtm{\ctxext{A}{P}}}}}
    {{x}{\ctxwk{A}{Q}}}
  \tag{by \autoref{defn-ws-3}}\\
& \jdeq 
  \subst
    {{u}{{x}{\idtm{\ctxext{A}{P}}}}}
    {{u}{\ctxwk{\subst{x}{P}}{\subst{x}{\ctxwk{A}{Q}}}}}
  \tag{by \autoref{defn-ws-3}}\\
& \jdeq 
  \subst
    {{u}{{x}{\idtm{\ctxext{A}{P}}}}}
    {{u}{{x}{\ctxwk{P}{{A}{Q}}}}}
  \tag{by \autoref{comp-sw-f}}\\
& \jdeq 
  \subst
    {u}
    {{{x}{\idtm{\ctxext{A}{P}}}}{{x}{\ctxwk{{P}{{A}{Q}}}}}}
  \tag{by \autoref{comp-ss-f}}\\
& \jdeq 
  \subst
    {u}
    {{x}{{\idtm{\ctxext{A}{P}}}{\ctxwk{P}{{A}{Q}}}}}
  \tag{by \autoref{comp-ss-f}}\\
& \jdeq 
  \subst
    {u}
    {{x}{{\idtm{\ctxext{A}{P}}}{\ctxwk{\ctxext{A}{P}}{Q}}}}
  \tag{by \autoref{comp-ew-f}}\\
& \jdeq 
  \subst
    {u}
    {{x}{Q}}
  \tag{by \autoref{idfunc-wk-defn}}
\end{align*}
\end{proof}

We have seen above that the pairing function into $\ctxext{A}{P}$ is just the identity term on
$\ctxext{A}{P}$. To analyze the pairing functin a little further, we will also
need the projection maps from $\ctxext{A}{P}$ to $A$ and from $\ctxext{A}{P}$
to $P$. We will now define these and see that the identity term of an
extended family is the extension (or pairing) of the identity
functions on the components in the apropriate way.

To find out what the
apropriate way is, note that
\begin{align*}
\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}} 
& \jdeq 
  \ctxwk{P}{{A}{\ctxext{A}{P}}}
  \\
& \jdeq 
  \ctxext{\ctxwk{P}{{A}{A}}}{\ctxwk{P}{{A}{P}}}
\end{align*}
We have the term $\jterm{{\Gamma}{{A}{P}}}{\ctxwk{P}{A}}{\ctxwk{P}{\idtm{A}}}$.
Thus we need to find out what $\subst{\ctxwk{P}{\idtm{A}}}{\ctxwk{P}{{A}{P}}}$ is:
\begin{align*}
\subst{\ctxwk{P}{\idtm{A}}}{\ctxwk{P}{{A}{P}}} 
& \jdeq 
  \ctxwk{P}{\subst{\idtm{A}}{\ctxwk{A}{P}}}
  \\
& \jdeq 
  \ctxwk{P}{P},
\end{align*}
where we find the term $\idtm{P}$. Therefore we define:

\begin{defn}
Let $\jfam{\Gamma}{A}$ and $\jfam{{\Gamma}{A}}{P}$ be families. We define
\begin{align*}
\jhomdefn*
  {\Gamma}
  {{A}{P}}
  {A}
  {\cprojfstf{A}{P}}
  {\unfold{\cprojfstf{A}{P}}}
  \\
\jtermdefn*
  {\ctxext{\Gamma}{{A}{P}}}
  {\ctxwk{P}{P}}
  {\cprojsndf{A}{P}}
  {\unfold{\cprojsndf{A}{P}}}
\end{align*}
\end{defn}

The constructions of the terms $\tmext{A}{P}{x}{u}$ and $\cprojfst{A}{P}{w}$ and
$\cprojsnd{A}{P}{w}$ are subject to various rules, with all of them being
consequences of earlier introduced inference rules.

\begin{lem}\label{lem:tmext-basic}
The following inference rules expressing that pairing is a strict
inverse to the combination of decompositions, are valid:
\begin{align*}
& \inference
  { \jterm{\Gamma}{\ctxext{A}{P}}{w}
    }
  { \jtermeq
      {\Gamma}
      {\ctxext{A}{P}}
      {\tmext{A}{P}{\cprojfst{A}{P}{w}}{\cprojsnd{A}{P}{w}}}
      {w}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    }
  { \jtermeq
      {\Gamma}
      {A}
      {\cprojfst{A}{P}{\tmext{A}{P}{x}{u}}}
      {x}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    }
  { \jtermeq
      {\Gamma}
      {\subst{x}{P}}
      {\cprojsnd{A}{P}{\tmext{A}{P}{x}{u}}}
      {u}
    }
\end{align*}
\end{lem}

\begin{proof}
To prove the first judgmental equality, note that
\begin{align*}
w 
& \jdeq 
  \subst{w}{\idtm{\ctxext{A}{P}}} 
  \tag{by \autoref{idfunc-subst-defn}}\\
& \jdeq 
  \subst
    { w}
    { { \idtm{P}}
      { { \ctxwk{P}{\idtm{A}}}
        { \idtm{\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}}}
        }
      }
  \tag{by \autoref{idfunc-ext-comp}}\\
& \jdeq 
  \subst
    { {w}
      {\idtm{P}}
      }
    { {w}
      { { \ctxwk{P}{\idtm{A}}
          }
        { \idtm{\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}}
          }
        }
      }
  \tag{by \autoref{comp-ss-t}}\\
& \jdeq 
  \subst
    { {w}
      {\idtm{P}}
      }
    { { {w}
        {\ctxwk{P}{\idtm{A}}}
        }
      { {w}
        {\idtm{\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}}}
        }
      }
  \tag{by \autoref{comp-ss-t}}\\
& \jdeq 
  \subst
    { {w}
      {\idtm{P}}
      }
    { { {w}
        {\ctxwk{P}{\idtm{A}}}
        }
      { {w}
        {\ctxwk{\ctxext{A}{P}}{\idtm{\ctxext{A}{P}}}}
        }
      }
  \tag{by \autoref{idfunc-wk-comp}}\\
& \jdeq 
  \subst
    { {w}
      {\idtm{P}}
      }
    { { {w}
        {\ctxwk{P}{\idtm{A}}}
        }
      { \idtm{\ctxext{A}{P}}
        }
      }
  \tag{by \autoref{defn-ws-4}}\\
& \jdeq 
  \tmext{A}{P}{\cprojfst{A}{P}{w}}{\cprojsnd{A}{P}{w}}
  \tag{by definition}
\end{align*}
To prove the second judgmental equality, let $\jterm{\Gamma}{A}{x}$ and
$\jterm{\Gamma}{\subst{x}{P}}{u}$. Then we have
\begin{align*}
\cprojfst{A}{P}{\tmext{A}{P}{x}{u}}
& \jdeq 
  \subst{\tmext{A}{P}{x}{u}}{\ctxwk{P}{\idtm{A}}}
  \\
& \jdeq 
  \subst{u}{{x}{\ctxwk{P}{\idtm{A}}}} 
  \\
& \jdeq 
  \subst{u}{\ctxwk{\subst{x}{P}}{\subst{x}{\idtm{A}}}}
  \\
& \jdeq 
  \subst{x}{\idtm{A}}
  \\
& \jdeq 
  x.
\end{align*}
To prove the third judgmental equality, note that
\begin{align*}
\cprojsnd{A}{P}{\tmext{A}{P}{x}{u}}
& \jdeq 
  \subst{\tmext{A}{P}{x}{u}}{\idtm{P}}
  \\
& \jdeq 
  \subst{u}{{x}{\idtm{P}}}
  \\
& \jdeq 
  \subst{u}{\idtm{\subst{x}{P}}}
  \\
& \jdeq 
  u.
  \qedhere
\end{align*}
\end{proof}

In \autoref{lem:tmext-emp,lem:tmext-ext,lem:tmext-wk,lem:tmext-subst,lem:tmext-id}
we show that term extension and the projections are
compatible with the empty families, extension,
weakening, substitution and the identity terms (in that order). \autoref{lem:tmext-id}
is in fact a generalization of the above \autoref{lem:tmext-basic}.

\begin{lem}\label{lem:tmext-emp}
The following compatibility rules for extensions of the term of the empty family
are valid:
\begin{align*}
& \inference
  { \jterm{\Gamma}{A}{x}
    }
  { \jtermeq{\Gamma}{A}{\tmext{\emptytm}{x}}{x}
    }
& & \inference
  { \jterm{\Gamma}{A}{x}
    }
  { \jtermeq{\Gamma}{A}{\tmext{x}{\emptytm}}{x}
    }
  \\
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jtermeq
      {{\Gamma}{A}}
      {\emptyf}
      {\cprojfstf{\emptyf}{A}}
      {\emptytm}
    }
& & \inference
  { \jfam{\Gamma}{A}
    }
  { \jhomeq
      {\Gamma}
      {A}
      {A}
      {\cprojfstf{A}{\emptyf}}
      {\idtm{A}}
    }
  \\
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jhomeq
      {\Gamma}
      {A}
      {A}
      {\cprojsndf{\emptyf}{A}}
      {\idtm{A}}
    }
& & \inference
  { \jfam{\Gamma}{A}
    }
  { \jtermeq
      {{\Gamma}{A}}
      {\emptyf}
      {\cprojsndf{A}{\emptyf}}
      {\emptytm}
    }
\end{align*}
\end{lem}

\begin{proof}
These equalities are very easy to verify. We only display a proof of the first:
\begin{equation*}
\tmext{\emptytm}{x}
\jdeq \unfold{\tmext{\emptyf}{A}{\emptytm}{x}}
\jdeq \subst{x}{\idtm{{\emptyf}{A}}}
\jdeq \subst{x}{\idtm{A}}
\jdeq x.\qedhere
\end{equation*}
\end{proof}

\begin{lem}\label{lem:tmext-ext}
The following compatibility rules for two consecutive term extensions are valid:
\begin{align*}
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    \jterm{\Gamma}{\subst{\tmext{A}{P}{x}{u}}{Q}}{v}
    }
  { \jtermeq
      {\Gamma}
      {\ctxext{{A}{P}}{Q}}
      {\tmext{A}{{P}{Q}}{x}{{\subst{x}{P}}{\subst{x}{Q}}{u}{v}}}
      {\tmext{{A}{P}}{Q}{{A}{P}{x}{u}}{v}}
    }
  \\
& \inference
  { \jfam{{{\Gamma}{A}}{P}}{Q}
    }
  { \jhomeq
      {\Gamma}
      {\ctxext{{A}{P}}{Q}}
      {A}
      {\jcomp{}{\cprojfstf{{A}{P}}{Q}}{\cprojfstf{A}{P}}}
      {\cprojfstf{A}{{P}{Q}}}
    }
  \\
& \inference
  { \jfam{{{\Gamma}{A}}{P}}{Q}
    }
  { \jhomeq
      {{\Gamma}{A}}
      {{P}{Q}}
      {P}
      {\jcomp{}{\cprojfstf{{A}{P}}{Q}}{\cprojsndf{A}{P}}}
      {\jcomp{}{\cprojsndf{A}{{P}{Q}}}{\cprojfstf{P}{Q}}}
    }
  \\
& \inference
    { \jfam{{{\Gamma}{A}}{P}}{Q}
      }
    { \jhomeq
        {{{\Gamma}{A}}{P}}
        {Q}
        {Q}
        {\cprojsndf{{A}{P}}{Q}}
        {\jcomp{}{\cprojsndf{A}{{P}{Q}}}{\cprojsndf{P}{Q}}}
      }
\end{align*}
\end{lem}

\begin{proof}
Consider terms $\jterm{\Gamma}{A}{x}$, $\jterm{\Gamma}{\subst{x}{P}}{u}$ and
$\jterm{\Gamma}{\subst{u}{{x}{Q}}}{v}$. Then we have
\begin{align*}
\tmext{x}{{u}{v}}
& \jdeq 
  \subst
    {\tmext{u}{v}}{{x}{\idtm{\ctxext{A}{{P}{Q}}}}}
  \\
& \jdeq 
  \subst{v}{{u}{{x}{\idtm{\ctxext{A}{{P}{Q}}}}}}
  \\
& \jdeq 
  \subst{v}{{u}{{x}{\idtm{\ctxext{{A}{P}}{Q}}}}}
  \\
& \jdeq 
  \subst{v}{{\tmext{x}{u}}{\idtm{\ctxext{{A}{P}}{Q}}}}
  \\
& \jdeq 
  \tmext{{x}{u}}{v}.
\end{align*}
To prove the judmental equality
\begin{equation*}
\jhomeq
  {\Gamma}
  {\ctxext{{A}{P}}{Q}}
  {A}
  {\jcomp{}{\cprojfstf{{A}{P}}{Q}}{\cprojfstf{A}{P}}}
  {\cprojfstf{A}{{P}{Q}}}
\end{equation*}
note that we have the judgmental equalities
\begin{align*}
\jcomp{{{A}{P}}{Q}}{\cprojfstf{{A}{P}}{Q}}{\cprojfstf{A}{P}}
& \jdeq 
  \unfoldall{\jcomp{{{A}{P}}{Q}}{\cprojfstf{{A}{P}}{Q}}{\cprojfstf{A}{P}}}
  \\
& \jdeq 
  \subst
    {\ctxwk{Q}{\idtm{{A}{P}}}}
    {\ctxwk{Q}{{\ctxext{A}{P}}{{P}{\idtm{A}}}}}
  \\
& \jdeq
  \ctxwk{Q}{\subst{\idtm{{A}{P}}}{\ctxwk{\ctxext{A}{P}}{{P}{\idtm{A}}}}}
  \\
& \jdeq
  \ctxwk{Q}{{P}{\idtm{A}}}
  \\
& \jdeq
  \ctxwk{\ctxext{P}{Q}}{\idtm{A}}
  \\
& \jdeq
  \cprojfstf{A}{{P}{Q}}
\end{align*}
To prove the judgmental equality
\begin{equation*}
\jhomeq
  {{\Gamma}{A}}
  {{P}{Q}}
  {P}
  {\jcomp{}{\cprojfstf{{A}{P}}{Q}}{\cprojsndf{A}{P}}}
  {\jcomp{}{\cprojsndf{A}{{P}{Q}}}{\cprojfstf{P}{Q}}}
\end{equation*}
note that we have the judgmental equalities
\begin{align*}
\jcomp{{{A}{P}}{Q}}{\cprojfstf{{A}{P}}{Q}}{\cprojsndf{A}{P}}
& \jdeq 
  \unfoldall{\jcomp{{{A}{P}}{Q}}{\cprojfstf{{A}{P}}{Q}}{\cprojsndf{A}{P}}}
  \\
& \jdeq
  \subst{\ctxwk{Q}{\idtm{{A}{P}}}}{\ctxwk{Q}{{\ctxext{A}{P}}{\idtm{P}}}}
  \\
& \jdeq
  \ctxwk{Q}{\subst{\idtm{{A}{P}}}{\ctxwk{\ctxext{A}{P}}{\idtm{P}}}}
  \\
& \jdeq
  \ctxwk{Q}{\idtm{P}}
  \\
& \jdeq
  \unfoldall{\jcomp{{P}{Q}}{\cprojsndf{A}{{P}{Q}}}{\cprojfstf{P}{Q}}}
  \\
& \jdeq
  \jcomp{{P}{Q}}{\cprojsndf{A}{{P}{Q}}}{\cprojfstf{P}{Q}}
\end{align*}
To prove the judgmental equality
\begin{equation*}
\jhomeq
  {{{\Gamma}{A}}{P}}
  {Q}
  {Q}
  {\cprojsndf{{A}{P}}{Q}}
  {\jcomp{}{\cprojsndf{A}{{P}{Q}}}{\cprojsndf{P}{Q}}}
\end{equation*}
note that we have the judgmental equalities
\begin{align*}
\cprojsndf{{A}{P}}{Q}
& \jdeq
  \unfoldall{\cprojsndf{{A}{P}}{Q}}
  \\
& \jdeq 
  \unfoldall{\jcomp{{P}{Q}}{\cprojsndf{A}{{P}{Q}}}{\cprojsndf{P}{Q}}}
  \\
& \jdeq
  \jcomp{}{\cprojsndf{A}{{P}{Q}}}{\cprojsndf{P}{Q}}\qedhere
\end{align*}
\begin{comment}
%%%% This was a proof of an old version of the statement
Now consider a term $\jterm{\Gamma}{\ctxext{A}{{P}{Q}}}{w}$. Then we have
\begin{align*}
w 
& \jdeq 
  \tmext
    {A}
    {{P}{Q}}
    {\cprojfst{A}{\ctxext{P}{Q}}{w}}
    {\cprojsnd{A}{\ctxext{P}{Q}}{w}}
  \\
& \jdeq 
  \tmext
    {A}
    {{P}{Q}}
    {\cprojfst{A}{\ctxext{P}{Q}}{w}}
    { {P}
      {Q}
      {\cprojfst{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}
      {\cprojsnd{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}
      }
  \\
& \jdeq 
  \tmext
    {{A}{P}}
    {Q}
    { {} % need to provide base and family, but there's no unfold.
      {}
      {\cprojfst{A}{\ctxext{P}{Q}}{w}}
      {\cprojfst{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}
      }
    { \cprojsnd{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}
      }
\end{align*}
Thus we see that 
\begin{align*}
\cprojfst{\ctxext{A}{P}}{Q}{w} 
& \jdeq 
  \tmext
    {A}
    {P}
    {\cprojfst{A}{\ctxext{P}{Q}}{w}}
    {\cprojfst{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}}}
  \\ 
\cprojsnd{\ctxext{A}{P}}{Q}{w} 
& \jdeq 
  \cprojsnd{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}},
\end{align*}
proving the fourth judgmental equality, and therefore also that
\begin{align*}
\cprojfst{A}{P}{\cprojfst{\ctxext{A}{P}}{Q}{w}} 
& \jdeq 
  \cprojfst{A}{\ctxext{P}{Q}}{w}
  \\
\cprojsnd{A}{P}{\cprojfst{\ctxext{A}{P}}{Q}{w}} 
& \jdeq 
  \cprojfst{P}{Q}{\cprojsnd{A}{\ctxext{P}{Q}}{w}},
\end{align*}
proving the second and the third judgmental equalities.
\end{comment}
\end{proof}

\begin{lem}\label{lem:tmext-wk}
When we weaken a term $\tmext{B}{Q}{y}{v}$ of $\ctxext{B}{Q}$ in context $\Gamma$ by
a family $A$, the term that we get is $\tmext{\ctxwk{A}{B}}{\ctxwk{A}{Q}}{\ctxwk{A}{y}}{\ctxwk{A}{v}}$. More
precisely, the following inference rules are valid:
\begin{align*}
& \inference
  { \jterm{{\Gamma}{B}}{Q}{g}
    \jterm{{\Gamma}{B}}{\subst{g}{R}}{t}
    }
  { \jtermeq
      {{{\Gamma}{A}}{\ctxwk{A}{B}}}
      {\ctxwk{A}{\ctxext{Q}{R}}}
      {\ctxwk{A}{\tmext{Q}{R}{g}{t}}}
      {\tmext{\ctxwk{A}{Q}}{\ctxwk{A}{R}}{\ctxwk{A}{g}}{\ctxwk{A}{t}}}
    }
  \\
& \inference
  { \jfam{{{\Gamma}{B}}{Q}}{R}
    }
  { \jhomeq
      {{{\Gamma}{A}}{\ctxwk{A}{B}}}
      {{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}
      {\ctxwk{A}{Q}}
      {\cprojfstf{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}
      {\ctxwk{A}{\cprojfstf{Q}{R}}}
    }
  \\
& \inference
  { \jfam{{{\Gamma}{B}}{Q}}{R}
    }
  { \jhomeq
      {{{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}}
      {\ctxwk{A}{R}}
      {\ctxwk{A}{R}}
      {\cprojsndf{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}
      {\ctxwk{A}{\cprojsndf{Q}{R}}}
    }
\end{align*}
\end{lem}

\begin{proof}
Consider $\jterm{{\Gamma}{B}}{Q}{g}$ and $\jterm{{\Gamma}{B}}{\subst{g}{R}}{t}$.
Then we have the judgmental equalities
\begin{align*}
\ctxwk{A}{\ctxext{Q}{R}{g}{t}}
& \jdeq 
  \ctxwk{A}{\subst{t}{{g}{\idtm{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{\ctxwk{A}{t}}{\ctxwk{A}{\subst{g}{\idtm{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{\ctxwk{A}{t}}{{\ctxwk{A}{g}}{\ctxwk{A}{\idtm{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{\ctxwk{A}{t}}{{\ctxwk{A}{g}}{\idtm{\ctxwk{A}{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{\ctxwk{A}{t}}{{\ctxwk{A}{g}}{\idtm{\ctxext{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}}}
  \\
& \jdeq 
  \tmext{\ctxwk{A}{Q}}{\ctxwk{A}{R}}{\ctxwk{A}{g}}{\ctxwk{A}{t}}
\end{align*}
Next, we want to prove the judgmental equality
\begin{equation*}
\jhomeq
  {{{\Gamma}{A}}{\ctxwk{A}{B}}}
  {{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}
  {\ctxwk{A}{Q}}
  {\cprojfstf{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}
  {\ctxwk{A}{\cprojfstf{Q}{R}}}
\end{equation*}
Note that we have the judgmental equalities
\begin{align*}
\cprojfstf{\ctxwk{A}{Q}}{\ctxwk{A}{R}}
& \jdeq
  \unfoldall{\cprojfstf{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}
  \\
& \jdeq
  \ctxwk{{A}{R}}{{A}{\idtm{Q}}}
  \\
& \jdeq
  \unfoldall{\ctxwk{A}{\cprojfstf{Q}{R}}}
  \\
& \jdeq
  \ctxwk{A}{\cprojfstf{Q}{R}}.
\end{align*}
Finally, we want to prove the judgmental equality
\begin{equation*}
\jhomeq
  {{{{\Gamma}{A}}{\ctxwk{A}{B}}}{\ctxwk{A}{Q}}}
  {\ctxwk{A}{R}}
  {\ctxwk{A}{R}}
  {\cprojsndf{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}
  {\ctxwk{A}{\cprojsndf{Q}{R}}}
\end{equation*}
Note that we have the judgmental equalities
\begin{align*}
\cprojsndf{\ctxwk{A}{Q}}{\ctxwk{A}{R}}
& \jdeq
  \unfoldall{\cprojsndf{\ctxwk{A}{Q}}{\ctxwk{A}{R}}}
  \\
& \jdeq
  \unfoldall{\ctxwk{A}{\cprojsndf{Q}{R}}}
  \\
& \jdeq
  \ctxwk{A}{\cprojsndf{Q}{R}}.
  \qedhere
\end{align*}
\end{proof}

\begin{lem}\label{lem:tmext-subst}
When we substitute an extended term $\tmext{P}{Q}{f}{g}$ of $\ctxext{P}{Q}$ by a term
$x$ of $A$, the term that we get is $\tmext{\subst{x}{P}}{\subst{x}{Q}}{\subst{x}{f}}{\subst{x}{g}}$.
More precisely, the following inference rules are valid:
\begin{align*}
& \inference
  { \jterm{\Gamma}{A}{x}
    \jterm{{{\Gamma}{A}}{P}}{Q}{g}
    \jterm{{{\Gamma}{A}}{P}}{\subst{g}{R}}{t}
    }
  { \jtermeq
      {{\Gamma}{\subst{x}{P}}}
      {\ctxext{\subst{x}{Q}}{\subst{x}{R}}}
      {\subst{x}{\tmext{Q}{R}{g}{t}}}
      {\tmext{\subst{x}{Q}}{\subst{x}{R}}{\subst{x}{g}}{\subst{x}{t}}}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jfam{{{{\Gamma}{A}}{P}}{Q}}{R}
    }
  { \jhomeq
      {{\Gamma}{\subst{x}{P}}}
      {{\subst{x}{Q}}{\subst{x}{R}}}
      {\subst{x}{Q}}
      {\cprojfstf{\subst{x}{Q}}{\subst{x}{R}}}
      {\subst{x}{\cprojfstf{Q}{R}}}
    }
  \\
& \inference
  { \jterm{\Gamma}{A}{x}
    \jfam{{{{\Gamma}{A}}{P}}{Q}}{R}
    }
  { \jhomeq
      {{{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}}
      {\subst{x}{R}}
      {\subst{x}{R}}
      {\cprojsndf{\subst{x}{Q}}{\subst{x}{R}}}
      {\subst{x}{\cprojsndf{Q}{R}}}
    }
\end{align*}
\end{lem}

\begin{proof}
Consider $\jterm{{\Gamma}{B}}{Q}{g}$ and $\jterm{{\Gamma}{B}}{\subst{g}{R}}{t}$.
Then we have the judgmental equalities
\begin{align*}
\subst{x}{\tmext{Q}{R}{g}{t}}
& \jdeq 
  \subst{x}{{t}{{g}{\idtm{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{{x}{t}}{{x}{{g}{\idtm{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{{x}{t}}{{{x}{g}}{{x}{\idtm{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{{x}{t}}{{{x}{g}}{\idtm{\subst{x}{\ctxext{Q}{R}}}}}
  \\
& \jdeq 
  \subst{{x}{t}}{{{x}{g}}{\idtm{\ctxext{\subst{x}{Q}}{\subst{x}{R}}}}}
  \\
& \jdeq 
  \tmext{\subst{x}{Q}}{\subst{x}{R}}{\subst{x}{g}}{\subst{x}{t}}.
\end{align*}
Next, we want to prove the judgmental equality
\begin{equation*}
\jhomeq
  {{\Gamma}{\subst{x}{P}}}
  {{\subst{x}{Q}}{\subst{x}{R}}}
  {\subst{x}{Q}}
  {\cprojfstf{\subst{x}{Q}}{\subst{x}{R}}}
  {\subst{x}{\cprojfstf{Q}{R}}}
\end{equation*}
Note that we have the judgmental equalities
\begin{align*}
\cprojfstf{\subst{x}{Q}}{\subst{x}{R}}
& \jdeq
  \unfoldall{\cprojfstf{\subst{x}{Q}}{\subst{x}{R}}}
  \\
& \jdeq
  \ctxwk{\subst{x}{R}}{\subst{x}{\idtm{Q}}}
  \\
& \jdeq
  \unfoldall{\subst{x}{\cprojfstf{Q}{R}}}
  \\
& \jdeq
  \subst{x}{\cprojfstf{Q}{R}}.
\end{align*}
And finally we want to prove the judgmental equality
\begin{equation*}
\jhomeq
  {{{\Gamma}{\subst{x}{P}}}{\subst{x}{Q}}}
  {\subst{x}{R}}
  {\subst{x}{R}}
  {\cprojsndf{\subst{x}{Q}}{\subst{x}{R}}}
  {\subst{x}{\cprojsndf{Q}{R}}}
\end{equation*}
Note that we have the judgmental equalities
\begin{align*}
\cprojsndf{\subst{x}{Q}}{\subst{x}{R}}
& \jdeq
  \unfoldall{\cprojsndf{\subst{x}{Q}}{\subst{x}{R}}}
  \\
& \jdeq
  \unfoldall{\subst{x}{\cprojsndf{Q}{R}}}
  \\
& \jdeq
  \subst{x}{\cprojsndf{Q}{R}}.
  \qedhere
\end{align*}
\end{proof}

We find the following inference rule, which expresses that the identity term
is compatible with extension:

\begin{lem}\label{lem:tmext-id}
For any $\jfam{\Gamma}{A}$ and $\jfam{{\Gamma}{A}}{P}$ we have
\begin{equation}\label{idfunc-ext-comp}
\inference
  { \jfam{\Gamma}{A}
    \jfam{{\Gamma}{A}}{P}
    }
  { \jhomeq
      {\Gamma}
      {{A}{P}}{{A}{P}}
      {\idtm{\ctxext{A}{P}}}
      { \tmext
          {\ctxwk{\ctxext{A}{P}}{A}}
          {\ctxwk{\ctxext{A}{P}}{P}}
          {\cprojfstf{A}{P}}
          {\cprojsndf{A}{P}}
        }
    }
\end{equation}
\end{lem}

\begin{proof}
Consider the families $\jfam{\Gamma}{A}$ and $\jfam{{\Gamma}{A}}{P}$. Then
we have the judgmental equalities
\begin{align*}
\tmext
  {\ctxwk{\ctxext{A}{P}}{A}}
  {\ctxwk{\ctxext{A}{P}}{P}}
  {\cprojfstf{A}{P}}
  {\cprojsndf{A}{P}}
& \jdeq 
  \unfold
  { \tmext
      {\ctxwk{\ctxext{A}{P}}{A}}
      {\ctxwk{\ctxext{A}{P}}{P}}
      {\cprojfstf{A}{P}}
      {\cprojsndf{A}{P}}
    }
  \\
& \jdeq 
  \subst
    { \idtm{P}
      }
    { {\ctxwk{P}{\idtm{A}}}
      {\idtm{\ctxwk{\ctxext{A}{P}}{\ctxext{A}{P}}}}
      }
  \\
& \jdeq 
  \subst
    { \idtm{P}
      }
    { {\ctxwk{P}{\idtm{A}}}
      {\ctxwk{\ctxext{A}{P}}{\idtm{\ctxext{A}{P}}}}
      }
  \\
& \jdeq 
  \subst
    { \idtm{P}
      }
    { {\ctxwk{P}{\idtm{A}}}
      {\ctxwk{P}{{A}{\idtm{\ctxext{A}{P}}}}}
      }
  \\
& \jdeq 
  \subst
    { \idtm{P}
      }
    {\ctxwk
      {P}
      { \subst
        {\idtm{A}}
        {\ctxwk{A}{\idtm{\ctxext{A}{P}}}}
        }
      }
  \\
& \jdeq 
  \subst
    { \idtm{A}
      }
    { \ctxwk{A}{\idtm{\ctxext{A}{P}}}
      }
  \\
& \jdeq 
  \idtm{\ctxext{A}{P}}.
  \qedhere
\end{align*}
\end{proof}

\subsection{More on morphisms}

For the following lemma, recall that the judgment $\jhom{\Gamma}{A}{{B}{Q}}{f}$
unfolds as
\begin{equation*}
\unfold{\jhom{\Gamma}{A}{{B}{Q}}{f}}
\end{equation*}
and that we have the judgmental equality 
$ \jfameq
    {{\Gamma}{A}}
    {\ctxwk{A}{\ctxext{B}{Q}}}
    {\ctxext{\ctxwk{A}{B}}{\ctxwk{A}{Q}}}.
  $
Therefore, each morphism into an extended family can itself be described as
an extended term. The following lemma explains how this goes.

\begin{lem}
Let $\jhom{\Gamma}{A}{{B}{Q}}{f}$ be a morphism from $A$ to $\ctxext{B}{Q}$
in a context $\Gamma$. Then we have
\begin{equation*}
\jhomeq
  {\Gamma}
  {A}
  {{B}{Q}}
  {f}
  {\tmext{\jcomp{}{f}{\cprojfstf{B}{Q}}}{\jcomp{}{f}{\cprojsndf{B}{Q}}}}.
\end{equation*}
Alternatively, when $\jhom{\Gamma}{A}{B}{f_0}$ and 
$\jterm{{\Gamma}{A}}{\jcomp{}{f_0}{Q}}{f_1}$ we obtain a morphism
$\jhom{\Gamma}{A}{{B}{Q}}{\tmext{f_0}{f_1}}$ with the property that
\begin{align*}
\jhomeq*{\Gamma}{A}{B}{\jcomp{}{\tmext{f_0}{f_1}}{\cprojfstf{B}{Q}}}{f_0}\\
\jtermeq*{{\Gamma}{A}}{\jcomp{}{f_0}{Q}}{\jcomp{}{\tmext{f_0}{f_1}}{\cprojsndf{B}{Q}}}{f_1}.
\end{align*}
\end{lem}

\begin{proof}
Let $\jhom{\Gamma}{A}{{B}{Q}}{f}$ be a morphism in context $\Gamma$. Then we
have the judgmental equalities
\begin{align*}
\cprojfst{\ctxwk{A}{B}}{\ctxwk{A}{Q}}{f}
& \jdeq
  \subst{f}{\ctxwk{A}{\cprojfstf{B}{Q}}}
  \\
& \jdeq
  \jcomp{}{f}{\cprojfstf{B}{Q}}
  \\
\cprojsnd{\ctxwk{A}{B}}{\ctxwk{A}{Q}}{f}
& \jdeq
  \subst{f}{\ctxwk{A}{\cprojsndf{B}{Q}}}
  \\
& \jdeq
  \jcomp{}{f}{\cprojsndf{B}{Q}}
\end{align*}
The alternative formulation of the statement is a direct corollary.
\end{proof}

We also have the following lemma about the compatibility of pairing and composition:

\begin{lem}
The following inference rule is valid
\begin{align*}
& \inference
  { \jhom{\Gamma}{A}{B}{f}
    \jhom{\Gamma}{B}{C}{g}
    \jfam{{\Gamma}{C}}{R}
    \jterm{{\Gamma}{B}}{\subst{g}{\ctxwk{B}{R}}}{w}
    }
  { \jhomeq
      {\Gamma}
      {A}
      {{C}{R}}
      {\jcomp{A}{f}{\tmext{\ctxwk{B}{C}}{\ctxwk{B}{R}}{g}{w}}}
      {\tmext{\ctxwk{A}{C}}{\ctxwk{A}{R}}{\jcomp{A}{f}{g}}{\jcomp{A}{f}{w}}}
    }
\end{align*}
\end{lem}

\begin{proof}
Let $\jhom{\Gamma}{A}{B}{f}$, $\jhom{\Gamma}{B}{C}{g}$, $\jfam{{\Gamma}{C}}{R}$
and $\jterm{{\Gamma}{B}}{\subst{g}{\ctxwk{B}{R}}}{w}$. Then we have the
judgmental equalities
\begin{align*}
\jcomp{A}{f}{\tmext{\ctxwk{B}{C}}{\ctxwk{B}{R}}{g}{w}}
& \jdeq 
  \subst{f}{\ctxwk{A}{\tmext{\ctxwk{B}{C}}{\ctxwk{B}{R}}{g}{w}}}
  \\
& \jdeq 
  \subst
    {f}
    {\tmext{\ctxwk{A}{{B}{C}}}{\ctxwk{A}{{B}{R}}}{\ctxwk{A}{g}}{\ctxwk{A}{w}}}
  \\
& \jdeq 
  \tmext
    {\ctxwk{A}{C}}
    {\ctxwk{A}{R}}
    {\subst{f}{\ctxwk{A}{g}}}
    {\subst{f}{\ctxwk{A}{w}}}
  \\
& \jdeq 
  \tmext{\ctxwk{A}{C}}{\ctxwk{A}{R}}{\jcomp{A}{f}{g}}{\jcomp{A}{f}{w}}.
  \qedhere
\end{align*}
\end{proof}

\begin{defn}
Let $\jhom{\Gamma}{A}{B}{f}$ be a morphism from $A$ to $B$ in context $\Gamma$
and let $\jfhom{\Gamma}{A}{B}{f}{P}{Q}{F}$ be a morphism over $f$ in context 
$\Gamma$. We define
\begin{equation*}
\jhomdefn{\Gamma}{{A}{P}}{{B}{Q}}{\jvcomp{P}{f}{F}}{\unfold{\jvcomp{P}{f}{F}}}
\end{equation*}
\end{defn}

\subsection{Fiber inclusions}
We will use the insights of \autoref{extension-on-terms} to define and study
\emph{fiber inclusions}. The fiber inclusion of the \emph{fiber}
$\subst{x}{P}$ into the extension $\ctxext{A}{P}$ is a morphism
$\jhom{\Gamma}{\subst{x}{P}}{{A}{P}}{\finc{x}{P}}$, for any family
$\jfam{{\Gamma}{A}}{P}$ and any term $\jterm{\Gamma}{A}{x}$. Then we will determine
the ways in which it is compatible with the other operators. Note that in this
subsection we will focus on the compatibility properties; the fact that
the fiber inclusions also appear in a pullback diagram will be established in
\autoref{pullback}. 

\begin{defn}
Let $\jterm{\Gamma}{A}{x}$ be a term and let $\jfam{{\Gamma}{A}}{P}$ be a
family. Then we define the \emph{fiber inclusion} of $\subst{x}{P}$ into
$\ctxext{A}{P}$ in context $\Gamma$ to be the morphism
\begin{equation*}
\jhomdefn{\Gamma}{\subst{x}{P}}{{A}{P}}{\finc{x}{P}}{\unfoldnext{\finc{x}{P}}}.
\end{equation*}
\end{defn}

We have the following lemmas expressing the compatibility of the fiber
inclusions with the empty context, extension, weakening and substitution. 

\begin{lem}
The fiber inclusions are compatible with the empty families; i.e.~the following
inference rules are valid
\begin{align*}
& \inference
  { \jterm{\Gamma}{A}{x}
    }
  { \jtermeq
      {\Gamma}
      {A}
      {\finc{x}{\emptyf}}
      {x}
    }
  \\
& \inference
  { \jfam{\Gamma}{A}
    }
  { \jhomeq
      {\Gamma}
      {A}
      {A}
      {\finc{\emptytm}{A}}
      {\idtm{A}}
    }
\end{align*}
\end{lem}

\begin{lem}
The fiber inclusions are compatible with extension; i.e.~the following inference
rule is valid
\begin{equation*}
\inference
  { \jterm{\Gamma}{A}{x}
    \jterm{\Gamma}{\subst{x}{P}}{u}
    \jfam{{{\Gamma}{A}}{P}}{Q}
    }
  { \jhomeq
      {\Gamma}
      {\subst{\tmext{x}{u}}{Q}}
      {{{A}{P}}{Q}}
      {\finc{\tmext{x}{u}}{Q}}
      {\jcomp{}{\finc{u}{\subst{x}{Q}}}{\finc{x}{\ctxext{P}{Q}}}}
    }
\end{equation*}
\end{lem}

\begin{lem}
The fiber inclusions are compatible with weakening; i.e.~the following inference
rule is valid
\begin{equation*}
\inference
  { \jfam{\Gamma}{A}
    \jterm{\Gamma}{B}{y}
    \jfam{{\Gamma}{B}}{Q}
    }
  { \jhomeq
      {{\Gamma}{A}}
      {\subst{\ctxwk{A}{y}}{\ctxwk{A}{Q}}}
      {{\ctxwk{A}{B}}{\ctxwk{A}{Q}}}
      {\finc{\ctxwk{A}{y}}{\ctxwk{A}{Q}}}
      {\ctxwk{A}{\finc{y}{Q}}}
    }
\end{equation*}
\end{lem}

\begin{lem}
The fiber inclusions are compatible with substitution; i.e.~the following
inference rule is valid
\begin{equation*}
\inference
  { \jterm{\Gamma}{A}{x}
    \jfam{{{\Gamma}{A}}{P}}{Q}
    \jterm{{\Gamma}{A}}{P}{f}
    }
  { \jhomeq
      {\Gamma}
      {\subst{{x}{f}}{{x}{Q}}}
      {{\subst{x}{P}}{\subst{x}{Q}}}
      {\finc{\subst{x}{f}}{\subst{x}{Q}}}
      {\subst{x}{\finc{f}{Q}}}
    }
\end{equation*}
\end{lem}

\begin{lem}
The fiber inclusions are compatible with identity terms; i.e.~the following
inference rule is valid
\begin{equation*}
\inference
  { \jfam{{\Gamma}{A}}{P}
    }
  { \jhomeq
      {{\Gamma}{A}}
      {P}
      {\ctxwk{A}{\ctxext{A}{P}}}
      {\finc{\idtm{A}}{\ctxwk{A}{P}}}
      {\idtm{{A}{P}}}
    }
\end{equation*}
\end{lem}

\subsection{Pullback squares and family pullback squares}
\label{pullback}
Now that we have introduced the notions of morphisms, composition and identity
terms, we can develop a diagramatic style of of displaying type dependencies
combined with morphisms. We give an informal, metatheoretical definition of
such diagrams by indicating what the various components mean. The definition
is informal because we will only use such diagrams occasionally to provide a
graphical indication of the situation in which we're working. In particular,
we will not shy away from using natural numbers and trust that the reader can
figure out what we mean.

\begin{defn}
A diagram is said to be a \emph{dependency diagram in context $\Gamma$}
if it is built up according to the following steps:
\begin{itemize}
\item The arrows appearing in a dependency diagram are either ordinary, like the
arrow%
$\begin{tikzcd}[ampersand replacement = \&]
X \ar{r} \& Y,
\end{tikzcd}$
or double-headed, like
$\begin{tikzcd}[ampersand replacement = \&]
X \ar[fib]{r} \& Y.
\end{tikzcd}$
\item An ordinary arrow 
\begin{equation*}
\begin{tikzcd}
A \ar{r}{f} & B
\end{tikzcd}
\end{equation*}
between two families $A$ and $B$ of contexts over $\Gamma$ indicates that
$f$ is a morphism from $A$ to $B$ in context $\Gamma$, i.e.~that we have the
judgment $\jhom{\Gamma}{A}{B}{f}$.
\item The set of double-headed arrows must form a forest and the root of
each maximal tree of double-headed arrows is a family of contexts over $\Gamma$.
In particular, if an object is not the domain of a double-headed arrow it must
be a family of contexts over $\Gamma$.
\item A sequence of double-headed 
arrows
\begin{equation*}
\begin{tikzcd}
P_{n} \ar[fib]{r} & \cdots \ar[fib]{r} & P_1 \ar[fib]{r} & A
\end{tikzcd}
\end{equation*}
indicates that $P_1$ is a family of contexts over $\ctxext{\Gamma}{A}$, that
$P_2$ is a family of contexts over $\ctxext{{\Gamma}{A}}{P_1}$, etcetera.
\item There can be two kinds of ladders of double-headed arrows:
\begin{equation*}
\begin{tikzcd}
P_{n} \ar{r}{F_{n}} \ar[fib]{d} & Q_{n} \ar[fib]{d}\\
\vdots \ar[fib]{d} & \vdots \ar[fib]{d}\\
P_1 \ar{r}{F_1} \ar[fib]{d} & Q_1 \ar[fib]{d}\\
A \ar{r}{f} & B
\end{tikzcd}
\qquad
\begin{tikzcd}[column sep = tiny]
P_{n+m} \ar{rr}{F_{n+m}} \ar[fib]{d} & & Q_{n+m} \ar[fib]{d}\\
\vdots \ar[fib]{d} & & \vdots \ar[fib]{d}\\
P_{n+1} \ar{rr}{F_{n+1}} \ar[fib]{dr} & & Q_{n+1} \ar[fib]{dl}\\
& P_n \ar[fib]{d}\\
& \vdots \ar[fib]{d}\\
& P_1 \ar[fib]{d}\\
& A
\end{tikzcd}
\end{equation*}
The ladder on the left 
indicates that $F_1$ is a morphism from $P_1$ to $Q_1$ \emph{over} $f$,
i.e.~that the judgment $\jfhom{\Gamma}{A}{B}{f}{P_1}{Q_1}{F_1}$ holds, that
$F_2$ is a morphism from $P_2$ to $Q_2$ over
the morphism $\tmext{\ctxwk{P_1}{f}}{F_1}$ from $\ctxext{A}{P_1}$ to
$\ctxext{B}{Q_1}$, etcetera.

The ladder on the right indicates that $F_{n+1}$ is a morphism from $P_{n+1}$ to
$Q_{n+1}$ in the appropriate context, that $F_{n+2}$ is a morphism from
$P_{n+2}$ to $Q_{n+2}$ over $F_{n+1}$, etcetera.
 
Note that the object(s) at the bottom of a ladder are always families of contexts
over $\Gamma$, so that the typing of the various ingredients makes sense.
\end{itemize}
Such a diagram is said to be commutative if the subdiagram consisting of only
the normal headed arrows is commutative in the usual sense (using judgmental
equality). Note that the ladders are inherently commutative.
\end{defn}

The most basic illustrative example of a commutative dependency diagram is
the diagram
\begin{equation*}
\begin{tikzcd}
P \ar[fib]{d} \ar{r}{F} & Q \ar[fib]{d} \\
A \ar{r}{f} & B
\end{tikzcd}
\end{equation*}
indicating a morphism $F$ from $P$ to $Q$ over the morphism $f$ from $A$ to
$B$ in a context $\Gamma$.

We can just copy the usual categorical definition of a pullback square to our
current situation, but we have to require that each arrow in the pullback square
is an ordinary arrow. When families (i.e. double-headed arrows) are involved
in the diagram, we make the following definition of a family pullback:

\begin{defn}
We say that a commutative dependency diagram of the form
\begin{equation*}
\begin{tikzcd}
P \ar[fib]{d} \ar{r}{F} & Q \ar[fib]{d} \\
A \ar{r}{f} & B
\end{tikzcd}
\end{equation*}
is a \emph{family pullback} if the following inference rules are valid:
\begin{align*}
& \inference
  { \jfam{{\Gamma}{A}}{P'}
    \jfhom{\Gamma}{A}{B}{f}{P'}{Q}{F'}
    }
  { \jhom{{\Gamma}{A}}{P'}{P}{u}
    }
  \\
& \inference
  { \jfam{{\Gamma}{A}}{P'}
    \jfhom{\Gamma}{A}{B}{f}{P'}{Q}{F'}
    }
  { \jfhomeq{\Gamma}{A}{B}{f}{P'}{Q}{\jcomp{}{u}{F}}{F'}
    }
  \\
& \inference
  { \jhom{{\Gamma}{A}}{P'}{P}{v}
    \jfhomeq{\Gamma}{A}{B}{f}{P'}{Q}{\jcomp{}{v}{F}}{F'}
    }
  { \jhomeq{{\Gamma}{A}}{P'}{P}{v}{u}
    }
\end{align*}
\end{defn}

The following lemma explains that when a square involving families is a
family pullback square whenever the corresponding square involving projections is a
pullback square. There is no proof in the the opposite direction.

\begin{lem}
A square
\begin{equation}\label{eq:fpb_to_pb_eqv_fpb}
\begin{tikzcd}
P \ar[fib]{d} \ar{r}{F} & Q \ar[fib]{d} \\
A \ar{r}{f} & B
\end{tikzcd}
\end{equation}
is a family pullback square whenever the square
\begin{equation}\label{eq:fpb_to_pb_eqv_pb}
\begin{tikzcd}[column sep = large]
\ctxext{A}{P} \ar{d}[swap]{\cprojfstf{A}{P}} \ar{r}{\tmext{\ctxwk{P}{f}}{F}} & \ctxext{B}{Q} \ar{d}{\cprojfstf{B}{Q}} \\
A \ar{r}{f} & B
\end{tikzcd}
\end{equation}
is a pullback square.
\end{lem}

The family pullback of a family along any morphism always exists. It is simply given
by the precomposition of the family with the morphism. Note that this fact does
not carry over to arbitrary pullbacks.

\begin{lem}
The diagram
\begin{equation*}
\begin{tikzcd}
\jcomp{}{f}{Q} \ar[fib]{d} \ar{r}{\idtm{\jcomp{}{f}{Q}}} & Q \ar[fib]{d} \\
A \ar{r}{f} & B
\end{tikzcd}
\end{equation*}
is a family pullback diagram.
\end{lem}

\begin{proof}
The proof is a triviality because $\jhom{{\Gamma}{A}}{P'}{\jcomp{}{f}{Q}}{F'}$
is the same judgment as $\jfhom{\Gamma}{A}{B}{f}{P'}{Q}{F'}$ and
$\jcomp{}{\idtm{\jcomp{}{f}{Q}}}{F'}\jdeq F'$.
\end{proof}

For arbitrary pullbacks we have the pasting lemma as usual, but for family
pullbacks we can only derive one of the parts of the pasting lemma.

\begin{lem}
Suppose we have the diagram
\begin{equation*}
\begin{tikzcd}
P \ar{r}{F} \ar[fib]{d} & Q \ar{r}{G} \ar[fib]{d} & R \ar[fib]{d}\\
A \ar{r}{f} & B \ar{r}{g} & C
\end{tikzcd}
\end{equation*}
where the square on the right and the outer rectangle are family pullback 
diagrams. Then the square on the left is a family pullback diagram.
\end{lem}

\begin{proof}
Let $\jfam{{\Gamma}{A}}{P'}$ be a family and let $\jfhom{\Gamma}{A}{B}{f}
{P'}{Q}{F}$ be a morphism over $f$.
\begin{itemize}
\item Then we compose $F'$ with $G$ to obtain a morphism over $\jcomp{}{f}{g}$.
\item Then we get $\jhom{{\Gamma}{A}}{P'}{P}{u}$ with a uniqueness property.
      The property that $\jcomp{}{u}{F}\jdeq F'$ follows from the assumption
      that the right square is a pullback.
\item Now assume that we have another such $v$. Compose it with $F$ and $G$.
      By the assumed properties this is the same as $u$ composed with $F$ and
      $G$. By the pullback condition we now get $u\jdeq v$. 
\end{itemize}
\end{proof}

\begin{lem}
For any $\jterm{\Gamma}{A}{x}$ and any $\jfam{{\Gamma}{A}}{P}$, the square
\begin{equation*}
\begin{tikzcd}
\subst{x}{P} \ar{d} \ar{r}{\finc{x}{P}} & \ctxext{A}{P} \ar{d}{\cprojfstf{A}{P}}\\
\emptyf \ar{r}{\ctxwk{\emptyf}{x}} & A
\end{tikzcd}
\end{equation*}
is a pullback square.
\end{lem}

In the following lemma we assert that pulling back a family $Q$ 
over $\ctxext{{\Gamma}{A}}{P}$ along a fiber
inclusion $\finc{x}{P}$ gives the family $\subst{x}{Q}$ over $\ctxext{\Gamma}{\subst{x}{P}}$. 

\begin{lem}
We have the following inference rule:
\begin{equation*}
\inference
  { \jfam{{{\Gamma}{A}}{P}}{Q}
    \jterm{\Gamma}{A}{x}
    }
  { \jfameq
      {{\Gamma}{\subst{x}{P}}}
      {\jcomp{}{\finc{x}{P}}{Q}}
      {\subst{x}{Q}}
    }
\end{equation*}
\end{lem}

\begin{proof}
We have the judgmental equalities:
\begin{align*}
\jcomp{\subst{x}{P}}{\finc{x}{P}}{Q}
& \jdeq
  \subst{\tmext{\ctxwk{\subst{x}{P}}{x}}{\idtm{\subst{x}{P}}}}{\ctxwk{\subst{x}{P}}{Q}}
  \\
& \jdeq
  \subst{\idtm{\subst{x}{P}}}{{\ctxwk{\subst{x}{P}}{x}}{\ctxwk{\subst{x}{P}}{Q}}}
  \\
& \jdeq
  \subst{\idtm{\subst{x}{P}}}{\ctxwk{\subst{x}{P}}{\subst{x}{Q}}}
  \\
& \jdeq
  \subst{x}{Q}.
\end{align*}
\end{proof}

\begin{lem}
The following inference rule is valid:
\begin{equation*}
\inference
  { \jfam{{\Gamma}{A}}{P}
    \jfam{{\Gamma}{A}}{Q}
    }
  { \jfameq
      {{\Gamma}{{A}{P}}}
      {\jcomp{{A}{P}}{\cprojfstf{A}{P}}{Q}}
      {\ctxwk{P}{Q}}
    }
\end{equation*}
\end{lem}

\begin{proof}
Let $\jfam{{\Gamma}{A}}{P}$ and $\jfam{{\Gamma}{A}}{Q}$ be
families. Then we have
\begin{align*}
\jcomp{{A}{P}}{\cprojfstf{A}{P}}{Q}
& \jdeq
  \unfoldall{\jcomp{{A}{P}}{\cprojfstf{A}{P}}{Q}}
  \tag{by definition}\\
& \jdeq 
  \subst{\ctxwk{P}{\idtm{A}}}{\ctxwk{P}{{A}{Q}}} 
  \tag{by \autoref{comp-ww-f}}\\
& \jdeq 
  \ctxwk{P}{\subst{\idtm{A}}{\ctxwk{A}{Q}}} 
  \tag{by \autoref{comp-ws-f}}\\
& \jdeq 
  \ctxwk{P}{Q} 
  \tag{by \autoref{idfunc-wk-defn}}
\end{align*}
\end{proof}


\subsection{Another special case of projections}
In this subsection we investigate the special case of a projection which
appears as a morphism from $\ctxext{{A}{P}}{\ctxwk{P}{Q}}$ to $\ctxext{A}{Q}$
in context $\Gamma$, where we assume to have the families 
$\jfam{{\Gamma}{A}}{P}$ and $\jfam{{\Gamma}{A}}{Q}$. 

Note that we have the judgmental
equalities
\begin{align*}
\ctxwk{\ctxext{{A}{P}}{\ctxwk{P}{\mfam{A}}}}{\ctxext{A}{\mfam{A}}}
& \jdeq 
  \ctxext
    {\ctxwk{\ctxext{{A}{P}}{\ctxwk{P}{\mfam{A}}}}{A}}
    {\ctxwk{\ctxext{{A}{P}}{\ctxwk{P}{\mfam{A}}}}{\mfam{A}}}
  \\
& \jdeq
  \ctxext
    {\ctxwk{{P}{\mfam{A}}}{{\ctxext{A}{P}}{A}}}
    {\ctxwk{\ctxext{{A}{P}}{\ctxwk{P}{\mfam{A}}}}{\mfam{A}}}
\end{align*}
Note that we have the term $\ctxwk{{P}{\mfam{A}}}{\cprojfstf{A}{P}}$ of the
family $\ctxwk{{P}{\mfam{A}}}{{\ctxext{A}{P}}{A}}$. Therefore, we need to
find a term of type $\subst{\ctxwk{{P}{\mfam{A}}}{\cprojfstf{A}{P}}}
{\ctxwk{\ctxext{{A}{P}}{\ctxwk{P}{\mfam{A}}}}{\mfam{A}}}$. Note that we have
the judgmental equalities:
\begin{align*}
\subst
  {\ctxwk{{P}{\mfam{A}}}{\cprojfstf{A}{P}}}
  {\ctxwk{\ctxext{{A}{P}}{\ctxwk{P}{\mfam{A}}}}{\mfam{A}}}
& \jdeq
  \subst
    {\ctxwk{{P}{\mfam{A}}}{\cprojfstf{A}{P}}}
    {\ctxwk{{P}{\mfam{A}}}{{\ctxext{A}{P}}{\mfam{A}}}}
  \\
& \jdeq
  \ctxwk
    { {P}{\mfam{A}}
      }
    { \subst
        {\cprojfstf{A}{P}}
        {\ctxwk{\ctxext{A}{P}}{\mfam{A}}}
      }
  \\
& \jdeq
  \ctxwk
    { {P}{\mfam{A}}
      }
    { {P}{\mfam{A}}
      }
  \\
& \jdeq
  \ctxwk{P}{{\mfam{A}}{\mfam{A}}}
\end{align*}
We find the term $\ctxwk{P}{\idtm{\mfam{A}}}$ here. Thus we can now define
$\bar{\typefont{pr}}$ by:
\begin{equation}\label{barproj}
\jhomdefn
  {\Gamma}
  {{{A}{P}}{\mfam{A}}}
  {{A}{\mfam{A}}}
  {\bar{\typefont{pr}}}
  {\tmext{\ctxwk{{P}{\mfam{A}}}{\cprojfstf{A}{P}}}{\ctxwk{P}{\idtm{\mfam{A}}}}}
\end{equation}

\begin{lem}
We have the judgmental equality
\begin{equation*}
\jfameq
  {{{{\Gamma}{A}}{P}}{\ctxwk{P}{\mfam{A}}}}
  {\jcomp{}{\bar{\typefont{pr}}}{Q}}
  {\ctxwk{P}{Q}}
\end{equation*}
for any family $Q$ of contexts over $\ctxext{{\Gamma}{A}}{\mfam{A}}$ 
\end{lem}

\subsection{Inductive morphisms}
\begin{defn}
Let $\jhom{\Gamma}{A}{B}{f}$ be a context morphism. We say that $f$ is an 
\emph{inductive morphism} if the following inference rules are valid:
\begin{align*}
& \inference
  { \jfam{{\Gamma}{B}}{Q}
    \jterm{{\Gamma}{A}}{\jcomp{A}{f}{Q}}{g}
    }
  { \jterm{{\Gamma}{B}}{Q}{\jtcext{g}}
    }
& & \inference
  { \jfam{{\Gamma}{B}}{Q}
    \jterm{{\Gamma}{A}}{\jcomp{A}{f}{Q}}{g}
    }
  { \jtermeq{{\Gamma}{A}}{\jcomp{A}{f}{Q}}{\jcomp{A}{f}{\jtcext{g}}}{g}
    }
\end{align*}
\end{defn}

When $f$ is a context morphism from $A$ to $B$ in context $\Gamma$, 
finding a term of a family $Q$ over $\ctxext{\Gamma}{B}$ can be accomplished
by finding a term of the family $\jcomp{A}{f}{Q}$ over $\ctxext{\Gamma}{A}$.
Inductive morphisms come with a computation rule. Thus, term
constructors of inductively defined types are going to be the major source of
examples of inductive morphisms. Since identity terms behave
so nicely, they are inductive morphisms too.

\begin{lem}
The identity term
$\jhom{\Gamma}{A}{A}{\idtm{A}}$ is an inductive morphism
for each family $A$ of contexts over $\Gamma$
\end{lem}

\begin{itemize}
\item Extensions of inductive morphisms are inductive
\item Weakenings of inductive morphisms are inductive
\item Substitutions of inductive morphisms are inductive
\end{itemize}

